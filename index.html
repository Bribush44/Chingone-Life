<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Chingone Life Tracker</title>

<!-- PWA Meta Tags -->
<meta name="application-name" content="Chingone Life Tracker">
<meta name="description" content="Your personal health & fitness tracker ‚Äî food log, workouts, AI plans, and more.">
<meta name="theme-color" content="#0d0f0e">
<meta name="background-color" content="#0d0f0e">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Chingone">
<meta name="msapplication-TileColor" content="#0d0f0e">
<meta name="msapplication-tap-highlight" content="no">
<meta name="format-detection" content="telephone=no">

<!-- PWA Meta Tags -->


<!-- PWA Icons (inline SVG as data URIs) -->
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='115' fill='%230d0f0e'/%3E%3Ccircle cx='256' cy='256' r='175' fill='none' stroke='%234ade80' stroke-width='24'/%3E%3Ctext x='256' y='330' font-family='Arial Black,sans-serif' font-size='220' font-weight='900' fill='%234ade80' text-anchor='middle'%3EC%3C/text%3E%3C/svg%3E">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='115' fill='%230d0f0e'/%3E%3Ccircle cx='256' cy='256' r='175' fill='none' stroke='%234ade80' stroke-width='24'/%3E%3Ctext x='256' y='330' font-family='Arial Black,sans-serif' font-size='220' font-weight='900' fill='%234ade80' text-anchor='middle'%3EC%3C/text%3E%3C/svg%3E">
<link rel="apple-touch-icon" sizes="152x152" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='115' fill='%230d0f0e'/%3E%3Ccircle cx='256' cy='256' r='175' fill='none' stroke='%234ade80' stroke-width='24'/%3E%3Ctext x='256' y='330' font-family='Arial Black,sans-serif' font-size='220' font-weight='900' fill='%234ade80' text-anchor='middle'%3EC%3C/text%3E%3C/svg%3E">
<link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='115' fill='%230d0f0e'/%3E%3Ccircle cx='256' cy='256' r='175' fill='none' stroke='%234ade80' stroke-width='24'/%3E%3Ctext x='256' y='330' font-family='Arial Black,sans-serif' font-size='220' font-weight='900' fill='%234ade80' text-anchor='middle'%3EC%3C/text%3E%3C/svg%3E">
<link rel="apple-touch-icon" sizes="167x167" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='115' fill='%230d0f0e'/%3E%3Ccircle cx='256' cy='256' r='175' fill='none' stroke='%234ade80' stroke-width='24'/%3E%3Ctext x='256' y='330' font-family='Arial Black,sans-serif' font-size='220' font-weight='900' fill='%234ade80' text-anchor='middle'%3EC%3C/text%3E%3C/svg%3E">
<link rel="manifest" href="data:application/manifest+json,%7B%0A%20%20%22name%22%3A%20%22Chingone%20Life%20Tracker%22%2C%0A%20%20%22short_name%22%3A%20%22Chingone%22%2C%0A%20%20%22description%22%3A%20%22Your%20personal%20health%20and%20fitness%20tracker%22%2C%0A%20%20%22start_url%22%3A%20%22.%22%2C%0A%20%20%22display%22%3A%20%22standalone%22%2C%0A%20%20%22orientation%22%3A%20%22portrait-primary%22%2C%0A%20%20%22background_color%22%3A%20%22%230d0f0e%22%2C%0A%20%20%22theme_color%22%3A%20%22%230d0f0e%22%2C%0A%20%20%22categories%22%3A%20%5B%22health%22%2C%20%22fitness%22%5D%2C%0A%20%20%22icons%22%3A%20%5B%0A%20%20%20%20%7B%0A%20%20%20%20%20%20%22src%22%3A%20%22data%3Aimage%2Fsvg%2Bxml%2C%253Csvg%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%20viewBox%3D%270%200%20512%20512%27%253E%253Crect%20width%3D%27512%27%20height%3D%27512%27%20rx%3D%27115%27%20fill%3D%27%25230d0f0e%27%2F%253E%253Ccircle%20cx%3D%27256%27%20cy%3D%27256%27%20r%3D%27175%27%20fill%3D%27none%27%20stroke%3D%27%25234ade80%27%20stroke-width%3D%2724%27%2F%253E%253Ctext%20x%3D%27256%27%20y%3D%27330%27%20font-family%3D%27Arial%20Black%2Csans-serif%27%20font-size%3D%27220%27%20font-weight%3D%27900%27%20fill%3D%27%25234ade80%27%20text-anchor%3D%27middle%27%253EC%253C%2Ftext%253E%253C%2Fsvg%253E%22%2C%0A%20%20%20%20%20%20%22sizes%22%3A%20%22512x512%22%2C%0A%20%20%20%20%20%20%22type%22%3A%20%22image%2Fsvg%2Bxml%22%2C%0A%20%20%20%20%20%20%22purpose%22%3A%20%22any%22%0A%20%20%20%20%7D%2C%0A%20%20%20%20%7B%0A%20%20%20%20%20%20%22src%22%3A%20%22data%3Aimage%2Fsvg%2Bxml%2C%253Csvg%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%20viewBox%3D%270%200%20512%20512%27%253E%253Crect%20width%3D%27512%27%20height%3D%27512%27%20rx%3D%27115%27%20fill%3D%27%25230d0f0e%27%2F%253E%253Ccircle%20cx%3D%27256%27%20cy%3D%27256%27%20r%3D%27175%27%20fill%3D%27none%27%20stroke%3D%27%25234ade80%27%20stroke-width%3D%2724%27%2F%253E%253Ctext%20x%3D%27256%27%20y%3D%27330%27%20font-family%3D%27Arial%20Black%2Csans-serif%27%20font-size%3D%27220%27%20font-weight%3D%27900%27%20fill%3D%27%25234ade80%27%20text-anchor%3D%27middle%27%253EC%253C%2Ftext%253E%253C%2Fsvg%253E%22%2C%0A%20%20%20%20%20%20%22sizes%22%3A%20%22192x192%22%2C%0A%20%20%20%20%20%20%22type%22%3A%20%22image%2Fsvg%2Bxml%22%2C%0A%20%20%20%20%20%20%22purpose%22%3A%20%22maskable%22%0A%20%20%20%20%7D%0A%20%20%5D%0A%7D">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0f0e;
    --surface: #161a18;
    --surface2: #1e2420;
    --surface3: #252c28;
    --border: #2e3832;
    --green: #4ade80;
    --green-dim: #22c55e;
    --green-glow: rgba(74,222,128,0.15);
    --green-dark: #166534;
    --accent: #facc15;
    --accent2: #fb923c;
    --text: #e8ede9;
    --text-dim: #8a9e8f;
    --text-muted: #4a5e50;
    --red: #f87171;
    --blue: #60a5fa;
    --radius: 12px;
    --radius-lg: 20px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }

  /* NOISE TEXTURE */
  body::before { content: ''; position: fixed; inset: 0; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E"); pointer-events: none; z-index: 9999; opacity: 0.4; }

  /* ‚îÄ‚îÄ AUTH SCREEN ‚îÄ‚îÄ */
  #auth-screen { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; background: radial-gradient(ellipse at 30% 50%, rgba(74,222,128,0.06) 0%, transparent 60%), radial-gradient(ellipse at 70% 20%, rgba(250,204,21,0.04) 0%, transparent 50%); }
  .auth-box { width: 100%; max-width: 440px; }
  .auth-logo { font-family: 'Bebas Neue', sans-serif; font-size: 52px; letter-spacing: 3px; color: var(--green); text-shadow: 0 0 40px rgba(74,222,128,0.4); margin-bottom: 4px; }
  .auth-tagline { color: var(--text-dim); font-size: 14px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 40px; }
  .auth-tabs { display: flex; gap: 0; margin-bottom: 28px; border-radius: var(--radius); overflow: hidden; border: 1px solid var(--border); }
  .auth-tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-size: 14px; font-weight: 500; background: var(--surface2); color: var(--text-dim); transition: all 0.2s; }
  .auth-tab.active { background: var(--green); color: #0d0f0e; font-weight: 600; }

  /* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
  .form-group { margin-bottom: 16px; }
  label { display: block; font-size: 12px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; color: var(--text-dim); margin-bottom: 8px; }
  input, select, textarea { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px 16px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 14px; outline: none; transition: border-color 0.2s; }
  input:focus, select:focus, textarea:focus { border-color: var(--green); box-shadow: 0 0 0 3px var(--green-glow); }
  select option { background: var(--surface2); }
  textarea { resize: vertical; min-height: 80px; }

  /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
  .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 13px 24px; border-radius: var(--radius); font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; text-decoration: none; }
  .btn-primary { background: var(--green); color: #0d0f0e; }
  .btn-primary:hover { background: #86efac; transform: translateY(-1px); box-shadow: 0 8px 24px rgba(74,222,128,0.3); }
  .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-dim); }
  .btn-outline:hover { border-color: var(--green); color: var(--green); background: var(--green-glow); }
  .btn-danger { background: rgba(248,113,113,0.15); border: 1px solid rgba(248,113,113,0.3); color: var(--red); }
  .btn-danger:hover { background: rgba(248,113,113,0.25); }
  .btn-full { width: 100%; }
  .btn-sm { padding: 8px 14px; font-size: 13px; border-radius: 8px; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

  /* ‚îÄ‚îÄ APP LAYOUT ‚îÄ‚îÄ */
  #app { display: none; height: 100vh; overflow: hidden; }
  #app.visible { display: flex; }
  .sidebar { width: 240px; flex-shrink: 0; background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; height: 100vh; overflow-y: auto; }
  .sidebar-logo { font-family: 'Bebas Neue', sans-serif; font-size: 22px; letter-spacing: 2px; color: var(--green); padding: 20px 16px 12px; border-bottom: 1px solid var(--border); }
  .sidebar-user { padding: 12px 16px; border-bottom: 1px solid var(--border); }
  .user-chip { display: flex; align-items: center; gap: 10px; padding: 8px 10px; border-radius: 10px; cursor: pointer; transition: background 0.15s; }
  .user-chip:hover { background: var(--surface2); }
  .user-avatar { width: 34px; height: 34px; border-radius: 50%; background: var(--green); color: #0d0f0e; font-size: 15px; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .user-name { font-size: 14px; font-weight: 600; }
  .sidebar-nav { flex: 1; padding: 12px 8px; overflow-y: auto; }
  .nav-item { display: flex; align-items: center; gap: 12px; padding: 11px 14px; border-radius: 10px; cursor: pointer; color: var(--text-dim); font-size: 14px; font-weight: 500; transition: all 0.15s; margin-bottom: 2px; }
  .nav-item:hover { background: var(--surface2); color: var(--text); }
  .nav-item.active { background: var(--green-glow); color: var(--green); }
  .nav-item .nav-icon { font-size: 18px; width: 22px; text-align: center; }
  .sidebar-bottom { padding: 16px; border-top: 1px solid var(--border); }
  .main { flex: 1; overflow-y: auto; background: var(--bg); }
  .page { display: none; padding: 28px 32px; max-width: 900px; }
  .page.active { display: block; }
  .page-title { font-family: 'Bebas Neue', sans-serif; font-size: 42px; letter-spacing: 1px; line-height: 1; margin-bottom: 4px; }
  .page-sub { color: var(--text-dim); font-size: 14px; margin-bottom: 24px; }

  /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 16px; }
  .card-title { font-family: 'Bebas Neue', sans-serif; font-size: 22px; letter-spacing: 0.5px; margin-bottom: 14px; }

  /* ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ */
  .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 20px; }
  .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 18px; }
  .stat-card.calories { border-color: rgba(250,204,21,0.3); }
  .stat-card.protein { border-color: rgba(74,222,128,0.3); }
  .stat-card.fat { border-color: rgba(251,146,60,0.3); }
  .stat-card.carbs { border-color: rgba(96,165,250,0.3); }
  .stat-value { font-family: 'Bebas Neue', sans-serif; font-size: 42px; line-height: 1; }
  .stat-unit { font-size: 14px; color: var(--text-dim); margin-left: 3px; }
  .stat-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-top: 4px; }
  .stat-goal { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
  .stat-bar { height: 4px; background: var(--border); border-radius: 2px; margin-top: 10px; overflow: hidden; }
  .stat-bar-fill { height: 100%; border-radius: 2px; background: var(--green); transition: width 0.5s ease; }
  .stat-card.calories .stat-bar-fill { background: var(--accent); }
  .stat-card.fat .stat-bar-fill { background: var(--accent2); }
  .stat-card.carbs .stat-bar-fill { background: var(--blue); }

  /* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
  .badge { display: inline-block; padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: 700; }
  .badge-green { background: var(--green-glow); color: var(--green); border: 1px solid rgba(74,222,128,0.3); }
  .badge-yellow { background: rgba(250,204,21,0.15); color: var(--accent); border: 1px solid rgba(250,204,21,0.3); }

  /* ‚îÄ‚îÄ TABLES ‚îÄ‚îÄ */
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { text-align: left; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); padding: 8px 12px; border-bottom: 1px solid var(--border); }
  td { padding: 10px 12px; border-bottom: 1px solid var(--border); color: var(--text-dim); }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: var(--surface2); }

  /* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(6px); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 28px; width: 100%; animation: slideUp 0.2s ease; }
  @keyframes slideUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
  .modal-title { font-family: 'Bebas Neue', sans-serif; font-size: 28px; letter-spacing: 0.5px; margin-bottom: 4px; }
  .modal-sub { font-size: 14px; color: var(--text-dim); margin-bottom: 20px; }

  /* ‚îÄ‚îÄ FOOD LOG ‚îÄ‚îÄ */
  .date-bar { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
  .date-nav { display: flex; align-items: center; gap: 8px; }
  .date-nav button { background: var(--surface2); border: 1px solid var(--border); color: var(--text-dim); width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; }
  .date-nav button:hover { border-color: var(--green); color: var(--green); }
  #log-date-label { font-weight: 600; font-size: 15px; }
  .search-bar { display: flex; gap: 10px; margin-bottom: 14px; flex-wrap: wrap; }
  .search-bar input { flex: 1; min-width: 200px; }
  .meal-section { margin-bottom: 20px; }
  .meal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
  .meal-title { font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); }
  .meal-cals { font-size: 12px; color: var(--text-muted); }
  .food-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); gap: 10px; }
  .food-item:last-child { border-bottom: none; }
  .food-name { font-size: 14px; font-weight: 500; }
  .food-brand { font-size: 12px; color: var(--text-muted); }
  .food-macros { display: flex; gap: 12px; font-size: 12px; color: var(--text-muted); flex-wrap: wrap; }
  .food-cals { font-weight: 700; font-size: 15px; font-family: 'Bebas Neue', sans-serif; }
  .search-results { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius); margin-top: 6px; max-height: 340px; overflow-y: auto; }
  .search-result-item { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.15s; }
  .search-result-item:hover { background: var(--surface3); }
  .search-result-item:last-child { border-bottom: none; }
  .source-tabs { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; }
  .source-tab { padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer; border: 1px solid var(--border); background: var(--surface2); color: var(--text-dim); transition: all 0.15s; }
  .source-tab.active { background: var(--green); color: #0d0f0e; border-color: var(--green); }
  .manual-badge { display: inline-block; padding: 2px 7px; border-radius: 8px; font-size: 10px; font-weight: 700; background: rgba(250,204,21,0.15); color: var(--accent); border: 1px solid rgba(250,204,21,0.3); margin-left: 6px; }

  /* ‚îÄ‚îÄ WORKOUT LOG ‚îÄ‚îÄ */
  .workout-card { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; margin-bottom: 12px; }
  .workout-card-header { display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
  .workout-card-title { font-weight: 600; font-size: 15px; }
  .workout-card-meta { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
  .stat-pills { display: flex; gap: 8px; flex-wrap: wrap; }
  .stat-pill { background: var(--surface3); border: 1px solid var(--border); border-radius: 20px; padding: 4px 12px; font-size: 12px; font-weight: 600; }
  .exercise-row { display: flex; align-items: baseline; gap: 8px; padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
  .exercise-row:last-child { border-bottom: none; }
  .exercise-name { font-weight: 600; min-width: 160px; }
  .exercise-sets { font-family: 'DM Mono', monospace; color: var(--text-muted); font-size: 12px; }
  .streak-badge { display: flex; align-items: center; gap: 6px; background: rgba(250,204,21,0.1); border: 1px solid rgba(250,204,21,0.2); border-radius: var(--radius); padding: 10px 16px; margin-bottom: 16px; font-size: 13px; font-weight: 600; color: var(--accent); }
  .pr-badge { display: inline-block; padding: 1px 6px; border-radius: 6px; font-size: 10px; font-weight: 700; background: rgba(250,204,21,0.15); color: var(--accent); border: 1px solid rgba(250,204,21,0.3); margin-left: 4px; }

  /* ‚îÄ‚îÄ AI PLAN ‚îÄ‚îÄ */
  .ai-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .api-key-note { background: rgba(250,204,21,0.08); border: 1px solid rgba(250,204,21,0.2); border-radius: var(--radius); padding: 14px 16px; font-size: 13px; color: var(--accent); margin-bottom: 16px; }
  .ai-plan-output { font-size: 14px; color: var(--text-dim); line-height: 1.8; white-space: pre-wrap; }
  .spinner { width: 18px; height: 18px; border: 2px solid var(--border); border-top-color: var(--green); border-radius: 50%; animation: spin 0.6s linear infinite; display: inline-block; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .chip-input-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
  .ai-chip { padding: 6px 14px; border-radius: 20px; background: var(--surface2); border: 1px solid var(--border); color: var(--text-dim); font-size: 13px; cursor: pointer; transition: all 0.15s; }
  .ai-chip:hover, .ai-chip.selected { background: var(--green-glow); border-color: var(--green); color: var(--green); }

  /* ‚îÄ‚îÄ RECIPES ‚îÄ‚îÄ */
  .recipes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
  .recipe-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 20px; cursor: pointer; transition: all 0.2s; }
  .recipe-card:hover { border-color: var(--green); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
  .recipe-emoji { font-size: 36px; margin-bottom: 10px; }
  .recipe-name { font-family: 'Bebas Neue', sans-serif; font-size: 22px; letter-spacing: 0.5px; margin-bottom: 4px; }
  .recipe-author { font-size: 12px; color: var(--text-muted); margin-bottom: 8px; }
  .recipe-desc { font-size: 13px; color: var(--text-dim); line-height: 1.5; margin-bottom: 12px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .recipe-macros { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
  .recipe-macro { text-align: center; }
  .recipe-macro-val { font-family: 'Bebas Neue', sans-serif; font-size: 20px; line-height: 1; }
  .recipe-macro-lbl { font-size: 10px; color: var(--text-muted); text-transform: uppercase; }
  .recipe-tags { display: flex; gap: 6px; flex-wrap: wrap; }
  .recipe-tag { padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: var(--surface2); border: 1px solid var(--border); color: var(--text-dim); }
  .cat-breakfast { background: rgba(250,204,21,0.1); border-color: rgba(250,204,21,0.2); color: var(--accent); }
  .cat-lunch { background: rgba(74,222,128,0.1); border-color: rgba(74,222,128,0.2); color: var(--green); }
  .cat-dinner { background: rgba(96,165,250,0.1); border-color: rgba(96,165,250,0.2); color: var(--blue); }
  .cat-snack { background: rgba(251,146,60,0.1); border-color: rgba(251,146,60,0.2); color: var(--accent2); }
  .cat-smoothie, .cat-dessert { background: rgba(248,113,113,0.1); border-color: rgba(248,113,113,0.2); color: var(--red); }
  .recipe-filter-bar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
  .filter-btn { padding: 6px 16px; border-radius: 20px; border: 1px solid var(--border); background: var(--surface2); color: var(--text-dim); font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.15s; font-family: 'DM Sans', sans-serif; }
  .filter-btn.active, .filter-btn:hover { background: var(--green-glow); border-color: var(--green); color: var(--green); }

  /* ‚îÄ‚îÄ USERS GRID ‚îÄ‚îÄ */
  .users-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 14px; }
  .user-card { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s; }
  .user-card:hover { border-color: var(--green); transform: translateY(-2px); }
  .user-card.active-user { border-color: var(--green); background: var(--green-glow); }
  .uc-avatar { width: 52px; height: 52px; border-radius: 50%; background: var(--green); color: #0d0f0e; font-size: 22px; font-weight: 700; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; }
  .uc-name { font-weight: 700; font-size: 15px; }
  .uc-goal { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

  /* ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ */
  .success-msg { background: rgba(74,222,128,0.1); border: 1px solid rgba(74,222,128,0.2); color: var(--green); border-radius: var(--radius); padding: 10px 14px; font-size: 13px; }
  .error-msg { background: rgba(248,113,113,0.08); border: 1px solid rgba(248,113,113,0.2); color: var(--red); border-radius: var(--radius); padding: 10px 14px; font-size: 13px; }

  /* ‚îÄ‚îÄ GOOGLE SHEETS ‚îÄ‚îÄ */
  .sheets-connected { display: flex; align-items: center; gap: 10px; background: rgba(74,222,128,0.08); border: 1px solid rgba(74,222,128,0.2); border-radius: var(--radius); padding: 12px 16px; font-size: 14px; color: var(--green); margin-bottom: 20px; }

  /* ‚îÄ‚îÄ MOBILE RESPONSIVE ‚îÄ‚îÄ */
  @media (max-width: 768px) {
    /* Hide desktop sidebar on mobile */
    .sidebar { display: none !important; }
    #app.visible { flex-direction: column; }
    .main { width: 100%; padding-bottom: 72px; /* space for bottom tabs */ }
    .page { padding: 16px 14px; }
    .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .ai-form-grid { grid-template-columns: 1fr; }
    #mi-input-grid { grid-template-columns: 1fr !important; }
    .page-title { font-size: 28px; }
    .hamburger { display: none !important; }
    /* Show bottom tab bar */
    .bottom-tab-bar { display: flex !important; }
  }
  @media (max-width: 480px) {
    .recipes-grid { grid-template-columns: 1fr; }
    .pdf-stats-row { grid-template-columns: repeat(2, 1fr); }
    .bottom-tab-bar .tab-label { font-size: 9px; }
  }

  /* ‚îÄ‚îÄ BOTTOM TAB BAR (mobile only) ‚îÄ‚îÄ */
  .bottom-tab-bar {
    display: none;
    position: fixed;
    bottom: 0; left: 0; right: 0;
    height: 64px;
    background: var(--surface);
    border-top: 1px solid var(--border);
    z-index: 600;
    align-items: stretch;
    padding-bottom: env(safe-area-inset-bottom);
    box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
  }
  .tab-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 3px;
    cursor: pointer;
    background: none;
    border: none;
    color: var(--text-muted);
    font-family: 'DM Sans', sans-serif;
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.2px;
    padding: 6px 2px;
    transition: color 0.15s;
    -webkit-tap-highlight-color: transparent;
    position: relative;
  }
  .tab-btn .tab-icon { font-size: 22px; line-height: 1; }
  .tab-btn .tab-label { font-size: 10px; }
  .tab-btn.active { color: var(--green); }
  .tab-btn.active .tab-icon { filter: drop-shadow(0 0 6px rgba(74,222,128,0.5)); }
  .tab-btn.active::before {
    content: '';
    position: absolute;
    top: 0; left: 20%; right: 20%;
    height: 2px;
    background: var(--green);
    border-radius: 0 0 3px 3px;
  }
  /* "More" menu overlay */
  .more-menu {
    display: none;
    position: fixed;
    bottom: 64px; left: 0; right: 0;
    background: var(--surface);
    border-top: 1px solid var(--border);
    border-radius: 20px 20px 0 0;
    z-index: 601;
    padding: 8px 0 16px;
    box-shadow: 0 -8px 32px rgba(0,0,0,0.4);
    animation: slideUpMenu 0.2s ease;
  }
  .more-menu.open { display: block; }
  @keyframes slideUpMenu { from { transform: translateY(30px); opacity:0; } to { transform: translateY(0); opacity:1; } }
  .more-menu-handle { width: 36px; height: 4px; background: var(--border); border-radius: 2px; margin: 8px auto 16px; }
  .more-menu-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); padding: 0 20px 8px; }
  .more-menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; padding: 0 8px; }
  .more-menu-item {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 6px; padding: 14px 8px; border-radius: 12px; cursor: pointer;
    background: none; border: none; font-family: 'DM Sans', sans-serif;
    color: var(--text-dim); font-size: 12px; font-weight: 500;
    transition: background 0.15s; -webkit-tap-highlight-color: transparent;
  }
  .more-menu-item:hover, .more-menu-item:active { background: var(--surface2); color: var(--text); }
  .more-menu-item.active { color: var(--green); }
  .more-menu-item .mi-icon { font-size: 26px; }
  .more-menu-overlay { display: none; position: fixed; inset: 0; z-index: 599; }
  .more-menu-overlay.open { display: block; }

  /* HAMBURGER ‚Äî only used on desktop medium screens */
  .hamburger { display: none; }
  .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 499; }
  .sidebar-overlay.open { display: block; }
</style>
</head>
<body>
<style>
  /* PWA / Mobile feel */
  * { -webkit-tap-highlight-color: transparent; }
  html, body { overscroll-behavior: none; -webkit-overflow-scrolling: touch; }
  @media (display-mode: standalone) {
    #app .sidebar { padding-top: max(20px, env(safe-area-inset-top)); }
    #app .main { padding-bottom: max(24px, env(safe-area-inset-bottom)); }
  }

  /* ‚îÄ‚îÄ MEAL IDEAS ‚îÄ‚îÄ */
  .ingredient-chip-row { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
  .ingredient-chip { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; background: var(--surface2); border: 1px solid var(--border); font-size: 13px; color: var(--text-dim); font-weight: 500; }
  .ingredient-chip .chip-del { background: none; border: none; color: var(--text-muted); font-size: 14px; cursor: pointer; padding: 0; line-height: 1; transition: color 0.15s; }
  .ingredient-chip .chip-del:hover { color: var(--red); }
  .ingredient-chip.fridge { border-color: rgba(96,165,250,0.4); background: rgba(96,165,250,0.08); color: var(--blue); }
  .ingredient-chip.cupboard { border-color: rgba(250,204,21,0.4); background: rgba(250,204,21,0.08); color: var(--accent); }
  .meal-idea-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 16px; transition: border-color 0.2s; }
  .meal-idea-card:hover { border-color: var(--green); }
  .meal-idea-title { font-family: 'Bebas Neue', sans-serif; font-size: 26px; letter-spacing: 0.5px; margin-bottom: 4px; }
  .meal-idea-meta { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 12px; }
  .meal-idea-body { font-size: 14px; color: var(--text-dim); line-height: 1.8; }
  .meal-idea-section { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin: 14px 0 6px; }
  .meal-idea-ingredient.have { display:inline-flex; align-items:center; gap:5px; padding:4px 10px; border-radius:12px; font-size:12px; font-weight:500; margin:3px; background: rgba(74,222,128,0.12); color: var(--green); border: 1px solid rgba(74,222,128,0.25); }
  .meal-idea-ingredient.need { display:inline-flex; align-items:center; gap:5px; padding:4px 10px; border-radius:12px; font-size:12px; font-weight:500; margin:3px; background: rgba(248,113,113,0.12); color: var(--red); border: 1px solid rgba(248,113,113,0.25); }
  .meal-macros-row { display: flex; gap: 16px; flex-wrap: wrap; padding: 12px 16px; background: var(--surface2); border-radius: var(--radius); margin-top: 12px; }
  .quick-add-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; margin-bottom: 16px; }
  .quick-add-btn { padding: 8px 10px; border-radius: var(--radius); border: 1px solid var(--border); background: var(--surface2); color: var(--text-dim); font-size: 12px; font-weight: 500; cursor: pointer; text-align: center; transition: all 0.15s; font-family: 'DM Sans', sans-serif; }
  .quick-add-btn:hover { border-color: var(--green); color: var(--green); background: var(--green-glow); }
  .mi-streaming { white-space: pre-wrap; font-size: 14px; color: var(--text-dim); line-height: 1.8; font-family: 'DM Sans', sans-serif; min-height: 60px; }
  .mi-cursor { display: inline-block; width: 2px; height: 1em; background: var(--green); animation: blink 0.8s infinite; vertical-align: text-bottom; margin-left: 2px; }
  @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0; } }

  /* ‚îÄ‚îÄ PDF / PRINT STYLES ‚îÄ‚îÄ */
  @media print {
    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    body { background: #fff !important; margin: 0 !important; padding: 0 !important; }
    #auth-screen, #app { display: none !important; }
    #pdf-print-frame { display: block !important; }
  }
  #pdf-print-frame { display: none; }

  /* PDF Preview Modal */
  .pdf-modal { max-width: 700px; max-height: 92vh; overflow-y: auto; width: 100%; }
  .pdf-preview { background: #fff; border-radius: 8px; padding: 32px 36px; color: #1a1a1a; font-family: 'DM Sans', -apple-system, sans-serif; box-shadow: 0 4px 24px rgba(0,0,0,0.15); }
  .pdf-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 3px solid #0d0f0e; padding-bottom: 16px; margin-bottom: 20px; }
  .pdf-logo { font-family: 'Bebas Neue', sans-serif; font-size: 28px; letter-spacing: 1px; color: #0d0f0e; }
  .pdf-logo span { color: #4ade80; }
  .pdf-date-block { text-align: right; }
  .pdf-date-block .pdf-date { font-size: 15px; font-weight: 700; color: #0d0f0e; }
  .pdf-date-block .pdf-user { font-size: 12px; color: #666; margin-top: 2px; }
  .pdf-section-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; color: #888; margin: 20px 0 10px; }
  .pdf-stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 4px; }
  .pdf-stat-box { border-radius: 10px; padding: 14px 12px; text-align: center; }
  .pdf-stat-box.cals    { background: #fef3c7; border: 1px solid #fde68a; }
  .pdf-stat-box.protein { background: #dcfce7; border: 1px solid #86efac; }
  .pdf-stat-box.carbs   { background: #dbeafe; border: 1px solid #93c5fd; }
  .pdf-stat-box.fat     { background: #ffedd5; border: 1px solid #fdba74; }
  .pdf-stat-val  { font-size: 28px; font-weight: 800; line-height: 1; }
  .pdf-stat-unit { font-size: 12px; font-weight: 600; margin-left: 2px; }
  .pdf-stat-label { font-size: 11px; color: #666; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
  .pdf-stat-goal  { font-size: 10px; color: #999; margin-top: 2px; }
  .pdf-bar-wrap { height: 6px; background: #e5e7eb; border-radius: 3px; margin-top: 6px; overflow: hidden; }
  .pdf-bar-fill { height: 100%; border-radius: 3px; }
  .pdf-meal-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f3f4f6; font-size: 13px; }
  .pdf-meal-row:last-child { border-bottom: none; }
  .pdf-meal-icon { font-size: 16px; margin-right: 8px; }
  .pdf-meal-name { font-weight: 600; color: #1a1a1a; }
  .pdf-meal-items { font-size: 12px; color: #888; }
  .pdf-meal-cals { font-weight: 700; font-size: 15px; color: #1a1a1a; white-space: nowrap; }
  .pdf-workout-block { background: #f9fafb; border-radius: 8px; padding: 14px 16px; margin-bottom: 10px; border-left: 4px solid #0d0f0e; }
  .pdf-workout-name { font-weight: 700; font-size: 14px; margin-bottom: 4px; }
  .pdf-workout-meta { font-size: 12px; color: #666; display: flex; gap: 12px; flex-wrap: wrap; }
  .pdf-exercise-row { font-size: 12px; color: #444; padding: 4px 0; display: flex; gap: 6px; align-items: baseline; }
  .pdf-exercise-name { font-weight: 600; min-width: 130px; }
  .pdf-exercise-sets { color: #666; font-family: monospace; }
  .pdf-footer { margin-top: 24px; padding-top: 14px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
  .pdf-footer-app { font-size: 11px; color: #aaa; }
  .pdf-footer-date { font-size: 11px; color: #aaa; }
  .pdf-goal-badge { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: #dcfce7; color: #16a34a; border: 1px solid #86efac; }
  .pdf-no-data { font-size: 13px; color: #aaa; font-style: italic; padding: 10px 0; }
  .pdf-totals-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0 0; font-size: 13px; font-weight: 600; border-top: 1px solid #e5e7eb; margin-top: 4px; }
</style>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="auth-screen">
  <div class="auth-box">
    <div class="auth-logo">Chingone Life Tracker</div>
    <div class="auth-tagline">Your group health & fitness companion</div>

    <div class="auth-tabs">
      <div class="auth-tab active" onclick="switchAuthTab('login')">Sign In</div>
      <div class="auth-tab" onclick="switchAuthTab('register')">Create Account</div>
    </div>

    <!-- LOGIN -->
    <div id="login-form">
      <div class="form-group">
        <label>Username</label>
        <input type="text" id="login-username" placeholder="Enter your username">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="login-password" placeholder="Enter your password">
      </div>
      <div class="error-msg" id="login-error">Invalid username or password.</div>
      <button class="btn btn-primary btn-full" style="margin-top:8px" onclick="doLogin()">Sign In ‚Üí</button>
      <div style="margin-top:16px; padding:14px; background:var(--surface2); border-radius:var(--radius); font-size:13px; color:var(--text-dim);">
        üí° Demo users: <strong style="color:var(--text)">sarah</strong> / <strong style="color:var(--text)">demo123</strong> &nbsp;or&nbsp; <strong style="color:var(--text)">mike</strong> / <strong style="color:var(--text)">demo123</strong>
      </div>
    </div>

    <!-- REGISTER -->
    <div id="register-form" style="display:none">
      <div class="ai-form-grid">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="reg-username" placeholder="Choose a username">
        </div>
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="reg-name" placeholder="Your full name">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="reg-password" placeholder="Create a password">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="reg-email" placeholder="your@email.com">
        </div>
        <div class="form-group">
          <label>Age</label>
          <input type="number" id="reg-age" placeholder="25">
        </div>
        <div class="form-group">
          <label>Gender</label>
          <select id="reg-gender">
            <option value="male">Male</option>
            <option value="female">Female</option>
            <option value="other">Other / Prefer not to say</option>
          </select>
        </div>
        <div class="form-group">
          <label>Height (inches)</label>
          <input type="number" id="reg-height" placeholder="68">
        </div>
        <div class="form-group">
          <label>Weight (lbs)</label>
          <input type="number" id="reg-weight" placeholder="160">
        </div>
        <div class="form-group full">
          <label>Primary Goal</label>
          <select id="reg-goal">
            <option value="lose_weight">Lose Weight</option>
            <option value="build_muscle">Build Muscle</option>
            <option value="maintain">Maintain Weight</option>
            <option value="improve_fitness">Improve Overall Fitness</option>
          </select>
        </div>
      </div>
      <div class="error-msg" id="reg-error">Username already taken.</div>
      <button class="btn btn-primary btn-full" style="margin-top:8px" onclick="doRegister()">Create Account ‚Üí</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="app">
  <!-- Mobile sidebar overlay -->
  <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-logo">Chingone Life Tracker</div>
    <div class="sidebar-user">
      <div class="user-chip" onclick="navigate('users')">
        <div class="user-avatar" id="sidebar-avatar">S</div>
        <div class="user-name" id="sidebar-username">Sarah</div>
      </div>
    </div>
    <div class="sidebar-nav">
      <div class="nav-item active" onclick="navigate('dashboard')"><span class="nav-icon">üìä</span> Dashboard</div>
      <div class="nav-item" onclick="navigate('food-log')"><span class="nav-icon">ü•ó</span> Food Log</div>
      <div class="nav-item" onclick="navigate('workout-log')"><span class="nav-icon">üèãÔ∏è</span> Workout Log</div>
      <div class="nav-item" onclick="navigate('ai-plan')"><span class="nav-icon">ü§ñ</span> AI Plan</div>
      <div class="nav-item" onclick="navigate('meal-ideas')"><span class="nav-icon">üßë‚Äçüç≥</span> Meal Ideas</div>
      <div class="nav-item" onclick="navigate('recipes')"><span class="nav-icon">üìñ</span> Recipes</div>
      <div class="nav-item" onclick="navigate('history')"><span class="nav-icon">üìÖ</span> History</div>
      <div class="nav-item" onclick="navigate('import')"><span class="nav-icon">üì•</span> Import Data</div>
      <div class="nav-item" onclick="navigate('sheets')"><span class="nav-icon">üìä</span> Google Sheets</div>
      <div class="nav-item" onclick="navigate('profile')"><span class="nav-icon">üë§</span> My Profile</div>
      <div class="nav-item" onclick="navigate('users')"><span class="nav-icon">üë•</span> Switch User</div>
      <div class="nav-item" id="nav-admin" style="display:none;" onclick="navigate('admin')"><span class="nav-icon">üõ°Ô∏è</span> Admin Panel</div>
      <div class="nav-item" onclick="navigate('install')"><span class="nav-icon">üì≤</span> Install App</div>
    </div>
    <div class="sidebar-bottom">
      <div id="sidebar-whatsapp" style="display:none;margin-bottom:10px;">
        <button class="btn btn-whatsapp btn-full" onclick="openWhatsApp()" style="justify-content:center;gap:8px;">
          <span style="font-size:18px;">üí¨</span> Open WhatsApp Group
        </button>
      </div>
      <button class="btn btn-outline btn-full btn-sm" onclick="doLogout()">Sign Out</button>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main">

    <!-- ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ -->
    <div class="page active" id="page-dashboard">
      <!-- Header row: greeting + date nav -->
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:6px;">
        <!-- Left: hamburger + greeting -->
        <div style="display:flex;align-items:center;gap:12px;">
          <div>
            <div class="page-title" id="dash-greeting" style="margin-bottom:2px;">Good morning, Sarah</div>
            <div class="page-sub" id="dash-date" style="margin-bottom:0;">Wednesday, February 18, 2026</div>
          </div>
        </div>
        <!-- Right: share + date navigator -->
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <button class="btn btn-outline btn-sm" onclick="shareDashboardPDF()" style="display:flex;align-items:center;gap:6px;">
            <span>üì§</span> Share Day
          </button>
          <div style="display:flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px 14px;">
            <button onclick="changeDashDate(-1)" style="background:none;border:none;color:var(--text-dim);font-size:18px;cursor:pointer;padding:0 4px;line-height:1;transition:color 0.15s;" onmouseover="this.style.color='var(--green)'" onmouseout="this.style.color='var(--text-dim)'">&#8249;</button>
            <div style="text-align:center;min-width:110px;">
              <div id="dash-nav-date" style="font-size:13px;font-weight:600;color:var(--text);">Today</div>
              <div id="dash-nav-day" style="font-size:11px;color:var(--text-muted);">Feb 18</div>
            </div>
            <button onclick="changeDashDate(1)" id="dash-next-btn" style="background:none;border:none;color:var(--text-dim);font-size:18px;cursor:pointer;padding:0 4px;line-height:1;transition:color 0.15s;" onmouseover="this.style.color='var(--green)'" onmouseout="this.style.color='var(--text-dim)'">&#8250;</button>
          </div>
        </div>
      </div>

      <!-- "Viewing past day" banner -->
      <div id="dash-past-banner" style="display:none;background:rgba(250,204,21,0.08);border:1px solid rgba(250,204,21,0.2);border-radius:var(--radius);padding:10px 16px;margin-bottom:16px;font-size:13px;color:var(--accent);display:none;align-items:center;justify-content:space-between;">
        <span>&#128337; Viewing a past day&#39;s metrics</span>
        <button onclick="jumpDashToday()" style="background:none;border:1px solid rgba(250,204,21,0.3);border-radius:6px;padding:4px 10px;color:var(--accent);font-size:12px;cursor:pointer;font-family:'DM Sans',sans-serif;">Back to Today</button>
      </div>

      <!-- Nutrition stat cards -->
      <div class="stats-grid" style="margin-top:16px;">
        <div class="stat-card calories">
          <div><span class="stat-value" id="d-cals">0</span><span class="stat-unit">kcal</span></div>
          <div class="stat-label">Calories</div>
          <div class="stat-goal" id="d-cals-goal">Goal: 1800 kcal</div>
          <div class="stat-bar"><div class="stat-bar-fill" id="d-cals-bar" style="width:0%"></div></div>
        </div>
        <div class="stat-card protein">
          <div><span class="stat-value" id="d-protein">0</span><span class="stat-unit">g</span></div>
          <div class="stat-label">Protein</div>
          <div class="stat-goal" id="d-protein-goal">Goal: 120g</div>
          <div class="stat-bar"><div class="stat-bar-fill" id="d-protein-bar" style="width:0%"></div></div>
        </div>
        <div class="stat-card fat">
          <div><span class="stat-value" id="d-fat">0</span><span class="stat-unit">g</span></div>
          <div class="stat-label">Fat</div>
          <div class="stat-goal" id="d-fat-goal">Goal: 60g</div>
          <div class="stat-bar"><div class="stat-bar-fill" id="d-fat-bar" style="width:0%"></div></div>
        </div>
        <div class="stat-card carbs">
          <div><span class="stat-value" id="d-carbs">0</span><span class="stat-unit">g</span></div>
          <div class="stat-label">Carbs</div>
          <div class="stat-goal" id="d-carbs-goal">Goal: 200g</div>
          <div class="stat-bar"><div class="stat-bar-fill" id="d-carbs-bar" style="width:0%"></div></div>
        </div>
      </div>

      <!-- Food summary card -->
      <div class="card" style="margin-bottom:16px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
          <div class="card-title" style="margin-bottom:0;">&#127829; Food Log</div>
          <button class="btn btn-outline btn-sm" onclick="navigate('food-log')">Log Food &#43;</button>
        </div>
        <div id="dash-food-summary" style="color:var(--text-dim); font-size:14px;">No food logged. Head to the Food Log tab to get started!</div>
      </div>

      <!-- Workout summary card -->
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
          <div class="card-title" style="margin-bottom:0;">&#127947; Workout Summary</div>
          <button class="btn btn-outline btn-sm" onclick="navigate('workout-log')">Log Workout &#43;</button>
        </div>
        <div id="dash-workout-summary">
          <div style="color:var(--text-dim);font-size:14px;">No workouts logged. Head to the Workout Log tab!</div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ FOOD LOG ‚îÄ‚îÄ -->
    <div class="page" id="page-food-log">
      <div class="page-title">Food Log</div>
      <div class="page-sub">Search any food or packaged product, or scan a barcode</div>

      <div class="date-bar">
        <div class="date-nav">
          <button onclick="changeLogDate(-1)">‚Äπ</button>
          <button onclick="changeLogDate(1)">‚Ä∫</button>
        </div>
        <div class="date-label" id="log-date-label">Today</div>
      </div>

      <!-- SEARCH BAR -->
      <div class="food-search-bar">
        <div style="position:relative; flex:1;">
          <input type="text" id="food-search-input" placeholder="Search any food or packaged product..." oninput="onFoodSearch(this.value)" onkeydown="if(event.key==='Enter') doFoodSearch()" autocomplete="off">
          <div id="search-spinner" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);display:none;"><div class="spinner"></div></div>
        </div>
        <button class="btn btn-primary" onclick="doFoodSearch()">Search</button>
        <button class="btn btn-outline" onclick="openScanner()" title="Scan Barcode" style="padding:13px 16px;font-size:20px;line-height:1;">&#128247;</button>
        <button class="btn btn-outline" onclick="openManualEntry()" title="Log Manually" style="padding:13px 16px;font-size:13px;font-weight:600;white-space:nowrap;">&#9997;&#65039; Manual</button>
      </div>

      <!-- SEARCH SOURCE TOGGLE -->
      <div style="display:flex;gap:8px;margin-bottom:20px;margin-top:-4px;flex-wrap:wrap;">
        <button class="src-btn src-active" id="src-both" onclick="setSearchSource('both')">&#127775; All Foods</button>
        <button class="src-btn" id="src-packaged" onclick="setSearchSource('packaged')">&#128230; Packaged Products (Open Food Facts)</button>
        <button class="src-btn" id="src-local" onclick="setSearchSource('local')">&#129367; Basic Foods (offline)</button>
      </div>

      <!-- SEARCH RESULTS DROPDOWN -->
      <div class="search-results" style="margin-bottom:24px;position:relative;">
        <div id="search-dropdown" class="search-dropdown" style="display:none;"></div>
      </div>

      <!-- BARCODE SCANNER PANEL -->
      <div id="scanner-panel" style="display:none;margin-bottom:24px;">
        <div class="card" style="padding:0;overflow:hidden;">
          <div style="background:var(--surface2);padding:16px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);">
            <div>
              <div style="font-weight:600;font-size:15px;">&#128247; Barcode Scanner</div>
              <div style="font-size:12px;color:var(--text-dim);margin-top:2px;">Point camera at any product barcode to instantly get nutrition info</div>
            </div>
            <button class="btn btn-outline btn-sm" onclick="closeScanner()">&#10005; Close</button>
          </div>
          <div style="position:relative;background:#000;min-height:260px;display:flex;align-items:center;justify-content:center;">
            <video id="scanner-video" style="width:100%;max-height:320px;display:block;object-fit:cover;" playsinline autoplay muted></video>
            <canvas id="scanner-canvas" style="display:none;"></canvas>
            <div style="position:absolute;inset:0;pointer-events:none;display:flex;align-items:center;justify-content:center;">
              <div style="width:260px;height:130px;border:3px solid var(--green);border-radius:12px;box-shadow:0 0 0 9999px rgba(0,0,0,0.5);position:relative;">
                <div style="position:absolute;top:-3px;left:-3px;width:28px;height:28px;border-top:5px solid var(--green);border-left:5px solid var(--green);border-radius:5px 0 0 0;"></div>
                <div style="position:absolute;top:-3px;right:-3px;width:28px;height:28px;border-top:5px solid var(--green);border-right:5px solid var(--green);border-radius:0 5px 0 0;"></div>
                <div style="position:absolute;bottom:-3px;left:-3px;width:28px;height:28px;border-bottom:5px solid var(--green);border-left:5px solid var(--green);border-radius:0 0 0 5px;"></div>
                <div style="position:absolute;bottom:-3px;right:-3px;width:28px;height:28px;border-bottom:5px solid var(--green);border-right:5px solid var(--green);border-radius:0 0 5px 0;"></div>
                <div id="scan-line" style="position:absolute;left:8px;right:8px;height:2px;background:linear-gradient(90deg,transparent,var(--green),transparent);top:50%;animation:scanline 2s ease-in-out infinite;"></div>
              </div>
            </div>
          </div>
          <div id="scanner-status" style="padding:14px 20px;font-size:13px;color:var(--text-dim);text-align:center;min-height:48px;display:flex;align-items:center;justify-content:center;gap:8px;border-top:1px solid var(--border);">
            <div class="spinner"></div> Requesting camera access...
          </div>
          <div style="padding:0 20px 20px;">
            <div style="font-size:12px;color:var(--text-muted);margin:0 0 8px;">Can't scan? Enter barcode number manually:</div>
            <div style="display:flex;gap:8px;">
              <input type="number" id="manual-barcode" placeholder="e.g. 036800379442" style="flex:1;" onkeydown="if(event.key==='Enter') lookupBarcode(this.value)">
              <button class="btn btn-outline btn-sm" onclick="lookupBarcode(document.getElementById('manual-barcode').value)">Look Up</button>
            </div>
          </div>
        </div>
      </div>

      <!-- MEALS -->
      <div id="meals-container">
        <div class="meal-section">
          <div class="meal-header">
            <span class="meal-label">üåÖ Breakfast</span>
            <span class="meal-cals" id="meal-cal-breakfast">0 kcal</span>
          </div>
          <div id="meal-breakfast" class="food-empty">Nothing logged yet</div>
        </div>
        <div class="meal-section">
          <div class="meal-header">
            <span class="meal-label">‚òÄÔ∏è Lunch</span>
            <span class="meal-cals" id="meal-cal-lunch">0 kcal</span>
          </div>
          <div id="meal-lunch" class="food-empty">Nothing logged yet</div>
        </div>
        <div class="meal-section">
          <div class="meal-header">
            <span class="meal-label">üåô Dinner</span>
            <span class="meal-cals" id="meal-cal-dinner">0 kcal</span>
          </div>
          <div id="meal-dinner" class="food-empty">Nothing logged yet</div>
        </div>
        <div class="meal-section">
          <div class="meal-header">
            <span class="meal-label">üçé Snacks</span>
            <span class="meal-cals" id="meal-cal-snack">0 kcal</span>
          </div>
          <div id="meal-snack" class="food-empty">Nothing logged yet</div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ WORKOUT LOG ‚îÄ‚îÄ -->
    <div class="page" id="page-workout-log">
      <div class="page-title">Workout Log</div>
      <div class="page-sub">Track your exercises, sets, reps, and weights</div>

      <div class="date-bar">
        <div class="date-nav">
          <button onclick="changeWorkoutDate(-1)">‚Äπ</button>
          <button onclick="changeWorkoutDate(1)">‚Ä∫</button>
        </div>
        <div class="date-label" id="workout-date-label">Today</div>
      </div>

      <!-- START WORKOUT BUTTON -->
      <div style="display:flex;gap:12px;margin-bottom:24px;flex-wrap:wrap;align-items:center;">
        <button class="btn btn-primary" onclick="openAddWorkout()">Ôºã Log New Workout</button>
        <div id="workout-streak" style="font-size:13px;color:var(--text-dim);"></div>
      </div>

      <!-- WORKOUTS FOR THE DAY -->
      <div id="workout-sessions-container">
        <div id="workout-empty-state" style="text-align:center;padding:48px 20px;color:var(--text-muted);font-size:14px;border:1px dashed var(--border);border-radius:var(--radius-lg);">
          <div style="font-size:40px;margin-bottom:12px;">üèãÔ∏è</div>
          <div style="font-weight:600;margin-bottom:6px;color:var(--text-dim);">No workouts logged today</div>
          <div>Click "Log New Workout" to get started</div>
        </div>
      </div>

      <!-- WORKOUT HISTORY SUMMARY -->
      <div id="workout-history-card" style="display:none;margin-top:32px;">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
            <div class="card-title" style="margin-bottom:0;">üìÖ Recent Workouts</div>
            <button class="btn btn-outline btn-sm" onclick="navigate('workout-history')">View All ‚Üí</button>
          </div>
          <div id="workout-recent-list"></div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ WORKOUT HISTORY ‚îÄ‚îÄ -->
    <div class="page" id="page-workout-history">
      <div class="page-title">Workout History</div>
      <div class="page-sub">All your logged workouts over time</div>
      <div style="margin-bottom:20px;display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn btn-outline btn-sm" onclick="navigate('workout-log')">‚Üê Back</button>
        <button class="btn btn-outline btn-sm" onclick="exportWorkoutCSV()">‚¨á Export CSV</button>
      </div>
      <div id="workout-history-full"></div>
    </div>

    <!-- ‚îÄ‚îÄ MEAL IDEAS ‚îÄ‚îÄ -->
    <div class="page" id="page-meal-ideas">
      <div class="page-title">üßë‚Äçüç≥ Meal Ideas</div>
      <div class="page-sub">Tell Claude what's in your fridge & cupboards ‚Äî get personalised meal ideas based on your goals</div>

      <!-- API key warning (shown if no key saved) -->
      <div id="mi-no-key-warning" style="display:none;margin-bottom:16px;">
        <div class="api-key-note">
          üîë You need an Anthropic API key to use this feature. <button class="btn btn-outline btn-sm" style="margin-left:8px;" onclick="navigate('ai-plan')">Add Key ‚Üí</button>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;" id="mi-input-grid">

        <!-- Fridge -->
        <div class="card">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
            <span style="font-size:22px;">üßä</span>
            <div class="card-title" style="margin-bottom:0;">Fridge / Freezer</div>
          </div>
          <div class="ingredient-chip-row" id="fridge-chips"></div>
          <div style="display:flex;gap:8px;">
            <input type="text" id="fridge-input" placeholder="e.g. chicken breast, eggs..." style="flex:1;font-size:13px;" onkeydown="if(event.key==='Enter')addIngredient('fridge')">
            <button class="btn btn-outline btn-sm" onclick="addIngredient('fridge')">Ôºã Add</button>
          </div>
          <div class="quick-add-grid" style="margin-top:12px;">
            <button class="quick-add-btn" onclick="quickAdd('fridge','ü•ö Eggs')">ü•ö Eggs</button>
            <button class="quick-add-btn" onclick="quickAdd('fridge','üçó Chicken')">üçó Chicken</button>
            <button class="quick-add-btn" onclick="quickAdd('fridge','ü•© Ground Beef')">ü•© Ground Beef</button>
            <button class="quick-add-btn" onclick="quickAdd('fridge','üêü Salmon')">üêü Salmon</button>
            <button class="quick-add-btn" onclick="quickAdd('fridge','ü•õ Milk')">ü•õ Milk</button>
            <button class="quick-add-btn" onclick="quickAdd('fridge','üßÄ Cheese')">üßÄ Cheese</button>
            <button class="quick-add-btn" onclick="quickAdd('fridge','ü•¶ Broccoli')">ü•¶ Broccoli</button>
            <button class="quick-add-btn" onclick="quickAdd('fridge','ü•¨ Spinach')">ü•¨ Spinach</button>
            <button class="quick-add-btn" onclick="quickAdd('fridge','üçÖ Tomatoes')">üçÖ Tomatoes</button>
            <button class="quick-add-btn" onclick="quickAdd('fridge','ü´ë Bell Pepper')">ü´ë Bell Pepper</button>
            <button class="quick-add-btn" onclick="quickAdd('fridge','ü•ï Carrots')">ü•ï Carrots</button>
            <button class="quick-add-btn" onclick="quickAdd('fridge','üßÖ Onion')">üßÖ Onion</button>
          </div>
        </div>

        <!-- Cupboard -->
        <div class="card">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
            <span style="font-size:22px;">üóÑÔ∏è</span>
            <div class="card-title" style="margin-bottom:0;">Cupboard / Pantry</div>
          </div>
          <div class="ingredient-chip-row" id="cupboard-chips"></div>
          <div style="display:flex;gap:8px;">
            <input type="text" id="cupboard-input" placeholder="e.g. rice, olive oil..." style="flex:1;font-size:13px;" onkeydown="if(event.key==='Enter')addIngredient('cupboard')">
            <button class="btn btn-outline btn-sm" onclick="addIngredient('cupboard')">Ôºã Add</button>
          </div>
          <div class="quick-add-grid" style="margin-top:12px;">
            <button class="quick-add-btn" onclick="quickAdd('cupboard','üçö Rice')">üçö Rice</button>
            <button class="quick-add-btn" onclick="quickAdd('cupboard','üçù Pasta')">üçù Pasta</button>
            <button class="quick-add-btn" onclick="quickAdd('cupboard','ü•´ Canned Tuna')">ü•´ Canned Tuna</button>
            <button class="quick-add-btn" onclick="quickAdd('cupboard','ü´ò Black Beans')">ü´ò Black Beans</button>
            <button class="quick-add-btn" onclick="quickAdd('cupboard','ü•ú Peanut Butter')">ü•ú Peanut Butter</button>
            <button class="quick-add-btn" onclick="quickAdd('cupboard','üåæ Oats')">üåæ Oats</button>
            <button class="quick-add-btn" onclick="quickAdd('cupboard','ü´ô Olive Oil')">ü´ô Olive Oil</button>
            <button class="quick-add-btn" onclick="quickAdd('cupboard','üßÑ Garlic')">üßÑ Garlic</button>
            <button class="quick-add-btn" onclick="quickAdd('cupboard','üçû Bread')">üçû Bread</button>
            <button class="quick-add-btn" onclick="quickAdd('cupboard','üåΩ Corn')">üåΩ Corn</button>
            <button class="quick-add-btn" onclick="quickAdd('cupboard','ü•£ Protein Powder')">ü•£ Protein Powder</button>
            <button class="quick-add-btn" onclick="quickAdd('cupboard','üßÇ Spices')">üßÇ Spices</button>
          </div>
        </div>
      </div>

      <!-- Preferences row -->
      <div class="card" style="margin-bottom:20px;">
        <div class="card-title">‚öôÔ∏è Meal Preferences</div>
        <div class="ai-form-grid">
          <div class="form-group">
            <label>Meal Type</label>
            <select id="mi-meal-type">
              <option value="any">Any / All</option>
              <option value="breakfast">Breakfast</option>
              <option value="lunch">Lunch</option>
              <option value="dinner">Dinner</option>
              <option value="snack">Snack / Post-workout</option>
            </select>
          </div>
          <div class="form-group">
            <label>Number of Ideas</label>
            <select id="mi-count">
              <option value="3">3 meals</option>
              <option value="5" selected>5 meals</option>
              <option value="7">7 meals</option>
            </select>
          </div>
          <div class="form-group">
            <label>Dietary Restrictions</label>
            <input type="text" id="mi-restrictions" placeholder="e.g. no dairy, gluten-free, low-carb">
          </div>
          <div class="form-group">
            <label>Max Prep Time</label>
            <select id="mi-time">
              <option value="any">No limit</option>
              <option value="15">Under 15 mins</option>
              <option value="30" selected>Under 30 mins</option>
              <option value="60">Under 1 hour</option>
            </select>
          </div>
        </div>
        <div class="form-group" style="margin-bottom:0;">
          <label>Additional Notes <span style="font-size:11px;font-weight:400;color:var(--text-muted);">(optional)</span></label>
          <input type="text" id="mi-notes" placeholder="e.g. I want something high protein, I hate mushrooms, keep it simple...">
        </div>
      </div>

      <!-- Generate button -->
      <button class="btn btn-primary btn-full" id="mi-gen-btn" onclick="generateMealIdeas()" style="font-size:15px;padding:16px;margin-bottom:24px;">
        ‚ú® Generate Meal Ideas from My Ingredients
      </button>

      <!-- Results area -->
      <div id="mi-results" style="display:none;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px;">
          <div class="card-title" style="margin-bottom:0;">üçΩÔ∏è Your Personalised Meal Ideas</div>
          <div style="display:flex;gap:8px;">
            <button class="btn btn-outline btn-sm" onclick="saveMealIdeasToRecipes()">üìñ Save All to Recipes</button>
            <button class="btn btn-outline btn-sm" onclick="generateMealIdeas()">üîÑ Regenerate</button>
          </div>
        </div>
        <div id="mi-results-content"></div>
      </div>

      <!-- Empty state -->
      <div id="mi-empty-state" style="text-align:center;padding:48px 20px;color:var(--text-muted);">
        <div style="font-size:48px;margin-bottom:12px;">üßë‚Äçüç≥</div>
        <div style="font-weight:600;color:var(--text-dim);margin-bottom:6px;">Add ingredients to get started</div>
        <div style="font-size:13px;">Enter what's in your fridge and cupboards above, then hit Generate</div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ AI PLAN ‚îÄ‚îÄ -->
    <div class="page" id="page-ai-plan">
      <div class="page-title">AI Fitness Plan</div>
      <div class="page-sub">Generate a personalized workout & diet plan powered by Claude AI</div>

      <div class="api-key-note">
        ü§ñ <strong>Powered by Claude AI (Anthropic)</strong> ‚Äî Enter your Anthropic API key below to generate your plan. Your key is stored only in your browser and never shared. New accounts include free credits.
      </div>

      <!-- HOW TO GET YOUR API KEY -->
      <div class="card" style="margin-bottom:24px;">
        <div class="card-title">üîë How to Get Your Claude AI (Anthropic) API Key</div>
        <div class="sheets-step">
          <div class="step-num">1</div>
          <div class="step-content">
            <h4>Create a free Anthropic account</h4>
            <p>Go to <a href="https://console.anthropic.com" target="_blank" style="color:var(--green);text-underline-offset:3px;">console.anthropic.com</a> and sign up with your email address. This is the Anthropic developer console ‚Äî different from Claude.ai chat.</p>
          </div>
        </div>
        <div class="sheets-step">
          <div class="step-num">2</div>
          <div class="step-content">
            <h4>Go to the API Keys page</h4>
            <p>Once logged in, click <strong>"API Keys"</strong> in the left sidebar ‚Äî or go directly to <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color:var(--green);text-underline-offset:3px;">console.anthropic.com/settings/keys</a>.</p>
          </div>
        </div>
        <div class="sheets-step">
          <div class="step-num">3</div>
          <div class="step-content">
            <h4>Create a new API key</h4>
            <p>Click <strong>"Create Key"</strong>, give it a name like <code>Chingone Life Tracker</code>, and click Create. <strong>Important:</strong> copy the key immediately ‚Äî it starts with <code>sk-ant-</code> and Anthropic will only show it once!</p>
          </div>
        </div>
        <div class="sheets-step">
          <div class="step-num">4</div>
          <div class="step-content">
            <h4>Add billing credits (if needed)</h4>
            <p>New accounts include free credits to try it out. If yours run out, go to <strong>Settings ‚Üí Billing</strong> and add a small amount ‚Äî even $5 goes a very long way since each plan generation costs just fractions of a cent.</p>
          </div>
        </div>
        <div class="sheets-step" style="border-bottom:none;">
          <div class="step-num">5</div>
          <div class="step-content">
            <h4>Paste your key below</h4>
            <p>Copy your key (it starts with <code>sk-ant-</code>) and paste it into the field below, then click <strong>Save Key</strong>. You only need to do this once per device.</p>
          </div>
        </div>
      </div>

      <div class="card" style="margin-bottom:24px;">
        <div class="card-title">Anthropic (Claude) API Key</div>
        <div style="display:flex;gap:10px;">
          <input type="password" id="openai-key" placeholder="sk-ant-..." style="flex:1;">
          <button class="btn btn-outline" onclick="saveApiKey()">Save Key</button>
        </div>
        <div class="success-msg" id="key-saved" style="display:none;">‚úì Key saved!</div>
      </div>

      <div class="card">
        <div class="card-title">Your Stats & Goals</div>
        <div class="ai-form-grid">
          <div class="form-group">
            <label>Age</label>
            <input type="number" id="ai-age" placeholder="25">
          </div>
          <div class="form-group">
            <label>Gender</label>
            <select id="ai-gender">
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>Height (inches)</label>
            <input type="number" id="ai-height" placeholder="68">
          </div>
          <div class="form-group">
            <label>Weight (lbs)</label>
            <input type="number" id="ai-weight" placeholder="160">
          </div>
          <div class="form-group">
            <label>Activity Level</label>
            <select id="ai-activity">
              <option value="sedentary">Sedentary (desk job, no exercise)</option>
              <option value="light">Lightly active (1-2 days/week)</option>
              <option value="moderate">Moderately active (3-4 days/week)</option>
              <option value="very">Very active (5-6 days/week)</option>
              <option value="extreme">Extremely active (daily intense)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Primary Goal</label>
            <select id="ai-goal">
              <option value="lose weight">Lose Weight</option>
              <option value="build muscle">Build Muscle</option>
              <option value="maintain weight">Maintain Weight</option>
              <option value="improve endurance">Improve Endurance</option>
              <option value="improve overall fitness">Improve Overall Fitness</option>
            </select>
          </div>
          <div class="form-group">
            <label>Target Weight (lbs, optional)</label>
            <input type="number" id="ai-target" placeholder="150">
          </div>
          <div class="form-group">
            <label>Timeframe</label>
            <select id="ai-timeframe">
              <option value="4 weeks">4 Weeks</option>
              <option value="8 weeks">8 Weeks</option>
              <option value="12 weeks">12 Weeks</option>
              <option value="6 months">6 Months</option>
            </select>
          </div>
          <div class="form-group full">
            <label>Any injuries, dietary restrictions, or preferences?</label>
            <textarea id="ai-notes" placeholder="e.g. bad knees, vegetarian, no gym equipment..." rows="2"></textarea>
          </div>
          <div class="form-group full" style="margin-top:4px;">
            <label style="display:flex;align-items:center;gap:8px;">
              <span>üéØ Describe Your Personal Goals</span>
              <span style="font-size:11px;color:var(--text-muted);font-weight:400;text-transform:none;letter-spacing:0;">‚Äî the more detail, the better your plan</span>
            </label>
            <textarea id="ai-custom-goals" rows="5" placeholder="Tell Claude AI exactly what you want to achieve in your own words. For example:&#10;&#10;‚Ä¢ I want to be more muscular with visible abs&#10;‚Ä¢ I want to increase my cardio endurance for a 5K&#10;‚Ä¢ I am training for an Ironman triathlon in 6 months&#10;‚Ä¢ I want to lose my belly fat and tone my arms&#10;‚Ä¢ I want to build functional strength for hiking&#10;&#10;Be as specific as you like ‚Äî no goal is too big!"></textarea>
            <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px;" id="goal-chips">
              <span style="font-size:11px;color:var(--text-muted);align-self:center;margin-right:2px;">Quick add:</span>
              <button type="button" class="goal-chip" onclick="addGoalChip(this)">üí™ Be more muscular</button>
              <button type="button" class="goal-chip" onclick="addGoalChip(this)">üèÉ Increase cardio</button>
              <button type="button" class="goal-chip" onclick="addGoalChip(this)">üèä Train for an Ironman</button>
              <button type="button" class="goal-chip" onclick="addGoalChip(this)">üî• Lose belly fat</button>
              <button type="button" class="goal-chip" onclick="addGoalChip(this)">üßò Improve flexibility</button>
              <button type="button" class="goal-chip" onclick="addGoalChip(this)">‚ö° Boost energy levels</button>
              <button type="button" class="goal-chip" onclick="addGoalChip(this)">üèãÔ∏è Build functional strength</button>
              <button type="button" class="goal-chip" onclick="addGoalChip(this)">üö¥ Train for a marathon</button>
              <button type="button" class="goal-chip" onclick="addGoalChip(this)">ü§∏ Tone and define arms</button>
              <button type="button" class="goal-chip" onclick="addGoalChip(this)">üò¥ Improve sleep & recovery</button>
            </div>
          </div>
        </div>
        <button class="btn btn-accent" id="gen-plan-btn" onclick="generatePlan()">‚ú® Generate My Plan</button>
        <div id="plan-output" class="plan-output" style="display:none;"></div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ RECIPES ‚îÄ‚îÄ -->
    <div class="page" id="page-recipes">
      <div class="page-title">Community Recipes</div>
      <div class="page-sub">Healthy recipes shared by everyone in your group</div>

      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px;">
        <div class="recipes-search-bar" style="flex:1;min-width:200px;margin-bottom:0;">
          <input type="text" id="recipe-search" placeholder="Search recipes..." oninput="renderRecipes()" autocomplete="off" style="flex:1;">
        </div>
        <button class="btn btn-primary" onclick="openAddRecipe()">Ôºã Share a Recipe</button>
      </div>

      <div class="recipes-filter-row">
        <button class="filter-chip active" data-cat="all" onclick="setRecipeFilter(this,'all')">üçΩÔ∏è All</button>
        <button class="filter-chip" data-cat="breakfast" onclick="setRecipeFilter(this,'breakfast')">üåÖ Breakfast</button>
        <button class="filter-chip" data-cat="lunch" onclick="setRecipeFilter(this,'lunch')">‚òÄÔ∏è Lunch</button>
        <button class="filter-chip" data-cat="dinner" onclick="setRecipeFilter(this,'dinner')">üåô Dinner</button>
        <button class="filter-chip" data-cat="snack" onclick="setRecipeFilter(this,'snack')">üçé Snack</button>
        <button class="filter-chip" data-cat="smoothie" onclick="setRecipeFilter(this,'smoothie')">ü•§ Smoothie</button>
        <button class="filter-chip" data-cat="dessert" onclick="setRecipeFilter(this,'dessert')">üçì Dessert</button>
      </div>

      <div id="recipe-grid" class="recipe-grid"></div>
      <div id="recipe-empty" class="recipe-empty" style="display:none;">
        <div class="recipe-empty-icon">üë®‚Äçüç≥</div>
        <div style="font-weight:600;color:var(--text-dim);margin-bottom:6px;">No recipes yet</div>
        <div>Be the first to share a healthy recipe with the group!</div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ -->
    <div class="page" id="page-history">
      <div class="page-title">Food History</div>
      <div class="page-sub">All your logged meals across all days</div>
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
          <div class="card-title" style="margin-bottom:0">Log History</div>
          <button class="btn btn-outline btn-sm" onclick="exportCSV()">‚¨á Export CSV</button>
        </div>
        <div class="table-wrap">
          <table id="history-table">
            <thead>
              <tr><th>Date</th><th>Meal</th><th>Food</th><th>Qty</th><th>Calories</th><th>Protein</th><th>Carbs</th><th>Fat</th></tr>
            </thead>
            <tbody id="history-tbody"></tbody>
          </table>
        </div>
        <div id="history-empty" style="text-align:center;color:var(--text-muted);padding:32px;font-size:14px;">No history yet. Start logging your food!</div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ IMPORT DATA ‚îÄ‚îÄ -->
    <div class="page" id="page-import">
      <div class="page-title">Import Health Data</div>
      <div class="page-sub">Bring in your history from Fitbit, MyFitnessPal, or Apple Health</div>

      <!-- Platform tabs -->
      <div class="import-source-tabs">
        <button class="import-tab active" onclick="switchImportTab('fitbit',this)">
          <span class="tab-icon">‚åö</span> Fitbit
        </button>
        <button class="import-tab" onclick="switchImportTab('mfp',this)">
          <span class="tab-icon">ü•ó</span> MyFitnessPal
        </button>
        <button class="import-tab" onclick="switchImportTab('apple',this)">
          <span class="tab-icon">üçé</span> Apple Health
        </button>
        <button class="import-tab" onclick="switchImportTab('csv',this)">
          <span class="tab-icon">üìÑ</span> Generic CSV
        </button>
      </div>

      <!-- ‚îÄ‚îÄ FITBIT PANEL ‚îÄ‚îÄ -->
      <div class="platform-panel active" id="import-panel-fitbit">
        <div class="card" style="margin-bottom:20px;">
          <div class="card-title">‚åö How to Export from Fitbit</div>
          <div class="import-step">
            <div class="import-step-num">1</div>
            <div class="import-step-body">
              <h4>Go to your Fitbit Dashboard</h4>
              <p>Open a browser and go to <a href="https://www.fitbit.com/settings/data/export" target="_blank" style="color:var(--green);">fitbit.com/settings/data/export</a> and log in to your account.</p>
            </div>
          </div>
          <div class="import-step">
            <div class="import-step-num">2</div>
            <div class="import-step-body">
              <h4>Request your data export</h4>
              <p>Click <strong>"Export Account Archive"</strong>. Fitbit will email you a ZIP file ‚Äî this can take up to 24 hours. Once you get the email, download and unzip it.</p>
            </div>
          </div>
          <div class="import-step">
            <div class="import-step-num">3</div>
            <div class="import-step-body">
              <h4>Find the food log CSV</h4>
              <p>Inside the ZIP, open the <code>Foods</code> folder. Look for files named <code>food_log_YYYY-MM-DD.csv</code> ‚Äî these contain your logged meals. You can also find <code>activities</code> CSVs in the <code>Activities</code> folder for workout history.</p>
            </div>
          </div>
          <div class="import-step">
            <div class="import-step-num">4</div>
            <div class="import-step-body">
              <h4>Upload your CSV files below</h4>
              <p>Upload one or more Fitbit CSV files. The app will automatically detect whether it's food or activity data and import it into your history.</p>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Upload Fitbit Export Files</div>
          <div class="drop-zone" id="dz-fitbit" onclick="document.getElementById('file-fitbit').click()" ondragover="handleDragOver(event,'fitbit')" ondragleave="handleDragLeave('fitbit')" ondrop="handleDrop(event,'fitbit','fitbit')">
            <div class="drop-zone-icon">üìÇ</div>
            <div class="drop-zone-title">Drop CSV files here or click to browse</div>
            <div class="drop-zone-sub">Supports food_log_*.csv and exercise_*.csv files</div>
          </div>
          <input type="file" id="file-fitbit" accept=".csv,.json" multiple style="display:none" onchange="handleFileSelect(event,'fitbit')">
          <div id="import-preview-fitbit"></div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ MYFITNESSPAL PANEL ‚îÄ‚îÄ -->
      <div class="platform-panel" id="import-panel-mfp">
        <div class="card" style="margin-bottom:20px;">
          <div class="card-title">ü•ó How to Export from MyFitnessPal</div>
          <div class="import-step">
            <div class="import-step-num">1</div>
            <div class="import-step-body">
              <h4>Open MyFitnessPal on desktop</h4>
              <p>Go to <a href="https://www.myfitnesspal.com" target="_blank" style="color:var(--green);">myfitnesspal.com</a> in a browser and log in. Data export is only available on the website, not the mobile app.</p>
            </div>
          </div>
          <div class="import-step">
            <div class="import-step-num">2</div>
            <div class="import-step-body">
              <h4>Navigate to Export</h4>
              <p>Click your profile name ‚Üí <strong>My Account</strong> ‚Üí <strong>Export Data</strong>. Or go directly to <a href="https://www.myfitnesspal.com/account/export" target="_blank" style="color:var(--green);">myfitnesspal.com/account/export</a>. Note: this feature requires a <strong>Premium</strong> account.</p>
            </div>
          </div>
          <div class="import-step">
            <div class="import-step-num">3</div>
            <div class="import-step-body">
              <h4>Download your nutrition export</h4>
              <p>Select a date range and click <strong>"Export to CSV"</strong>. You'll get a file called <code>Nutrition Summary.csv</code> or <code>Nutrition Details.csv</code>. Both are supported.</p>
            </div>
          </div>
          <div class="import-step">
            <div class="import-step-num">4</div>
            <div class="import-step-body">
              <h4>Upload below</h4>
              <p>Drop your exported CSV into the upload area. The app will parse your daily calorie and macro totals into your food history.</p>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Upload MyFitnessPal CSV</div>
          <div class="drop-zone" id="dz-mfp" onclick="document.getElementById('file-mfp').click()" ondragover="handleDragOver(event,'mfp')" ondragleave="handleDragLeave('mfp')" ondrop="handleDrop(event,'mfp','mfp')">
            <div class="drop-zone-icon">üìÇ</div>
            <div class="drop-zone-title">Drop CSV file here or click to browse</div>
            <div class="drop-zone-sub">Supports Nutrition Summary.csv and Nutrition Details.csv</div>
          </div>
          <input type="file" id="file-mfp" accept=".csv" multiple style="display:none" onchange="handleFileSelect(event,'mfp')">
          <div id="import-preview-mfp"></div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ APPLE HEALTH PANEL ‚îÄ‚îÄ -->
      <div class="platform-panel" id="import-panel-apple">
        <div class="card" style="margin-bottom:20px;">
          <div class="card-title">üçé How to Export from Apple Health</div>
          <div class="import-step">
            <div class="import-step-num">1</div>
            <div class="import-step-body">
              <h4>Open the Health app on your iPhone</h4>
              <p>Go to the <strong>Health</strong> app (white icon with a red heart). Make sure you're on iOS 12 or later.</p>
            </div>
          </div>
          <div class="import-step">
            <div class="import-step-num">2</div>
            <div class="import-step-body">
              <h4>Export your data</h4>
              <p>Tap your profile picture in the top-right ‚Üí scroll down ‚Üí tap <strong>"Export All Health Data"</strong> ‚Üí tap <strong>"Export"</strong> to confirm. This creates a ZIP file.</p>
            </div>
          </div>
          <div class="import-step">
            <div class="import-step-num">3</div>
            <div class="import-step-body">
              <h4>Transfer the ZIP to your computer</h4>
              <p>Share the ZIP to your computer via AirDrop, email, or iCloud Drive. Once on your computer, unzip it ‚Äî you'll find a file called <code>export.xml</code> inside the <code>apple_health_export</code> folder.</p>
            </div>
          </div>
          <div class="import-step">
            <div class="import-step-num">4</div>
            <div class="import-step-body">
              <h4>Upload the XML file below</h4>
              <p>The app will parse your workout history (active calories, exercise minutes, steps) and any nutrition data logged through Health-connected apps.</p>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Upload Apple Health Export</div>
          <div class="drop-zone" id="dz-apple" onclick="document.getElementById('file-apple').click()" ondragover="handleDragOver(event,'apple')" ondragleave="handleDragLeave('apple')" ondrop="handleDrop(event,'apple','apple')">
            <div class="drop-zone-icon">üìÇ</div>
            <div class="drop-zone-title">Drop export.xml here or click to browse</div>
            <div class="drop-zone-sub">Supports Apple Health export.xml files</div>
          </div>
          <input type="file" id="file-apple" accept=".xml,.zip" multiple style="display:none" onchange="handleFileSelect(event,'apple')">
          <div id="import-preview-apple"></div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ GENERIC CSV PANEL ‚îÄ‚îÄ -->
      <div class="platform-panel" id="import-panel-csv">
        <div class="card" style="margin-bottom:20px;">
          <div class="card-title">üìÑ Import from any CSV</div>
          <p style="font-size:14px;color:var(--text-dim);line-height:1.7;margin-bottom:16px;">
            Upload any CSV file with health data. The app will try to auto-detect columns for date, calories, protein, carbs, fat, and workout data. You can also map columns manually after uploading.
          </p>
          <div style="background:var(--surface2);border-radius:var(--radius);padding:14px 16px;font-size:13px;color:var(--text-dim);">
            <div style="font-weight:600;margin-bottom:8px;color:var(--text);">Expected column names (any order, case-insensitive):</div>
            <div style="display:flex;flex-wrap:wrap;gap:6px;">
              <code style="background:var(--surface3);padding:3px 8px;border-radius:4px;font-family:'DM Mono',monospace;font-size:12px;color:var(--green);">date</code>
              <code style="background:var(--surface3);padding:3px 8px;border-radius:4px;font-family:'DM Mono',monospace;font-size:12px;color:var(--green);">calories</code>
              <code style="background:var(--surface3);padding:3px 8px;border-radius:4px;font-family:'DM Mono',monospace;font-size:12px;color:var(--green);">protein</code>
              <code style="background:var(--surface3);padding:3px 8px;border-radius:4px;font-family:'DM Mono',monospace;font-size:12px;color:var(--green);">carbs / carbohydrates</code>
              <code style="background:var(--surface3);padding:3px 8px;border-radius:4px;font-family:'DM Mono',monospace;font-size:12px;color:var(--green);">fat</code>
              <code style="background:var(--surface3);padding:3px 8px;border-radius:4px;font-family:'DM Mono',monospace;font-size:12px;color:var(--green);">meal / type</code>
              <code style="background:var(--surface3);padding:3px 8px;border-radius:4px;font-family:'DM Mono',monospace;font-size:12px;color:var(--green);">food / name</code>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Upload CSV</div>
          <div class="drop-zone" id="dz-csv" onclick="document.getElementById('file-csv').click()" ondragover="handleDragOver(event,'csv')" ondragleave="handleDragLeave('csv')" ondrop="handleDrop(event,'csv','csv')">
            <div class="drop-zone-icon">üìÇ</div>
            <div class="drop-zone-title">Drop CSV here or click to browse</div>
            <div class="drop-zone-sub">Any CSV with date + nutrition/workout columns</div>
          </div>
          <input type="file" id="file-csv" accept=".csv" multiple style="display:none" onchange="handleFileSelect(event,'csv')">
          <div id="import-preview-csv"></div>
        </div>
      </div>

      <!-- Global import log -->
      <div id="import-log" style="margin-top:20px;display:none;">
        <div class="card">
          <div class="card-title">üìã Import Log</div>
          <div id="import-log-content" style="font-size:13px;font-family:'DM Mono',monospace;color:var(--text-dim);line-height:2;max-height:200px;overflow-y:auto;"></div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ GOOGLE SHEETS ‚îÄ‚îÄ -->
    <div class="page" id="page-sheets">
      <div class="page-title">Google Sheets Sync</div>
      <div class="page-sub">Automatically send your food log data to a Google Sheet for analysis & sharing</div>

      <div id="sheets-connected-banner" class="sheets-connected" style="display:none;">
        ‚úÖ Connected to Google Sheets! Data syncs automatically when you log food.
      </div>

      <div class="card" style="margin-bottom:24px;">
        <div class="card-title">Quick Export</div>
        <p style="font-size:14px;color:var(--text-dim);margin-bottom:16px;">Download all your data as a CSV file and import it directly into Google Sheets in seconds.</p>
        <button class="btn btn-primary" onclick="exportCSV()">‚¨á Download CSV Export</button>
      </div>

      <div class="card" style="margin-bottom:24px;">
        <div class="card-title">Google Sheets API Integration</div>
        <p style="font-size:14px;color:var(--text-dim);margin-bottom:20px;">Set up automatic syncing so every food entry is instantly recorded in your Google Sheet. Follow these steps:</p>
        
        <div class="sheets-step">
          <div class="step-num">1</div>
          <div class="step-content">
            <h4>Create a Google Cloud Project</h4>
            <p>Go to <strong>console.cloud.google.com</strong>, create a new project, then enable the <strong>Google Sheets API</strong> and <strong>Google Drive API</strong> under APIs & Services ‚Üí Library.</p>
          </div>
        </div>
        <div class="sheets-step">
          <div class="step-num">2</div>
          <div class="step-content">
            <h4>Create OAuth 2.0 Credentials</h4>
            <p>Go to APIs & Services ‚Üí Credentials ‚Üí Create Credentials ‚Üí <strong>OAuth 2.0 Client ID</strong>. Select "Web Application." Add your app's domain to the Authorized JavaScript Origins. Copy the <strong>Client ID</strong>.</p>
          </div>
        </div>
        <div class="sheets-step">
          <div class="step-num">3</div>
          <div class="step-content">
            <h4>Create Your Google Sheet</h4>
            <p>Create a new Google Sheet. Add this header row in Row 1: <code>Date, User, Meal, Food Name, Quantity, Calories, Protein(g), Carbs(g), Fat(g)</code>. Copy the <strong>Sheet ID</strong> from the URL.</p>
          </div>
        </div>
        <div class="sheets-step">
          <div class="step-num">4</div>
          <div class="step-content">
            <h4>Enter Your Credentials Below</h4>
            <p>Paste your OAuth Client ID and Sheet ID below. Click Connect, then authorize access with your Google account. All future food log entries will sync in real time.</p>
          </div>
        </div>

        <div class="divider"></div>

        <div class="ai-form-grid">
          <div class="form-group">
            <label>Google OAuth Client ID</label>
            <input type="text" id="goog-client-id" placeholder="123456789.apps.googleusercontent.com">
          </div>
          <div class="form-group">
            <label>Google Sheet ID</label>
            <input type="text" id="goog-sheet-id" placeholder="1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgVE2upms">
          </div>
        </div>
        <button class="btn btn-primary" onclick="connectGoogleSheets()">Connect to Google Sheets</button>
        <div class="success-msg" id="sheets-msg" style="margin-top:10px;">‚úì Connected! New food entries will sync automatically.</div>
        <div class="error-msg" id="sheets-err" style="margin-top:10px;">Please enter both Client ID and Sheet ID.</div>
      </div>

      <div class="card">
        <div class="card-title">Manual Sync</div>
        <p style="font-size:14px;color:var(--text-dim);margin-bottom:16px;">Push all your current data to Google Sheets now.</p>
        <button class="btn btn-outline" onclick="manualSyncSheets()">üîÑ Sync All Data to Sheets Now</button>
        <div class="success-msg" id="sync-msg" style="margin-top:10px;">‚úì All data synced to Google Sheets!</div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ -->
    <div class="page" id="page-profile">
      <div class="page-title">My Profile</div>
      <div class="page-sub">Manage your personal stats and goals</div>
      <div class="profile-grid">
        <div class="card">
          <div class="avatar-big" id="profile-avatar">S</div>
          <div class="form-group">
            <label>Full Name</label>
            <input type="text" id="profile-name">
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="profile-email">
          </div>
          <div class="form-group">
            <label>Age</label>
            <input type="number" id="profile-age">
          </div>
          <div class="form-group">
            <label>Gender</label>
            <select id="profile-gender">
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="other">Other</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
          <div class="success-msg" id="profile-saved" style="display:none;margin-top:8px;">‚úì Profile saved!</div>
        </div>
        <div>
          <div class="card" style="margin-bottom:16px;">
            <div class="card-title">Body Stats</div>
            <div class="ai-form-grid">
              <div class="form-group">
                <label>Height (inches)</label>
                <input type="number" id="profile-height">
              </div>
              <div class="form-group">
                <label>Weight (lbs)</label>
                <input type="number" id="profile-weight">
              </div>
            </div>
          </div>
          <div class="card" style="margin-bottom:16px;">
            <div class="card-title">Daily Nutrition Goals</div>
            <div class="ai-form-grid">
              <div class="form-group">
                <label>Calorie Goal</label>
                <input type="number" id="profile-cal-goal" placeholder="1800">
              </div>
              <div class="form-group">
                <label>Protein Goal (g)</label>
                <input type="number" id="profile-protein-goal" placeholder="120">
              </div>
              <div class="form-group">
                <label>Fat Goal (g)</label>
                <input type="number" id="profile-fat-goal" placeholder="60">
              </div>
              <div class="form-group">
                <label>Carbs Goal (g)</label>
                <input type="number" id="profile-carbs-goal" placeholder="200">
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-title">Primary Goal</div>
            <div class="form-group">
              <select id="profile-goal">
                <option value="lose_weight">Lose Weight</option>
                <option value="build_muscle">Build Muscle</option>
                <option value="maintain">Maintain Weight</option>
                <option value="improve_fitness">Improve Overall Fitness</option>
              </select>
            </div>
            <button class="btn btn-primary" onclick="saveProfile()">Save All</button>
          </div>

          <!-- WhatsApp Group Card -->
          <div class="card" style="border-color:rgba(37,211,102,0.3);">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px;">
              <span style="font-size:22px;">üí¨</span>
              <div class="card-title" style="margin-bottom:0;">WhatsApp Group Shortcut</div>
            </div>
            <p style="font-size:13px;color:var(--text-dim);margin-bottom:16px;line-height:1.6;">
              Paste your WhatsApp group invite link below. A shortcut button will appear in the sidebar so you can jump straight to the chat anytime.
            </p>
            <div class="form-group">
              <label>WhatsApp Group Link</label>
              <input type="url" id="profile-whatsapp" placeholder="https://chat.whatsapp.com/..." autocomplete="off">
              <div style="font-size:11px;color:var(--text-muted);margin-top:6px;">To get your link: open WhatsApp ‚Üí group chat ‚Üí group info ‚Üí Invite via link ‚Üí Copy link</div>
            </div>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
              <button class="btn btn-whatsapp" onclick="saveWhatsApp()">üíæ Save Link</button>
              <button class="btn btn-outline btn-sm" id="wa-test-btn" onclick="openWhatsApp()" style="display:none;">‚Üó Open Group</button>
              <button class="btn btn-outline btn-sm" id="wa-clear-btn" onclick="clearWhatsApp()" style="display:none;color:var(--red);border-color:rgba(248,113,113,0.3);">‚úï Remove</button>
            </div>
            <div class="success-msg" id="wa-saved" style="display:none;margin-top:10px;">‚úì WhatsApp link saved! Check your sidebar.</div>
            <div class="error-msg" id="wa-error" style="margin-top:10px;">Please enter a valid WhatsApp link (starts with https://chat.whatsapp.com/)</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ USERS ‚îÄ‚îÄ -->
    <div class="page" id="page-users">
      <div class="page-title">Switch User</div>
      <div class="page-sub">Select a profile or create a new one</div>
      <div class="users-grid" id="users-grid"></div>
      <div style="margin-top:20px;">
        <button class="btn btn-outline" onclick="switchAuthTab('register'); document.getElementById('app').classList.remove('visible'); document.getElementById('auth-screen').style.display='flex'; document.getElementById('app').classList.remove('visible');">+ Add New User</button>
      </div>
    </div>

  <!-- ‚îÄ‚îÄ ADMIN PANEL ‚îÄ‚îÄ -->
    <div class="page" id="page-admin">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:4px;">
        <div class="page-title" style="margin-bottom:0;">Admin Panel</div>
        <span class="admin-badge">üõ°Ô∏è Admin</span>
      </div>
      <div class="page-sub">Manage users, permissions, and app settings</div>

      <div class="admin-panel-card">
        <div class="card-title">üë• User Management</div>
        <div id="admin-user-list">Loading...</div>
      </div>

      <div class="admin-panel-card">
        <div class="card-title">üìñ Recipe Management</div>
        <p style="font-size:14px;color:var(--text-dim);margin-bottom:16px;">As admin you can delete any recipe shared by any user.</p>
        <div id="admin-recipe-list">Loading...</div>
      </div>

      <div class="admin-panel-card" style="border-color:rgba(248,113,113,0.25);">
        <div class="card-title" style="color:var(--red);">‚ö†Ô∏è Danger Zone</div>
        <p style="font-size:14px;color:var(--text-dim);margin-bottom:16px;">Permanently delete all demo accounts (sarah &amp; mike). This cannot be undone.</p>
        <button class="btn btn-danger btn-sm" onclick="adminDeleteDemoUsers()">üóë Remove Demo Users</button>
      </div>
    </div>

  <!-- ‚îÄ‚îÄ INSTALL APP ‚îÄ‚îÄ -->
    <div class="page" id="page-install">
      <div class="page-title">üì≤ Install the App</div>
      <div class="page-sub">Add Chingone Life Tracker to your home screen for the full app experience</div>

      <!-- Install prompt (shown on Android Chrome) -->
      <div id="install-prompt-card" style="display:none;margin-bottom:20px;">
        <div class="card" style="border-color:rgba(74,222,128,0.4);background:var(--green-glow);">
          <div style="display:flex;align-items:center;gap:14px;">
            <div style="font-size:40px;">üéâ</div>
            <div style="flex:1;">
              <div style="font-weight:700;font-size:15px;margin-bottom:4px;">Ready to install!</div>
              <div style="font-size:13px;color:var(--text-dim);">Your browser supports direct installation. Tap the button below to add Chingone to your home screen.</div>
            </div>
          </div>
          <button class="btn btn-primary btn-full" style="margin-top:16px;font-size:15px;padding:14px;" onclick="triggerPWAInstall()">‚¨áÔ∏è Install Chingone Life Tracker</button>
        </div>
      </div>

      <!-- App preview card -->
      <div class="card" style="margin-bottom:20px;text-align:center;padding:32px 20px;">
        <div style="width:88px;height:88px;border-radius:22px;background:#0d0f0e;border:2px solid #4ade80;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;box-shadow:0 0 32px rgba(74,222,128,0.25);">
          <span style="font-family:'Bebas Neue',sans-serif;font-size:52px;color:#4ade80;line-height:1;">C</span>
        </div>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:1px;margin-bottom:4px;">Chingone Life Tracker</div>
        <div style="font-size:13px;color:var(--text-dim);">Food ¬∑ Workouts ¬∑ AI Plans ¬∑ Recipes</div>
        <div style="display:flex;justify-content:center;gap:16px;margin-top:20px;flex-wrap:wrap;">
          <div style="text-align:center;"><div style="font-size:22px;">üì¥</div><div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Works Offline</div></div>
          <div style="text-align:center;"><div style="font-size:22px;">‚ö°</div><div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Instant Load</div></div>
          <div style="text-align:center;"><div style="font-size:22px;">üîí</div><div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Data Stays Private</div></div>
          <div style="text-align:center;"><div style="font-size:22px;">üîÑ</div><div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Auto Updates</div></div>
        </div>
      </div>

      <!-- iPhone instructions -->
      <div class="card" style="margin-bottom:16px;">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
          <span style="font-size:26px;">üçé</span>
          <div class="card-title" style="margin-bottom:0;">Install on iPhone / iPad</div>
        </div>
        <div class="import-step">
          <div class="import-step-num">1</div>
          <div class="import-step-body">
            <h4>Open in Safari</h4>
            <p>This <strong>must</strong> be done in <strong>Safari</strong> ‚Äî not Chrome or Firefox. If you're reading this in another browser, copy the URL and open it in Safari.</p>
          </div>
        </div>
        <div class="import-step">
          <div class="import-step-num">2</div>
          <div class="import-step-body">
            <h4>Tap the Share button</h4>
            <p>At the bottom of Safari, tap the <strong>Share icon</strong> ‚Äî it looks like a box with an arrow pointing up <span style="font-size:16px;">‚¨ÜÔ∏è</span></p>
          </div>
        </div>
        <div class="import-step">
          <div class="import-step-num">3</div>
          <div class="import-step-body">
            <h4>Tap "Add to Home Screen"</h4>
            <p>Scroll down in the share sheet and tap <strong>"Add to Home Screen"</strong>. The app name will show as <strong>Chingone</strong>. Tap <strong>Add</strong> in the top-right corner.</p>
          </div>
        </div>
        <div class="import-step" style="border-bottom:none;">
          <div class="import-step-num">4</div>
          <div class="import-step-body">
            <h4>Open from your home screen</h4>
            <p>Find the <strong>Chingone</strong> icon on your home screen and tap it. It will open fullscreen like a native app ‚Äî no browser bar, no address bar.</p>
          </div>
        </div>
        <div style="background:rgba(250,204,21,0.08);border:1px solid rgba(250,204,21,0.2);border-radius:var(--radius);padding:12px 14px;margin-top:12px;font-size:12px;color:var(--accent);">
          üí° <strong>Tip:</strong> The app must be hosted at a URL (not opened as a local file) for "Add to Home Screen" to show the custom icon. See hosting options below.
        </div>
      </div>

      <!-- Android instructions -->
      <div class="card" style="margin-bottom:16px;">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
          <span style="font-size:26px;">ü§ñ</span>
          <div class="card-title" style="margin-bottom:0;">Install on Android</div>
        </div>
        <div class="import-step">
          <div class="import-step-num">1</div>
          <div class="import-step-body">
            <h4>Open in Chrome</h4>
            <p>Open the app URL in <strong>Google Chrome</strong> on your Android phone. Chrome has the best PWA support on Android.</p>
          </div>
        </div>
        <div class="import-step">
          <div class="import-step-num">2</div>
          <div class="import-step-body">
            <h4>Tap the install banner or menu</h4>
            <p>Chrome may automatically show an <strong>"Add to Home screen"</strong> banner at the bottom. If not, tap the <strong>‚ãÆ three-dot menu</strong> in the top-right and select <strong>"Add to Home screen"</strong> or <strong>"Install app"</strong>.</p>
          </div>
        </div>
        <div class="import-step" style="border-bottom:none;">
          <div class="import-step-num">3</div>
          <div class="import-step-body">
            <h4>Tap Install and you're done</h4>
            <p>Confirm the install. The Chingone icon appears on your home screen. It opens fullscreen with no browser UI ‚Äî just like a real Android app.</p>
          </div>
        </div>
      </div>

      <!-- Hosting options -->
      <div class="card" style="margin-bottom:16px;">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
          <span style="font-size:26px;">üåê</span>
          <div class="card-title" style="margin-bottom:0;">How to Host It (Free Options)</div>
        </div>
        <p style="font-size:13px;color:var(--text-dim);margin-bottom:16px;line-height:1.7;">The app needs to be at a public URL so your group can access it. Here are the easiest free options:</p>

        <div style="display:flex;flex-direction:column;gap:12px;">
          <div style="background:var(--surface2);border-radius:var(--radius);padding:16px;">
            <div style="font-weight:700;font-size:14px;margin-bottom:4px;">‚ö° Netlify Drop <span style="background:var(--green);color:#0d0f0e;font-size:10px;padding:2px 7px;border-radius:10px;font-weight:700;margin-left:6px;">Easiest</span></div>
            <div style="font-size:13px;color:var(--text-dim);line-height:1.7;margin-bottom:8px;">Go to <a href="https://app.netlify.com/drop" target="_blank" style="color:var(--green);">app.netlify.com/drop</a>, drag and drop your HTML file onto the page, and you instantly get a public URL like <code style="font-size:11px;background:var(--surface3);padding:2px 5px;border-radius:4px;">yoursite.netlify.app</code>. Free, no account needed to start.</div>
          </div>
          <div style="background:var(--surface2);border-radius:var(--radius);padding:16px;">
            <div style="font-weight:700;font-size:14px;margin-bottom:4px;">üêô GitHub Pages</div>
            <div style="font-size:13px;color:var(--text-dim);line-height:1.7;">Create a free GitHub account, make a repository, upload the HTML file as <code style="font-size:11px;background:var(--surface3);padding:2px 5px;border-radius:4px;">index.html</code>, and enable GitHub Pages in settings. Free forever.</div>
          </div>
          <div style="background:var(--surface2);border-radius:var(--radius);padding:16px;">
            <div style="font-weight:700;font-size:14px;margin-bottom:4px;">üî• Firebase Hosting</div>
            <div style="font-size:13px;color:var(--text-dim);line-height:1.7;">Google's free hosting. Gives you a clean URL and excellent performance. Requires a Google account and the Firebase CLI tool.</div>
          </div>
        </div>
      </div>

      <!-- Share with group -->
      <div class="card">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
          <span style="font-size:26px;">üí¨</span>
          <div class="card-title" style="margin-bottom:0;">Share with Your Group</div>
        </div>
        <p style="font-size:13px;color:var(--text-dim);line-height:1.7;margin-bottom:14px;">Once hosted, share the URL in your WhatsApp group. Anyone who opens it can create an account and install it on their phone. No app store, no download ‚Äî just open and install.</p>
        <div id="share-url-section">
          <div class="form-group">
            <label>Your App URL (paste it here once hosted)</label>
            <input type="url" id="app-url-input" placeholder="https://yourapp.netlify.app" oninput="updateShareMessage()">
          </div>
          <div id="share-message-box" style="display:none;background:var(--surface2);border-radius:var(--radius);padding:14px;margin-top:10px;">
            <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:8px;">Share Message Preview</div>
            <div id="share-message-text" style="font-size:13px;color:var(--text-dim);line-height:1.8;white-space:pre-wrap;"></div>
            <button class="btn btn-outline btn-sm" style="margin-top:10px;" onclick="copyShareMessage()">üìã Copy Message</button>
            <div id="share-copied" style="display:none;font-size:12px;color:var(--green);margin-top:6px;">‚úì Copied to clipboard!</div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- end main -->

  <!-- ‚îÄ‚îÄ BOTTOM TAB BAR (mobile) ‚îÄ‚îÄ -->
  <nav class="bottom-tab-bar" id="bottom-tab-bar">
    <button class="tab-btn active" id="tab-dashboard" onclick="navigate('dashboard')">
      <span class="tab-icon">üìä</span>
      <span class="tab-label">Dashboard</span>
    </button>
    <button class="tab-btn" id="tab-food-log" onclick="navigate('food-log')">
      <span class="tab-icon">ü•ó</span>
      <span class="tab-label">Food</span>
    </button>
    <button class="tab-btn" id="tab-workout-log" onclick="navigate('workout-log')">
      <span class="tab-icon">üèãÔ∏è</span>
      <span class="tab-label">Workout</span>
    </button>
    <button class="tab-btn" id="tab-meal-ideas" onclick="navigate('meal-ideas')">
      <span class="tab-icon">üßë‚Äçüç≥</span>
      <span class="tab-label">Meals</span>
    </button>
    <button class="tab-btn" id="tab-more" onclick="openMoreMenu()">
      <span class="tab-icon">‚ò∞</span>
      <span class="tab-label">More</span>
    </button>
  </nav>

  <!-- More menu (slides up from bottom tab bar) -->
  <div class="more-menu-overlay" id="more-menu-overlay" onclick="closeMoreMenu()"></div>
  <div class="more-menu" id="more-menu">
    <div class="more-menu-handle"></div>
    <div class="more-menu-title">More Options</div>
    <div class="more-menu-grid">
      <button class="more-menu-item" id="mtab-ai-plan" onclick="navigate('ai-plan');closeMoreMenu()">
        <span class="mi-icon">ü§ñ</span>AI Plan
      </button>
      <button class="more-menu-item" id="mtab-recipes" onclick="navigate('recipes');closeMoreMenu()">
        <span class="mi-icon">üìñ</span>Recipes
      </button>
      <button class="more-menu-item" id="mtab-history" onclick="navigate('history');closeMoreMenu()">
        <span class="mi-icon">üìÖ</span>History
      </button>
      <button class="more-menu-item" id="mtab-import" onclick="navigate('import');closeMoreMenu()">
        <span class="mi-icon">üì•</span>Import
      </button>
      <button class="more-menu-item" id="mtab-sheets" onclick="navigate('sheets');closeMoreMenu()">
        <span class="mi-icon">üìä</span>Sheets
      </button>
      <button class="more-menu-item" id="mtab-profile" onclick="navigate('profile');closeMoreMenu()">
        <span class="mi-icon">üë§</span>Profile
      </button>
      <button class="more-menu-item" id="mtab-users" onclick="navigate('users');closeMoreMenu()">
        <span class="mi-icon">üë•</span>Switch User
      </button>
      <button class="more-menu-item" id="mtab-admin" style="display:none;" onclick="navigate('admin');closeMoreMenu()">
        <span class="mi-icon">üõ°Ô∏è</span>Admin
      </button>
      <button class="more-menu-item" id="mtab-install" onclick="navigate('install');closeMoreMenu()">
        <span class="mi-icon">üì≤</span>Install
      </button>
    </div>
  </div>

</div><!-- end app -->

<!-- PDF SHARE MODAL -->
<div class="modal-overlay" id="pdf-modal">
  <div class="modal pdf-modal">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
      <div class="modal-title" style="margin-bottom:0;">üì§ Share Day Summary</div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-primary btn-sm" onclick="printDashboardPDF()">üñ®Ô∏è Save / Print PDF</button>
        <button class="btn btn-outline btn-sm" onclick="document.getElementById('pdf-modal').classList.remove('open')">‚úï Close</button>
      </div>
    </div>
    <p style="font-size:13px;color:var(--text-dim);margin-bottom:16px;">Preview your day summary below. Hit <strong>Save / Print PDF</strong> ‚Äî on mobile choose <strong>"Save as PDF"</strong> or share directly to WhatsApp.</p>

    <!-- Live preview rendered here -->
    <div id="pdf-preview-container"></div>
  </div>
</div>

<!-- Hidden print frame (only visible during print) -->
<div id="pdf-print-frame"></div>

<!-- CONTACT ADMIN MODAL -->
<div class="modal-overlay" id="contact-admin-modal">
  <div class="modal" style="max-width:420px;text-align:center;">
    <div style="font-size:48px;margin-bottom:12px;">üîí</div>
    <div class="modal-title">Admin Permission Required</div>
    <div class="modal-sub" style="margin-bottom:16px;">You need admin access to <span id="contact-admin-msg">perform this action</span>.</div>
    <div class="contact-banner" style="text-align:left;margin-bottom:20px;">
      <span style="font-size:20px;">üìß</span>
      <div>
        <div style="font-weight:600;margin-bottom:2px;">Contact the App Admin</div>
        <a href="/cdn-cgi/l/email-protection#6d0f1f040f181e0559592d0a000c0401430e0200" style="color:var(--blue);text-decoration:none;font-size:13px;"><span class="__cf_email__" data-cfemail="3654445f5443455e020276515b575f5a1855595b">[email&#160;protected]</span></a>
      </div>
    </div>
    <button class="btn btn-outline btn-full" onclick="document.getElementById('contact-admin-modal').classList.remove('open')">Close</button>
  </div>
</div>

<!-- ADD WORKOUT MODAL -->
<div class="modal-overlay" id="add-workout-modal">
  <div class="modal" style="max-width:600px;max-height:90vh;overflow-y:auto;">
    <div class="modal-title" id="wm-title">üèãÔ∏è Log Workout</div>
    <div class="modal-sub">Add exercises, sets, reps, and weights</div>

    <!-- Activity type -->
    <div class="form-group">
      <label>Activity Type</label>
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:4px;" id="activity-chips">
        <button type="button" class="activity-chip active" onclick="selectActivity(this,'Weightlifting')">üèãÔ∏è Weightlifting</button>
        <button type="button" class="activity-chip" onclick="selectActivity(this,'Cardio')">üèÉ Cardio</button>
        <button type="button" class="activity-chip" onclick="selectActivity(this,'HIIT')">‚ö° HIIT</button>
        <button type="button" class="activity-chip" onclick="selectActivity(this,'Yoga')">üßò Yoga</button>
        <button type="button" class="activity-chip" onclick="selectActivity(this,'Swimming')">üèä Swimming</button>
        <button type="button" class="activity-chip" onclick="selectActivity(this,'Cycling')">üö¥ Cycling</button>
        <button type="button" class="activity-chip" onclick="selectActivity(this,'Running')">üèÉ Running</button>
        <button type="button" class="activity-chip" onclick="selectActivity(this,'Sports')">‚öΩ Sports</button>
        <button type="button" class="activity-chip" onclick="selectActivity(this,'Other')">‚ûï Other</button>
      </div>
      <input type="text" id="wm-activity-custom" placeholder="Or type a custom activity..." style="margin-top:8px;display:none;">
    </div>

    <div class="ai-form-grid">
      <div class="form-group">
        <label>Workout Name (optional)</label>
        <input type="text" id="wm-name" placeholder="e.g. Chest Day, Leg Day, Morning Run">
      </div>
      <div class="form-group">
        <label>Duration (minutes)</label>
        <input type="number" id="wm-duration" placeholder="60" min="1">
      </div>
      <div class="form-group">
        <label>Intensity</label>
        <select id="wm-intensity">
          <option value="Light">Light</option>
          <option value="Moderate" selected>Moderate</option>
          <option value="Hard">Hard</option>
          <option value="Max Effort">Max Effort</option>
        </select>
      </div>
      <div class="form-group">
        <label>Calories Burned (est.)</label>
        <input type="number" id="wm-calories" placeholder="0" min="0">
      </div>
    </div>

    <!-- EXERCISES TABLE -->
    <div style="margin:4px 0 12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
        <label style="margin-bottom:0;">Exercises</label>
        <button type="button" class="btn btn-outline btn-sm" onclick="addExerciseRow()">Ôºã Add Exercise</button>
      </div>
      <div id="exercise-rows-container">
        <!-- rows injected here -->
      </div>
      <div id="no-exercises-msg" style="padding:16px;text-align:center;color:var(--text-muted);font-size:13px;border:1px dashed var(--border);border-radius:var(--radius);">
        No exercises added yet ‚Äî click "+ Add Exercise" above
      </div>
    </div>

    <div class="form-group">
      <label>Notes (optional)</label>
      <textarea id="wm-notes" rows="2" placeholder="How did it feel? Any PRs? Anything to remember..."></textarea>
    </div>

    <div class="error-msg" id="wm-error" style="margin-bottom:12px;">Please select an activity type.</div>
    <div class="modal-actions">
      <button class="btn btn-primary" style="flex:1;" onclick="confirmAddWorkout()">‚úì Save Workout</button>
      <button class="btn btn-outline" onclick="closeWorkoutModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- ADD RECIPE MODAL -->
<div class="modal-overlay" id="add-recipe-modal">
  <div class="modal recipe-detail-modal">
    <div class="modal-title">üë®‚Äçüç≥ Share a Recipe</div>
    <div class="modal-sub">Your recipe will be visible to everyone using the app</div>

    <!-- Emoji picker -->
    <div class="form-group">
      <label>Choose an Icon</label>
      <div class="emoji-picker-row" id="recipe-emoji-picker">
        <span class="emoji-opt selected" data-emoji="ü•ó" onclick="selectRecipeEmoji(this)">ü•ó</span>
        <span class="emoji-opt" data-emoji="üç≥" onclick="selectRecipeEmoji(this)">üç≥</span>
        <span class="emoji-opt" data-emoji="ü•ò" onclick="selectRecipeEmoji(this)">ü•ò</span>
        <span class="emoji-opt" data-emoji="üç≤" onclick="selectRecipeEmoji(this)">üç≤</span>
        <span class="emoji-opt" data-emoji="ü•ô" onclick="selectRecipeEmoji(this)">ü•ô</span>
        <span class="emoji-opt" data-emoji="üåÆ" onclick="selectRecipeEmoji(this)">üåÆ</span>
        <span class="emoji-opt" data-emoji="ü•ë" onclick="selectRecipeEmoji(this)">ü•ë</span>
        <span class="emoji-opt" data-emoji="üç±" onclick="selectRecipeEmoji(this)">üç±</span>
        <span class="emoji-opt" data-emoji="ü•£" onclick="selectRecipeEmoji(this)">ü•£</span>
        <span class="emoji-opt" data-emoji="ü•§" onclick="selectRecipeEmoji(this)">ü•§</span>
        <span class="emoji-opt" data-emoji="ü´ô" onclick="selectRecipeEmoji(this)">ü´ô</span>
        <span class="emoji-opt" data-emoji="üçú" onclick="selectRecipeEmoji(this)">üçú</span>
        <span class="emoji-opt" data-emoji="ü•¶" onclick="selectRecipeEmoji(this)">ü•¶</span>
        <span class="emoji-opt" data-emoji="üçó" onclick="selectRecipeEmoji(this)">üçó</span>
        <span class="emoji-opt" data-emoji="ü•©" onclick="selectRecipeEmoji(this)">ü•©</span>
        <span class="emoji-opt" data-emoji="üêü" onclick="selectRecipeEmoji(this)">üêü</span>
        <span class="emoji-opt" data-emoji="üçì" onclick="selectRecipeEmoji(this)">üçì</span>
        <span class="emoji-opt" data-emoji="ü´ê" onclick="selectRecipeEmoji(this)">ü´ê</span>
      </div>
    </div>

    <div class="ai-form-grid">
      <div class="form-group full">
        <label>Recipe Name <span style="color:var(--red)">*</span></label>
        <input type="text" id="r-name" placeholder="e.g. High-Protein Chicken Bowl">
      </div>
      <div class="form-group full">
        <label>Short Description</label>
        <input type="text" id="r-desc" placeholder="e.g. A quick, macro-friendly lunch packed with lean protein">
      </div>
      <div class="form-group">
        <label>Category</label>
        <select id="r-category">
          <option value="breakfast">üåÖ Breakfast</option>
          <option value="lunch" selected>‚òÄÔ∏è Lunch</option>
          <option value="dinner">üåô Dinner</option>
          <option value="snack">üçé Snack</option>
          <option value="smoothie">ü•§ Smoothie</option>
          <option value="dessert">üçì Dessert</option>
        </select>
      </div>
      <div class="form-group">
        <label>Servings</label>
        <input type="number" id="r-servings" placeholder="2" min="1" value="2">
      </div>
      <div class="form-group">
        <label>Prep Time</label>
        <input type="text" id="r-prep" placeholder="e.g. 10 mins">
      </div>
      <div class="form-group">
        <label>Cook Time</label>
        <input type="text" id="r-cook" placeholder="e.g. 20 mins">
      </div>
    </div>

    <!-- Nutrition per serving -->
    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:16px;">
      <div class="card-title" style="margin-bottom:12px;">Nutrition Per Serving <span style="font-size:11px;color:var(--text-muted);font-weight:400;text-transform:none;letter-spacing:0;">(optional but helpful)</span></div>
      <div class="ai-form-grid">
        <div class="form-group" style="margin-bottom:8px;">
          <label style="color:var(--accent)">Calories</label>
          <input type="number" id="r-kcal" placeholder="0" min="0">
        </div>
        <div class="form-group" style="margin-bottom:8px;">
          <label style="color:var(--green)">Protein (g)</label>
          <input type="number" id="r-protein" placeholder="0" min="0" step="0.1">
        </div>
        <div class="form-group" style="margin-bottom:8px;">
          <label style="color:var(--blue)">Carbs (g)</label>
          <input type="number" id="r-carbs" placeholder="0" min="0" step="0.1">
        </div>
        <div class="form-group" style="margin-bottom:8px;">
          <label style="color:var(--accent2)">Fat (g)</label>
          <input type="number" id="r-fat" placeholder="0" min="0" step="0.1">
        </div>
      </div>
    </div>

    <!-- Ingredients -->
    <div style="margin-bottom:16px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
        <label style="margin-bottom:0;">Ingredients <span style="color:var(--red)">*</span></label>
        <button type="button" class="btn btn-outline btn-sm" onclick="addIngredientRow()">Ôºã Add</button>
      </div>
      <div style="display:grid;grid-template-columns:80px 65px 1fr 24px;gap:6px;margin-bottom:6px;">
        <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--text-muted);">Amount</div>
        <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--text-muted);">Unit</div>
        <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--text-muted);">Ingredient</div>
        <div></div>
      </div>
      <div id="ingredients-container"></div>
      <div id="no-ingredients-msg" style="font-size:13px;color:var(--text-muted);padding:8px 0;">Click "+ Add" to add ingredients</div>
    </div>

    <!-- Steps -->
    <div style="margin-bottom:16px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
        <label style="margin-bottom:0;">Instructions <span style="color:var(--red)">*</span></label>
        <button type="button" class="btn btn-outline btn-sm" onclick="addStepRow()">Ôºã Add Step</button>
      </div>
      <div id="steps-container"></div>
      <div id="no-steps-msg" style="font-size:13px;color:var(--text-muted);padding:8px 0;">Click "+ Add Step" to add cooking instructions</div>
    </div>

    <!-- Tags -->
    <div class="form-group">
      <label>Tags <span style="font-size:11px;color:var(--text-muted);font-weight:400;text-transform:none;letter-spacing:0;">(comma separated, optional)</span></label>
      <input type="text" id="r-tags" placeholder="e.g. high-protein, gluten-free, meal-prep, vegan">
    </div>

    <div class="error-msg" id="r-error" style="margin-bottom:12px;">Please enter a recipe name and at least one ingredient.</div>
    <div class="modal-actions">
      <button class="btn btn-primary" style="flex:1;" onclick="confirmAddRecipe()">üìñ Share Recipe</button>
      <button class="btn btn-outline" onclick="closeRecipeModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- RECIPE DETAIL MODAL -->
<div class="modal-overlay" id="recipe-detail-modal">
  <div class="modal recipe-detail-modal">
    <div id="recipe-detail-content"></div>
    <div class="modal-actions" style="margin-top:20px;">
      <button class="btn btn-outline" style="flex:1;" onclick="document.getElementById('recipe-detail-modal').classList.remove('open')">Close</button>
      <button class="btn btn-danger btn-sm" id="recipe-delete-btn" onclick="deleteCurrentRecipe()">üóë Delete</button>
    </div>
  </div>
</div>

<!-- ADD FOOD MODAL -->
<div class="modal-overlay" id="add-food-modal">
  <div class="modal">
    <div class="modal-title" id="modal-food-name">Chicken Breast</div>
    <div class="modal-sub" id="modal-food-brand">Per 100g serving</div>
    <div class="macro-grid">
      <div class="macro-item"><div class="macro-val" id="modal-cals" style="color:var(--accent)">0</div><div class="macro-lbl">Calories</div></div>
      <div class="macro-item"><div class="macro-val" id="modal-protein" style="color:var(--green)">0g</div><div class="macro-lbl">Protein</div></div>
      <div class="macro-item"><div class="macro-val" id="modal-carbs" style="color:var(--blue)">0g</div><div class="macro-lbl">Carbs</div></div>
      <div class="macro-item"><div class="macro-val" id="modal-fat" style="color:var(--accent2)">0g</div><div class="macro-lbl">Fat</div></div>
    </div>
    <div class="form-group">
      <label>Quantity (grams)</label>
      <input type="number" id="modal-qty" value="100" min="1" oninput="updateModalMacros()">
    </div>
    <div class="form-group">
      <label>Meal</label>
      <select id="modal-meal">
        <option value="breakfast">Breakfast</option>
        <option value="lunch">Lunch</option>
        <option value="dinner">Dinner</option>
        <option value="snack">Snack</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" style="flex:1" onclick="confirmAddFood()">Add to Log</button>
      <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- MANUAL FOOD ENTRY MODAL -->
<div class="modal-overlay" id="manual-food-modal">
  <div class="modal" style="max-width:540px;">
    <div class="modal-title">&#9997;&#65039; Log Food Manually</div>
    <div class="modal-sub">Enter any food with your own nutritional values</div>

    <div class="form-group">
      <label>Food Name <span style="color:var(--red)">*</span></label>
      <input type="text" id="mf-name" placeholder="e.g. Mom's Chicken Soup, Protein Bar, etc.">
    </div>
    <div class="form-group">
      <label>Brand / Notes (optional)</label>
      <input type="text" id="mf-brand" placeholder="e.g. Homemade, Quest, Kirkland...">
    </div>

    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:16px;">
      <div style="font-size:12px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(--text-dim);margin-bottom:14px;">Nutrition Per Serving</div>
      <div class="ai-form-grid">
        <div class="form-group" style="margin-bottom:10px;">
          <label style="color:var(--accent)">Calories (kcal) <span style="color:var(--red)">*</span></label>
          <input type="number" id="mf-kcal" placeholder="0" min="0" oninput="previewManualMacros()">
        </div>
        <div class="form-group" style="margin-bottom:10px;">
          <label>Serving Size</label>
          <div style="display:flex;gap:8px;">
            <input type="number" id="mf-serving" placeholder="100" min="1" style="flex:1;" oninput="previewManualMacros()">
            <select id="mf-serving-unit" style="width:80px;">
              <option value="g">g</option>
              <option value="ml">ml</option>
              <option value="oz">oz</option>
              <option value="cup">cup</option>
              <option value="tsp">tsp</option>
              <option value="tbsp">tbsp</option>
              <option value="piece">piece</option>
            </select>
          </div>
        </div>
        <div class="form-group" style="margin-bottom:10px;">
          <label style="color:var(--green)">Protein (g)</label>
          <input type="number" id="mf-protein" placeholder="0" min="0" step="0.1" oninput="previewManualMacros()">
        </div>
        <div class="form-group" style="margin-bottom:10px;">
          <label style="color:var(--blue)">Carbohydrates (g)</label>
          <input type="number" id="mf-carbs" placeholder="0" min="0" step="0.1" oninput="previewManualMacros()">
        </div>
        <div class="form-group" style="margin-bottom:10px;">
          <label style="color:var(--accent2)">Fat (g)</label>
          <input type="number" id="mf-fat" placeholder="0" min="0" step="0.1" oninput="previewManualMacros()">
        </div>
        <div class="form-group" style="margin-bottom:10px;">
          <label>Fiber (g)</label>
          <input type="number" id="mf-fiber" placeholder="0" min="0" step="0.1">
        </div>
        <div class="form-group" style="margin-bottom:10px;">
          <label>Sugar (g)</label>
          <input type="number" id="mf-sugar" placeholder="0" min="0" step="0.1">
        </div>
        <div class="form-group" style="margin-bottom:10px;">
          <label>Sodium (mg)</label>
          <input type="number" id="mf-sodium" placeholder="0" min="0">
        </div>
      </div>
    </div>

    <!-- Live preview -->
    <div id="mf-preview" style="display:none;background:var(--surface3);border-radius:var(--radius);padding:12px 16px;margin-bottom:16px;">
      <div style="font-size:11px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(--text-muted);margin-bottom:8px;">Preview ¬∑ 1 serving</div>
      <div style="display:flex;gap:16px;flex-wrap:wrap;">
        <div style="text-align:center;"><div style="font-family:'Bebas Neue',sans-serif;font-size:26px;color:var(--accent)" id="mf-prev-cals">0</div><div style="font-size:11px;color:var(--text-dim)">KCAL</div></div>
        <div style="text-align:center;"><div style="font-family:'Bebas Neue',sans-serif;font-size:26px;color:var(--green)" id="mf-prev-protein">0g</div><div style="font-size:11px;color:var(--text-dim)">PROTEIN</div></div>
        <div style="text-align:center;"><div style="font-family:'Bebas Neue',sans-serif;font-size:26px;color:var(--blue)" id="mf-prev-carbs">0g</div><div style="font-size:11px;color:var(--text-dim)">CARBS</div></div>
        <div style="text-align:center;"><div style="font-family:'Bebas Neue',sans-serif;font-size:26px;color:var(--accent2)" id="mf-prev-fat">0g</div><div style="font-size:11px;color:var(--text-dim)">FAT</div></div>
      </div>
    </div>

    <div class="form-group">
      <label>Log to Meal</label>
      <select id="mf-meal">
        <option value="breakfast">&#127745; Breakfast</option>
        <option value="lunch">&#9728;&#65039; Lunch</option>
        <option value="dinner">&#127769; Dinner</option>
        <option value="snack">&#127822; Snack</option>
      </select>
    </div>

    <div class="form-group">
      <label>How many servings?</label>
      <input type="number" id="mf-servings" value="1" min="0.25" step="0.25" oninput="previewManualMacros()">
    </div>

    <div class="error-msg" id="mf-error" style="margin-bottom:12px;">Please enter a food name and at least the calories.</div>

    <div class="modal-actions">
      <button class="btn btn-primary" style="flex:1" onclick="confirmManualFood()">&#10003; Add to Log</button>
      <button class="btn btn-outline" onclick="closeManualModal()">Cancel</button>
    </div>
  </div>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INSTALL PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderInstallPage() {
  // Show the Android install prompt card if available
  const card = document.getElementById('install-prompt-card');
  if (card) card.style.display = deferredInstallPrompt ? 'block' : 'none';
  // Restore saved app URL if user entered one before
  const saved = localStorage.getItem('vt_app_url') || '';
  const urlInput = document.getElementById('app-url-input');
  if (urlInput && saved) {
    urlInput.value = saved;
    updateShareMessage();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MOBILE SIDEBAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openSidebar() {
  document.querySelector('.sidebar').classList.add('open');
  document.getElementById('sidebar-overlay').classList.add('open');
}
function closeSidebar() {
  document.querySelector('.sidebar').classList.remove('open');
  document.getElementById('sidebar-overlay').classList.remove('open');
}
// Bottom tab bar handles mobile navigation ‚Äî sidebar auto-hidden on mobile

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentUser = null;
let allUsers = {};
let currentLogDate = getTodayStr();
let selectedFood = null;
let gSheetsConfig = null;
let searchTimeout = null;

function getTodayStr() {
  return new Date().toISOString().split('T')[0];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STORAGE HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadStorage() {
  try { allUsers = JSON.parse(localStorage.getItem('vt_users') || '{}'); } catch(e) { allUsers = {}; }
  gSheetsConfig = JSON.parse(localStorage.getItem('vt_sheets') || 'null');
  
  // Seed admin account (always ensure it exists with correct password & role)
  allUsers['bribush44'] = Object.assign({
    username: 'bribush44', password: 'Lynsbri3844!', name: 'Admin',
    email: 'bribush44@gmail.com', age: 0, gender: 'other',
    height: 0, weight: 0, goal: 'improve_fitness',
    cals_goal: 2000, protein_goal: 120, fat_goal: 60, carbs_goal: 250,
    foodLog: {}, workoutLog: {}, aiPlan: '', isAdmin: true, isSuperAdmin: true
  }, allUsers['bribush44'] || {}, { password: 'Lynsbri3844!', isAdmin: true, isSuperAdmin: true });

  // Seed demo users
  if (!allUsers['sarah']) {
    allUsers['sarah'] = {
      username: 'sarah', password: 'demo123', name: 'Sarah Johnson',
      email: 'sarah@demo.com', age: 28, gender: 'female',
      height: 65, weight: 135, goal: 'lose_weight',
      cals_goal: 1500, protein_goal: 100, fat_goal: 50, carbs_goal: 180,
      foodLog: {}, aiPlan: ''
    };
  }
  if (!allUsers['mike']) {
    allUsers['mike'] = {
      username: 'mike', password: 'demo123', name: 'Mike Chen',
      email: 'mike@demo.com', age: 32, gender: 'male',
      height: 71, weight: 185, goal: 'build_muscle',
      cals_goal: 2800, protein_goal: 180, fat_goal: 80, carbs_goal: 300,
      foodLog: {}, aiPlan: ''
    };
  }
  saveStorage();
}

function saveStorage() {
  localStorage.setItem('vt_users', JSON.stringify(allUsers));
  if (gSheetsConfig) localStorage.setItem('vt_sheets', JSON.stringify(gSheetsConfig));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchAuthTab(tab) {
  document.querySelectorAll('.auth-tab').forEach((t,i) => t.classList.toggle('active', (tab==='login' ? i===0 : i===1)));
  document.getElementById('login-form').style.display = tab === 'login' ? 'block' : 'none';
  document.getElementById('register-form').style.display = tab === 'register' ? 'block' : 'none';
}

function doLogin() {
  const uname = document.getElementById('login-username').value.trim().toLowerCase();
  const pass = document.getElementById('login-password').value;
  const err = document.getElementById('login-error');
  if (allUsers[uname] && allUsers[uname].password === pass) {
    err.style.display = 'none';
    currentUser = uname;
    localStorage.setItem('vt_current', uname);
    launchApp();
  } else {
    err.style.display = 'block';
  }
}

function doRegister() {
  const uname = document.getElementById('reg-username').value.trim().toLowerCase();
  const pass = document.getElementById('reg-password').value;
  const err = document.getElementById('reg-error');
  if (!uname || !pass) { err.textContent = 'Username and password are required.'; err.style.display = 'block'; return; }
  if (allUsers[uname]) { err.textContent = 'Username already taken.'; err.style.display = 'block'; return; }
  allUsers[uname] = {
    username: uname,
    password: pass,
    name: document.getElementById('reg-name').value || uname,
    email: document.getElementById('reg-email').value,
    age: parseInt(document.getElementById('reg-age').value) || 25,
    gender: document.getElementById('reg-gender').value,
    height: parseInt(document.getElementById('reg-height').value) || 68,
    weight: parseInt(document.getElementById('reg-weight').value) || 160,
    goal: document.getElementById('reg-goal').value,
    cals_goal: 1800, protein_goal: 120, fat_goal: 60, carbs_goal: 200,
    foodLog: {}, aiPlan: ''
  };
  saveStorage();
  err.style.display = 'none';
  currentUser = uname;
  localStorage.setItem('vt_current', uname);
  launchApp();
}

function doLogout() {
  currentUser = null;
  localStorage.removeItem('vt_current');
  document.getElementById('app').style.display = 'none';
  document.getElementById('auth-screen').style.display = 'flex';
}

function launchApp() {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app').classList.add('visible');
  refreshSidebarUser();
  seedDemoRecipes();
  refreshSidebarWhatsApp();
  // Show/hide admin nav item
  const adminNav = document.getElementById('nav-admin');
  if (adminNav) adminNav.style.display = isAdmin() ? 'flex' : 'none';
  navigate('dashboard');
  syncBottomTabs('dashboard');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openMoreMenu() {
  document.getElementById('more-menu').classList.add('open');
  document.getElementById('more-menu-overlay').classList.add('open');
}
function closeMoreMenu() {
  document.getElementById('more-menu').classList.remove('open');
  document.getElementById('more-menu-overlay').classList.remove('open');
}

// Pages shown in the main bottom tab bar
const MAIN_TABS = ['dashboard','food-log','workout-log','meal-ideas'];
// Pages that live in the More menu
const MORE_TABS = ['ai-plan','recipes','history','import','sheets','profile','users','admin','install'];

function syncBottomTabs(page) {
  // Reset all main tabs
  MAIN_TABS.forEach(t => {
    const el = document.getElementById('tab-' + t);
    if (el) el.classList.remove('active');
  });
  // Reset all more-menu items
  MORE_TABS.forEach(t => {
    const el = document.getElementById('mtab-' + t);
    if (el) el.classList.remove('active');
  });
  // Highlight the more button if on a more-menu page
  const moreBtn = document.getElementById('tab-more');
  if (moreBtn) moreBtn.classList.toggle('active', MORE_TABS.includes(page));
  // Highlight the correct main tab or more-menu item
  const mainTab = document.getElementById('tab-' + page);
  if (mainTab) mainTab.classList.add('active');
  const moreItem = document.getElementById('mtab-' + page);
  if (moreItem) moreItem.classList.add('active');
  // Show/hide admin in more menu
  const adminItem = document.getElementById('mtab-admin');
  if (adminItem) adminItem.style.display = isAdmin() ? 'flex' : 'none';
}

function navigate(page) {
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  // Highlight the correct nav item by matching its onclick attribute
  document.querySelectorAll('.nav-item').forEach(n => {
    if (n.getAttribute('onclick') && n.getAttribute('onclick').includes("'" + page + "'")) {
      n.classList.add('active');
    }
  });
  const pg = document.getElementById('page-' + page);
  if (pg) pg.classList.add('active');
  if (page === 'dashboard') renderDashboard();
  if (page === 'food-log') renderFoodLog();
  if (page === 'workout-log') renderWorkoutLog();
  if (page === 'history') renderHistory();
  if (page === 'profile') loadProfileForm();
  if (page === 'users') renderUsersGrid();
  if (page === 'ai-plan') loadAIPage();
  if (page === 'sheets') loadSheetsPage();
  if (page === 'recipes') renderRecipes();
  if (page === 'workout-history') renderWorkoutHistory();
  if (page === 'meal-ideas') loadMealIdeasPage();
  if (page === 'import') renderImportPage();
  if (page === 'admin') { if (isAdmin()) renderAdminPanel(); else showContactAdmin('access the Admin Panel'); }
  if (page === 'install') renderInstallPage();
  syncBottomTabs(page);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SIDEBAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function refreshSidebarUser() {
  const u = allUsers[currentUser];
  if (!u) return;
  document.getElementById('sidebar-avatar').textContent = u.name.charAt(0).toUpperCase();
  document.getElementById('sidebar-username').textContent = u.name.split(' ')[0];
  // Admin badge
  let badge = document.getElementById('sidebar-admin-badge');
  if (isAdmin()) {
    if (!badge) {
      badge = document.createElement('span');
      badge.id = 'sidebar-admin-badge';
      badge.className = 'admin-badge';
      badge.style.marginLeft = '4px';
      badge.textContent = 'üõ°Ô∏è Admin';
      const userChip = document.querySelector('.user-chip');
      if (userChip) userChip.appendChild(badge);
    }
    badge.style.display = 'inline-flex';
  } else {
    if (badge) badge.style.display = 'none';
  }
  // Show/hide admin nav item
  const adminNav = document.getElementById('nav-admin');
  if (adminNav) adminNav.style.display = isAdmin() ? 'flex' : 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let dashViewDate = getTodayStr();

function changeDashDate(delta) {
  const d = new Date(dashViewDate + 'T12:00:00');
  d.setDate(d.getDate() + delta);
  const today = new Date();
  today.setHours(23,59,59,999);
  if (d > today) return; // can't go past today
  dashViewDate = d.toISOString().split('T')[0];
  renderDashboard();
}

function jumpDashToday() {
  dashViewDate = getTodayStr();
  renderDashboard();
}

function renderDashboard() {
  const u = allUsers[currentUser];
  if (!u) return;
  const isToday = dashViewDate === getTodayStr();
  const viewDate = new Date(dashViewDate + 'T12:00:00');

  // ‚îÄ‚îÄ Header ‚îÄ‚îÄ
  if (isToday) {
    const hour = new Date().getHours();
    const greet = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
    document.getElementById('dash-greeting').textContent = greet + ', ' + u.name.split(' ')[0];
    document.getElementById('dash-date').textContent = new Date().toLocaleDateString('en-US', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
    document.getElementById('dash-nav-date').textContent = 'Today';
    document.getElementById('dash-next-btn').style.opacity = '0.3';
    document.getElementById('dash-next-btn').style.cursor = 'default';
  } else {
    document.getElementById('dash-greeting').textContent = u.name.split(' ')[0] + "'s Summary";
    document.getElementById('dash-date').textContent = viewDate.toLocaleDateString('en-US', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
    document.getElementById('dash-nav-date').textContent = viewDate.toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric'});
    document.getElementById('dash-next-btn').style.opacity = '1';
    document.getElementById('dash-next-btn').style.cursor = 'pointer';
  }
  document.getElementById('dash-nav-day').textContent = viewDate.toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});

  // ‚îÄ‚îÄ Past day banner ‚îÄ‚îÄ
  const banner = document.getElementById('dash-past-banner');
  banner.style.display = isToday ? 'none' : 'flex';

  // ‚îÄ‚îÄ Nutrition stats ‚îÄ‚îÄ
  const totals = getDayTotals(dashViewDate);
  const goals = { cals: u.cals_goal || 1800, protein: u.protein_goal || 120, fat: u.fat_goal || 60, carbs: u.carbs_goal || 200 };

  document.getElementById('d-cals').textContent    = Math.round(totals.cals);
  document.getElementById('d-protein').textContent = Math.round(totals.protein);
  document.getElementById('d-fat').textContent     = Math.round(totals.fat);
  document.getElementById('d-carbs').textContent   = Math.round(totals.carbs);
  document.getElementById('d-cals-goal').textContent    = 'Goal: ' + goals.cals + ' kcal';
  document.getElementById('d-protein-goal').textContent = 'Goal: ' + goals.protein + 'g';
  document.getElementById('d-fat-goal').textContent     = 'Goal: ' + goals.fat + 'g';
  document.getElementById('d-carbs-goal').textContent   = 'Goal: ' + goals.carbs + 'g';

  const pct = (v, g) => Math.min(100, Math.round(v / g * 100)) + '%';
  document.getElementById('d-cals-bar').style.width    = pct(totals.cals, goals.cals);
  document.getElementById('d-protein-bar').style.width = pct(totals.protein, goals.protein);
  document.getElementById('d-fat-bar').style.width     = pct(totals.fat, goals.fat);
  document.getElementById('d-carbs-bar').style.width   = pct(totals.carbs, goals.carbs);

  // ‚îÄ‚îÄ Food summary ‚îÄ‚îÄ
  const log = (u.foodLog || {})[dashViewDate];
  const sumEl = document.getElementById('dash-food-summary');
  if (!log || Object.values(log).every(m => !m.length)) {
    sumEl.innerHTML = '<span style="color:var(--text-muted)">No food logged ' + (isToday ? 'today' : 'on this day') + '.</span>';
  } else {
    const mealIcons = {breakfast:'üåÖ',lunch:'‚òÄÔ∏è',dinner:'üåô',snack:'üçé'};
    const parts = [];
    ['breakfast','lunch','dinner','snack'].forEach(meal => {
      if (log[meal] && log[meal].length) {
        const mealCals = log[meal].reduce((s,item) => s + (item.kcal||0)*((item.qty||100)/100), 0);
        parts.push(`<div style="display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--border);">
          <div style="display:flex;align-items:center;gap:8px;">
            <span>${mealIcons[meal]}</span>
            <span style="font-size:14px;font-weight:500;">${meal.charAt(0).toUpperCase()+meal.slice(1)}</span>
            <span style="font-size:12px;color:var(--text-muted);">${log[meal].length} item${log[meal].length!==1?'s':''}</span>
          </div>
          <span style="font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--accent);">${Math.round(mealCals)} <span style="font-size:12px;font-family:'DM Sans',sans-serif;color:var(--text-dim);">kcal</span></span>
        </div>`);
      }
    });
    const totalCals = Math.round(totals.cals);
    const remaining = goals.cals - totalCals;
    sumEl.innerHTML = parts.join('') +
      `<div style="display:flex;justify-content:space-between;align-items:center;padding-top:10px;margin-top:2px;">
        <span style="font-size:13px;font-weight:600;color:var(--text-dim);">Total Calories</span>
        <span style="font-family:'Bebas Neue',sans-serif;font-size:24px;color:var(--accent);">${totalCals} <span style="font-size:12px;font-family:'DM Sans',sans-serif;color:${remaining>=0?'var(--green)':'var(--red)'};">${remaining>=0?remaining+' remaining':Math.abs(remaining)+' over'}</span></span>
      </div>`;
  }

  // ‚îÄ‚îÄ Workout summary ‚îÄ‚îÄ
  const workouts = ((u.workoutLog || {})[dashViewDate]) || [];
  const wEl = document.getElementById('dash-workout-summary');
  if (!workouts.length) {
    wEl.innerHTML = '<div style="color:var(--text-muted);font-size:14px;">No workouts logged ' + (isToday ? 'today.' : 'on this day.') + '</div>';
  } else {
    const totalDuration = workouts.reduce((s,w) => s + (parseInt(w.duration)||0), 0);
    const totalCalsBurned = workouts.reduce((s,w) => s + (parseInt(w.calories)||0), 0);
    const totalExercises = workouts.reduce((s,w) => s + (w.exercises||[]).length, 0);
    const totalSets = workouts.reduce((s,w) => s + (w.exercises||[]).reduce((es,e) => es + (e.sets||[]).length, 0), 0);
    const totalVol = workouts.reduce((s,w) =>
      s + (w.exercises||[]).reduce((es,e) =>
        es + (e.sets||[]).reduce((ss,set) => ss + (parseFloat(set.weight)||0)*(parseInt(set.reps)||0), 0), 0), 0);

    // Stat pills row
    const pills = [
      totalDuration ? `<div class="dash-workout-pill"><span style="color:var(--green);font-family:'Bebas Neue',sans-serif;font-size:22px;">${totalDuration}</span><span style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;"> min</span></div>` : '',
      totalCalsBurned ? `<div class="dash-workout-pill"><span style="color:var(--red);font-family:'Bebas Neue',sans-serif;font-size:22px;">${totalCalsBurned}</span><span style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;"> burned</span></div>` : '',
      totalExercises ? `<div class="dash-workout-pill"><span style="color:var(--blue);font-family:'Bebas Neue',sans-serif;font-size:22px;">${totalExercises}</span><span style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;"> exercise${totalExercises!==1?'s':''}</span></div>` : '',
      totalSets ? `<div class="dash-workout-pill"><span style="color:var(--accent2);font-family:'Bebas Neue',sans-serif;font-size:22px;">${totalSets}</span><span style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;"> sets</span></div>` : '',
      totalVol > 0 ? `<div class="dash-workout-pill"><span style="color:var(--accent);font-family:'Bebas Neue',sans-serif;font-size:22px;">${Math.round(totalVol).toLocaleString()}</span><span style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;"> lbs vol</span></div>` : '',
    ].filter(Boolean).join('');

    // Per-workout breakdown
    const sessionRows = workouts.map((w, wi) => {
      const exerciseList = (w.exercises || []).map(ex => {
        const setsSummary = (ex.sets || []).filter(s => s.weight || s.reps).map(s =>
          [s.weight ? s.weight+'lbs' : '', s.reps ? s.reps+' reps' : ''].filter(Boolean).join(' √ó ')
        ).join(' ¬∑ ');
        return `<div style="padding:6px 0 6px 12px;border-left:2px solid var(--border);margin-bottom:4px;">
          <div style="font-size:13px;font-weight:600;">üí™ ${escHtml(ex.name)}</div>
          ${setsSummary ? `<div style="font-size:12px;color:var(--text-muted);margin-top:2px;font-family:'DM Mono',monospace;">${escHtml(setsSummary)}</div>` : ''}
        </div>`;
      }).join('');

      return `<div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;margin-bottom:10px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:6px;">
          <div>
            <span style="font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:0.5px;">${escHtml(w.activity)}${w.name ? ' ‚Äî ' + escHtml(w.name) : ''}</span>
            <div style="margin-top:2px;display:flex;gap:10px;flex-wrap:wrap;">
              ${w.duration ? `<span style="font-size:12px;color:var(--text-muted);">‚è± ${w.duration} min</span>` : ''}
              ${w.calories ? `<span style="font-size:12px;color:var(--text-muted);">üî• ${w.calories} kcal burned</span>` : ''}
              <span style="font-size:11px;padding:2px 8px;border-radius:10px;" class="intensity-badge intensity-${w.intensity||'Moderate'}">${w.intensity||'Moderate'}</span>
            </div>
          </div>
        </div>
        ${exerciseList}
        ${w.notes ? `<div style="margin-top:8px;font-size:12px;color:var(--text-dim);font-style:italic;border-top:1px solid var(--border);padding-top:8px;">üìù ${escHtml(w.notes)}</div>` : ''}
      </div>`;
    }).join('');

    wEl.innerHTML = `
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px;">${pills}</div>
      ${sessionRows}
    `;
  }
}

function getDayTotals(dateStr) {
  const u = allUsers[currentUser];
  const log = (u.foodLog || {})[dateStr] || {};
  let cals=0, protein=0, fat=0, carbs=0, fiber=0, sugar=0, sodium=0;
  ['breakfast','lunch','dinner','snack'].forEach(meal => {
    (log[meal] || []).forEach(item => {
      const factor = (item.qty || 100) / 100;
      cals += (item.kcal || 0) * factor;
      protein += (item.protein || 0) * factor;
      fat += (item.fat || 0) * factor;
      carbs += (item.carbs || 0) * factor;
      fiber += (item.fiber || 0) * factor;
      sugar += (item.sugar || 0) * factor;
      sodium += (item.sodium || 0) * factor;
    });
  });
  return { cals, protein, fat, carbs, fiber, sugar, sodium };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FOOD LOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderFoodLog() {
  const u = allUsers[currentUser];
  const log = (u.foodLog || {})[currentLogDate] || {};
  
  document.getElementById('log-date-label').textContent = currentLogDate === getTodayStr() ? 
    'Today ‚Äî ' + new Date().toLocaleDateString('en-US',{month:'short',day:'numeric'}) :
    new Date(currentLogDate + 'T12:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'});
  
  ['breakfast','lunch','dinner','snack'].forEach(meal => {
    const items = log[meal] || [];
    const container = document.getElementById('meal-' + meal);
    const calEl = document.getElementById('meal-cal-' + meal);
    
    if (!items.length) {
      container.outerHTML = `<div id="meal-${meal}" class="food-empty">Nothing logged yet ‚Äî search above to add food</div>`;
      document.getElementById('meal-' + meal);
    } else {
      let mealCals = 0;
      const html = items.map((item, idx) => {
        const factor = (item.qty || 100) / 100;
        const cals = Math.round((item.kcal || 0) * factor);
        const prot = Math.round((item.protein || 0) * factor * 10) / 10;
        const carb = Math.round((item.carbs || 0) * factor * 10) / 10;
        const fat = Math.round((item.fat || 0) * factor * 10) / 10;
        mealCals += cals;
        const manualBadge = item._manual ? ' <span style="font-size:10px;background:rgba(250,204,21,0.15);color:var(--accent);padding:2px 6px;border-radius:8px;font-weight:600;letter-spacing:0.3px;">&#9997;&#65039; MANUAL</span>' : '';
        const qtyDisplay = item._manual && item.unit && item.unit !== 'g'
          ? (Math.round(item.qty) + item.unit)
          : (Math.round(item.qty || 100) + 'g');
        return `<div class="food-item">
          <div style="flex:1;min-width:0;">
            <div class="food-item-name">${item.name}${manualBadge}</div>
            <div class="food-item-macros">${qtyDisplay} &middot; P: ${prot}g &middot; C: ${carb}g &middot; F: ${fat}g</div>
          </div>
          <div style="display:flex;align-items:center;gap:12px;flex-shrink:0;">
            <div class="food-item-cals">${cals}</div>
            <button class="btn btn-danger btn-sm" onclick="removeFood('${meal}', ${idx})">&#10005;</button>
          </div>
        </div>`;
      }).join('');
      document.getElementById('meal-' + meal).outerHTML = `<div id="meal-${meal}">${html}</div>`;
      calEl.textContent = mealCals + ' kcal';
    }
  });
}

function changeLogDate(delta) {
  const d = new Date(currentLogDate + 'T12:00:00');
  d.setDate(d.getDate() + delta);
  const today = new Date();
  if (d > today) return;
  currentLogDate = d.toISOString().split('T')[0];
  renderFoodLog();
}

function removeFood(meal, idx) {
  const u = allUsers[currentUser];
  if (!u.foodLog) u.foodLog = {};
  if (!u.foodLog[currentLogDate]) u.foodLog[currentLogDate] = {};
  if (!u.foodLog[currentLogDate][meal]) return;
  u.foodLog[currentLogDate][meal].splice(idx, 1);
  saveStorage();
  renderFoodLog();
}

// ‚îÄ‚îÄ BUILT-IN FOOD DATABASE (100+ common foods, always works offline) ‚îÄ‚îÄ
const FOOD_DB = [
  // Proteins
  {name:'Chicken Breast (cooked)',category:'Protein',kcal:165,protein:31,carbs:0,fat:3.6,fiber:0,sugar:0,sodium:74},
  {name:'Chicken Thigh (cooked)',category:'Protein',kcal:209,protein:26,carbs:0,fat:10.9,fiber:0,sugar:0,sodium:88},
  {name:'Salmon (baked)',category:'Protein',kcal:208,protein:20,carbs:0,fat:13,fiber:0,sugar:0,sodium:59},
  {name:'Tilapia (cooked)',category:'Protein',kcal:128,protein:26,carbs:0,fat:2.7,fiber:0,sugar:0,sodium:52},
  {name:'Tuna (canned in water)',category:'Protein',kcal:116,protein:25.5,carbs:0,fat:1,fiber:0,sugar:0,sodium:396},
  {name:'Shrimp (cooked)',category:'Protein',kcal:99,protein:24,carbs:0,fat:0.3,fiber:0,sugar:0,sodium:111},
  {name:'Ground Beef 80/20 (cooked)',category:'Protein',kcal:254,protein:26,carbs:0,fat:17,fiber:0,sugar:0,sodium:75},
  {name:'Ground Turkey (cooked)',category:'Protein',kcal:189,protein:27,carbs:0,fat:9,fiber:0,sugar:0,sodium:88},
  {name:'Pork Tenderloin (cooked)',category:'Protein',kcal:143,protein:26,carbs:0,fat:3.5,fiber:0,sugar:0,sodium:54},
  {name:'Steak Sirloin (cooked)',category:'Protein',kcal:207,protein:30,carbs:0,fat:8.9,fiber:0,sugar:0,sodium:54},
  {name:'Egg (whole, large)',category:'Protein',kcal:143,protein:13,carbs:0.7,fat:9.5,fiber:0,sugar:0.4,sodium:142},
  {name:'Egg White',category:'Protein',kcal:52,protein:11,carbs:0.7,fat:0.2,fiber:0,sugar:0.6,sodium:166},
  {name:'Cottage Cheese (low fat)',category:'Protein',kcal:72,protein:12,carbs:2.7,fat:1,fiber:0,sugar:2.7,sodium:321},
  {name:'Greek Yogurt (plain, nonfat)',category:'Protein',kcal:59,protein:10,carbs:3.6,fat:0.4,fiber:0,sugar:3.2,sodium:36},
  {name:'Protein Powder (whey)',category:'Protein',kcal:382,protein:75,carbs:8,fat:4,fiber:0,sugar:4,sodium:180},
  {name:'Tofu (firm)',category:'Protein',kcal:76,protein:8,carbs:1.9,fat:4.2,fiber:0.3,sugar:0.6,sodium:7},
  {name:'Black Beans (cooked)',category:'Protein',kcal:132,protein:8.9,carbs:24,fat:0.5,fiber:8.7,sugar:0.3,sodium:1},
  {name:'Lentils (cooked)',category:'Protein',kcal:116,protein:9,carbs:20,fat:0.4,fiber:7.9,sugar:1.8,sodium:2},
  {name:'Chickpeas (cooked)',category:'Protein',kcal:164,protein:8.9,carbs:27,fat:2.6,fiber:7.6,sugar:4.8,sodium:7},
  // Grains & Carbs
  {name:'White Rice (cooked)',category:'Grains',kcal:130,protein:2.7,carbs:28,fat:0.3,fiber:0.4,sugar:0,sodium:1},
  {name:'Brown Rice (cooked)',category:'Grains',kcal:111,protein:2.6,carbs:23,fat:0.9,fiber:1.8,sugar:0.4,sodium:5},
  {name:'Oats (dry)',category:'Grains',kcal:389,protein:17,carbs:66,fat:7,fiber:10,sugar:0,sodium:2},
  {name:'Oatmeal (cooked)',category:'Grains',kcal:68,protein:2.4,carbs:12,fat:1.4,fiber:1.7,sugar:0.5,sodium:49},
  {name:'Pasta (cooked)',category:'Grains',kcal:158,protein:5.8,carbs:31,fat:0.9,fiber:1.8,sugar:0.6,sodium:1},
  {name:'Whole Wheat Bread',category:'Grains',kcal:247,protein:13,carbs:41,fat:3.4,fiber:6,sugar:6,sodium:400},
  {name:'White Bread',category:'Grains',kcal:265,protein:9,carbs:49,fat:3.2,fiber:2.7,sugar:5,sodium:491},
  {name:'Quinoa (cooked)',category:'Grains',kcal:120,protein:4.4,carbs:21,fat:1.9,fiber:2.8,sugar:0.9,sodium:7},
  {name:'Sweet Potato (baked)',category:'Grains',kcal:90,protein:2,carbs:21,fat:0.1,fiber:3.3,sugar:6.5,sodium:36},
  {name:'White Potato (baked)',category:'Grains',kcal:93,protein:2.5,carbs:21,fat:0.1,fiber:2.2,sugar:1.1,sodium:10},
  {name:'Corn Tortilla',category:'Grains',kcal:218,protein:5.7,carbs:46,fat:2.5,fiber:6.3,sugar:1,sodium:175},
  {name:'Granola Bar (average)',category:'Grains',kcal:471,protein:10,carbs:64,fat:20,fiber:4,sugar:24,sodium:229},
  // Vegetables
  {name:'Broccoli (raw)',category:'Vegetables',kcal:34,protein:2.8,carbs:7,fat:0.4,fiber:2.6,sugar:1.7,sodium:33},
  {name:'Spinach (raw)',category:'Vegetables',kcal:23,protein:2.9,carbs:3.6,fat:0.4,fiber:2.2,sugar:0.4,sodium:79},
  {name:'Kale (raw)',category:'Vegetables',kcal:49,protein:4.3,carbs:8.8,fat:0.9,fiber:3.6,sugar:2.3,sodium:38},
  {name:'Romaine Lettuce',category:'Vegetables',kcal:17,protein:1.2,carbs:3.3,fat:0.3,fiber:2.1,sugar:1.2,sodium:8},
  {name:'Cucumber',category:'Vegetables',kcal:15,protein:0.7,carbs:3.6,fat:0.1,fiber:0.5,sugar:1.7,sodium:2},
  {name:'Tomato',category:'Vegetables',kcal:18,protein:0.9,carbs:3.9,fat:0.2,fiber:1.2,sugar:2.6,sodium:5},
  {name:'Bell Pepper (red)',category:'Vegetables',kcal:31,protein:1,carbs:6,fat:0.3,fiber:2.1,sugar:4.2,sodium:4},
  {name:'Carrot (raw)',category:'Vegetables',kcal:41,protein:0.9,carbs:10,fat:0.2,fiber:2.8,sugar:4.7,sodium:69},
  {name:'Celery',category:'Vegetables',kcal:16,protein:0.7,carbs:3,fat:0.2,fiber:1.6,sugar:1.3,sodium:80},
  {name:'Onion',category:'Vegetables',kcal:40,protein:1.1,carbs:9.3,fat:0.1,fiber:1.7,sugar:4.2,sodium:4},
  {name:'Garlic',category:'Vegetables',kcal:149,protein:6.4,carbs:33,fat:0.5,fiber:2.1,sugar:1,sodium:17},
  {name:'Mushrooms (raw)',category:'Vegetables',kcal:22,protein:3.1,carbs:3.3,fat:0.3,fiber:1,sugar:1.7,sodium:5},
  {name:'Asparagus',category:'Vegetables',kcal:20,protein:2.2,carbs:3.9,fat:0.1,fiber:2.1,sugar:1.9,sodium:2},
  {name:'Green Beans',category:'Vegetables',kcal:31,protein:1.8,carbs:7,fat:0.2,fiber:2.7,sugar:3.3,sodium:6},
  {name:'Zucchini',category:'Vegetables',kcal:17,protein:1.2,carbs:3.1,fat:0.3,fiber:1,sugar:2.5,sodium:8},
  {name:'Avocado',category:'Vegetables',kcal:160,protein:2,carbs:9,fat:14.7,fiber:6.7,sugar:0.7,sodium:7},
  // Fruits
  {name:'Banana',category:'Fruits',kcal:89,protein:1.1,carbs:23,fat:0.3,fiber:2.6,sugar:12,sodium:1},
  {name:'Apple',category:'Fruits',kcal:52,protein:0.3,carbs:14,fat:0.2,fiber:2.4,sugar:10,sodium:1},
  {name:'Orange',category:'Fruits',kcal:47,protein:0.9,carbs:12,fat:0.1,fiber:2.4,sugar:9.4,sodium:0},
  {name:'Strawberries',category:'Fruits',kcal:32,protein:0.7,carbs:7.7,fat:0.3,fiber:2,sugar:4.9,sodium:1},
  {name:'Blueberries',category:'Fruits',kcal:57,protein:0.7,carbs:14,fat:0.3,fiber:2.4,sugar:10,sodium:1},
  {name:'Grapes',category:'Fruits',kcal:69,protein:0.7,carbs:18,fat:0.2,fiber:0.9,sugar:15,sodium:2},
  {name:'Watermelon',category:'Fruits',kcal:30,protein:0.6,carbs:7.6,fat:0.2,fiber:0.4,sugar:6.2,sodium:1},
  {name:'Mango',category:'Fruits',kcal:60,protein:0.8,carbs:15,fat:0.4,fiber:1.6,sugar:13.7,sodium:1},
  {name:'Pineapple',category:'Fruits',kcal:50,protein:0.5,carbs:13,fat:0.1,fiber:1.4,sugar:9.9,sodium:1},
  {name:'Peach',category:'Fruits',kcal:39,protein:0.9,carbs:10,fat:0.3,fiber:1.5,sugar:8.4,sodium:0},
  // Dairy
  {name:'Whole Milk',category:'Dairy',kcal:61,protein:3.2,carbs:4.8,fat:3.3,fiber:0,sugar:5.1,sodium:43},
  {name:'Skim Milk',category:'Dairy',kcal:34,protein:3.4,carbs:5,fat:0.2,fiber:0,sugar:5,sodium:42},
  {name:'Cheddar Cheese',category:'Dairy',kcal:402,protein:25,carbs:1.3,fat:33,fiber:0,sugar:0.5,sodium:621},
  {name:'Mozzarella Cheese',category:'Dairy',kcal:280,protein:28,carbs:3.1,fat:17,fiber:0,sugar:1,sodium:627},
  {name:'Greek Yogurt (whole milk)',category:'Dairy',kcal:97,protein:9,carbs:3.8,fat:5,fiber:0,sugar:3.2,sodium:36},
  {name:'Butter',category:'Dairy',kcal:717,protein:0.9,carbs:0.1,fat:81,fiber:0,sugar:0.1,sodium:576},
  // Fats & Nuts
  {name:'Olive Oil',category:'Fats',kcal:884,protein:0,carbs:0,fat:100,fiber:0,sugar:0,sodium:2},
  {name:'Coconut Oil',category:'Fats',kcal:862,protein:0,carbs:0,fat:100,fiber:0,sugar:0,sodium:0},
  {name:'Almonds',category:'Nuts',kcal:579,protein:21,carbs:22,fat:50,fiber:12.5,sugar:4.4,sodium:1},
  {name:'Peanut Butter (natural)',category:'Nuts',kcal:588,protein:25,carbs:20,fat:50,fiber:6,sugar:9,sodium:459},
  {name:'Peanuts (roasted)',category:'Nuts',kcal:567,protein:26,carbs:16,fat:49,fiber:8.5,sugar:4,sodium:2},
  {name:'Walnuts',category:'Nuts',kcal:654,protein:15,carbs:14,fat:65,fiber:6.7,sugar:2.6,sodium:2},
  {name:'Cashews',category:'Nuts',kcal:553,protein:18,carbs:30,fat:44,fiber:3.3,sugar:5.9,sodium:12},
  {name:'Chia Seeds',category:'Nuts',kcal:486,protein:17,carbs:42,fat:31,fiber:34,sugar:0,sodium:16},
  // Fast Food & Common Meals
  {name:'McDonald\'s Big Mac',category:'Fast Food',kcal:550,protein:25,carbs:45,fat:30,fiber:3,sugar:9,sodium:1010},
  {name:'McDonald\'s Fries (medium)',category:'Fast Food',kcal:320,protein:4,carbs:43,fat:15,fiber:4,sugar:0,sodium:400},
  {name:'Subway 6" Turkey Breast',category:'Fast Food',kcal:280,protein:18,carbs:46,fat:3.5,fiber:3,sugar:7,sodium:700},
  {name:'Pizza Margherita (1 slice)',category:'Fast Food',kcal:272,protein:12,carbs:33,fat:10,fiber:2,sugar:3,sodium:551},
  {name:'Burger (homemade)',category:'Fast Food',kcal:295,protein:17,carbs:24,fat:14,fiber:1,sugar:5,sodium:396},
  // Beverages
  {name:'Orange Juice',category:'Drinks',kcal:45,protein:0.7,carbs:10,fat:0.2,fiber:0.2,sugar:8.4,sodium:1},
  {name:'Coffee (black)',category:'Drinks',kcal:2,protein:0.3,carbs:0,fat:0,fiber:0,sugar:0,sodium:5},
  {name:'Whole Milk Latte (12oz)',category:'Drinks',kcal:150,protein:8,carbs:12,fat:6,fiber:0,sugar:12,sodium:115},
  {name:'Sports Drink (Gatorade)',category:'Drinks',kcal:26,protein:0,carbs:7,fat:0,fiber:0,sugar:6,sodium:160},
  {name:'Protein Shake (avg)',category:'Drinks',kcal:160,protein:30,carbs:8,fat:2.5,fiber:1,sugar:5,sodium:200},
  // Condiments & Extras
  {name:'Ketchup',category:'Condiments',kcal:101,protein:1.3,carbs:26,fat:0.1,fiber:0.3,sugar:22,sodium:907},
  {name:'Mayonnaise',category:'Condiments',kcal:680,protein:1,carbs:0.6,fat:75,fiber:0,sugar:0.4,sodium:635},
  {name:'Soy Sauce',category:'Condiments',kcal:53,protein:8.1,carbs:4.9,fat:0.1,fiber:0.1,sugar:1.7,sodium:5493},
  {name:'Salsa',category:'Condiments',kcal:36,protein:2,carbs:8,fat:0.4,fiber:1.9,sugar:4.7,sodium:864},
  {name:'Ranch Dressing',category:'Condiments',kcal:476,protein:2.3,carbs:6,fat:49,fiber:0,sugar:4.5,sodium:867},
];

// ‚îÄ‚îÄ SEARCH STATE ‚îÄ‚îÄ
let searchSource = 'both'; // 'both' | 'packaged' | 'local'

function setSearchSource(src) {
  searchSource = src;
  ['both','packaged','local'].forEach(s => {
    const el = document.getElementById('src-' + s);
    if (el) el.classList.toggle('src-active', s === src);
  });
  const q = document.getElementById('food-search-input').value.trim();
  if (q) doFoodSearch();
}

// ‚îÄ‚îÄ Search cache: avoids repeat API calls for same term ‚îÄ‚îÄ
const _searchCache = new Map();

function onFoodSearch(val) {
  clearTimeout(searchTimeout);
  const dd = document.getElementById('search-dropdown');
  if (!val.trim()) { dd.style.display = 'none'; return; }

  const ql = val.trim().toLowerCase();

  // 1. Show local results INSTANTLY (no delay)
  if (searchSource !== 'packaged') {
    const localResults = FOOD_DB
      .filter(f => f.name.toLowerCase().includes(ql) || f.category.toLowerCase().includes(ql))
      .slice(0, 6)
      .map(f => ({ ...f, _src: 'local' }));
    if (localResults.length) {
      window._searchResults = localResults;
      renderSearchResults(localResults);
      dd.style.display = 'block';
    }
  }

  // 2. Check cache before making any network call
  if (_searchCache.has(ql)) {
    const cached = _searchCache.get(ql);
    window._searchResults = cached;
    renderSearchResults(cached);
    dd.style.display = 'block';
    return;
  }

  // 3. Debounce the network call (500ms ‚Äî user still typing)
  searchTimeout = setTimeout(() => doFoodSearch(val.trim()), 500);
}

async function doFoodSearch(q) {
  if (!q) return;
  const ql = q.toLowerCase();
  const dd = document.getElementById('search-dropdown');
  const spinner = document.getElementById('search-spinner');
  dd.style.display = 'block';
  if (spinner) spinner.style.display = 'block';

  // Local results
  const localResults = (searchSource !== 'packaged')
    ? FOOD_DB.filter(f => f.name.toLowerCase().includes(ql) || f.category.toLowerCase().includes(ql))
        .slice(0, 6).map(f => ({ ...f, _src: 'local' }))
    : [];

  // Remote search
  let remoteResults = [];
  if (searchSource !== 'local') {
    try {
      remoteResults = await searchOpenFoodFacts(q);
    } catch(e) {
      console.log('Remote search failed:', e.message);
    }
  }

  if (spinner) spinner.style.display = 'none';

  // Merge: remote first, then local
  const seen = new Set();
  const merged = [];
  remoteResults.forEach(r => { const k = r.name.toLowerCase(); if (!seen.has(k)) { seen.add(k); merged.push({...r, _src:'off'}); } });
  if (searchSource !== 'packaged') {
    localResults.forEach(r => { const k = r.name.toLowerCase(); if (!seen.has(k)) { seen.add(k); merged.push({...r, _src:'local'}); } });
  }

  // Only update if this is still the current search term
  const currentVal = (document.getElementById('food-search-input') || {}).value || '';
  if (!currentVal.toLowerCase().startsWith(ql.slice(0, 3))) return;

  if (!merged.length) {
    dd.innerHTML = '<div style="padding:16px 20px;color:var(--text-dim);font-size:13px;">No results found. Try a different search term.</div>';
    dd.style.display = 'block';
    return;
  }

  // Cache the result (keep cache small)
  _searchCache.set(ql, merged);
  if (_searchCache.size > 30) _searchCache.delete(_searchCache.keys().next().value);

  window._searchResults = merged;
  renderSearchResults(merged);
}

function renderSearchResults(results) {
  const dd = document.getElementById('search-dropdown');
  dd.style.display = 'block';
  dd.innerHTML = results.map((f, i) => {
    const kcal = Math.round(f.kcal || 0);
    const prot = Math.round((f.protein || 0) * 10) / 10;
    const carb = Math.round((f.carbs || 0) * 10) / 10;
    const fat  = Math.round((f.fat || 0) * 10) / 10;
    const srcBadge = f._src === 'off'
      ? '<span class="sri-source off">Open Food Facts</span>'
      : '<span class="sri-source local">Basic Foods</span>';
    return `<div class="search-result-item" onclick="selectFood(${i})">
      <div style="display:flex;justify-content:space-between;align-items:start;gap:10px;">
        <div style="flex:1;min-width:0;">
          <div class="sri-name" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escHtml(f.name)}${srcBadge}</div>
          <div class="sri-brand">${escHtml(f.brand || f.category || '')} ¬∑ per 100g</div>
        </div>
        <div class="sri-cals" style="flex-shrink:0;">${kcal} kcal</div>
      </div>
      <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">P: ${prot}g &nbsp;C: ${carb}g &nbsp;F: ${fat}g</div>
    </div>`;
  }).join('');
}

function escHtml(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// Open Food Facts search ‚Äî races ALL endpoints simultaneously, uses whichever responds first
function parseOFFProducts(data) {
  return (data.products || [])
    .filter(p => p.product_name && p.nutriments)
    .map(p => {
      const n = p.nutriments;
      return {
        name: p.product_name,
        brand: p.brands || '',
        kcal: n['energy-kcal_100g'] || (n['energy-kcal'] ? n['energy-kcal'] / 10 : 0),
        protein: n['proteins_100g'] || 0,
        carbs: n['carbohydrates_100g'] || 0,
        fat: n['fat_100g'] || 0,
        fiber: n['fiber_100g'] || 0,
        sugar: n['sugars_100g'] || 0,
        sodium: n['sodium_100g'] || 0
      };
    });
}

async function searchOpenFoodFacts(query) {
  const encoded = encodeURIComponent(query);
  const base = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encoded}&search_simple=1&action=process&json=1&page_size=12&fields=product_name,brands,nutriments`;

  const urls = [
    base,
    `https://corsproxy.io/?${encodeURIComponent(base)}`,
    `https://api.allorigins.win/raw?url=${encodeURIComponent(base)}`
  ];

  // Helper: fetch one URL with a timeout, returns null on any failure
  const tryFetch = async (url) => {
    try {
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), 3000); // 3s per request
      const res = await fetch(url, {
        signal: controller.signal,
        headers: { 'Accept': 'application/json' }
      });
      clearTimeout(timer);
      if (!res.ok) return null;
      const data = await res.json();
      const products = parseOFFProducts(data);
      return products.length ? products : null;
    } catch(e) {
      return null;
    }
  };

  // Race all URLs simultaneously ‚Äî use the first one that returns results
  return new Promise(resolve => {
    let resolved = false;
    let pending = urls.length;

    urls.forEach(url => {
      tryFetch(url).then(products => {
        pending--;
        if (products && !resolved) {
          resolved = true;
          resolve(products);
        } else if (pending === 0 && !resolved) {
          resolve([]); // all failed
        }
      });
    });
  });
}

// Barcode lookup
async function lookupBarcode(barcode) {
  barcode = String(barcode).trim();
  if (!barcode) return;
  setStatus('scanner-status', '&#128269; Looking up barcode ' + barcode + '...');

  const urls = [
    `https://world.openfoodfacts.org/api/v0/product/${barcode}.json`,
    `https://corsproxy.io/?${encodeURIComponent(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`)}`,
    `https://api.allorigins.win/raw?url=${encodeURIComponent(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`)}`
  ];

  for (const url of urls) {
    try {
      const res = await Promise.race([
        fetch(url),
        new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), 6000))
      ]);
      if (!res.ok) continue;
      const data = await res.json();
      if (data.status === 1 && data.product) {
        const p = data.product;
        const n = p.nutriments || {};
        selectedFood = {
          name: p.product_name || p.product_name_en || 'Unknown Product',
          brand: p.brands || '',
          kcal: n['energy-kcal_100g'] || (n['energy-kcal'] ? n['energy-kcal'] / 10 : 0),
          protein: n['proteins_100g'] || 0,
          carbs: n['carbohydrates_100g'] || 0,
          fat: n['fat_100g'] || 0,
          fiber: n['fiber_100g'] || 0,
          sugar: n['sugars_100g'] || 0,
          sodium: n['sodium_100g'] || 0
        };
        closeScanner();
        openAddModal();
        return;
      } else {
        setStatus('scanner-status', '&#10060; Product not found in database. Try manual search above.');
        return;
      }
    } catch(e) { continue; }
  }
  setStatus('scanner-status', '&#10060; Lookup failed. Check internet connection or try manual search.');
}

function setStatus(id, html) {
  const el = document.getElementById(id);
  if (el) el.innerHTML = html;
}

// ‚îÄ‚îÄ BARCODE SCANNER ‚îÄ‚îÄ
let scannerStream = null;
let scannerInterval = null;
let barcodeDetector = null;

async function openScanner() {
  document.getElementById('scanner-panel').style.display = 'block';
  document.getElementById('scanner-panel').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  setStatus('scanner-status', '<div class="spinner"></div>&nbsp; Requesting camera access...');

  try {
    // Get camera stream
    scannerStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
    });
    const video = document.getElementById('scanner-video');
    video.srcObject = scannerStream;
    await video.play();

    setStatus('scanner-status', '&#128247; Camera ready ‚Äî point at a barcode');

    // Try native BarcodeDetector first (Chrome, Edge, Android)
    if ('BarcodeDetector' in window) {
      barcodeDetector = new BarcodeDetector({ formats: ['ean_13','ean_8','upc_a','upc_e','code_128','code_39','qr_code'] });
      startNativeScanning(video);
    } else {
      // Fallback: use ZXing library via CDN
      setStatus('scanner-status', '<div class="spinner"></div>&nbsp; Loading barcode library...');
      await loadZXing();
    }
  } catch(e) {
    if (e.name === 'NotAllowedError') {
      setStatus('scanner-status', '&#128683; Camera permission denied. Use manual entry below.');
    } else {
      setStatus('scanner-status', '&#9888;&#65039; Camera not available: ' + e.message + '. Use manual entry below.');
    }
  }
}

function startNativeScanning(video) {
  clearInterval(scannerInterval);
  scannerInterval = setInterval(async () => {
    if (!barcodeDetector || video.readyState < 2) return;
    try {
      const barcodes = await barcodeDetector.detect(video);
      if (barcodes.length > 0) {
        const code = barcodes[0].rawValue;
        clearInterval(scannerInterval);
        setStatus('scanner-status', '&#10003; Barcode detected: ' + code);
        await lookupBarcode(code);
      }
    } catch(e) {}
  }, 300);
}

async function loadZXing() {
  return new Promise((resolve, reject) => {
    if (window.ZXing) { resolve(); startZXingScanning(); return; }
    const s = document.createElement('script');
    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/zxing-js/0.19.1/zxing.min.js';
    s.onload = () => { resolve(); startZXingScanning(); };
    s.onerror = () => {
      setStatus('scanner-status', '&#9888;&#65039; Barcode library failed to load. Please use manual entry below.');
      reject();
    };
    document.head.appendChild(s);
  });
}

function startZXingScanning() {
  try {
    const codeReader = new ZXing.BrowserMultiFormatReader();
    const video = document.getElementById('scanner-video');
    setStatus('scanner-status', '&#128247; Scanning ‚Äî point at a barcode');
    codeReader.decodeFromStream(scannerStream, video, (result, err) => {
      if (result) {
        codeReader.reset();
        const code = result.getText();
        setStatus('scanner-status', '&#10003; Barcode detected: ' + code);
        lookupBarcode(code);
      }
    });
    window._zxingReader = codeReader;
  } catch(e) {
    setStatus('scanner-status', '&#9888;&#65039; Scanner error. Use manual entry below.');
  }
}

function closeScanner() {
  clearInterval(scannerInterval);
  if (window._zxingReader) { try { window._zxingReader.reset(); } catch(e) {} window._zxingReader = null; }
  if (scannerStream) { scannerStream.getTracks().forEach(t => t.stop()); scannerStream = null; }
  document.getElementById('scanner-panel').style.display = 'none';
  document.getElementById('scanner-video').srcObject = null;
}

function selectFood(idx) {
  const f = window._searchResults[idx];
  selectedFood = { ...f };
  document.getElementById('search-dropdown').style.display = 'none';
  document.getElementById('food-search-input').value = '';
  openAddModal();
}

function openAddModal() {
  if (!selectedFood) return;
  document.getElementById('modal-food-name').textContent = selectedFood.name.substring(0, 50);
  document.getElementById('modal-food-brand').textContent = (selectedFood.brand || 'Unknown brand') + ' ¬∑ per 100g';
  document.getElementById('modal-qty').value = 100;
  updateModalMacros();
  document.getElementById('add-food-modal').classList.add('open');
}

function updateModalMacros() {
  if (!selectedFood) return;
  const qty = parseFloat(document.getElementById('modal-qty').value) || 100;
  const f = qty / 100;
  document.getElementById('modal-cals').textContent = Math.round(selectedFood.kcal * f);
  document.getElementById('modal-protein').textContent = Math.round(selectedFood.protein * f * 10) / 10 + 'g';
  document.getElementById('modal-carbs').textContent = Math.round(selectedFood.carbs * f * 10) / 10 + 'g';
  document.getElementById('modal-fat').textContent = Math.round(selectedFood.fat * f * 10) / 10 + 'g';
}

function confirmAddFood() {
  if (!selectedFood) return;
  const meal = document.getElementById('modal-meal').value;
  const qty = parseFloat(document.getElementById('modal-qty').value) || 100;
  const u = allUsers[currentUser];
  if (!u.foodLog) u.foodLog = {};
  if (!u.foodLog[currentLogDate]) u.foodLog[currentLogDate] = {};
  if (!u.foodLog[currentLogDate][meal]) u.foodLog[currentLogDate][meal] = [];
  u.foodLog[currentLogDate][meal].push({ ...selectedFood, qty });
  saveStorage();
  closeModal();
  renderFoodLog();
  // Auto-sync to sheets if connected
  if (gSheetsConfig && gSheetsConfig.connected) syncEntryToSheets(selectedFood, meal, qty);
}

function closeModal() {
  document.getElementById('add-food-modal').classList.remove('open');
  selectedFood = null;
}

// ‚îÄ‚îÄ MANUAL FOOD ENTRY ‚îÄ‚îÄ
function openManualEntry() {
  // Clear all fields
  ['mf-name','mf-brand','mf-kcal','mf-protein','mf-carbs','mf-fat',
   'mf-fiber','mf-sugar','mf-sodium'].forEach(id => {
    document.getElementById(id).value = '';
  });
  document.getElementById('mf-serving').value = '100';
  document.getElementById('mf-serving-unit').value = 'g';
  document.getElementById('mf-servings').value = '1';
  document.getElementById('mf-meal').value = 'breakfast';
  document.getElementById('mf-error').style.display = 'none';
  document.getElementById('mf-preview').style.display = 'none';
  document.getElementById('manual-food-modal').classList.add('open');
  setTimeout(() => document.getElementById('mf-name').focus(), 100);
}

function closeManualModal() {
  document.getElementById('manual-food-modal').classList.remove('open');
}

function previewManualMacros() {
  const kcal    = parseFloat(document.getElementById('mf-kcal').value)    || 0;
  const protein = parseFloat(document.getElementById('mf-protein').value) || 0;
  const carbs   = parseFloat(document.getElementById('mf-carbs').value)   || 0;
  const fat     = parseFloat(document.getElementById('mf-fat').value)     || 0;
  const srvs    = parseFloat(document.getElementById('mf-servings').value) || 1;

  if (kcal || protein || carbs || fat) {
    document.getElementById('mf-preview').style.display = 'block';
    document.getElementById('mf-prev-cals').textContent    = Math.round(kcal * srvs);
    document.getElementById('mf-prev-protein').textContent = Math.round(protein * srvs * 10) / 10 + 'g';
    document.getElementById('mf-prev-carbs').textContent   = Math.round(carbs * srvs * 10) / 10 + 'g';
    document.getElementById('mf-prev-fat').textContent     = Math.round(fat * srvs * 10) / 10 + 'g';
  } else {
    document.getElementById('mf-preview').style.display = 'none';
  }
}

function confirmManualFood() {
  const name    = document.getElementById('mf-name').value.trim();
  const kcal    = parseFloat(document.getElementById('mf-kcal').value) || 0;
  const errEl   = document.getElementById('mf-error');

  if (!name) {
    errEl.textContent = 'Please enter a food name.';
    errEl.style.display = 'block';
    document.getElementById('mf-name').focus();
    return;
  }
  if (!kcal && kcal !== 0) {
    errEl.textContent = 'Please enter the calorie count (can be 0).';
    errEl.style.display = 'block';
    return;
  }
  errEl.style.display = 'none';

  const brand   = document.getElementById('mf-brand').value.trim();
  const protein = parseFloat(document.getElementById('mf-protein').value) || 0;
  const carbs   = parseFloat(document.getElementById('mf-carbs').value)   || 0;
  const fat     = parseFloat(document.getElementById('mf-fat').value)     || 0;
  const fiber   = parseFloat(document.getElementById('mf-fiber').value)   || 0;
  const sugar   = parseFloat(document.getElementById('mf-sugar').value)   || 0;
  const sodium  = parseFloat(document.getElementById('mf-sodium').value)  || 0;
  const serving = parseFloat(document.getElementById('mf-serving').value) || 100;
  const unit    = document.getElementById('mf-serving-unit').value;
  const srvs    = parseFloat(document.getElementById('mf-servings').value) || 1;
  const meal    = document.getElementById('mf-meal').value;

  // Store with _manual flag; qty = serving * servings for display
  // We store kcal/macros as-per-serving-size, qty = total grams logged
  const u = allUsers[currentUser];
  if (!u.foodLog) u.foodLog = {};
  if (!u.foodLog[currentLogDate]) u.foodLog[currentLogDate] = {};
  if (!u.foodLog[currentLogDate][meal]) u.foodLog[currentLogDate][meal] = [];

  // Normalize: store per-100g equivalent so existing render logic works
  // qty will be stored as serving*srvs, kcal/macros per 100g equivalent
  const totalQty = serving * srvs;
  const per100   = totalQty > 0 ? (100 / totalQty) : 1;

  const entry = {
    name:    name,
    brand:   brand,
    kcal:    kcal    * per100,
    protein: protein * per100,
    carbs:   carbs   * per100,
    fat:     fat     * per100,
    fiber:   fiber   * per100,
    sugar:   sugar   * per100,
    sodium:  sodium  * per100,
    qty:     totalQty,
    unit:    unit,
    _manual: true
  };

  u.foodLog[currentLogDate][meal].push(entry);
  saveStorage();
  closeManualModal();
  renderFoodLog();
  if (gSheetsConfig && gSheetsConfig.connected) syncEntryToSheets(entry, meal, totalQty);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI PLAN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadAIPage() {
  const u = allUsers[currentUser];
  if (!u) return;
  document.getElementById('ai-age').value = u.age || '';
  document.getElementById('ai-gender').value = u.gender || 'male';
  document.getElementById('ai-height').value = u.height || '';
  document.getElementById('ai-weight').value = u.weight || '';
  const goalMap = { lose_weight: 'lose weight', build_muscle: 'build muscle', maintain: 'maintain weight', improve_fitness: 'improve overall fitness' };
  document.getElementById('ai-goal').value = goalMap[u.goal] || 'lose weight';
  
  const savedKey = localStorage.getItem('vt_anthropic_key') || '';
  if (savedKey) document.getElementById('openai-key').value = savedKey;
  
  if (u.aiPlan) {
    document.getElementById('plan-output').textContent = u.aiPlan;
    document.getElementById('plan-output').style.display = 'block';
  }
}

function saveApiKey() {
  const key = document.getElementById('openai-key').value.trim();
  if (key) {
    localStorage.setItem('vt_anthropic_key', key);
    document.getElementById('key-saved').style.display = 'block';
    setTimeout(() => document.getElementById('key-saved').style.display = 'none', 2000);
  }
}

function addGoalChip(btn) {
  const textarea = document.getElementById('ai-custom-goals');
  const label = btn.textContent.trim().replace(/^[\p{Emoji}\u200d\uFE0F\s]+/u, '').trim();
  const current = textarea.value.trim();
  textarea.value = current ? current + '\n\u2022 ' + label : '\u2022 ' + label;
  btn.classList.add('added');
  setTimeout(() => btn.classList.remove('added'), 1200);
  textarea.focus();
}

async function generatePlan() {
  const key = document.getElementById('openai-key').value.trim() || localStorage.getItem('vt_anthropic_key');
  if (!key) { alert('Please enter your Anthropic API key first.'); return; }

  const age        = document.getElementById('ai-age').value;
  const gender     = document.getElementById('ai-gender').value;
  const height     = document.getElementById('ai-height').value;
  const weight     = document.getElementById('ai-weight').value;
  const activity   = document.getElementById('ai-activity').value;
  const goal       = document.getElementById('ai-goal').value;
  const target     = document.getElementById('ai-target').value;
  const timeframe  = document.getElementById('ai-timeframe').value;
  const notes      = document.getElementById('ai-notes').value;
  const customGoals = document.getElementById('ai-custom-goals').value.trim();

  const prompt = `You are a certified personal trainer and nutritionist. Create a detailed, personalized fitness and nutrition plan for this person:

- Age: ${age || 'not specified'}, Gender: ${gender}
- Height: ${height || 'not specified'} inches, Current weight: ${weight || 'not specified'} lbs${target ? ', Target weight: ' + target + ' lbs' : ''}
- Activity level: ${activity}
- Primary goal: ${goal}
- Timeframe: ${timeframe}
${notes ? '- Notes/restrictions: ' + notes : ''}
${customGoals ? '- Personal goals in their own words:\n' + customGoals : ''}

Please provide:
1. WEEKLY WORKOUT PLAN ‚Äî A specific 7-day workout schedule with exercises, sets, reps, and rest times. Tailor it to their activity level and goal.
2. DAILY NUTRITION PLAN ‚Äî Calorie target, macro breakdown (protein/carbs/fat in grams), meal timing, and a sample day of meals with rough portion sizes.
3. TIPS & MOTIVATION ‚Äî 3-5 specific, actionable tips for achieving their goal in the given timeframe.

Format it clearly with headings. Be specific, practical, and encouraging.`;

  const btn    = document.getElementById('gen-plan-btn');
  const output = document.getElementById('plan-output');
  btn.innerHTML = '<div class="spinner"></div> Generating your plan...';
  btn.disabled  = true;
  output.style.display = 'block';
  output.classList.add('loading');
  output.textContent = 'ü§ñ Claude AI is crafting your personalized plan...';

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type':         'application/json',
        'x-api-key':            key,
        'anthropic-version':    '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model:      'claude-opus-4-6',
        max_tokens: 2048,
        messages:   [{ role: 'user', content: prompt }]
      })
    });

    if (!res.ok) {
      let errMsg = 'API error ' + res.status;
      try { const e = await res.json(); errMsg = e.error?.message || errMsg; } catch(_) {}
      throw new Error(errMsg);
    }

    const data = await res.json();
    const plan = data.content?.[0]?.text || 'No response received.';
    output.classList.remove('loading');
    output.style.whiteSpace = 'pre-wrap';
    output.textContent = plan;

    allUsers[currentUser].aiPlan = plan;
    saveStorage();

  } catch(e) {
    output.classList.remove('loading');
    output.textContent = '‚ùå Error: ' + e.message
      + '\n\nCommon fixes:\n'
      + '‚Ä¢ Make sure your key starts with "sk-ant-"\n'
      + '‚Ä¢ Go to console.anthropic.com/settings/keys to verify the key is active\n'
      + '‚Ä¢ Check your billing credits at console.anthropic.com/settings/billing\n'
      + '‚Ä¢ If you just created the key, wait 30 seconds and try again';
  }

  btn.innerHTML = '‚ú® Generate My Plan';
  btn.disabled  = false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HISTORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHistory() {
  const u = allUsers[currentUser];
  const log = u.foodLog || {};
  const rows = [];
  
  Object.keys(log).sort().reverse().forEach(date => {
    ['breakfast','lunch','dinner','snack'].forEach(meal => {
      (log[date][meal] || []).forEach(item => {
        const f = (item.qty || 100) / 100;
        rows.push({ date, meal, ...item, f });
      });
    });
  });
  
  const tbody = document.getElementById('history-tbody');
  const empty = document.getElementById('history-empty');
  
  if (!rows.length) { tbody.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';
  
  tbody.innerHTML = rows.map(r => `<tr>
    <td>${r.date}</td>
    <td><span class="badge badge-green">${r.meal}</span></td>
    <td>${r.name}</td>
    <td>${r.qty}g</td>
    <td style="color:var(--accent);font-family:'DM Mono',monospace">${Math.round((r.kcal||0)*r.f)}</td>
    <td style="color:var(--green)">${Math.round((r.protein||0)*r.f*10)/10}g</td>
    <td style="color:var(--blue)">${Math.round((r.carbs||0)*r.f*10)/10}g</td>
    <td style="color:var(--accent2)">${Math.round((r.fat||0)*r.f*10)/10}g</td>
  </tr>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROFILE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadProfileForm() {
  const u = allUsers[currentUser];
  if (!u) return;
  document.getElementById('profile-avatar').textContent = u.name.charAt(0).toUpperCase();
  document.getElementById('profile-name').value = u.name || '';
  document.getElementById('profile-email').value = u.email || '';
  document.getElementById('profile-age').value = u.age || '';
  document.getElementById('profile-gender').value = u.gender || 'male';
  document.getElementById('profile-height').value = u.height || '';
  document.getElementById('profile-weight').value = u.weight || '';
  document.getElementById('profile-cal-goal').value = u.cals_goal || 1800;
  document.getElementById('profile-protein-goal').value = u.protein_goal || 120;
  document.getElementById('profile-fat-goal').value = u.fat_goal || 60;
  document.getElementById('profile-carbs-goal').value = u.carbs_goal || 200;
  document.getElementById('profile-goal').value = u.goal || 'lose_weight';
  // WhatsApp
  const waInput = document.getElementById('profile-whatsapp');
  const waTest  = document.getElementById('wa-test-btn');
  const waClear = document.getElementById('wa-clear-btn');
  const waErr   = document.getElementById('wa-error');
  if (waInput) waInput.value = u.whatsapp || '';
  if (waErr) waErr.style.display = 'none';
  if (waTest)  waTest.style.display  = u.whatsapp ? 'inline-flex' : 'none';
  if (waClear) waClear.style.display = u.whatsapp ? 'inline-flex' : 'none';
}

function saveProfile() {
  const u = allUsers[currentUser];
  u.name = document.getElementById('profile-name').value;
  u.email = document.getElementById('profile-email').value;
  u.age = parseInt(document.getElementById('profile-age').value) || u.age;
  u.gender = document.getElementById('profile-gender').value;
  u.height = parseInt(document.getElementById('profile-height').value) || u.height;
  u.weight = parseInt(document.getElementById('profile-weight').value) || u.weight;
  u.cals_goal = parseInt(document.getElementById('profile-cal-goal').value) || 1800;
  u.protein_goal = parseInt(document.getElementById('profile-protein-goal').value) || 120;
  u.fat_goal = parseInt(document.getElementById('profile-fat-goal').value) || 60;
  u.carbs_goal = parseInt(document.getElementById('profile-carbs-goal').value) || 200;
  u.goal = document.getElementById('profile-goal').value;
  saveStorage();
  refreshSidebarUser();
  refreshSidebarWhatsApp();
  document.getElementById('profile-saved').style.display = 'block';
  setTimeout(() => document.getElementById('profile-saved').style.display = 'none', 2000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PWA ‚Äî INSTALL & SERVICE WORKER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let deferredInstallPrompt = null;

// Catch the beforeinstallprompt event (Android Chrome)
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredInstallPrompt = e;
  // Show the install card on the Install page if it's open
  const card = document.getElementById('install-prompt-card');
  if (card) card.style.display = 'block';
});

// After install
window.addEventListener('appinstalled', () => {
  deferredInstallPrompt = null;
  const card = document.getElementById('install-prompt-card');
  if (card) {
    card.innerHTML = '<div class="card" style="border-color:rgba(74,222,128,0.4);background:var(--green-glow);padding:20px;text-align:center;"><div style="font-size:40px;">üéâ</div><div style="font-weight:700;font-size:16px;margin-top:10px;">Successfully Installed!</div><div style="font-size:13px;color:var(--text-dim);margin-top:6px;">Chingone is now on your home screen.</div></div>';
  }
});

function triggerPWAInstall() {
  if (deferredInstallPrompt) {
    deferredInstallPrompt.prompt();
    deferredInstallPrompt.userChoice.then((choice) => {
      deferredInstallPrompt = null;
    });
  } else {
    // iOS or already installed ‚Äî show instructions
    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    if (isIOS) {
      alert('On iPhone:\n\n1. Tap the Share button (‚¨Ü) at the bottom of Safari\n2. Scroll down and tap "Add to Home Screen"\n3. Tap "Add" in the top right\n\nMake sure you\'re using Safari, not Chrome.');
    } else {
      alert('To install:\n\nTap the ‚ãÆ menu in Chrome ‚Üí "Add to Home screen" or "Install app"');
    }
  }
}

function updateShareMessage() {
  const url = document.getElementById('app-url-input').value.trim();
  if (url) localStorage.setItem('vt_app_url', url);
  const box  = document.getElementById('share-message-box');
  const text = document.getElementById('share-message-text');
  if (!url) { box.style.display = 'none'; return; }
  box.style.display = 'block';
  text.textContent =
    'üëã Hey everyone!\n\n' +
    'I set up our group health tracker app ‚Äî Chingone Life Tracker üí™\n\n' +
    'üì≤ Open this link on your phone:\n' + url + '\n\n' +
    'Then:\n' +
    '‚Ä¢ iPhone: Tap Share ‚¨Ü ‚Üí "Add to Home Screen"\n' +
    '‚Ä¢ Android: Tap ‚ãÆ menu ‚Üí "Add to Home screen"\n\n' +
    'It installs like a real app! Create your account once you\'re in. üèãÔ∏èü•ó';
}

function copyShareMessage() {
  const text = document.getElementById('share-message-text').textContent;
  navigator.clipboard.writeText(text).then(() => {
    const el = document.getElementById('share-copied');
    el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 2500);
  }).catch(() => {
    // Fallback for older browsers
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    const el = document.getElementById('share-copied');
    el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 2500);
  });
}

// Register inline Service Worker for offline support
function registerServiceWorker() {
  if (!('serviceWorker' in navigator)) return;

  // Build SW code as a base64 data URI ‚Äî works without HTTPS hosting restriction on blob URLs
  const swCode = [
    "const CACHE='chingone-v2';",
    "self.addEventListener('install',e=>{",
    "  e.waitUntil(caches.open(CACHE).then(c=>c.add(self.location.href)));",
    "  self.skipWaiting();",
    "});",
    "self.addEventListener('activate',e=>{",
    "  e.waitUntil(caches.keys().then(ks=>Promise.all(ks.filter(k=>k!==CACHE).map(k=>caches.delete(k)))));",
    "  self.clients.claim();",
    "});",
    "self.addEventListener('fetch',e=>{",
    "  if(e.request.mode==='navigate'){",
    "    e.respondWith(fetch(e.request).catch(()=>caches.match(e.request).then(r=>r||caches.open(CACHE).then(c=>c.match(self.location.href)))));",
    "  } else {",
    "    e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));",
    "  }",
    "});"
  ].join('\n');

  // Encode as base64 data URI ‚Äî supported in all browsers, no blob URL needed
  const b64 = btoa(unescape(encodeURIComponent(swCode)));
  const swUrl = 'data:application/javascript;base64,' + b64;

  navigator.serviceWorker.register(swUrl, { scope: './' })
    .then(() => console.log('‚úÖ Service Worker registered ‚Äî app works offline!'))
    .catch(err => {
      // Will fail on local file:// ‚Äî works fine once hosted on HTTPS
      if (!err.message.includes('protocol')) {
        console.log('SW registration note:', err.message);
      }
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMPORT DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let importLogs = [];

function renderImportPage() {
  // Just make sure the first tab is active on load
  const panels = document.querySelectorAll('.platform-panel');
  panels.forEach(p => p.classList.remove('active'));
  const first = document.getElementById('import-panel-fitbit');
  if (first) first.classList.add('active');
}

function switchImportTab(platform, btn) {
  document.querySelectorAll('.import-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.platform-panel').forEach(p => p.classList.remove('active'));
  const panel = document.getElementById('import-panel-' + platform);
  if (panel) panel.classList.add('active');
}

function handleDragOver(e, id) {
  e.preventDefault();
  document.getElementById('dz-' + id).classList.add('drag-over');
}
function handleDragLeave(id) {
  document.getElementById('dz-' + id).classList.remove('drag-over');
}
function handleDrop(e, dzId, platform) {
  e.preventDefault();
  document.getElementById('dz-' + dzId).classList.remove('drag-over');
  processFiles(Array.from(e.dataTransfer.files), platform);
}
function handleFileSelect(e, platform) {
  processFiles(Array.from(e.target.files), platform);
  e.target.value = '';
}

function processFiles(files, platform) {
  importLogs = [];
  let processed = 0;
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const text = e.target.result;
      try {
        if (platform === 'fitbit')  parseFitbit(text, file.name);
        else if (platform === 'mfp') parseMFP(text, file.name);
        else if (platform === 'apple') parseAppleHealth(text, file.name);
        else if (platform === 'csv')   parseGenericCSV(text, file.name);
      } catch(err) {
        importLogs.push('‚ùå Error parsing ' + file.name + ': ' + err.message);
      }
      processed++;
      if (processed === files.length) {
        showImportLog();
        showImportPreview(platform);
      }
    };
    if (file.name.endsWith('.xml')) reader.readAsText(file);
    else reader.readAsText(file);
  });
}

// ‚îÄ‚îÄ PARSE CSV helper ‚îÄ‚îÄ
function parseCSVText(text) {
  const lines = text.trim().split('\n');
  if (lines.length < 2) return [];
  const headers = lines[0].split(',').map(h => h.replace(/"/g,'').trim().toLowerCase());
  return lines.slice(1).filter(l => l.trim()).map(line => {
    const vals = splitCSVLine(line);
    const row = {};
    headers.forEach((h,i) => row[h] = (vals[i] || '').replace(/"/g,'').trim());
    return row;
  });
}

function splitCSVLine(line) {
  const result = [];
  let cur = '', inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    if (line[i] === '"') { inQuotes = !inQuotes; }
    else if (line[i] === ',' && !inQuotes) { result.push(cur); cur = ''; }
    else { cur += line[i]; }
  }
  result.push(cur);
  return result;
}

function normalizeDate(str) {
  if (!str) return null;
  // Try YYYY-MM-DD
  if (/^\d{4}-\d{2}-\d{2}/.test(str)) return str.slice(0,10);
  // Try MM/DD/YYYY
  const mdy = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
  if (mdy) return mdy[3] + '-' + mdy[1].padStart(2,'0') + '-' + mdy[2].padStart(2,'0');
  // Try DD/MM/YYYY
  const dmy = str.match(/^(\d{1,2})-(\d{1,2})-(\d{4})/);
  if (dmy) return dmy[3] + '-' + dmy[2].padStart(2,'0') + '-' + dmy[1].padStart(2,'0');
  return str.slice(0,10);
}

function safeParse(v) { return parseFloat(String(v).replace(/,/g,'')) || 0; }

// ‚îÄ‚îÄ FITBIT PARSER ‚îÄ‚îÄ
function parseFitbit(text, filename) {
  const rows = parseCSVText(text);
  if (!rows.length) { importLogs.push('‚ö†Ô∏è ' + filename + ': no data found'); return; }
  const u = allUsers[currentUser];
  if (!u.foodLog) u.foodLog = {};

  let foodCount = 0, workoutCount = 0;
  const fn = filename.toLowerCase();

  // Detect file type by headers
  const headers = Object.keys(rows[0]);
  const isFood     = headers.some(h => h.includes('calori') || h.includes('food') || h.includes('meal'));
  const isActivity = headers.some(h => h.includes('activit') || h.includes('duration') || h.includes('steps'));

  rows.forEach(row => {
    const dateRaw = row['date'] || row['log date'] || row['start time'] || '';
    const date = normalizeDate(dateRaw);
    if (!date) return;

    if (isFood) {
      const kcal    = safeParse(row['calories'] || row['energy (kcal)'] || row['cal'] || 0);
      const protein = safeParse(row['protein (g)'] || row['protein'] || 0);
      const carbs   = safeParse(row['carbohydrates (g)'] || row['carbs'] || row['carbohydrates'] || 0);
      const fat     = safeParse(row['fat (g)'] || row['fat'] || row['total fat'] || 0);
      const name    = row['food name'] || row['name'] || row['description'] || 'Fitbit Import';
      const meal    = normalizeMeal(row['meal'] || row['meal name'] || row['type'] || 'snack');

      if (!u.foodLog[date]) u.foodLog[date] = {};
      if (!u.foodLog[date][meal]) u.foodLog[date][meal] = [];
      u.foodLog[date][meal].push({ name, brand: 'Fitbit Import', kcal, protein, carbs, fat, fiber:0, sugar:0, sodium:0, qty:100, _imported: true });
      foodCount++;
    }

    if (isActivity) {
      const activity  = row['activity name'] || row['activity type'] || row['activity'] || 'Fitbit Activity';
      const duration  = safeParse(row['duration'] || row['duration (min)'] || row['minutes'] || 0);
      const calories  = safeParse(row['calories burned'] || row['calories'] || 0);
      const steps     = safeParse(row['steps'] || 0);
      if (!u.workoutLog) u.workoutLog = {};
      if (!u.workoutLog[date]) u.workoutLog[date] = [];
      u.workoutLog[date].push({
        activity: activity, name: steps ? steps + ' steps' : '',
        duration: Math.round(duration), calories: Math.round(calories),
        intensity: 'Moderate', exercises: [], notes: 'Imported from Fitbit', timestamp: Date.now(), _imported: true
      });
      workoutCount++;
    }
  });

  saveStorage();
  if (foodCount)    importLogs.push('‚úÖ ' + filename + ': imported ' + foodCount + ' food entries');
  if (workoutCount) importLogs.push('‚úÖ ' + filename + ': imported ' + workoutCount + ' workout sessions');
  if (!foodCount && !workoutCount) importLogs.push('‚ö†Ô∏è ' + filename + ': no recognizable data found');
}

// ‚îÄ‚îÄ MYFITNESSPAL PARSER ‚îÄ‚îÄ
function parseMFP(text, filename) {
  const rows = parseCSVText(text);
  if (!rows.length) { importLogs.push('‚ö†Ô∏è ' + filename + ': no data found'); return; }
  const u = allUsers[currentUser];
  if (!u.foodLog) u.foodLog = {};
  let count = 0;

  rows.forEach(row => {
    const dateRaw = row['date'] || row['day'] || '';
    const date = normalizeDate(dateRaw);
    if (!date) return;

    const kcal    = safeParse(row['calories'] || row['energy (kcal)'] || row['cal'] || 0);
    const protein = safeParse(row['protein (g)'] || row['protein'] || 0);
    const carbs   = safeParse(row['carbohydrates (g)'] || row['carbohydrates'] || row['carbs'] || 0);
    const fat     = safeParse(row['fat (g)'] || row['fat'] || 0);
    const fiber   = safeParse(row['fiber (g)'] || row['fiber'] || 0);
    const sugar   = safeParse(row['sugar (g)'] || row['sugar'] || 0);
    const sodium  = safeParse(row['sodium (mg)'] || row['sodium'] || 0);
    const name    = row['name'] || row['food name'] || row['description'] || 'MFP Import';
    const meal    = normalizeMeal(row['meal'] || row['meal name'] || 'snack');

    if (kcal === 0 && protein === 0 && carbs === 0) return; // skip empty rows

    if (!u.foodLog[date]) u.foodLog[date] = {};
    if (!u.foodLog[date][meal]) u.foodLog[date][meal] = [];
    u.foodLog[date][meal].push({ name, brand: 'MyFitnessPal Import', kcal, protein, carbs, fat, fiber, sugar, sodium, qty:100, _imported: true });
    count++;
  });

  saveStorage();
  importLogs.push(count > 0
    ? '‚úÖ ' + filename + ': imported ' + count + ' food entries from MyFitnessPal'
    : '‚ö†Ô∏è ' + filename + ': no recognizable MFP data found');
}

// ‚îÄ‚îÄ APPLE HEALTH XML PARSER ‚îÄ‚îÄ
function parseAppleHealth(text, filename) {
  const u = allUsers[currentUser];
  if (!u.workoutLog) u.workoutLog = {};
  if (!u.foodLog)    u.foodLog = {};

  let workoutCount = 0, nutritionCount = 0;

  try {
    const parser = new DOMParser();
    const xml    = parser.parseFromString(text, 'text/xml');

    // Workouts
    const workouts = xml.querySelectorAll('Workout');
    workouts.forEach(w => {
      const type     = (w.getAttribute('workoutActivityType') || '').replace('HKWorkoutActivityType','');
      const start    = w.getAttribute('startDate') || '';
      const date     = normalizeDate(start);
      if (!date) return;
      const duration = parseFloat(w.getAttribute('duration') || 0);
      const kcal     = parseFloat(w.getAttribute('totalEnergyBurned') || 0);
      if (!u.workoutLog[date]) u.workoutLog[date] = [];
      u.workoutLog[date].push({
        activity: type || 'Apple Health Workout', name: '',
        duration: Math.round(duration), calories: Math.round(kcal),
        intensity: 'Moderate', exercises: [], notes: 'Imported from Apple Health', timestamp: Date.now(), _imported: true
      });
      workoutCount++;
    });

    // Nutrition records
    const nutritionTypes = {
      'HKQuantityTypeIdentifierDietaryEnergyConsumed': 'kcal',
      'HKQuantityTypeIdentifierDietaryProtein':        'protein',
      'HKQuantityTypeIdentifierDietaryCarbohydrates':  'carbs',
      'HKQuantityTypeIdentifierDietaryFatTotal':       'fat',
      'HKQuantityTypeIdentifierDietaryFiber':          'fiber',
      'HKQuantityTypeIdentifierDietarySodium':         'sodium',
      'HKQuantityTypeIdentifierDietarySugar':          'sugar'
    };
    const byDate = {};
    const records = xml.querySelectorAll('Record');
    records.forEach(r => {
      const type  = r.getAttribute('type') || '';
      const key   = nutritionTypes[type];
      if (!key) return;
      const start = r.getAttribute('startDate') || '';
      const date  = normalizeDate(start);
      if (!date) return;
      const val   = parseFloat(r.getAttribute('value') || 0);
      if (!byDate[date]) byDate[date] = { kcal:0, protein:0, carbs:0, fat:0, fiber:0, sodium:0, sugar:0 };
      if (key === 'kcal') byDate[date].kcal += val;
      else byDate[date][key] += val;
    });

    Object.entries(byDate).forEach(([date, n]) => {
      if (!n.kcal && !n.protein && !n.carbs && !n.fat) return;
      if (!u.foodLog[date]) u.foodLog[date] = {};
      if (!u.foodLog[date]['snack']) u.foodLog[date]['snack'] = [];
      u.foodLog[date]['snack'].push({
        name: 'Apple Health Daily Nutrition', brand: 'Apple Health',
        kcal: Math.round(n.kcal), protein: Math.round(n.protein*10)/10,
        carbs: Math.round(n.carbs*10)/10, fat: Math.round(n.fat*10)/10,
        fiber: Math.round(n.fiber*10)/10, sugar: Math.round(n.sugar*10)/10, sodium: Math.round(n.sodium),
        qty: 100, _imported: true
      });
      nutritionCount++;
    });

    saveStorage();
    if (workoutCount)   importLogs.push('‚úÖ ' + filename + ': imported ' + workoutCount + ' Apple Health workouts');
    if (nutritionCount) importLogs.push('‚úÖ ' + filename + ': imported nutrition data for ' + nutritionCount + ' days');
    if (!workoutCount && !nutritionCount) importLogs.push('‚ö†Ô∏è ' + filename + ': no Workout or Nutrition records found in XML');

  } catch(err) {
    importLogs.push('‚ùå ' + filename + ': XML parse error ‚Äî ' + err.message);
  }
}

// ‚îÄ‚îÄ GENERIC CSV PARSER ‚îÄ‚îÄ
function parseGenericCSV(text, filename) {
  const rows = parseCSVText(text);
  if (!rows.length) { importLogs.push('‚ö†Ô∏è ' + filename + ': empty or unreadable file'); return; }
  const u = allUsers[currentUser];
  if (!u.foodLog) u.foodLog = {};
  let count = 0;

  // Try to find date and nutrition columns by fuzzy matching
  const colMap = (row) => {
    const k = Object.keys(row);
    const find = (...terms) => k.find(h => terms.some(t => h.includes(t))) || '';
    return {
      date:    find('date','day','time'),
      kcal:    find('calori','kcal','energy','cal'),
      protein: find('protein'),
      carbs:   find('carb','carbohy'),
      fat:     find('fat','lipid'),
      fiber:   find('fiber','fibre'),
      sugar:   find('sugar'),
      sodium:  find('sodium','salt'),
      name:    find('food','name','desc','item','meal name'),
      meal:    find('meal','type','category'),
    };
  };
  const cols = colMap(rows[0]);

  rows.forEach(row => {
    const dateRaw = row[cols.date] || '';
    const date = normalizeDate(dateRaw);
    if (!date) return;
    const kcal    = safeParse(row[cols.kcal] || 0);
    const protein = safeParse(row[cols.protein] || 0);
    const carbs   = safeParse(row[cols.carbs] || 0);
    const fat     = safeParse(row[cols.fat] || 0);
    if (!kcal && !protein && !carbs) return;
    const name = row[cols.name] || 'CSV Import';
    const meal = normalizeMeal(row[cols.meal] || 'snack');
    if (!u.foodLog[date]) u.foodLog[date] = {};
    if (!u.foodLog[date][meal]) u.foodLog[date][meal] = [];
    u.foodLog[date][meal].push({
      name, brand: 'CSV Import', kcal, protein, carbs, fat,
      fiber: safeParse(row[cols.fiber]||0), sugar: safeParse(row[cols.sugar]||0),
      sodium: safeParse(row[cols.sodium]||0), qty: 100, _imported: true
    });
    count++;
  });

  saveStorage();
  importLogs.push(count > 0
    ? '‚úÖ ' + filename + ': imported ' + count + ' entries'
    : '‚ö†Ô∏è ' + filename + ': could not find recognizable columns. Expected: date, calories, protein, carbs, fat');
}

function normalizeMeal(val) {
  const v = String(val).toLowerCase();
  if (v.includes('break') || v.includes('morning')) return 'breakfast';
  if (v.includes('lunch') || v.includes('midday') || v.includes('noon')) return 'lunch';
  if (v.includes('dinner') || v.includes('supper') || v.includes('evening')) return 'dinner';
  return 'snack';
}

function showImportLog() {
  const log = document.getElementById('import-log');
  const content = document.getElementById('import-log-content');
  if (!log || !content) return;
  log.style.display = 'block';
  content.innerHTML = importLogs.map(l => {
    const color = l.startsWith('‚úÖ') ? 'var(--green)' : l.startsWith('‚ùå') ? 'var(--red)' : 'var(--accent)';
    return `<div style="color:${color}">${escHtml(l)}</div>`;
  }).join('');
  log.scrollIntoView({ behavior:'smooth', block:'nearest' });
}

function showImportPreview(platform) {
  const u = allUsers[currentUser];
  const container = document.getElementById('import-preview-' + platform);
  if (!container) return;

  // Count totals
  const foodLog = u.foodLog || {};
  const workLog = u.workoutLog || {};
  const importedFoodDates = Object.keys(foodLog).filter(d =>
    Object.values(foodLog[d]).some(m => m.some(i => i._imported))
  ).length;
  const importedWorkDates = Object.keys(workLog).filter(d =>
    workLog[d].some(w => w._imported)
  ).length;

  if (!importedFoodDates && !importedWorkDates) return;

  container.innerHTML = `
    <div class="import-preview" style="margin-top:16px;">
      <div class="import-preview-title">‚úÖ Import Summary</div>
      ${importedFoodDates ? `
      <div class="import-stat">
        <span>Days with food data</span>
        <span class="import-stat-val" style="color:var(--green);">${importedFoodDates}</span>
      </div>` : ''}
      ${importedWorkDates ? `
      <div class="import-stat">
        <span>Days with workout data</span>
        <span class="import-stat-val" style="color:var(--blue);">${importedWorkDates}</span>
      </div>` : ''}
      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn btn-primary btn-sm" onclick="navigate('history')">üìÖ View in History</button>
        <button class="btn btn-outline btn-sm" onclick="navigate('dashboard')">üìä Back to Dashboard</button>
        <button class="btn btn-danger btn-sm" onclick="clearImportedData('${platform}')">üóë Clear Imported Data</button>
      </div>
    </div>`;
}

function clearImportedData(platform) {
  if (!confirm('Remove all imported data? Your manually logged entries will not be affected.')) return;
  const u = allUsers[currentUser];
  // Remove imported food entries
  Object.keys(u.foodLog || {}).forEach(date => {
    Object.keys(u.foodLog[date]).forEach(meal => {
      u.foodLog[date][meal] = (u.foodLog[date][meal] || []).filter(i => !i._imported);
    });
  });
  // Remove imported workouts
  Object.keys(u.workoutLog || {}).forEach(date => {
    u.workoutLog[date] = (u.workoutLog[date] || []).filter(w => !w._imported);
  });
  saveStorage();
  importLogs.push('üóë All imported data cleared.');
  showImportLog();
  const container = document.getElementById('import-preview-' + platform);
  if (container) container.innerHTML = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WHATSAPP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveWhatsApp() {
  const input  = document.getElementById('profile-whatsapp');
  const errEl  = document.getElementById('wa-error');
  const savedEl = document.getElementById('wa-saved');
  const waTest  = document.getElementById('wa-test-btn');
  const waClear = document.getElementById('wa-clear-btn');
  const val = input.value.trim();

  errEl.style.display = 'none';

  if (!val) {
    // Treat empty as a clear
    clearWhatsApp();
    return;
  }

  // Validate ‚Äî accept any URL that could be a WhatsApp link
  const isWaLink = val.includes('chat.whatsapp.com') || val.includes('whatsapp.com') || val.startsWith('https://wa.me/');
  if (!isWaLink) {
    errEl.style.display = 'block';
    return;
  }

  allUsers[currentUser].whatsapp = val;
  saveStorage();
  refreshSidebarWhatsApp();
  if (waTest)  waTest.style.display  = 'inline-flex';
  if (waClear) waClear.style.display = 'inline-flex';
  savedEl.style.display = 'block';
  setTimeout(() => savedEl.style.display = 'none', 2500);
}

function clearWhatsApp() {
  allUsers[currentUser].whatsapp = '';
  saveStorage();
  refreshSidebarWhatsApp();
  document.getElementById('profile-whatsapp').value = '';
  document.getElementById('wa-test-btn').style.display  = 'none';
  document.getElementById('wa-clear-btn').style.display = 'none';
  document.getElementById('wa-error').style.display = 'none';
}

function openWhatsApp() {
  const u = allUsers[currentUser];
  const link = u && u.whatsapp;
  if (!link) {
    alert('No WhatsApp group linked yet. Go to My Profile to add your group link.');
    navigate('profile');
    return;
  }
  window.open(link, '_blank');
}

function refreshSidebarWhatsApp() {
  const u   = allUsers[currentUser];
  const btn = document.getElementById('sidebar-whatsapp');
  if (btn) btn.style.display = (u && u.whatsapp) ? 'block' : 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// USERS GRID
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderUsersGrid() {
  const grid = document.getElementById('users-grid');
  const goalLabels = { lose_weight:'Lose Weight', build_muscle:'Build Muscle', maintain:'Maintain', improve_fitness:'Get Fit' };
  grid.innerHTML = Object.values(allUsers).map(u => `
    <div class="user-card ${u.username === currentUser ? 'active-user' : ''}" onclick="switchToUser('${u.username}')">
      <div class="uc-avatar">${u.name.charAt(0).toUpperCase()}</div>
      <div class="uc-name">${u.name}</div>
      <div class="uc-goal">${goalLabels[u.goal] || 'General Fitness'}</div>
      ${u.username === currentUser ? '<div style="margin-top:8px"><span class="badge badge-green">Active</span></div>' : ''}
    </div>
  `).join('');
}

function switchToUser(uname) {
  currentUser = uname;
  localStorage.setItem('vt_current', uname);
  refreshSidebarUser();
  refreshSidebarWhatsApp();
  navigate('dashboard');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOOGLE SHEETS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadSheetsPage() {
  if (gSheetsConfig && gSheetsConfig.connected) {
    document.getElementById('sheets-connected-banner').style.display = 'flex';
    document.getElementById('goog-client-id').value = gSheetsConfig.clientId || '';
    document.getElementById('goog-sheet-id').value = gSheetsConfig.sheetId || '';
  }
}

function connectGoogleSheets() {
  const clientId = document.getElementById('goog-client-id').value.trim();
  const sheetId = document.getElementById('goog-sheet-id').value.trim();
  const errEl = document.getElementById('sheets-err');
  const msgEl = document.getElementById('sheets-msg');
  
  if (!clientId || !sheetId) { errEl.style.display = 'block'; return; }
  errEl.style.display = 'none';
  
  // Initialize Google Identity Services
  const script = document.createElement('script');
  script.src = 'https://accounts.google.com/gsi/client';
  script.onload = () => {
    try {
      window.tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: clientId,
        scope: 'https://www.googleapis.com/auth/spreadsheets',
        callback: (tokenResponse) => {
          if (tokenResponse.access_token) {
            gSheetsConfig = { clientId, sheetId, connected: true, token: tokenResponse.access_token };
            localStorage.setItem('vt_sheets', JSON.stringify(gSheetsConfig));
            msgEl.style.display = 'block';
            document.getElementById('sheets-connected-banner').style.display = 'flex';
          }
        }
      });
      window.tokenClient.requestAccessToken();
    } catch(e) {
      errEl.textContent = 'Google OAuth failed: ' + e.message;
      errEl.style.display = 'block';
    }
  };
  document.head.appendChild(script);
}

async function syncEntryToSheets(food, meal, qty) {
  if (!gSheetsConfig || !gSheetsConfig.token) return;
  const f = qty / 100;
  const row = [currentLogDate, allUsers[currentUser].name, meal, food.name, qty,
    Math.round((food.kcal||0)*f), Math.round((food.protein||0)*f*10)/10,
    Math.round((food.carbs||0)*f*10)/10, Math.round((food.fat||0)*f*10)/10];
  
  try {
    await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${gSheetsConfig.sheetId}/values/A1:I1:append?valueInputOption=USER_ENTERED`, {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + gSheetsConfig.token, 'Content-Type': 'application/json' },
      body: JSON.stringify({ values: [row] })
    });
  } catch(e) { console.log('Sheets sync failed:', e); }
}

async function manualSyncSheets() {
  if (!gSheetsConfig || !gSheetsConfig.token) {
    alert('Please connect to Google Sheets first.'); return;
  }
  const u = allUsers[currentUser];
  const log = u.foodLog || {};
  const rows = [['Date','User','Meal','Food Name','Quantity (g)','Calories','Protein (g)','Carbs (g)','Fat (g)']];
  
  Object.keys(log).sort().forEach(date => {
    ['breakfast','lunch','dinner','snack'].forEach(meal => {
      (log[date][meal] || []).forEach(item => {
        const f = (item.qty||100)/100;
        rows.push([date, u.name, meal, item.name, item.qty||100,
          Math.round((item.kcal||0)*f), Math.round((item.protein||0)*f*10)/10,
          Math.round((item.carbs||0)*f*10)/10, Math.round((item.fat||0)*f*10)/10]);
      });
    });
  });
  
  try {
    await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${gSheetsConfig.sheetId}/values/A1:I${rows.length}?valueInputOption=USER_ENTERED`, {
      method: 'PUT',
      headers: { 'Authorization': 'Bearer ' + gSheetsConfig.token, 'Content-Type': 'application/json' },
      body: JSON.stringify({ values: rows })
    });
    document.getElementById('sync-msg').style.display = 'block';
    setTimeout(() => document.getElementById('sync-msg').style.display = 'none', 3000);
  } catch(e) { alert('Sync failed: ' + e.message); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CSV EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportCSV() {
  const u = allUsers[currentUser];
  const log = u.foodLog || {};
  const rows = [['Date','User','Meal','Food Name','Quantity (g)','Calories (kcal)','Protein (g)','Carbs (g)','Fat (g)','Fiber (g)','Sugar (g)','Sodium (mg)']];
  
  Object.keys(log).sort().forEach(date => {
    ['breakfast','lunch','dinner','snack'].forEach(meal => {
      (log[date][meal] || []).forEach(item => {
        const f = (item.qty||100)/100;
        rows.push([date, u.name, meal, '"'+item.name+'"', item.qty||100,
          Math.round((item.kcal||0)*f),
          Math.round((item.protein||0)*f*10)/10,
          Math.round((item.carbs||0)*f*10)/10,
          Math.round((item.fat||0)*f*10)/10,
          Math.round((item.fiber||0)*f*10)/10,
          Math.round((item.sugar||0)*f*10)/10,
          Math.round((item.sodium||0)*f*10)/10
        ]);
      });
    });
  });
  
  const csv = rows.map(r => r.join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `vitaltrack_${currentUser}_${getTodayStr()}.csv`;
  a.click();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLOSE DROPDOWN ON CLICK OUTSIDE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('click', (e) => {
  if (!e.target.closest('#food-search-input') && !e.target.closest('#search-dropdown')) {
    document.getElementById('search-dropdown').style.display = 'none';
  }
});


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORKOUT LOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentWorkoutDate = getTodayStr();
let selectedActivity = 'Weightlifting';
let exerciseRowCount = 0;

function changeWorkoutDate(delta) {
  const d = new Date(currentWorkoutDate + 'T12:00:00');
  d.setDate(d.getDate() + delta);
  if (d > new Date()) return;
  currentWorkoutDate = d.toISOString().split('T')[0];
  renderWorkoutLog();
}

function renderWorkoutLog() {
  const u = allUsers[currentUser];
  const workouts = ((u.workoutLog || {})[currentWorkoutDate]) || [];
  const isToday = currentWorkoutDate === getTodayStr();

  document.getElementById('workout-date-label').textContent = isToday
    ? 'Today ‚Äî ' + new Date().toLocaleDateString('en-US', {month:'short', day:'numeric'})
    : new Date(currentWorkoutDate + 'T12:00:00').toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric', year:'numeric'});

  // Streak
  const streak = calcWorkoutStreak();
  document.getElementById('workout-streak').textContent = streak > 1 ? 'üî• ' + streak + '-day streak!' : '';

  const container = document.getElementById('workout-sessions-container');
  const emptyState = document.getElementById('workout-empty-state');

  if (!workouts.length) {
    emptyState.style.display = 'block';
    container.innerHTML = '';
    container.appendChild(emptyState);
  } else {
    emptyState.style.display = 'none';
    container.innerHTML = workouts.map((w, wi) => buildSessionCard(w, wi, currentWorkoutDate)).join('');
  }

  // Recent workouts
  renderRecentWorkouts();
}

function buildSessionCard(w, wi, date) {
  const totalSets = (w.exercises || []).reduce((s, e) => s + (e.sets || []).length, 0);
  const totalVol = (w.exercises || []).reduce((v, e) =>
    v + (e.sets || []).reduce((sv, s) => sv + ((parseFloat(s.weight) || 0) * (parseInt(s.reps) || 0)), 0), 0);

  const exercisesHTML = (w.exercises || []).map(ex => {
    const setsRows = (ex.sets || []).map((s, si) => {
      const prCheck = checkPR(ex.name, s.weight, s.reps, date);
      return `<tr>
        <td>Set ${si + 1}</td>
        <td>${s.weight ? s.weight + ' lbs' : '‚Äî'}</td>
        <td>${s.reps || '‚Äî'}</td>
        <td>${s.weight && s.reps ? Math.round(s.weight * s.reps) : '‚Äî'}</td>
        <td>${prCheck ? '<span class="pr-badge">üèÜ PR</span>' : ''}</td>
      </tr>`;
    }).join('');
    return `<div class="exercise-block">
      <div class="exercise-block-name">üí™ ${ex.name}</div>
      <table class="sets-table">
        <thead><tr><th>Set</th><th>Weight</th><th>Reps</th><th>Volume</th><th></th></tr></thead>
        <tbody>${setsRows}</tbody>
      </table>
    </div>`;
  }).join('');

  return `<div class="workout-session-card">
    <div class="wsc-header" onclick="toggleSession(this)">
      <div>
        <div class="wsc-activity">${w.activity}${w.name ? ' ‚Äî ' + w.name : ''}</div>
        <div class="wsc-meta">
          ${w.duration ? '<span>‚è± ' + w.duration + ' min</span>' : ''}
          ${w.calories ? '<span>üî• ' + w.calories + ' kcal burned</span>' : ''}
          <span>üìã ${(w.exercises || []).length} exercise${(w.exercises||[]).length !== 1 ? 's' : ''}</span>
          <span>üî¢ ${totalSets} sets</span>
          ${totalVol > 0 ? '<span>‚öñÔ∏è ' + Math.round(totalVol).toLocaleString() + ' lbs total volume</span>' : ''}
          <span class="intensity-badge intensity-${w.intensity || 'Moderate'}">${w.intensity || 'Moderate'}</span>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation();deleteWorkout('${date}',${wi})">‚úï</button>
        <span style="color:var(--text-muted);font-size:18px;">‚ñæ</span>
      </div>
    </div>
    <div class="wsc-body">
      ${exercisesHTML || '<div style="color:var(--text-muted);font-size:13px;">No exercises recorded</div>'}
      ${w.notes ? '<div class="wsc-notes">üìù ' + w.notes + '</div>' : ''}
    </div>
  </div>`;
}

function toggleSession(header) {
  const body = header.nextElementSibling;
  body.style.display = body.style.display === 'none' ? 'block' : 'none';
}

function deleteWorkout(date, idx) {
  if (!confirm('Delete this workout?')) return;
  const u = allUsers[currentUser];
  u.workoutLog[date].splice(idx, 1);
  saveStorage();
  renderWorkoutLog();
}

function calcWorkoutStreak() {
  const u = allUsers[currentUser];
  const log = u.workoutLog || {};
  let streak = 0;
  const d = new Date();
  while (true) {
    const key = d.toISOString().split('T')[0];
    if (log[key] && log[key].length > 0) { streak++; }
    else if (streak > 0) break;
    d.setDate(d.getDate() - 1);
    if (streak === 0 && key < getTodayStr()) break;
    if (d < new Date('2020-01-01')) break;
  }
  return streak;
}

function checkPR(exerciseName, weight, reps, currentDate) {
  if (!weight || !reps) return false;
  const u = allUsers[currentUser];
  const log = u.workoutLog || {};
  const vol = parseFloat(weight) * parseInt(reps);
  for (const [date, sessions] of Object.entries(log)) {
    if (date >= currentDate) continue;
    for (const session of sessions) {
      for (const ex of (session.exercises || [])) {
        if (ex.name.toLowerCase() === exerciseName.toLowerCase()) {
          for (const s of (ex.sets || [])) {
            if (s.weight && s.reps && parseFloat(s.weight) * parseInt(s.reps) >= vol) return false;
          }
        }
      }
    }
  }
  return true;
}

function renderRecentWorkouts() {
  const u = allUsers[currentUser];
  const log = u.workoutLog || {};
  const allDates = Object.keys(log).filter(d => log[d].length > 0).sort().reverse().slice(0, 5);
  const card = document.getElementById('workout-history-card');
  const list = document.getElementById('workout-recent-list');
  if (!allDates.length) { card.style.display = 'none'; return; }
  card.style.display = 'block';
  list.innerHTML = allDates.map(date => {
    const sessions = log[date];
    const label = date === getTodayStr() ? 'Today' : new Date(date + 'T12:00:00').toLocaleDateString('en-US', {month:'short', day:'numeric'});
    return `<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);">
      <div>
        <div style="font-size:13px;font-weight:600;">${label}</div>
        <div style="font-size:12px;color:var(--text-dim);margin-top:2px;">${sessions.map(s => s.activity + (s.name ? ' ‚Äì ' + s.name : '')).join(', ')}</div>
      </div>
      <div style="font-size:12px;color:var(--text-muted);">${sessions.reduce((t,s) => t + (s.exercises||[]).length, 0)} exercises</div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ WORKOUT MODAL ‚îÄ‚îÄ
function openAddWorkout() {
  // Reset form
  selectedActivity = 'Weightlifting';
  document.querySelectorAll('.activity-chip').forEach(c => c.classList.toggle('active', c.textContent.includes('Weightlifting')));
  document.getElementById('wm-activity-custom').style.display = 'none';
  document.getElementById('wm-name').value = '';
  document.getElementById('wm-duration').value = '';
  document.getElementById('wm-intensity').value = 'Moderate';
  document.getElementById('wm-calories').value = '';
  document.getElementById('wm-notes').value = '';
  document.getElementById('wm-error').style.display = 'none';
  document.getElementById('exercise-rows-container').innerHTML = '';
  exerciseRowCount = 0;
  document.getElementById('no-exercises-msg').style.display = 'block';
  // Add first exercise row by default
  addExerciseRow();
  document.getElementById('add-workout-modal').classList.add('open');
}

function closeWorkoutModal() {
  document.getElementById('add-workout-modal').classList.remove('open');
}

function selectActivity(btn, name) {
  document.querySelectorAll('.activity-chip').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  selectedActivity = name;
  const customInput = document.getElementById('wm-activity-custom');
  customInput.style.display = name === 'Other' ? 'block' : 'none';
  if (name === 'Other') customInput.focus();
}

function addExerciseRow() {
  document.getElementById('no-exercises-msg').style.display = 'none';
  const id = exerciseRowCount++;
  const row = document.createElement('div');
  row.className = 'exercise-row';
  row.id = 'ex-row-' + id;
  row.innerHTML = `
    <div class="exercise-row-header">
      <input class="exercise-name-input" id="ex-name-${id}" placeholder="Exercise name (e.g. Bench Press, Squat, Deadlift...)" autocomplete="off">
      <button type="button" class="del-exercise-btn" onclick="deleteExerciseRow(${id})" title="Remove exercise">‚úï</button>
    </div>
    <div class="sets-grid" style="margin-bottom:4px;">
      <div class="sets-header">#</div>
      <div class="sets-header">Weight (lbs)</div>
      <div class="sets-header">Reps</div>
      <div class="sets-header">Notes</div>
      <div></div>
    </div>
    <div id="ex-sets-${id}"></div>
    <button type="button" class="add-set-btn" onclick="addSetRow(${id})">Ôºã Add Set</button>
  `;
  document.getElementById('exercise-rows-container').appendChild(row);
  addSetRow(id); // start with one set
}

function addSetRow(exId) {
  const container = document.getElementById('ex-sets-' + exId);
  const setNum = container.children.length + 1;
  const setDiv = document.createElement('div');
  setDiv.className = 'sets-grid';
  setDiv.innerHTML = `
    <div class="set-num">${setNum}</div>
    <input class="set-input" type="number" placeholder="0" min="0" step="2.5">
    <input class="set-input" type="number" placeholder="0" min="0">
    <input class="set-input" type="text" placeholder="notes" style="font-family:'DM Sans',sans-serif;text-align:left;padding-left:8px;">
    <button type="button" class="del-set-btn" onclick="this.parentElement.remove();renumberSets(${exId})">‚úï</button>
  `;
  container.appendChild(setDiv);
}

function renumberSets(exId) {
  const container = document.getElementById('ex-sets-' + exId);
  Array.from(container.children).forEach((row, i) => {
    const numEl = row.querySelector('.set-num');
    if (numEl) numEl.textContent = i + 1;
  });
}

function deleteExerciseRow(id) {
  const row = document.getElementById('ex-row-' + id);
  if (row) row.remove();
  if (!document.getElementById('exercise-rows-container').children.length) {
    document.getElementById('no-exercises-msg').style.display = 'block';
  }
}

function confirmAddWorkout() {
  const activity = selectedActivity === 'Other'
    ? (document.getElementById('wm-activity-custom').value.trim() || 'Other')
    : selectedActivity;

  const exercises = [];
  document.querySelectorAll('.exercise-row').forEach(row => {
    const exId = row.id.replace('ex-row-', '');
    const nameEl = document.getElementById('ex-name-' + exId);
    const name = nameEl ? nameEl.value.trim() : '';
    if (!name) return;
    const sets = [];
    const setsContainer = document.getElementById('ex-sets-' + exId);
    if (setsContainer) {
      Array.from(setsContainer.children).forEach(setRow => {
        const inputs = setRow.querySelectorAll('input');
        if (inputs.length >= 2) {
          sets.push({
            weight: inputs[0].value || '',
            reps:   inputs[1].value || '',
            notes:  inputs[2] ? inputs[2].value : ''
          });
        }
      });
    }
    exercises.push({ name, sets });
  });

  const workout = {
    activity,
    name:      document.getElementById('wm-name').value.trim(),
    duration:  document.getElementById('wm-duration').value,
    intensity: document.getElementById('wm-intensity').value,
    calories:  document.getElementById('wm-calories').value,
    notes:     document.getElementById('wm-notes').value.trim(),
    exercises,
    timestamp: Date.now()
  };

  const u = allUsers[currentUser];
  if (!u.workoutLog) u.workoutLog = {};
  if (!u.workoutLog[currentWorkoutDate]) u.workoutLog[currentWorkoutDate] = [];
  u.workoutLog[currentWorkoutDate].push(workout);
  saveStorage();
  closeWorkoutModal();
  renderWorkoutLog();
}

// ‚îÄ‚îÄ WORKOUT HISTORY PAGE ‚îÄ‚îÄ
function renderWorkoutHistory() {
  const u = allUsers[currentUser];
  const log = u.workoutLog || {};
  const allDates = Object.keys(log).filter(d => log[d].length > 0).sort().reverse();
  const container = document.getElementById('workout-history-full');
  if (!allDates.length) {
    container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:48px;font-size:14px;">No workouts logged yet.</div>';
    return;
  }
  container.innerHTML = allDates.map(date => {
    const label = new Date(date + 'T12:00:00').toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric', year:'numeric'});
    return `<div style="margin-bottom:28px;">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:1px;color:var(--text-dim);margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border);">${label}</div>
      ${log[date].map((w, wi) => buildSessionCard(w, wi, date)).join('')}
    </div>`;
  }).join('');
}

function exportWorkoutCSV() {
  const u = allUsers[currentUser];
  const log = u.workoutLog || {};
  const rows = [['Date','User','Activity','Workout Name','Duration (min)','Intensity','Calories Burned','Exercise','Set','Weight (lbs)','Reps','Volume (lbs)','Set Notes','Workout Notes']];
  Object.keys(log).sort().forEach(date => {
    (log[date] || []).forEach(w => {
      if (!(w.exercises || []).length) {
        rows.push([date, u.name, w.activity, w.name||'', w.duration||'', w.intensity||'', w.calories||'', '', '', '', '', '', '', w.notes||'']);
      } else {
        w.exercises.forEach(ex => {
          (ex.sets || []).forEach((s, si) => {
            const vol = (parseFloat(s.weight)||0) * (parseInt(s.reps)||0);
            rows.push([date, u.name, w.activity, w.name||'', w.duration||'', w.intensity||'', w.calories||'',
              ex.name, si+1, s.weight||'', s.reps||'', vol||'', s.notes||'', w.notes||'']);
          });
        });
      }
    });
  });
  const csv = rows.map(r => r.map(v => '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'workout_log_' + currentUser + '_' + getTodayStr() + '.csv';
  a.click();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RECIPES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentRecipeFilter = 'all';
let currentRecipeId = null;
let recipeEmoji = 'ü•ó';
let ingredientCount = 0;
let stepCount = 0;

// Seed some demo recipes on first load
function seedDemoRecipes() {
  const existing = getSharedRecipes();
  if (existing.length > 0) return;
  const demos = [
    {
      id: 'demo1', emoji: 'ü•ó', name: 'High-Protein Chicken & Quinoa Bowl',
      desc: 'A filling, macro-balanced lunch bowl that preps in 20 minutes.',
      category: 'lunch', servings: 2, prep: '10 mins', cook: '20 mins',
      kcal: 480, protein: 42, carbs: 38, fat: 14,
      ingredients: [
        {amount:'200', unit:'g', name:'Chicken breast, grilled & sliced'},
        {amount:'1', unit:'cup', name:'Quinoa, cooked'},
        {amount:'1', unit:'cup', name:'Spinach'},
        {amount:'¬Ω', unit:'cup', name:'Cherry tomatoes, halved'},
        {amount:'¬º', unit:'cup', name:'Cucumber, diced'},
        {amount:'2', unit:'tbsp', name:'Lemon tahini dressing'},
      ],
      steps: [
        'Cook quinoa per package directions and let cool slightly.',
        'Season and grill chicken breast until cooked through (165¬∞F). Slice thin.',
        'Arrange quinoa as the base in two bowls.',
        'Top with spinach, cherry tomatoes, and cucumber.',
        'Layer sliced chicken on top and drizzle with tahini dressing.',
        'Season with salt, pepper, and a squeeze of fresh lemon. Serve immediately.'
      ],
      tags: ['high-protein','meal-prep','gluten-free'],
      author: 'Sarah Johnson', date: '2026-02-10'
    },
    {
      id: 'demo2', emoji: 'ü•£', name: 'Overnight Oats with Berries',
      desc: 'Zero cook time ‚Äî just mix the night before for a perfect high-fiber breakfast.',
      category: 'breakfast', servings: 1, prep: '5 mins', cook: 'None',
      kcal: 340, protein: 18, carbs: 52, fat: 7,
      ingredients: [
        {amount:'¬Ω', unit:'cup', name:'Rolled oats'},
        {amount:'¬æ', unit:'cup', name:'Unsweetened almond milk'},
        {amount:'¬Ω', unit:'cup', name:'Greek yogurt (nonfat)'},
        {amount:'1', unit:'tbsp', name:'Chia seeds'},
        {amount:'1', unit:'tsp', name:'Honey'},
        {amount:'¬Ω', unit:'cup', name:'Mixed berries (fresh or frozen)'},
      ],
      steps: [
        'Combine oats, almond milk, Greek yogurt, and chia seeds in a jar or container.',
        'Stir in honey and mix well.',
        'Seal and refrigerate overnight (at least 6 hours).',
        'In the morning, top with fresh or thawed berries.',
        'Add a dash of cinnamon or vanilla extract if desired.'
      ],
      tags: ['high-fiber','no-cook','meal-prep'],
      author: 'Mike Chen', date: '2026-02-12'
    },
    {
      id: 'demo3', emoji: 'ü•§', name: 'Post-Workout Green Protein Smoothie',
      desc: 'Packed with protein and greens ‚Äî perfect within 30 minutes of your workout.',
      category: 'smoothie', servings: 1, prep: '5 mins', cook: 'None',
      kcal: 290, protein: 30, carbs: 28, fat: 5,
      ingredients: [
        {amount:'1', unit:'scoop', name:'Vanilla whey protein powder'},
        {amount:'1', unit:'cup', name:'Unsweetened almond milk'},
        {amount:'1', unit:'cup', name:'Spinach or kale'},
        {amount:'¬Ω', unit:'', name:'Banana (frozen)'},
        {amount:'¬Ω', unit:'cup', name:'Frozen mango chunks'},
        {amount:'1', unit:'tsp', name:'Chia seeds'},
      ],
      steps: [
        'Add almond milk to blender first (helps blending).',
        'Add spinach/kale and blend until smooth.',
        'Add banana, mango, protein powder, and chia seeds.',
        'Blend on high for 45‚Äì60 seconds until completely smooth.',
        'Pour into a glass and drink immediately for best nutrition.'
      ],
      tags: ['post-workout','high-protein','vegan-option'],
      author: 'Sarah Johnson', date: '2026-02-14'
    }
  ];
  saveSharedRecipes(demos);
}

function getSharedRecipes() {
  try { return JSON.parse(localStorage.getItem('vt_recipes') || '[]'); } catch(e) { return []; }
}

function saveSharedRecipes(recipes) {
  localStorage.setItem('vt_recipes', JSON.stringify(recipes));
}

function renderRecipes() {
  const q = (document.getElementById('recipe-search')?.value || '').toLowerCase();
  let recipes = getSharedRecipes();

  if (currentRecipeFilter !== 'all') {
    recipes = recipes.filter(r => r.category === currentRecipeFilter);
  }
  if (q) {
    recipes = recipes.filter(r =>
      r.name.toLowerCase().includes(q) ||
      (r.desc || '').toLowerCase().includes(q) ||
      (r.tags || []).some(t => t.toLowerCase().includes(q)) ||
      (r.author || '').toLowerCase().includes(q)
    );
  }

  const grid = document.getElementById('recipe-grid');
  const empty = document.getElementById('recipe-empty');

  if (!recipes.length) {
    grid.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  grid.innerHTML = recipes.map(r => {
    const hasMacros = r.kcal || r.protein || r.carbs || r.fat;
    const catClass = 'cat-' + (r.category || 'lunch');
    const tags = (r.tags || []).slice(0, 3).map(t => `<span class="recipe-tag">#${t}</span>`).join('');
    const macrosHTML = hasMacros ? `
      <div class="recipe-macros-row">
        ${r.kcal ? `<div class="recipe-macro"><div class="recipe-macro-val" style="color:var(--accent)">${r.kcal}</div><div class="recipe-macro-lbl">kcal</div></div>` : ''}
        ${r.protein ? `<div class="recipe-macro"><div class="recipe-macro-val" style="color:var(--green)">${r.protein}g</div><div class="recipe-macro-lbl">protein</div></div>` : ''}
        ${r.carbs ? `<div class="recipe-macro"><div class="recipe-macro-val" style="color:var(--blue)">${r.carbs}g</div><div class="recipe-macro-lbl">carbs</div></div>` : ''}
        ${r.fat ? `<div class="recipe-macro"><div class="recipe-macro-val" style="color:var(--accent2)">${r.fat}g</div><div class="recipe-macro-lbl">fat</div></div>` : ''}
      </div>` : '';
    return `<div class="recipe-card" onclick="openRecipeDetail('${r.id}')">
      <div class="recipe-card-img">${r.emoji || 'ü•ó'}</div>
      <div class="recipe-card-body">
        <div class="recipe-card-title">${escHtml(r.name)}</div>
        <div class="recipe-card-author">by ${escHtml(r.author || 'Unknown')} ¬∑ ${r.servings || 1} serving${r.servings != 1 ? 's' : ''}</div>
        <div class="recipe-card-desc">${escHtml(r.desc || '')}</div>
        ${macrosHTML}
        <div class="recipe-card-footer">
          <span class="recipe-tag ${catClass}">${categoryLabel(r.category)}</span>
          ${r.prep ? `<span class="recipe-tag">‚è± ${r.prep}</span>` : ''}
          ${tags}
        </div>
      </div>
    </div>`;
  }).join('');
}

function categoryLabel(cat) {
  const m = {breakfast:'üåÖ Breakfast', lunch:'‚òÄÔ∏è Lunch', dinner:'üåô Dinner', snack:'üçé Snack', smoothie:'ü•§ Smoothie', dessert:'üçì Dessert'};
  return m[cat] || cat;
}

function setRecipeFilter(btn, cat) {
  document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  currentRecipeFilter = cat;
  renderRecipes();
}

// ‚îÄ‚îÄ RECIPE DETAIL ‚îÄ‚îÄ
function openRecipeDetail(id) {
  const recipes = getSharedRecipes();
  const r = recipes.find(rx => rx.id === id);
  if (!r) return;
  currentRecipeId = id;

  const u = allUsers[currentUser];
  const isOwner = r.author === (u ? u.name : '') || r.authorId === currentUser || isAdmin();
  document.getElementById('recipe-delete-btn').style.display = isOwner ? 'inline-flex' : 'none';

  const hasMacros = r.kcal || r.protein || r.carbs || r.fat;
  const ingredientsHTML = (r.ingredients || []).map(ing =>
    `<li><span style="font-weight:600;min-width:100px;display:inline-block;">${escHtml(ing.amount)} ${escHtml(ing.unit)}</span> ${escHtml(ing.name)}</li>`
  ).join('');
  const stepsHTML = (r.steps || []).map(s => `<li>${escHtml(s)}</li>`).join('');
  const tagsHTML = (r.tags || []).map(t => `<span class="recipe-tag">#${escHtml(t)}</span>`).join(' ');

  document.getElementById('recipe-detail-content').innerHTML = `
    <div class="recipe-detail-hero">${r.emoji || 'ü•ó'}</div>
    <div class="recipe-detail-title">${escHtml(r.name)}</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px;">
      <span class="recipe-tag cat-${r.category}">${categoryLabel(r.category)}</span>
      ${r.prep ? `<span class="recipe-tag">‚è± Prep: ${escHtml(r.prep)}</span>` : ''}
      ${r.cook && r.cook !== 'None' ? `<span class="recipe-tag">üî• Cook: ${escHtml(r.cook)}</span>` : ''}
      <span class="recipe-tag">üçΩÔ∏è ${r.servings || 1} serving${r.servings != 1 ? 's' : ''}</span>
    </div>
    ${r.desc ? `<p style="font-size:14px;color:var(--text-dim);margin-bottom:16px;line-height:1.7;">${escHtml(r.desc)}</p>` : ''}
    ${hasMacros ? `
    <div style="display:flex;gap:14px;flex-wrap:wrap;padding:14px;background:var(--surface2);border-radius:var(--radius);margin-bottom:20px;">
      ${r.kcal ? `<div class="recipe-macro"><div class="recipe-macro-val" style="color:var(--accent)">${r.kcal}</div><div class="recipe-macro-lbl">calories</div></div>` : ''}
      ${r.protein ? `<div class="recipe-macro"><div class="recipe-macro-val" style="color:var(--green)">${r.protein}g</div><div class="recipe-macro-lbl">protein</div></div>` : ''}
      ${r.carbs ? `<div class="recipe-macro"><div class="recipe-macro-val" style="color:var(--blue)">${r.carbs}g</div><div class="recipe-macro-lbl">carbs</div></div>` : ''}
      ${r.fat ? `<div class="recipe-macro"><div class="recipe-macro-val" style="color:var(--accent2)">${r.fat}g</div><div class="recipe-macro-lbl">fat</div></div>` : ''}
      <div style="font-size:11px;color:var(--text-muted);align-self:flex-end;margin-left:auto;">per serving</div>
    </div>` : ''}
    <div style="font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);margin-bottom:10px;">Ingredients</div>
    <ul class="ingredient-list">${ingredientsHTML || '<li style="color:var(--text-muted)">No ingredients listed</li>'}</ul>
    ${stepsHTML ? `
    <div style="font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);margin:18px 0 10px;">Instructions</div>
    <ol class="step-list">${stepsHTML}</ol>` : ''}
    ${tagsHTML ? `<div style="margin-top:16px;display:flex;gap:6px;flex-wrap:wrap;">${tagsHTML}</div>` : ''}
    <div style="margin-top:16px;font-size:12px;color:var(--text-muted);">Shared by <strong style="color:var(--text-dim)">${escHtml(r.author || 'Unknown')}</strong> ¬∑ ${r.date || ''}</div>
  `;
  document.getElementById('recipe-detail-modal').classList.add('open');
}

function deleteCurrentRecipe() {
  if (!currentRecipeId) return;
  const recipes = getSharedRecipes();
  const r = recipes.find(rx => rx.id === currentRecipeId);
  if (!r) return;
  const u = allUsers[currentUser];
  const isOwner = r.authorId === currentUser || r.author === (u ? u.name : '');
  if (!isOwner && !isAdmin()) { showContactAdmin('delete other users\' recipes'); return; }
  if (!confirm('Delete this recipe? It will be removed for all users.')) return;
  saveSharedRecipes(recipes.filter(rx => rx.id !== currentRecipeId));
  document.getElementById('recipe-detail-modal').classList.remove('open');
  renderRecipes();
}

// ‚îÄ‚îÄ ADD RECIPE FORM ‚îÄ‚îÄ
function openAddRecipe() {
  recipeEmoji = 'ü•ó';
  ingredientCount = 0;
  stepCount = 0;
  document.getElementById('r-name').value = '';
  document.getElementById('r-desc').value = '';
  document.getElementById('r-category').value = 'lunch';
  document.getElementById('r-servings').value = '2';
  document.getElementById('r-prep').value = '';
  document.getElementById('r-cook').value = '';
  document.getElementById('r-kcal').value = '';
  document.getElementById('r-protein').value = '';
  document.getElementById('r-carbs').value = '';
  document.getElementById('r-fat').value = '';
  document.getElementById('r-tags').value = '';
  document.getElementById('r-error').style.display = 'none';
  document.getElementById('ingredients-container').innerHTML = '';
  document.getElementById('steps-container').innerHTML = '';
  document.getElementById('no-ingredients-msg').style.display = 'block';
  document.getElementById('no-steps-msg').style.display = 'block';
  document.querySelectorAll('.emoji-opt').forEach(e => e.classList.toggle('selected', e.dataset.emoji === 'ü•ó'));
  // Add first ingredient + step
  addIngredientRow();
  addStepRow();
  document.getElementById('add-recipe-modal').classList.add('open');
  setTimeout(() => document.getElementById('r-name').focus(), 100);
}

function closeRecipeModal() {
  document.getElementById('add-recipe-modal').classList.remove('open');
}

function selectRecipeEmoji(el) {
  document.querySelectorAll('.emoji-opt').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
  recipeEmoji = el.dataset.emoji;
}

function addIngredientRow() {
  document.getElementById('no-ingredients-msg').style.display = 'none';
  const id = ingredientCount++;
  const row = document.createElement('div');
  row.style.cssText = 'display:grid;grid-template-columns:80px 65px 1fr 24px;gap:6px;margin-bottom:6px;';
  row.id = 'ing-row-' + id;
  row.innerHTML = `
    <input class="set-input" type="text" id="ing-amt-${id}" placeholder="1" style="text-align:left;padding:8px 10px;">
    <input class="set-input" type="text" id="ing-unit-${id}" placeholder="cup" style="text-align:left;padding:8px 10px;">
    <input class="set-input" type="text" id="ing-name-${id}" placeholder="Ingredient name" style="text-align:left;padding:8px 10px;">
    <button type="button" class="del-set-btn" onclick="document.getElementById('ing-row-${id}').remove(); checkIngredientEmpty()">‚úï</button>
  `;
  document.getElementById('ingredients-container').appendChild(row);
}

function checkIngredientEmpty() {
  const isEmpty = !document.getElementById('ingredients-container').children.length;
  document.getElementById('no-ingredients-msg').style.display = isEmpty ? 'block' : 'none';
}

function addStepRow() {
  document.getElementById('no-steps-msg').style.display = 'none';
  const id = stepCount++;
  const num = document.getElementById('steps-container').children.length + 1;
  const row = document.createElement('div');
  row.className = 'step-entry';
  row.id = 'step-row-' + id;
  row.innerHTML = `
    <div class="step-num-badge">${num}</div>
    <textarea id="step-text-${id}" rows="2" placeholder="Describe this step..." style="flex:1;resize:vertical;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;outline:none;line-height:1.6;"></textarea>
    <button type="button" class="del-set-btn" style="margin-top:10px;" onclick="document.getElementById('step-row-${id}').remove(); renumberSteps()">‚úï</button>
  `;
  document.getElementById('steps-container').appendChild(row);
}

function renumberSteps() {
  const isEmpty = !document.getElementById('steps-container').children.length;
  document.getElementById('no-steps-msg').style.display = isEmpty ? 'block' : 'none';
  document.querySelectorAll('#steps-container .step-num-badge').forEach((el, i) => el.textContent = i + 1);
}

function confirmAddRecipe() {
  const name = document.getElementById('r-name').value.trim();
  const errEl = document.getElementById('r-error');
  if (!name) { errEl.textContent = 'Please enter a recipe name.'; errEl.style.display = 'block'; return; }

  // Collect ingredients
  const ingredients = [];
  document.querySelectorAll('#ingredients-container > div').forEach(row => {
    const id = row.id.replace('ing-row-', '');
    const nameVal = document.getElementById('ing-name-' + id)?.value.trim();
    if (nameVal) {
      ingredients.push({
        amount: document.getElementById('ing-amt-' + id)?.value.trim() || '',
        unit:   document.getElementById('ing-unit-' + id)?.value.trim() || '',
        name:   nameVal
      });
    }
  });
  if (!ingredients.length) { errEl.textContent = 'Please add at least one ingredient.'; errEl.style.display = 'block'; return; }

  // Collect steps
  const steps = [];
  document.querySelectorAll('#steps-container .step-entry').forEach(row => {
    const id = row.id.replace('step-row-', '');
    const t = document.getElementById('step-text-' + id)?.value.trim();
    if (t) steps.push(t);
  });

  const u = allUsers[currentUser];
  const recipe = {
    id: 'r_' + Date.now() + '_' + Math.random().toString(36).slice(2,7),
    emoji:       recipeEmoji,
    name,
    desc:        document.getElementById('r-desc').value.trim(),
    category:    document.getElementById('r-category').value,
    servings:    parseInt(document.getElementById('r-servings').value) || 1,
    prep:        document.getElementById('r-prep').value.trim(),
    cook:        document.getElementById('r-cook').value.trim(),
    kcal:        parseFloat(document.getElementById('r-kcal').value) || 0,
    protein:     parseFloat(document.getElementById('r-protein').value) || 0,
    carbs:       parseFloat(document.getElementById('r-carbs').value) || 0,
    fat:         parseFloat(document.getElementById('r-fat').value) || 0,
    ingredients,
    steps,
    tags:        document.getElementById('r-tags').value.split(',').map(t => t.trim()).filter(Boolean),
    author:      u ? u.name : currentUser,
    authorId:    currentUser,
    date:        getTodayStr()
  };

  errEl.style.display = 'none';
  const recipes = getSharedRecipes();
  recipes.unshift(recipe); // newest first
  saveSharedRecipes(recipes);
  closeRecipeModal();
  renderRecipes();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PDF / SHARE DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function shareDashboardPDF() {
  const html = buildDashboardPDFHTML();
  document.getElementById('pdf-preview-container').innerHTML = html;
  document.getElementById('pdf-modal').classList.add('open');
}

function printDashboardPDF() {
  const html = buildDashboardPDFHTML();
  // Put content in the print frame and trigger print
  const frame = document.getElementById('pdf-print-frame');
  frame.innerHTML = html;
  window.print();
  // Clean up after print dialog closes
  setTimeout(() => { frame.innerHTML = ''; }, 2000);
}

function buildDashboardPDFHTML() {
  const u        = allUsers[currentUser];
  if (!u) return '<p>No user data.</p>';

  const dateStr  = dashViewDate;
  const viewDate = new Date(dateStr + 'T12:00:00');
  const dateLabel = viewDate.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
  const generatedAt = new Date().toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit' });

  const totals   = getDayTotals(dateStr);
  const log      = (u.foodLog || {})[dateStr] || {};
  const workouts = ((u.workoutLog || {})[dateStr]) || [];

  const goalLabels = { lose_weight:'Lose Weight üî•', build_muscle:'Build Muscle üí™', maintain:'Maintain Weight ‚öñÔ∏è', improve_fitness:'Improve Fitness üèÉ' };
  const goalLabel  = goalLabels[u.goal] || 'General Fitness';

  // ‚îÄ‚îÄ Macro progress bars ‚îÄ‚îÄ
  const calPct     = Math.min(100, Math.round((totals.cals    / (u.cals_goal    || 1800)) * 100));
  const proteinPct = Math.min(100, Math.round((totals.protein / (u.protein_goal || 120))  * 100));
  const carbsPct   = Math.min(100, Math.round((totals.carbs   / (u.carbs_goal   || 200))  * 100));
  const fatPct     = Math.min(100, Math.round((totals.fat     / (u.fat_goal     || 60))   * 100));

  const remaining  = Math.max(0, (u.cals_goal || 1800) - totals.cals);
  const overBy     = Math.max(0, totals.cals - (u.cals_goal || 1800));

  // ‚îÄ‚îÄ Meal rows ‚îÄ‚îÄ
  const mealEmojis = { breakfast:'üåÖ', lunch:'‚òÄÔ∏è', dinner:'üåô', snack:'üçé' };
  const mealLabels = { breakfast:'Breakfast', lunch:'Lunch', dinner:'Dinner', snack:'Snacks & Other' };

  let mealRows = '';
  let totalMealCals = 0;
  ['breakfast','lunch','dinner','snack'].forEach(meal => {
    const items = log[meal] || [];
    if (!items.length) return;
    const mealCals = items.reduce((s, i) => s + ((i.kcal||0) * ((i.qty||100)/100)), 0);
    totalMealCals += mealCals;
    const itemNames = items.slice(0,3).map(i => i.name).join(', ') + (items.length > 3 ? ` +${items.length-3} more` : '');
    mealRows += `
      <div class="pdf-meal-row">
        <div>
          <div style="display:flex;align-items:center;gap:6px;">
            <span class="pdf-meal-icon">${mealEmojis[meal]}</span>
            <span class="pdf-meal-name">${mealLabels[meal]}</span>
            <span style="font-size:11px;color:#999;">(${items.length} item${items.length!==1?'s':''})</span>
          </div>
          <div class="pdf-meal-items">${escHtml(itemNames)}</div>
        </div>
        <span class="pdf-meal-cals">${Math.round(mealCals)} kcal</span>
      </div>`;
  });

  if (!mealRows) {
    mealRows = '<div class="pdf-no-data">No food logged for this day.</div>';
  } else {
    const calStatus = overBy > 0
      ? `<span style="color:#dc2626;">+${Math.round(overBy)} kcal over goal</span>`
      : `<span style="color:#16a34a;">${Math.round(remaining)} kcal remaining</span>`;
    mealRows += `<div class="pdf-totals-row"><span>Total</span><span>${Math.round(totalMealCals)} kcal &nbsp;¬∑&nbsp; ${calStatus}</span></div>`;
  }

  // ‚îÄ‚îÄ Workout blocks ‚îÄ‚îÄ
  let workoutBlocks = '';
  if (workouts.length) {
    const totalDuration = workouts.reduce((s, w) => s + (w.duration||0), 0);
    const totalCalsBurned = workouts.reduce((s, w) => s + (w.calories||0), 0);
    workouts.forEach(w => {
      let exerciseRows = '';
      (w.exercises || []).forEach(ex => {
        const setsSummary = (ex.sets||[]).map(s => `${s.weight||'‚Äî'}√ó${s.reps||'‚Äî'}`).join('  ');
        exerciseRows += `<div class="pdf-exercise-row"><span class="pdf-exercise-name">${escHtml(ex.name||'Exercise')}</span><span class="pdf-exercise-sets">${setsSummary}</span></div>`;
      });
      workoutBlocks += `
        <div class="pdf-workout-block">
          <div class="pdf-workout-name">${escHtml(w.activity||'Workout')}${w.name ? ' ‚Äî ' + escHtml(w.name) : ''}</div>
          <div class="pdf-workout-meta">
            ${w.duration ? `<span>‚è± ${w.duration} min</span>` : ''}
            ${w.calories ? `<span>üî• ${w.calories} kcal burned</span>` : ''}
            ${w.intensity ? `<span>‚ö° ${w.intensity}</span>` : ''}
            ${w.exercises?.length ? `<span>üèãÔ∏è ${w.exercises.length} exercise${w.exercises.length!==1?'s':''}</span>` : ''}
          </div>
          ${exerciseRows ? `<div style="margin-top:8px;border-top:1px solid #e5e7eb;padding-top:8px;">${exerciseRows}</div>` : ''}
        </div>`;
    });
    workoutBlocks += `<div style="font-size:12px;color:#666;margin-top:6px;">Total: ${totalDuration} min active ¬∑ ${totalCalsBurned} kcal burned across ${workouts.length} session${workouts.length!==1?'s':''}</div>`;
  } else {
    workoutBlocks = '<div class="pdf-no-data">No workouts logged for this day.</div>';
  }

  // ‚îÄ‚îÄ Net calories ‚îÄ‚îÄ
  const netCals = Math.round(totals.cals - workouts.reduce((s, w) => s + (w.calories||0), 0));

  return `
  <div class="pdf-preview">

    <!-- Header -->
    <div class="pdf-header">
      <div>
        <div class="pdf-logo">CHINGONE <span>LIFE TRACKER</span></div>
        <div style="margin-top:6px;"><span class="pdf-goal-badge">${goalLabel}</span></div>
      </div>
      <div class="pdf-date-block">
        <div class="pdf-date">${dateLabel}</div>
        <div class="pdf-user">${escHtml(u.name)} ¬∑ Generated ${generatedAt}</div>
      </div>
    </div>

    <!-- Nutrition Stats -->
    <div class="pdf-section-title">üìä Nutrition Summary</div>
    <div class="pdf-stats-row">
      <div class="pdf-stat-box cals">
        <div><span class="pdf-stat-val" style="color:#d97706;">${Math.round(totals.cals)}</span><span class="pdf-stat-unit" style="color:#d97706;">kcal</span></div>
        <div class="pdf-stat-label">Calories</div>
        <div class="pdf-stat-goal">Goal: ${u.cals_goal||1800}</div>
        <div class="pdf-bar-wrap"><div class="pdf-bar-fill" style="width:${calPct}%;background:#f59e0b;"></div></div>
      </div>
      <div class="pdf-stat-box protein">
        <div><span class="pdf-stat-val" style="color:#16a34a;">${Math.round(totals.protein)}</span><span class="pdf-stat-unit" style="color:#16a34a;">g</span></div>
        <div class="pdf-stat-label">Protein</div>
        <div class="pdf-stat-goal">Goal: ${u.protein_goal||120}g</div>
        <div class="pdf-bar-wrap"><div class="pdf-bar-fill" style="width:${proteinPct}%;background:#22c55e;"></div></div>
      </div>
      <div class="pdf-stat-box carbs">
        <div><span class="pdf-stat-val" style="color:#2563eb;">${Math.round(totals.carbs)}</span><span class="pdf-stat-unit" style="color:#2563eb;">g</span></div>
        <div class="pdf-stat-label">Carbs</div>
        <div class="pdf-stat-goal">Goal: ${u.carbs_goal||200}g</div>
        <div class="pdf-bar-wrap"><div class="pdf-bar-fill" style="width:${carbsPct}%;background:#3b82f6;"></div></div>
      </div>
      <div class="pdf-stat-box fat">
        <div><span class="pdf-stat-val" style="color:#ea580c;">${Math.round(totals.fat)}</span><span class="pdf-stat-unit" style="color:#ea580c;">g</span></div>
        <div class="pdf-stat-label">Fat</div>
        <div class="pdf-stat-goal">Goal: ${u.fat_goal||60}g</div>
        <div class="pdf-bar-wrap"><div class="pdf-bar-fill" style="width:${fatPct}%;background:#f97316;"></div></div>
      </div>
    </div>

    ${workouts.length ? `
    <div style="margin-top:12px;padding:10px 14px;background:#f0fdf4;border:1px solid #86efac;border-radius:8px;font-size:13px;color:#166534;display:flex;justify-content:space-between;flex-wrap:wrap;gap:6px;">
      <span>üî• Net calories (after exercise): <strong>${netCals} kcal</strong></span>
      <span>${calPct}% of daily goal consumed</span>
    </div>` : `
    <div style="margin-top:12px;padding:10px 14px;background:#fffbeb;border:1px solid #fde68a;border-radius:8px;font-size:13px;color:#92400e;display:flex;justify-content:space-between;flex-wrap:wrap;gap:6px;">
      <span>${calPct >= 100 ? '‚ö†Ô∏è Over calorie goal by ' + Math.round(overBy) + ' kcal' : '‚úÖ ' + Math.round(remaining) + ' kcal remaining today'}</span>
      <span>${calPct}% of daily goal</span>
    </div>`}

    <!-- Food Log -->
    <div class="pdf-section-title">üçΩÔ∏è Food Log</div>
    <div>${mealRows}</div>

    ${totals.fiber || totals.sodium ? `
    <div style="display:flex;gap:20px;margin-top:10px;font-size:12px;color:#666;">
      ${totals.fiber  ? `<span>Fiber: <strong>${Math.round(totals.fiber)}g</strong></span>` : ''}
      ${totals.sodium ? `<span>Sodium: <strong>${Math.round(totals.sodium)}mg</strong></span>` : ''}
      ${totals.sugar  ? `<span>Sugar: <strong>${Math.round(totals.sugar)}g</strong></span>` : ''}
    </div>` : ''}

    <!-- Workouts -->
    <div class="pdf-section-title">üèãÔ∏è Workout Log</div>
    <div>${workoutBlocks}</div>

    <!-- Footer -->
    <div class="pdf-footer">
      <div class="pdf-footer-app">Chingone Life Tracker ¬∑ chingone.app</div>
      <div class="pdf-footer-date">Printed ${new Date().toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}</div>
    </div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MEAL IDEAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let fridgeItems    = [];
let cupboardItems  = [];
let lastMealIdeas  = [];

function loadMealIdeasPage() {
  // Check API key
  const key = localStorage.getItem('vt_anthropic_key') || '';
  const warning = document.getElementById('mi-no-key-warning');
  if (warning) warning.style.display = key ? 'none' : 'block';

  // Restore saved ingredients from user profile
  const u = allUsers[currentUser];
  if (u && u.fridgeItems)    fridgeItems    = [...(u.fridgeItems || [])];
  if (u && u.cupboardItems)  cupboardItems  = [...(u.cupboardItems || [])];
  renderChips('fridge');
  renderChips('cupboard');

  // Hide results initially only if no results yet
  const results = document.getElementById('mi-results');
  const empty   = document.getElementById('mi-empty-state');
  if (!lastMealIdeas.length) {
    if (results) results.style.display = 'none';
    if (empty) empty.style.display = 'block';
  }
}

function addIngredient(type) {
  const input = document.getElementById(type + '-input');
  const val   = input.value.trim();
  if (!val) return;
  const list  = type === 'fridge' ? fridgeItems : cupboardItems;
  const clean = val.replace(/^[^\w\s]+\s*/, '').trim(); // strip leading emoji
  if (!list.find(i => i.toLowerCase() === clean.toLowerCase())) {
    list.push(clean);
    saveIngredients();
    renderChips(type);
  }
  input.value = '';
  input.focus();
}

function quickAdd(type, label) {
  const clean = label.replace(/^[^\w\s]+\s*/, '').trim();
  const list  = type === 'fridge' ? fridgeItems : cupboardItems;
  if (!list.find(i => i.toLowerCase() === clean.toLowerCase())) {
    list.push(clean);
    saveIngredients();
    renderChips(type);
  }
}

function removeIngredient(type, idx) {
  if (type === 'fridge') fridgeItems.splice(idx, 1);
  else cupboardItems.splice(idx, 1);
  saveIngredients();
  renderChips(type);
}

function renderChips(type) {
  const container = document.getElementById(type + '-chips');
  if (!container) return;
  const list = type === 'fridge' ? fridgeItems : cupboardItems;
  if (!list.length) { container.innerHTML = ''; return; }
  container.innerHTML = list.map((item, i) =>
    `<span class="ingredient-chip ${type}">
      ${escHtml(item)}
      <button class="chip-del" onclick="removeIngredient('${type}',${i})" title="Remove">‚úï</button>
    </span>`
  ).join('');
}

function saveIngredients() {
  const u = allUsers[currentUser];
  if (!u) return;
  u.fridgeItems   = [...fridgeItems];
  u.cupboardItems = [...cupboardItems];
  saveStorage();
}

async function generateMealIdeas() {
  const key = localStorage.getItem('vt_anthropic_key') || '';
  if (!key) {
    alert('Please add your Anthropic API key in the AI Plan tab first.');
    navigate('ai-plan');
    return;
  }

  const allIngredients = [...fridgeItems, ...cupboardItems];
  if (!allIngredients.length) {
    alert('Please add at least a few ingredients first!');
    return;
  }

  const u           = allUsers[currentUser];
  const mealType    = document.getElementById('mi-meal-type').value;
  const count       = document.getElementById('mi-count').value;
  const restrictions = document.getElementById('mi-restrictions').value.trim();
  const maxTime     = document.getElementById('mi-time').value;
  const notes       = document.getElementById('mi-notes').value.trim();

  const goalMap = { lose_weight: 'lose weight (lower calorie, high protein, filling)', build_muscle: 'build muscle (high protein, calorie surplus)', maintain: 'maintain weight (balanced macros)', improve_fitness: 'improve overall fitness (clean, balanced nutrition)' };
  const userGoal = u ? (goalMap[u.goal] || 'general healthy eating') : 'general healthy eating';
  const userStats = u ? `Age: ${u.age||'unknown'}, Weight: ${u.weight||'unknown'} lbs, Goal: ${userGoal}` : '';

  const fridgeList   = fridgeItems.join(', ') || 'none listed';
  const cupboardList = cupboardItems.join(', ') || 'none listed';

  const prompt = `You are a creative nutritionist chef. Based on the ingredients this person has available, suggest ${count} ${mealType !== 'any' ? mealType : ''} meal ideas that match their fitness goal.

USER PROFILE: ${userStats}
FRIDGE/FREEZER: ${fridgeList}
CUPBOARD/PANTRY: ${cupboardList}
${restrictions ? 'DIETARY RESTRICTIONS: ' + restrictions : ''}
${maxTime !== 'any' ? 'MAX PREP + COOK TIME: ' + maxTime + ' minutes' : ''}
${notes ? 'ADDITIONAL NOTES: ' + notes : ''}

For EACH meal idea, provide exactly this structure (use these exact headings):

## [Meal Name]
**Category:** [Breakfast/Lunch/Dinner/Snack]
**Prep time:** [X mins] | **Cook time:** [X mins]
**Servings:** [X]

**Why it fits your goal:** [1 sentence explaining how it supports their specific fitness goal]

**Ingredients you have:** [comma-separated list from their available ingredients]
**You'll also need:** [any extra ingredients needed, or "Nothing ‚Äî you have everything!" if none needed]

**Estimated nutrition per serving:**
- Calories: ~[X] kcal | Protein: ~[X]g | Carbs: ~[X]g | Fat: ~[X]g

**Instructions:**
1. [step]
2. [step]
3. [step]
(etc.)

**Pro tip:** [one short practical tip]

---

Make the meals practical, delicious, and genuinely achievable with what they have. Prioritise meals that use mostly ingredients they already have. Order them from easiest/quickest to more involved.`;

  // UI loading state
  const btn     = document.getElementById('mi-gen-btn');
  const results = document.getElementById('mi-results');
  const empty   = document.getElementById('mi-empty-state');
  const content = document.getElementById('mi-results-content');

  btn.innerHTML = '<div class="spinner"></div> Claude is thinking...';
  btn.disabled  = true;
  if (empty) empty.style.display = 'none';
  results.style.display = 'block';
  content.innerHTML = '<div class="mi-streaming" id="mi-stream-text">Generating your personalised meal ideas...<span class="mi-cursor"></span></div>';

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': key,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-opus-4-6',
        max_tokens: 4096,
        stream: true,
        messages: [{ role: 'user', content: prompt }]
      })
    });

    if (!res.ok) {
      let msg = 'API error ' + res.status;
      try { const e = await res.json(); msg = e.error?.message || msg; } catch(_){}
      throw new Error(msg);
    }

    // Stream the response
    const reader  = res.body.getReader();
    const decoder = new TextDecoder();
    let   fullText = '';
    const streamEl = document.getElementById('mi-stream-text');

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      const chunk = decoder.decode(value, { stream: true });
      const lines = chunk.split('\n');
      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        const data = line.slice(6).trim();
        if (data === '[DONE]') continue;
        try {
          const json = JSON.parse(data);
          const text = json.delta?.text || '';
          if (text) {
            fullText += text;
            if (streamEl) {
              streamEl.innerHTML = escHtml(fullText).replace(/\n/g, '<br>') + '<span class="mi-cursor"></span>';
              streamEl.scrollIntoView({ behavior: 'smooth', block: 'end' });
            }
          }
        } catch(_) {}
      }
    }

    // Render nicely formatted cards
    renderMealIdeaCards(fullText);
    lastMealIdeas = fullText;

    // Save raw text to user profile for persistence
    if (u) { u.lastMealIdeas = fullText; saveStorage(); }

  } catch(e) {
    content.innerHTML = `<div class="meal-idea-card" style="border-color:rgba(248,113,113,0.3);">
      <div style="color:var(--red);font-weight:600;margin-bottom:8px;">‚ùå Error generating ideas</div>
      <div style="font-size:13px;color:var(--text-dim);">${escHtml(e.message)}</div>
      <div style="font-size:12px;color:var(--text-muted);margin-top:10px;">Check your API key in the AI Plan tab and make sure you have credits.</div>
    </div>`;
  }

  btn.innerHTML = '‚ú® Generate Meal Ideas from My Ingredients';
  btn.disabled  = false;
}

function renderMealIdeaCards(rawText) {
  const content = document.getElementById('mi-results-content');
  if (!content) return;

  // Split into individual meal blocks by ## heading
  const meals = rawText.split(/\n(?=##\s)/).filter(b => b.trim().startsWith('##'));

  if (!meals.length) {
    // Fallback: just show streamed text nicely
    content.innerHTML = `<div class="meal-idea-card"><div class="mi-streaming">${escHtml(rawText).replace(/\n/g,'<br>')}</div></div>`;
    return;
  }

  const allOwned = [...fridgeItems, ...cupboardItems].map(i => i.toLowerCase());

  content.innerHTML = meals.map((block, idx) => {
    const lines = block.trim().split('\n');
    const title = (lines[0] || '').replace(/^##\s*/, '').trim();

    const get = (label) => {
      const re = new RegExp(label + '[:\\s]+(.+)', 'i');
      for (const l of lines) { const m = l.match(re); if (m) return m[1].trim().replace(/\*\*/g,''); }
      return '';
    };

    const category   = get('Category');
    const prepTime   = get('Prep time');
    const cookTime   = get('Cook time');
    const servings   = get('Servings');
    const whyFits    = get('Why it fits your goal');
    const haveRaw    = get("Ingredients you have");
    const needRaw    = get("You'll also need|You'll need");
    const cals       = get('Calories');
    const protein    = get('Protein');
    const carbs      = get('Carbs');
    const fat        = get('Fat');
    const proTip     = get('Pro tip');

    // Instructions block
    const instrStart = lines.findIndex(l => /Instructions/i.test(l));
    const tipIdx     = lines.findIndex(l => /Pro tip/i.test(l));
    const instrLines = instrStart > -1
      ? lines.slice(instrStart + 1, tipIdx > instrStart ? tipIdx : undefined)
          .filter(l => /^\d+\./.test(l.trim()))
          .map(l => `<li>${escHtml(l.replace(/^\d+\.\s*/,''))}</li>`)
          .join('')
      : '';

    const haveChips = haveRaw.split(',').filter(Boolean).map(i => {
      const clean = i.trim().replace(/\*\*/g,'');
      const owned = allOwned.some(o => clean.toLowerCase().includes(o) || o.includes(clean.toLowerCase()));
      return `<span class="meal-idea-ingredient ${owned ? 'have' : 'have'}">‚úì ${escHtml(clean)}</span>`;
    }).join('');

    const needChips = (needRaw && !needRaw.toLowerCase().includes('nothing') && !needRaw.toLowerCase().includes('you have everything'))
      ? needRaw.split(',').filter(Boolean).map(i =>
          `<span class="meal-idea-ingredient need">+ ${escHtml(i.trim().replace(/\*\*/g,''))}</span>`
        ).join('')
      : '<span style="font-size:13px;color:var(--green);">‚úÖ You have everything!</span>';

    const catEmoji = { breakfast:'üåÖ', lunch:'‚òÄÔ∏è', dinner:'üåô', snack:'üçé' };
    const emoji    = catEmoji[(category||'').toLowerCase()] || 'üçΩÔ∏è';

    return `<div class="meal-idea-card">
      <div class="meal-idea-title">${escHtml(title)}</div>
      <div class="meal-idea-meta">
        ${category ? `<span class="recipe-tag cat-${(category||'').toLowerCase()}">${emoji} ${escHtml(category)}</span>` : ''}
        ${prepTime ? `<span class="recipe-tag">‚è± Prep: ${escHtml(prepTime.split('|')[0].trim())}</span>` : ''}
        ${cookTime ? `<span class="recipe-tag">üî• Cook: ${escHtml(cookTime)}</span>` : ''}
        ${servings ? `<span class="recipe-tag">üçΩÔ∏è ${escHtml(servings)} serving${servings!=='1'?'s':''}</span>` : ''}
      </div>
      ${whyFits ? `<div style="font-size:13px;color:var(--green);background:var(--green-glow);border-radius:var(--radius);padding:10px 14px;margin-bottom:12px;border:1px solid rgba(74,222,128,0.2);">üí™ ${escHtml(whyFits)}</div>` : ''}
      ${haveRaw ? `<div class="meal-idea-section">Ingredients You Have</div><div>${haveChips}</div>` : ''}
      ${needRaw ? `<div class="meal-idea-section">You'll Also Need</div><div>${needChips}</div>` : ''}
      ${(cals||protein||carbs||fat) ? `
      <div class="meal-macros-row">
        ${cals    ? `<div class="recipe-macro"><div class="recipe-macro-val" style="color:var(--accent)">${escHtml(cals.split(' ')[0].replace('~',''))}</div><div class="recipe-macro-lbl">calories</div></div>` : ''}
        ${protein ? `<div class="recipe-macro"><div class="recipe-macro-val" style="color:var(--green)">${escHtml(protein.split(' ')[0].replace('~',''))}</div><div class="recipe-macro-lbl">protein</div></div>` : ''}
        ${carbs   ? `<div class="recipe-macro"><div class="recipe-macro-val" style="color:var(--blue)">${escHtml(carbs.split(' ')[0].replace('~',''))}</div><div class="recipe-macro-lbl">carbs</div></div>` : ''}
        ${fat     ? `<div class="recipe-macro"><div class="recipe-macro-val" style="color:var(--accent2)">${escHtml(fat.split(' ')[0].replace('~',''))}</div><div class="recipe-macro-lbl">fat</div></div>` : ''}
      </div>` : ''}
      ${instrLines ? `<div class="meal-idea-section">Instructions</div><ol style="padding-left:20px;margin:0;">${instrLines}</ol>` : ''}
      ${proTip ? `<div style="margin-top:14px;padding:10px 14px;background:rgba(250,204,21,0.08);border:1px solid rgba(250,204,21,0.2);border-radius:var(--radius);font-size:13px;color:var(--accent);">üí° <strong>Tip:</strong> ${escHtml(proTip)}</div>` : ''}
      <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn btn-outline btn-sm" onclick="saveSingleMealToRecipes(${idx})">üìñ Save to Recipes</button>
        <button class="btn btn-outline btn-sm" onclick="logMealToFoodLog('${escHtml(title).replace(/'/g,"\\'")}', ${cals?cals.split(' ')[0].replace('~',''):0}, ${protein?protein.split(' ')[0].replace('~',''):0}, ${carbs?carbs.split(' ')[0].replace('~',''):0}, ${fat?fat.split(' ')[0].replace('~',''):0})">ü•ó Log to Food Log</button>
      </div>
    </div>`;
  }).join('');
}

function saveSingleMealToRecipes(idx) {
  // Re-parse the meal at index idx from lastMealIdeas
  const meals = String(lastMealIdeas).split(/\n(?=##\s)/).filter(b => b.trim().startsWith('##'));
  const block = meals[idx];
  if (!block) return;
  const title = (block.split('\n')[0] || '').replace(/^##\s*/,'').trim();
  const u = allUsers[currentUser];
  const recipe = {
    id: 'r_' + Date.now() + '_' + Math.random().toString(36).slice(2,5),
    emoji: 'üßë‚Äçüç≥', name: title, desc: 'Generated from your pantry ingredients by Claude AI',
    category: 'lunch', servings: 1, prep: '', cook: '', kcal: 0, protein: 0, carbs: 0, fat: 0,
    ingredients: [], steps: [block],
    tags: ['ai-generated','pantry-meal'],
    author: u ? u.name : currentUser, authorId: currentUser, date: getTodayStr()
  };
  const recipes = getSharedRecipes();
  recipes.unshift(recipe);
  saveSharedRecipes(recipes);
  alert('‚úÖ "' + title + '" saved to Recipes!');
}

function saveMealIdeasToRecipes() {
  const meals = String(lastMealIdeas).split(/\n(?=##\s)/).filter(b => b.trim().startsWith('##'));
  if (!meals.length) return;
  meals.forEach((_, i) => saveSingleMealToRecipes(i));
  alert('‚úÖ All ' + meals.length + ' meal ideas saved to your Recipes tab!');
}

function logMealToFoodLog(name, kcal, protein, carbs, fat) {
  const u = allUsers[currentUser];
  if (!u) return;
  if (!u.foodLog) u.foodLog = {};
  const today = getTodayStr();
  if (!u.foodLog[today]) u.foodLog[today] = {};
  if (!u.foodLog[today]['lunch']) u.foodLog[today]['lunch'] = [];
  u.foodLog[today]['lunch'].push({
    name: name, brand: 'AI Meal Idea', kcal: parseFloat(kcal)||0,
    protein: parseFloat(protein)||0, carbs: parseFloat(carbs)||0, fat: parseFloat(fat)||0,
    fiber:0, sugar:0, sodium:0, qty:100
  });
  saveStorage();
  alert('‚úÖ "' + name + '" logged to today\'s Food Log under Lunch!');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPER_ADMIN = 'bribush44';
const ADMIN_CONTACT = 'bribush44@gmail.com';

function isAdmin() {
  const u = allUsers[currentUser];
  return u && (u.isSuperAdmin || u.isAdmin);
}

function isSuperAdmin() {
  return currentUser === SUPER_ADMIN;
}

function showContactAdmin(action) {
  const modal = document.getElementById('contact-admin-modal');
  const msg   = document.getElementById('contact-admin-msg');
  if (msg) msg.textContent = action || 'perform this action';
  if (modal) modal.classList.add('open');
}

function renderAdminPanel() {
  renderAdminUsers();
  renderAdminRecipes();
}

function renderAdminUsers() {
  const container = document.getElementById('admin-user-list');
  const goalLabels = { lose_weight:'Lose Weight', build_muscle:'Build Muscle', maintain:'Maintain', improve_fitness:'Get Fit' };
  const users = Object.values(allUsers);

  container.innerHTML = users.map(u => {
    const isSelf   = u.username === currentUser;
    const isSA     = u.username === SUPER_ADMIN;
    const adminTag = u.isSuperAdmin
      ? '<span class="admin-badge">üõ°Ô∏è Super Admin</span>'
      : u.isAdmin ? '<span class="admin-badge">üõ°Ô∏è Admin</span>' : '';

    const promoteBtn = !u.isAdmin && !isSA
      ? `<button class="btn btn-warning btn-sm" onclick="adminToggleAdmin('${u.username}', true)">‚¨Ü Make Admin</button>` : '';
    const demoteBtn  = u.isAdmin && !u.isSuperAdmin && !isSA
      ? `<button class="btn btn-outline btn-sm" onclick="adminToggleAdmin('${u.username}', false)">‚¨á Remove Admin</button>` : '';
    const deleteBtn  = !isSA && !isSelf
      ? `<button class="btn btn-danger btn-sm" onclick="adminDeleteUser('${u.username}')">üóë Delete</button>` : '';

    return `<div class="admin-user-row">
      <div class="admin-user-info">
        <div class="uc-avatar" style="width:38px;height:38px;font-size:16px;border-radius:50%;background:var(--surface3);display:flex;align-items:center;justify-content:center;font-weight:700;">${u.name.charAt(0).toUpperCase()}</div>
        <div>
          <div style="font-weight:600;font-size:14px;display:flex;align-items:center;gap:8px;">${escHtml(u.name)} ${adminTag} ${isSelf ? '<span style="font-size:11px;color:var(--green);">(you)</span>' : ''}</div>
          <div style="font-size:12px;color:var(--text-muted);">@${u.username} ¬∑ ${goalLabels[u.goal] || 'General Fitness'}</div>
        </div>
      </div>
      <div class="admin-actions">
        ${promoteBtn}${demoteBtn}${deleteBtn}
      </div>
    </div>`;
  }).join('');
}

function renderAdminRecipes() {
  const container = document.getElementById('admin-recipe-list');
  const recipes   = getSharedRecipes();
  if (!recipes.length) {
    container.innerHTML = '<div style="color:var(--text-muted);font-size:14px;">No recipes shared yet.</div>';
    return;
  }
  container.innerHTML = recipes.map(r => `
    <div class="admin-user-row">
      <div style="display:flex;align-items:center;gap:10px;flex:1;min-width:0;">
        <span style="font-size:24px;">${r.emoji || 'ü•ó'}</span>
        <div style="min-width:0;">
          <div style="font-weight:600;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escHtml(r.name)}</div>
          <div style="font-size:12px;color:var(--text-muted);">by ${escHtml(r.author || 'Unknown')} ¬∑ ${r.date || ''}</div>
        </div>
      </div>
      <button class="btn btn-danger btn-sm" onclick="adminDeleteRecipe('${r.id}')">üóë Delete</button>
    </div>
  `).join('');
}

function adminToggleAdmin(username, makeAdmin) {
  if (!isSuperAdmin()) { showContactAdmin('manage admin roles'); return; }
  if (username === SUPER_ADMIN) return;
  const action = makeAdmin ? 'grant admin rights to' : 'remove admin rights from';
  if (!confirm(`Are you sure you want to ${action} @${username}?`)) return;
  allUsers[username].isAdmin = makeAdmin;
  saveStorage();
  renderAdminUsers();
  // If demoting and that user is currently logged in, refresh nav
  if (username === currentUser) refreshSidebarUser();
}

function adminDeleteUser(username) {
  if (!isSuperAdmin()) { showContactAdmin('delete users'); return; }
  if (username === SUPER_ADMIN) return;
  if (!confirm(`Permanently delete @${username} and ALL their data? This cannot be undone.`)) return;
  delete allUsers[username];
  saveStorage();
  renderAdminUsers();
}

function adminDeleteRecipe(id) {
  if (!confirm('Delete this recipe for all users?')) return;
  saveSharedRecipes(getSharedRecipes().filter(r => r.id !== id));
  renderAdminRecipes();
  renderRecipes();
}

function adminDeleteDemoUsers() {
  if (!isSuperAdmin()) { showContactAdmin('remove demo users'); return; }
  if (!confirm('Delete demo accounts sarah and mike? This will permanently remove all their data.')) return;
  delete allUsers['sarah'];
  delete allUsers['mike'];
  saveStorage();
  renderAdminUsers();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
loadStorage();
registerServiceWorker();
</script>
</body>
</html>