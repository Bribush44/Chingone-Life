<!DOCTYPE html>
<!-- Chingone Life Tracker | Built 2026-02-19 15:45 | v3.5 -->
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Chingone Life Tracker v4</title>

<!-- PWA Meta Tags -->
<meta name="application-name" content="Chingone Life Tracker">
<meta name="description" content="Your personal health & fitness tracker ‚Äî food log, workouts, AI plans, and more.">
<meta name="theme-color" content="#0d0f0e">
<meta name="background-color" content="#0d0f0e">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Chingone">
<meta name="msapplication-TileColor" content="#0d0f0e">
<meta name="msapplication-tap-highlight" content="no">
<meta name="format-detection" content="telephone=no">

<!-- PWA Meta Tags -->


<!-- PWA Icons (inline SVG as data URIs) -->
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='115' fill='%230d0f0e'/%3E%3Ccircle cx='256' cy='256' r='175' fill='none' stroke='%234ade80' stroke-width='24'/%3E%3Ctext x='256' y='330' font-family='Arial Black,sans-serif' font-size='220' font-weight='900' fill='%234ade80' text-anchor='middle'%3EC%3C/text%3E%3C/svg%3E">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='115' fill='%230d0f0e'/%3E%3Ccircle cx='256' cy='256' r='175' fill='none' stroke='%234ade80' stroke-width='24'/%3E%3Ctext x='256' y='330' font-family='Arial Black,sans-serif' font-size='220' font-weight='900' fill='%234ade80' text-anchor='middle'%3EC%3C/text%3E%3C/svg%3E">
<link rel="apple-touch-icon" sizes="152x152" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='115' fill='%230d0f0e'/%3E%3Ccircle cx='256' cy='256' r='175' fill='none' stroke='%234ade80' stroke-width='24'/%3E%3Ctext x='256' y='330' font-family='Arial Black,sans-serif' font-size='220' font-weight='900' fill='%234ade80' text-anchor='middle'%3EC%3C/text%3E%3C/svg%3E">
<link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='115' fill='%230d0f0e'/%3E%3Ccircle cx='256' cy='256' r='175' fill='none' stroke='%234ade80' stroke-width='24'/%3E%3Ctext x='256' y='330' font-family='Arial Black,sans-serif' font-size='220' font-weight='900' fill='%234ade80' text-anchor='middle'%3EC%3C/text%3E%3C/svg%3E">
<link rel="apple-touch-icon" sizes="167x167" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='115' fill='%230d0f0e'/%3E%3Ccircle cx='256' cy='256' r='175' fill='none' stroke='%234ade80' stroke-width='24'/%3E%3Ctext x='256' y='330' font-family='Arial Black,sans-serif' font-size='220' font-weight='900' fill='%234ade80' text-anchor='middle'%3EC%3C/text%3E%3C/svg%3E">
<link rel="manifest" href="data:application/manifest+json,%7B%0A%20%20%22name%22%3A%20%22Chingone%20Life%20Tracker%22%2C%0A%20%20%22short_name%22%3A%20%22Chingone%22%2C%0A%20%20%22description%22%3A%20%22Your%20personal%20health%20and%20fitness%20tracker%22%2C%0A%20%20%22start_url%22%3A%20%22.%22%2C%0A%20%20%22display%22%3A%20%22standalone%22%2C%0A%20%20%22orientation%22%3A%20%22portrait-primary%22%2C%0A%20%20%22background_color%22%3A%20%22%230d0f0e%22%2C%0A%20%20%22theme_color%22%3A%20%22%230d0f0e%22%2C%0A%20%20%22categories%22%3A%20%5B%22health%22%2C%20%22fitness%22%5D%2C%0A%20%20%22icons%22%3A%20%5B%0A%20%20%20%20%7B%0A%20%20%20%20%20%20%22src%22%3A%20%22data%3Aimage%2Fsvg%2Bxml%2C%253Csvg%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%20viewBox%3D%270%200%20512%20512%27%253E%253Crect%20width%3D%27512%27%20height%3D%27512%27%20rx%3D%27115%27%20fill%3D%27%25230d0f0e%27%2F%253E%253Ccircle%20cx%3D%27256%27%20cy%3D%27256%27%20r%3D%27175%27%20fill%3D%27none%27%20stroke%3D%27%25234ade80%27%20stroke-width%3D%2724%27%2F%253E%253Ctext%20x%3D%27256%27%20y%3D%27330%27%20font-family%3D%27Arial%20Black%2Csans-serif%27%20font-size%3D%27220%27%20font-weight%3D%27900%27%20fill%3D%27%25234ade80%27%20text-anchor%3D%27middle%27%253EC%253C%2Ftext%253E%253C%2Fsvg%253E%22%2C%0A%20%20%20%20%20%20%22sizes%22%3A%20%22512x512%22%2C%0A%20%20%20%20%20%20%22type%22%3A%20%22image%2Fsvg%2Bxml%22%2C%0A%20%20%20%20%20%20%22purpose%22%3A%20%22any%22%0A%20%20%20%20%7D%2C%0A%20%20%20%20%7B%0A%20%20%20%20%20%20%22src%22%3A%20%22data%3Aimage%2Fsvg%2Bxml%2C%253Csvg%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%20viewBox%3D%270%200%20512%20512%27%253E%253Crect%20width%3D%27512%27%20height%3D%27512%27%20rx%3D%27115%27%20fill%3D%27%25230d0f0e%27%2F%253E%253Ccircle%20cx%3D%27256%27%20cy%3D%27256%27%20r%3D%27175%27%20fill%3D%27none%27%20stroke%3D%27%25234ade80%27%20stroke-width%3D%2724%27%2F%253E%253Ctext%20x%3D%27256%27%20y%3D%27330%27%20font-family%3D%27Arial%20Black%2Csans-serif%27%20font-size%3D%27220%27%20font-weight%3D%27900%27%20fill%3D%27%25234ade80%27%20text-anchor%3D%27middle%27%253EC%253C%2Ftext%253E%253C%2Fsvg%253E%22%2C%0A%20%20%20%20%20%20%22sizes%22%3A%20%22192x192%22%2C%0A%20%20%20%20%20%20%22type%22%3A%20%22image%2Fsvg%2Bxml%22%2C%0A%20%20%20%20%20%20%22purpose%22%3A%20%22maskable%22%0A%20%20%20%20%7D%0A%20%20%5D%0A%7D">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0f0e;
    --surface: #161a18;
    --surface2: #1e2420;
    --surface3: #252c28;
    --border: #2e3832;
    --green: #4ade80;
    --green-dim: #22c55e;
    --green-glow: rgba(74,222,128,0.15);
    --green-dark: #166534;
    --accent: #facc15;
    --accent2: #fb923c;
    --text: #e8ede9;
    --text-dim: #8a9e8f;
    --text-muted: #4a5e50;
    --red: #f87171;
    --blue: #60a5fa;
    --radius: 12px;
    --radius-lg: 20px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }

  /* NOISE TEXTURE */
  body::before { content: ''; position: fixed; inset: 0; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E"); pointer-events: none; z-index: 9999; opacity: 0.4; }

  /* ‚îÄ‚îÄ AUTH SCREEN ‚îÄ‚îÄ */
  #auth-screen { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; background: radial-gradient(ellipse at 30% 50%, rgba(74,222,128,0.06) 0%, transparent 60%), radial-gradient(ellipse at 70% 20%, rgba(250,204,21,0.04) 0%, transparent 50%); }
  .auth-box { width: 100%; max-width: 440px; }
  .auth-logo { font-family: 'Bebas Neue', sans-serif; font-size: 52px; letter-spacing: 3px; color: var(--green); text-shadow: 0 0 40px rgba(74,222,128,0.4); margin-bottom: 4px; }
  .auth-tagline { color: var(--text-dim); font-size: 14px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 40px; }
  .auth-tabs { display: flex; gap: 0; margin-bottom: 28px; border-radius: var(--radius); overflow: hidden; border: 1px solid var(--border); }
  .auth-tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-size: 14px; font-weight: 500; background: var(--surface2); color: var(--text-dim); transition: all 0.2s; }
  .auth-tab.active { background: var(--green); color: #0d0f0e; font-weight: 600; }

  /* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
  .form-group { margin-bottom: 16px; }
  label { display: block; font-size: 12px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; color: var(--text-dim); margin-bottom: 8px; }
  input, select, textarea { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px 16px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 14px; outline: none; transition: border-color 0.2s; }
  input:focus, select:focus, textarea:focus { border-color: var(--green); box-shadow: 0 0 0 3px var(--green-glow); }
  select option { background: var(--surface2); }
  textarea { resize: vertical; min-height: 80px; }

  /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
  .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 13px 24px; border-radius: var(--radius); font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; text-decoration: none; }
  .btn-primary { background: var(--green); color: #0d0f0e; }
  .btn-primary:hover { background: #86efac; transform: translateY(-1px); box-shadow: 0 8px 24px rgba(74,222,128,0.3); }
  .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-dim); }
  .btn-outline:hover { border-color: var(--green); color: var(--green); background: var(--green-glow); }
  .btn-danger { background: rgba(248,113,113,0.15); border: 1px solid rgba(248,113,113,0.3); color: var(--red); }
  .btn-danger:hover { background: rgba(248,113,113,0.25); }
  .btn-full { width: 100%; }
  .btn-sm { padding: 8px 14px; font-size: 13px; border-radius: 8px; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

  /* ‚îÄ‚îÄ APP LAYOUT ‚îÄ‚îÄ */
  #app { display: none; height: 100vh; overflow: hidden; }
  #app.visible { display: flex; }
  .sidebar { width: 240px; flex-shrink: 0; background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; height: 100vh; overflow-y: auto; }
  .sidebar-logo { font-family: 'Bebas Neue', sans-serif; font-size: 22px; letter-spacing: 2px; color: var(--green); padding: 20px 16px 12px; border-bottom: 1px solid var(--border); }
  .sidebar-user { padding: 12px 16px; border-bottom: 1px solid var(--border); }
  .user-chip { display: flex; align-items: center; gap: 10px; padding: 8px 10px; border-radius: 10px; cursor: pointer; transition: background 0.15s; }
  .user-chip:hover { background: var(--surface2); }
  .user-avatar { width: 34px; height: 34px; border-radius: 50%; background: var(--green); color: #0d0f0e; font-size: 15px; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .user-name { font-size: 14px; font-weight: 600; }
  .sidebar-nav { flex: 1; padding: 12px 8px; overflow-y: auto; }
  .nav-item { display: flex; align-items: center; gap: 12px; padding: 11px 14px; border-radius: 10px; cursor: pointer; color: var(--text-dim); font-size: 14px; font-weight: 500; transition: all 0.15s; margin-bottom: 2px; }
  .nav-item:hover { background: var(--surface2); color: var(--text); }
  .nav-item.active { background: var(--green-glow); color: var(--green); }
  .nav-item .nav-icon { font-size: 18px; width: 22px; text-align: center; }
  .sidebar-bottom { padding: 16px; border-top: 1px solid var(--border); }
  .main { flex: 1; overflow-y: auto; overflow-x: hidden; background: var(--bg); height: 100vh; -webkit-overflow-scrolling: touch; }
  .page { display: none; padding: 28px 32px 80px; max-width: 900px; }
  .page.active { display: block; }
  .page-title { font-family: 'Bebas Neue', sans-serif; font-size: 42px; letter-spacing: 1px; line-height: 1; margin-bottom: 4px; }
  .page-sub { color: var(--text-dim); font-size: 14px; margin-bottom: 24px; }

  /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 16px; }
  .card-title { font-family: 'Bebas Neue', sans-serif; font-size: 22px; letter-spacing: 0.5px; margin-bottom: 14px; }

  /* ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ */
  .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 20px; }
  .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 18px; }
  .stat-card.calories { border-color: rgba(250,204,21,0.3); }
  .stat-card.protein { border-color: rgba(74,222,128,0.3); }
  .stat-card.fat { border-color: rgba(251,146,60,0.3); }
  .stat-card.carbs { border-color: rgba(96,165,250,0.3); }
  .stat-value { font-family: 'Bebas Neue', sans-serif; font-size: 42px; line-height: 1; }
  .stat-unit { font-size: 14px; color: var(--text-dim); margin-left: 3px; }
  .stat-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-top: 4px; }
  .stat-goal { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
  .stat-bar { height: 4px; background: var(--border); border-radius: 2px; margin-top: 10px; overflow: hidden; }
  .stat-bar-fill { height: 100%; border-radius: 2px; background: var(--green); transition: width 0.5s ease; }
  .stat-card.calories .stat-bar-fill { background: var(--accent); }
  .stat-card.fat .stat-bar-fill { background: var(--accent2); }
  .stat-card.carbs .stat-bar-fill { background: var(--blue); }

  /* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
  .badge { display: inline-block; padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: 700; }
  .badge-green { background: var(--green-glow); color: var(--green); border: 1px solid rgba(74,222,128,0.3); }
  .badge-yellow { background: rgba(250,204,21,0.15); color: var(--accent); border: 1px solid rgba(250,204,21,0.3); }

  /* ‚îÄ‚îÄ TABLES ‚îÄ‚îÄ */
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { text-align: left; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); padding: 8px 12px; border-bottom: 1px solid var(--border); }
  td { padding: 10px 12px; border-bottom: 1px solid var(--border); color: var(--text-dim); }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: var(--surface2); }

  /* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(6px); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 28px; width: 100%; animation: slideUp 0.2s ease; }
  @keyframes slideUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
  .modal-title { font-family: 'Bebas Neue', sans-serif; font-size: 28px; letter-spacing: 0.5px; margin-bottom: 4px; }
  .modal-sub { font-size: 14px; color: var(--text-dim); margin-bottom: 20px; }

  /* ‚îÄ‚îÄ FOOD LOG ‚îÄ‚îÄ */
  .date-bar { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
  .date-nav { display: flex; align-items: center; gap: 8px; }
  .date-nav button { background: var(--surface2); border: 1px solid var(--border); color: var(--text-dim); width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; }
  .date-nav button:hover { border-color: var(--green); color: var(--green); }
  #log-date-label { font-weight: 600; font-size: 15px; }
  .search-bar { display: flex; gap: 10px; margin-bottom: 14px; flex-wrap: wrap; }
  .search-bar input { flex: 1; min-width: 200px; }
  .meal-section { margin-bottom: 20px; }
  .meal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
  .meal-title { font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); }
  .meal-cals { font-size: 12px; color: var(--text-muted); }
  .food-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); gap: 10px; }
  .food-item:last-child { border-bottom: none; }
  .food-name { font-size: 14px; font-weight: 500; }
  .food-brand { font-size: 12px; color: var(--text-muted); }
  .food-macros { display: flex; gap: 12px; font-size: 12px; color: var(--text-muted); flex-wrap: wrap; }
  .food-cals { font-weight: 700; font-size: 15px; font-family: 'Bebas Neue', sans-serif; }
  .search-results { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius); margin-top: 6px; max-height: 340px; overflow-y: auto; }
  .search-result-item { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.15s; }
  .search-result-item:hover { background: var(--surface3); }
  .search-result-item:last-child { border-bottom: none; }
  .source-tabs { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; }
  .source-tab { padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer; border: 1px solid var(--border); background: var(--surface2); color: var(--text-dim); transition: all 0.15s; }
  .source-tab.active { background: var(--green); color: #0d0f0e; border-color: var(--green); }
  .manual-badge { display: inline-block; padding: 2px 7px; border-radius: 8px; font-size: 10px; font-weight: 700; background: rgba(250,204,21,0.15); color: var(--accent); border: 1px solid rgba(250,204,21,0.3); margin-left: 6px; }

  /* ‚îÄ‚îÄ WORKOUT LOG ‚îÄ‚îÄ */
  .workout-card { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; margin-bottom: 12px; }
  .workout-card-header { display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
  .workout-card-title { font-weight: 600; font-size: 15px; }
  .workout-card-meta { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
  .stat-pills { display: flex; gap: 8px; flex-wrap: wrap; }
  .stat-pill { background: var(--surface3); border: 1px solid var(--border); border-radius: 20px; padding: 4px 12px; font-size: 12px; font-weight: 600; }
  .exercise-row { display: flex; align-items: baseline; gap: 8px; padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
  .exercise-row:last-child { border-bottom: none; }
  .exercise-name { font-weight: 600; min-width: 160px; }
  .exercise-sets { font-family: 'DM Mono', monospace; color: var(--text-muted); font-size: 12px; }
  .streak-badge { display: flex; align-items: center; gap: 6px; background: rgba(250,204,21,0.1); border: 1px solid rgba(250,204,21,0.2); border-radius: var(--radius); padding: 10px 16px; margin-bottom: 16px; font-size: 13px; font-weight: 600; color: var(--accent); }
  .pr-badge { display: inline-block; padding: 1px 6px; border-radius: 6px; font-size: 10px; font-weight: 700; background: rgba(250,204,21,0.15); color: var(--accent); border: 1px solid rgba(250,204,21,0.3); margin-left: 4px; }

  /* ‚îÄ‚îÄ AI PLAN ‚îÄ‚îÄ */
  .ai-provider-card { display:flex; align-items:center; gap:12px; padding:14px 16px; border-radius:var(--radius); border:2px solid var(--border); background:var(--surface2); cursor:pointer; transition:all 0.2s; }
  .ai-provider-card:hover { border-color: var(--green); }
  .ai-provider-card.active { border-color: var(--green); background: rgba(74,222,128,0.08); }
  .ai-provider-logo { width:38px; height:38px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:20px; color:#fff; font-weight:900; flex-shrink:0; }
  .ai-provider-name { font-weight:700; font-size:15px; }
  .ai-provider-sub  { font-size:11px; color:var(--text-muted); }
  .ai-provider-check { margin-left:auto; width:22px; height:22px; border-radius:50%; background:var(--green); color:#0d0f0e; font-size:12px; font-weight:900; display:flex; align-items:center; justify-content:center; }
  .ai-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .api-key-note { background: rgba(250,204,21,0.08); border: 1px solid rgba(250,204,21,0.2); border-radius: var(--radius); padding: 14px 16px; font-size: 13px; color: var(--accent); margin-bottom: 16px; }
  .ai-plan-output { font-size: 14px; color: var(--text-dim); line-height: 1.8; white-space: pre-wrap; }
  .goal-chip { padding:6px 13px; border-radius:20px; border:1px solid var(--border); background:var(--surface2); color:var(--text-dim); font-size:12px; font-weight:600; cursor:pointer; transition:all 0.15s; font-family:'DM Sans',sans-serif; }
  .goal-chip:hover { border-color:var(--green); color:var(--green); background:var(--green-glow); }
  .goal-chip.added, .goal-chip.selected { background:var(--green-glow); border-color:var(--green); color:var(--green); }
  .btn-accent { background:linear-gradient(135deg,var(--green),var(--green-dim)); color:#0d0f0e; font-weight:700; }
  .btn-accent:hover { filter:brightness(1.1); transform:translateY(-1px); box-shadow:0 8px 24px rgba(74,222,128,0.3); }
  .plan-output { margin-top:20px; padding:20px; background:var(--surface2); border-radius:var(--radius); border:1px solid var(--border); font-size:13px; color:var(--text-dim); line-height:1.8; white-space:pre-wrap; }
  .plan-output.loading { color:var(--text-muted); font-style:italic; }
  .plan-actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:16px; padding-top:16px; border-top:1px solid var(--border); }
  .goals-adjusted-banner { background:rgba(74,222,128,0.08); border:1px solid rgba(74,222,128,0.25); border-radius:var(--radius); padding:14px 16px; margin-top:12px; font-size:13px; }
  .goals-adjusted-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-top:10px; }

  /* ‚îÄ‚îÄ WEEKLY PLAN ‚îÄ‚îÄ */
  .wp-day-btn { flex-shrink:0; width:54px; display:flex; flex-direction:column; align-items:center; padding:10px 6px; border-radius:12px; border:2px solid var(--border); background:var(--surface2); cursor:pointer; transition:all 0.15s; gap:2px; }
  .wp-day-btn:hover { border-color:var(--green); background:var(--green-glow); }
  .wp-day-btn.active { border-color:var(--green); background:var(--green-glow); }
  .wp-day-btn.today { border-color:var(--accent); }
  .wp-day-name { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); }
  .wp-day-num  { font-family:'Bebas Neue',sans-serif; font-size:20px; color:var(--text); line-height:1; }
  .wp-day-dot  { width:5px; height:5px; border-radius:50%; background:var(--green); margin-top:2px; }
  .wp-meal-row { display:flex; gap:12px; padding:10px 14px; background:var(--surface2); border-radius:10px; margin-bottom:8px; border:1px solid var(--border); }
  .wp-meal-icon { font-size:22px; flex-shrink:0; }
  .wp-meal-info { flex:1; }
  .wp-meal-type { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); }
  .wp-meal-name { font-size:13px; font-weight:600; color:var(--text); margin:2px 0; }
  .wp-meal-macros { font-size:11px; color:var(--text-muted); }
  .wp-workout-chip { display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:8px; background:rgba(74,222,128,0.08); border:1px solid rgba(74,222,128,0.2); font-size:12px; font-weight:600; color:var(--green); margin:3px; }
  .wp-rest-badge { display:inline-flex; align-items:center; gap:6px; padding:8px 14px; border-radius:8px; background:var(--surface3); border:1px solid var(--border); font-size:13px; color:var(--text-muted); }
  .goal-adj-box { text-align:center; padding:10px 6px; background:var(--surface); border-radius:10px; border:1px solid var(--border); }
  .goal-adj-val { font-family:'Bebas Neue',sans-serif; font-size:22px; color:var(--green); line-height:1; }
  .goal-adj-lbl { font-size:10px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; margin-top:2px; }
  /* ‚îÄ‚îÄ WEIGHT LOG & PROGRESS PHOTOS ‚îÄ‚îÄ */
  .weight-entry-row { display:flex; align-items:center; justify-content:space-between; padding:10px 0; border-bottom:1px solid var(--border); }
  .weight-entry-row:last-child { border-bottom:none; }
  .weight-chart-bar-wrap { display:flex; align-items:center; gap:10px; margin-bottom:6px; }
  .weight-chart-bar-track { flex:1; height:18px; background:var(--surface2); border-radius:6px; overflow:hidden; border:1px solid var(--border); position:relative; }
  .weight-chart-bar-fill { height:100%; border-radius:6px; display:flex; align-items:center; justify-content:flex-end; padding-right:6px; font-size:10px; font-weight:700; color:#0d0f0e; transition:width 0.4s; min-width:30px; }
  .photo-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:12px; }
  .photo-thumb { position:relative; aspect-ratio:3/4; border-radius:10px; overflow:hidden; cursor:pointer; border:2px solid var(--border); transition:border-color 0.15s; }
  .photo-thumb:hover { border-color:var(--green); }
  .photo-thumb img { width:100%; height:100%; object-fit:cover; display:block; }
  .photo-thumb-label { position:absolute; bottom:0; left:0; right:0; background:linear-gradient(transparent,rgba(0,0,0,0.7)); padding:6px 8px; font-size:10px; color:#fff; font-weight:600; }
  .photo-thumb-del { position:absolute; top:4px; right:4px; width:22px; height:22px; border-radius:50%; background:rgba(248,113,113,0.9); border:none; color:#fff; font-size:12px; cursor:pointer; display:flex; align-items:center; justify-content:center; line-height:1; font-family:sans-serif; }
  .photo-lightbox { position:fixed; inset:0; background:rgba(0,0,0,0.92); z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; }
  .photo-lightbox img { max-width:92vw; max-height:75vh; object-fit:contain; border-radius:12px; }
  .photo-lightbox-nav { display:flex; align-items:center; gap:20px; margin-top:16px; }
  .tlapse-progress { width:100%; height:6px; background:var(--surface2); border-radius:3px; margin-top:8px; overflow:hidden; }
  .tlapse-progress-fill { height:100%; background:var(--green); border-radius:3px; transition:width 0.1s; }

  /* ‚îÄ‚îÄ SLEEP LOG ‚îÄ‚îÄ */
  .sleep-bar-wrap { display:flex; align-items:center; gap:10px; margin-bottom:8px; }
  .sleep-bar-label { width:32px; font-size:11px; color:var(--text-muted); text-align:right; flex-shrink:0; }
  .sleep-bar-track { flex:1; height:22px; background:var(--surface2); border-radius:8px; overflow:hidden; position:relative; border:1px solid var(--border); }
  .sleep-bar-fill  { height:100%; border-radius:8px; display:flex; align-items:center; justify-content:flex-end; padding-right:8px; font-size:10px; font-weight:700; color:#0d0f0e; transition:width 0.4s ease; min-width:24px; }
  .sleep-bar-date  { width:28px; font-size:10px; color:var(--text-muted); text-align:right; flex-shrink:0; }

  .spinner { width: 18px; height: 18px; border: 2px solid var(--border); border-top-color: var(--green); border-radius: 50%; animation: spin 0.6s linear infinite; display: inline-block; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .chip-input-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
  .ai-chip { padding: 6px 14px; border-radius: 20px; background: var(--surface2); border: 1px solid var(--border); color: var(--text-dim); font-size: 13px; cursor: pointer; transition: all 0.15s; }
  .ai-chip:hover, .ai-chip.selected { background: var(--green-glow); border-color: var(--green); color: var(--green); }

  /* ‚îÄ‚îÄ RECIPES ‚îÄ‚îÄ */
  .recipes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
  .recipe-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 20px; cursor: pointer; transition: all 0.2s; }
  .recipe-card:hover { border-color: var(--green); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
  .recipe-emoji { font-size: 36px; margin-bottom: 10px; }
  .recipe-name { font-family: 'Bebas Neue', sans-serif; font-size: 22px; letter-spacing: 0.5px; margin-bottom: 4px; }
  .recipe-author { font-size: 12px; color: var(--text-muted); margin-bottom: 8px; }
  .recipe-desc { font-size: 13px; color: var(--text-dim); line-height: 1.5; margin-bottom: 12px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .recipe-macros { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
  .recipe-macro { text-align: center; }
  .recipe-macro-val { font-family: 'Bebas Neue', sans-serif; font-size: 20px; line-height: 1; }
  .recipe-macro-lbl { font-size: 10px; color: var(--text-muted); text-transform: uppercase; }
  .recipe-tags { display: flex; gap: 6px; flex-wrap: wrap; }
  .recipe-tag { padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: var(--surface2); border: 1px solid var(--border); color: var(--text-dim); }
  .cat-breakfast { background: rgba(250,204,21,0.1); border-color: rgba(250,204,21,0.2); color: var(--accent); }
  .cat-lunch { background: rgba(74,222,128,0.1); border-color: rgba(74,222,128,0.2); color: var(--green); }
  .cat-dinner { background: rgba(96,165,250,0.1); border-color: rgba(96,165,250,0.2); color: var(--blue); }
  .cat-snack { background: rgba(251,146,60,0.1); border-color: rgba(251,146,60,0.2); color: var(--accent2); }
  .cat-smoothie, .cat-dessert { background: rgba(248,113,113,0.1); border-color: rgba(248,113,113,0.2); color: var(--red); }
  .recipe-filter-bar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
  .filter-btn { padding: 6px 16px; border-radius: 20px; border: 1px solid var(--border); background: var(--surface2); color: var(--text-dim); font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.15s; font-family: 'DM Sans', sans-serif; }
  .filter-btn.active, .filter-btn:hover { background: var(--green-glow); border-color: var(--green); color: var(--green); }

  /* ‚îÄ‚îÄ USERS GRID ‚îÄ‚îÄ */
  .users-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 14px; }
  .user-card { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s; }
  .user-card:hover { border-color: var(--green); transform: translateY(-2px); }
  .user-card.active-user { border-color: var(--green); background: var(--green-glow); }
  .uc-avatar { width: 52px; height: 52px; border-radius: 50%; background: var(--green); color: #0d0f0e; font-size: 22px; font-weight: 700; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; }
  .uc-name { font-weight: 700; font-size: 15px; }
  .uc-goal { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

  /* ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ */
  .success-msg { background: rgba(74,222,128,0.1); border: 1px solid rgba(74,222,128,0.2); color: var(--green); border-radius: var(--radius); padding: 10px 14px; font-size: 13px; }
  .error-msg { background: rgba(248,113,113,0.08); border: 1px solid rgba(248,113,113,0.2); color: var(--red); border-radius: var(--radius); padding: 10px 14px; font-size: 13px; }

  /* ‚îÄ‚îÄ GOOGLE SHEETS ‚îÄ‚îÄ */
  .sheets-connected { display: flex; align-items: center; gap: 10px; background: rgba(74,222,128,0.08); border: 1px solid rgba(74,222,128,0.2); border-radius: var(--radius); padding: 12px 16px; font-size: 14px; color: var(--green); margin-bottom: 20px; }

  /* ‚îÄ‚îÄ MOBILE RESPONSIVE ‚îÄ‚îÄ */
  @media (max-width: 768px) {
    /* Hide desktop sidebar on mobile */
    .sidebar { display: none !important; }
    #app { overflow: visible !important; height: auto !important; min-height: 100vh; }
    #app.visible { flex-direction: column; }
    .main { width: 100%; flex: 1; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; height: auto; min-height: 0; max-height: calc(100vh - 64px); }
    .page { padding: 16px 14px 100px; }
    .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .ai-form-grid { grid-template-columns: 1fr; }
    #mi-input-grid { grid-template-columns: 1fr !important; }
    .page-title { font-size: 28px; }
    .hamburger { display: none !important; }
    /* Show bottom tab bar */
    .bottom-tab-bar { display: flex !important; }
  }
  @media (max-width: 480px) {
    .recipes-grid { grid-template-columns: 1fr; }
    .pdf-stats-row { grid-template-columns: repeat(2, 1fr); }
    .bottom-tab-bar .tab-label { font-size: 9px; }
  }

  /* ‚îÄ‚îÄ BOTTOM TAB BAR (mobile only) ‚îÄ‚îÄ */
  .bottom-tab-bar {
    display: none;
    position: fixed;
    bottom: 0; left: 0; right: 0;
    height: 64px;
    background: var(--surface);
    border-top: 1px solid var(--border);
    z-index: 600;
    align-items: stretch;
    padding-bottom: env(safe-area-inset-bottom);
    box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
  }
  .tab-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 3px;
    cursor: pointer;
    background: none;
    border: none;
    color: var(--text-muted);
    font-family: 'DM Sans', sans-serif;
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.2px;
    padding: 6px 2px;
    transition: color 0.15s;
    -webkit-tap-highlight-color: transparent;
    position: relative;
  }
  .tab-btn .tab-icon { font-size: 22px; line-height: 1; }
  .tab-btn .tab-label { font-size: 10px; }
  .tab-btn.active { color: var(--green); }
  .tab-btn.active .tab-icon { filter: drop-shadow(0 0 6px rgba(74,222,128,0.5)); }
  .tab-btn.active::before {
    content: '';
    position: absolute;
    top: 0; left: 20%; right: 20%;
    height: 2px;
    background: var(--green);
    border-radius: 0 0 3px 3px;
  }
  /* "More" menu overlay */
  .more-menu {
    display: none;
    position: fixed;
    bottom: 64px; left: 0; right: 0;
    background: var(--surface);
    border-top: 1px solid var(--border);
    border-radius: 20px 20px 0 0;
    z-index: 601;
    padding: 8px 0 16px;
    box-shadow: 0 -8px 32px rgba(0,0,0,0.4);
    animation: slideUpMenu 0.2s ease;
  }
  .more-menu.open { display: block; }
  @keyframes slideUpMenu { from { transform: translateY(30px); opacity:0; } to { transform: translateY(0); opacity:1; } }
  .more-menu-handle { width: 36px; height: 4px; background: var(--border); border-radius: 2px; margin: 8px auto 16px; }
  .more-menu-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); padding: 0 20px 8px; }
  .more-menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; padding: 0 8px; }
  .more-menu-item {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 6px; padding: 14px 8px; border-radius: 12px; cursor: pointer;
    background: none; border: none; font-family: 'DM Sans', sans-serif;
    color: var(--text-dim); font-size: 12px; font-weight: 500;
    transition: background 0.15s; -webkit-tap-highlight-color: transparent;
  }
  .more-menu-item:hover, .more-menu-item:active { background: var(--surface2); color: var(--text); }
  .more-menu-item.active { color: var(--green); }
  .more-menu-item .mi-icon { font-size: 26px; }
  .more-menu-overlay { display: none; position: fixed; inset: 0; z-index: 599; }
  .more-menu-overlay.open { display: block; }

  /* HAMBURGER ‚Äî only used on desktop medium screens */
  .hamburger { display: none; }
  .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 499; }
  .sidebar-overlay.open { display: block; }
</style>
</head>
<body>
<style>
  /* PWA / Mobile feel */
  * { -webkit-tap-highlight-color: transparent; }
  html, body { overscroll-behavior: none; -webkit-overflow-scrolling: touch; }
  @media (display-mode: standalone) {
    #app .sidebar { padding-top: max(20px, env(safe-area-inset-top)); }
  }

  /* ‚îÄ‚îÄ MEAL IDEAS ‚îÄ‚îÄ */
  .ingredient-chip-row { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
  .ingredient-chip { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; background: var(--surface2); border: 1px solid var(--border); font-size: 13px; color: var(--text-dim); font-weight: 500; }
  .ingredient-chip .chip-del { background: none; border: none; color: var(--text-muted); font-size: 14px; cursor: pointer; padding: 0; line-height: 1; transition: color 0.15s; }
  .ingredient-chip .chip-del:hover { color: var(--red); }
  .ingredient-chip.fridge { border-color: rgba(96,165,250,0.4); background: rgba(96,165,250,0.08); color: var(--blue); }
  .ingredient-chip.cupboard { border-color: rgba(250,204,21,0.4); background: rgba(250,204,21,0.08); color: var(--accent); }
  .meal-idea-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 16px; transition: border-color 0.2s; }
  .meal-idea-card:hover { border-color: var(--green); }
  .meal-idea-title { font-family: 'Bebas Neue', sans-serif; font-size: 26px; letter-spacing: 0.5px; margin-bottom: 4px; }
  .meal-idea-meta { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 12px; }
  .meal-idea-body { font-size: 14px; color: var(--text-dim); line-height: 1.8; }
  .meal-idea-section { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin: 14px 0 6px; }
  .meal-idea-ingredient.have { display:inline-flex; align-items:center; gap:5px; padding:4px 10px; border-radius:12px; font-size:12px; font-weight:500; margin:3px; background: rgba(74,222,128,0.12); color: var(--green); border: 1px solid rgba(74,222,128,0.25); }
  .meal-idea-ingredient.need { display:inline-flex; align-items:center; gap:5px; padding:4px 10px; border-radius:12px; font-size:12px; font-weight:500; margin:3px; background: rgba(248,113,113,0.12); color: var(--red); border: 1px solid rgba(248,113,113,0.25); }
  .meal-macros-row { display: flex; gap: 16px; flex-wrap: wrap; padding: 12px 16px; background: var(--surface2); border-radius: var(--radius); margin-top: 12px; }
  .quick-add-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; margin-bottom: 16px; }
  .quick-add-btn { padding: 8px 10px; border-radius: var(--radius); border: 1px solid var(--border); background: var(--surface2); color: var(--text-dim); font-size: 12px; font-weight: 500; cursor: pointer; text-align: center; transition: all 0.15s; font-family: 'DM Sans', sans-serif; }
  .quick-add-btn:hover { border-color: var(--green); color: var(--green); background: var(--green-glow); }
  .mi-streaming { white-space: pre-wrap; font-size: 14px; color: var(--text-dim); line-height: 1.8; font-family: 'DM Sans', sans-serif; min-height: 60px; }
  .mi-cursor { display: inline-block; width: 2px; height: 1em; background: var(--green); animation: blink 0.8s infinite; vertical-align: text-bottom; margin-left: 2px; }
  @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0; } }

  /* ‚îÄ‚îÄ PDF / PRINT STYLES ‚îÄ‚îÄ */
  @media print {
    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    body { background: #fff !important; margin: 0 !important; padding: 0 !important; }
    #auth-screen, #app { display: none !important; }
    #pdf-print-frame { display: block !important; }
  }
  #pdf-print-frame { display: none; }

  /* PDF Preview Modal */
  .pdf-modal { max-width: 700px; max-height: 92vh; overflow-y: auto; width: 100%; }
  .pdf-preview { background: #fff; border-radius: 8px; padding: 32px 36px; color: #1a1a1a; font-family: 'DM Sans', -apple-system, sans-serif; box-shadow: 0 4px 24px rgba(0,0,0,0.15); }
  .pdf-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 3px solid #0d0f0e; padding-bottom: 16px; margin-bottom: 20px; }
  .pdf-logo { font-family: 'Bebas Neue', sans-serif; font-size: 28px; letter-spacing: 1px; color: #0d0f0e; }
  .pdf-logo span { color: #4ade80; }
  .pdf-date-block { text-align: right; }
  .pdf-date-block .pdf-date { font-size: 15px; font-weight: 700; color: #0d0f0e; }
  .pdf-date-block .pdf-user { font-size: 12px; color: #666; margin-top: 2px; }
  .pdf-section-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; color: #888; margin: 20px 0 10px; }
  .pdf-stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 4px; }
  .pdf-stat-box { border-radius: 10px; padding: 14px 12px; text-align: center; }
  .pdf-stat-box.cals    { background: #fef3c7; border: 1px solid #fde68a; }
  .pdf-stat-box.protein { background: #dcfce7; border: 1px solid #86efac; }
  .pdf-stat-box.carbs   { background: #dbeafe; border: 1px solid #93c5fd; }
  .pdf-stat-box.fat     { background: #ffedd5; border: 1px solid #fdba74; }
  .pdf-stat-val  { font-size: 28px; font-weight: 800; line-height: 1; }
  .pdf-stat-unit { font-size: 12px; font-weight: 600; margin-left: 2px; }
  .pdf-stat-label { font-size: 11px; color: #666; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
  .pdf-stat-goal  { font-size: 10px; color: #999; margin-top: 2px; }
  .pdf-bar-wrap { height: 6px; background: #e5e7eb; border-radius: 3px; margin-top: 6px; overflow: hidden; }
  .pdf-bar-fill { height: 100%; border-radius: 3px; }
  .pdf-meal-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f3f4f6; font-size: 13px; }
  .pdf-meal-row:last-child { border-bottom: none; }
  .pdf-meal-icon { font-size: 16px; margin-right: 8px; }
  .pdf-meal-name { font-weight: 600; color: #1a1a1a; }
  .pdf-meal-items { font-size: 12px; color: #888; }
  .pdf-meal-cals { font-weight: 700; font-size: 15px; color: #1a1a1a; white-space: nowrap; }
  .pdf-workout-block { background: #f9fafb; border-radius: 8px; padding: 14px 16px; margin-bottom: 10px; border-left: 4px solid #0d0f0e; }
  .pdf-workout-name { font-weight: 700; font-size: 14px; margin-bottom: 4px; }
  .pdf-workout-meta { font-size: 12px; color: #666; display: flex; gap: 12px; flex-wrap: wrap; }
  .pdf-exercise-row { font-size: 12px; color: #444; padding: 4px 0; display: flex; gap: 6px; align-items: baseline; }
  .pdf-exercise-name { font-weight: 600; min-width: 130px; }
  .pdf-exercise-sets { color: #666; font-family: monospace; }
  .pdf-footer { margin-top: 24px; padding-top: 14px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
  .pdf-footer-app { font-size: 11px; color: #aaa; }
  .pdf-footer-date { font-size: 11px; color: #aaa; }
  .pdf-goal-badge { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: #dcfce7; color: #16a34a; border: 1px solid #86efac; }
  .pdf-no-data { font-size: 13px; color: #aaa; font-style: italic; padding: 10px 0; }
  .pdf-totals-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0 0; font-size: 13px; font-weight: 600; border-top: 1px solid #e5e7eb; margin-top: 4px; }
</style>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="auth-screen">
  <div class="auth-box">
    <div class="auth-logo">Chingone Life Tracker</div>
    <div class="auth-tagline">Your group health & fitness companion</div>

    <div class="auth-tabs">
      <div class="auth-tab active" onclick="switchAuthTab('login')">Sign In</div>
      <div class="auth-tab" onclick="switchAuthTab('register')">Create Account</div>
    </div>

    <!-- LOGIN -->
    <div id="login-form">
      <div class="form-group">
        <label>Username</label>
        <input type="text" id="login-username" placeholder="Enter your username">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="login-password" placeholder="Enter your password">
      </div>
      <div class="error-msg" id="login-error">Invalid username or password.</div>
      <button class="btn btn-primary btn-full" style="margin-top:8px" onclick="doLogin()">Sign In ‚Üí</button>
      <div style="text-align:center;margin-top:10px;font-size:12px;color:var(--text-muted);">üîí You'll stay signed in automatically</div>
      <div style="margin-top:16px; padding:14px; background:var(--surface2); border-radius:var(--radius); font-size:13px; color:var(--text-dim);">
        üí° Demo users: <strong style="color:var(--text)">sarah</strong> / <strong style="color:var(--text)">demo123</strong> &nbsp;or&nbsp; <strong style="color:var(--text)">mike</strong> / <strong style="color:var(--text)">demo123</strong>
      </div>
    </div>

    <!-- REGISTER -->
    <div id="register-form" style="display:none">
      <div class="ai-form-grid">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="reg-username" placeholder="Choose a username">
        </div>
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="reg-name" placeholder="Your full name">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="reg-password" placeholder="Create a password">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="reg-email" placeholder="your@email.com">
        </div>
        <div class="form-group">
          <label>Age</label>
          <input type="number" id="reg-age" placeholder="25">
        </div>
        <div class="form-group">
          <label>Gender</label>
          <select id="reg-gender">
            <option value="male">Male</option>
            <option value="female">Female</option>
            <option value="other">Other / Prefer not to say</option>
          </select>
        </div>
        <div class="form-group">
          <label>Height (inches)</label>
          <input type="number" id="reg-height" placeholder="68">
        </div>
        <div class="form-group">
          <label>Weight (lbs)</label>
          <input type="number" id="reg-weight" placeholder="160">
        </div>
        <div class="form-group full">
          <label>Primary Goal</label>
          <select id="reg-goal">
            <option value="lose_weight">Lose Weight</option>
            <option value="build_muscle">Build Muscle</option>
            <option value="maintain">Maintain Weight</option>
            <option value="improve_fitness">Improve Overall Fitness</option>
          </select>
        </div>
      </div>
      <div class="error-msg" id="reg-error" style="display:none;"></div>
      <button class="btn btn-primary btn-full" style="margin-top:8px" onclick="doRegister()">Create Account ‚Üí</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="app">
  <!-- Mobile sidebar overlay -->
  <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-logo">Chingone Life Tracker</div>
    <div class="sidebar-user">
      <div class="user-chip" onclick="navigate('users')">
        <div class="user-avatar" id="sidebar-avatar">S</div>
        <div class="user-name" id="sidebar-username">Sarah</div>
      </div>
    </div>
    <div class="sidebar-nav">
      <div class="nav-item active" onclick="navigate('dashboard')"><span class="nav-icon">üìä</span> Dashboard</div>
      <div class="nav-item" onclick="navigate('food-log')"><span class="nav-icon">ü•ó</span> Food Log</div>
      <div class="nav-item" onclick="navigate('workout-log')"><span class="nav-icon">üèãÔ∏è</span> Workout Log</div>
      <div class="nav-item" onclick="navigate('sleep-log')"><span class="nav-icon">üò¥</span> Sleep Log</div>
      <div class="nav-item" onclick="navigate('ai-plan')"><span class="nav-icon">ü§ñ</span> AI Plan</div>
      <div class="nav-item" onclick="navigate('weekly-plan')"><span class="nav-icon">üìÖ</span> Weekly Plan</div>
      <div class="nav-item" onclick="navigate('meal-ideas')"><span class="nav-icon">üßë‚Äçüç≥</span> Meal Ideas</div>
      <div class="nav-item" onclick="navigate('recipes')"><span class="nav-icon">üìñ</span> Recipes</div>
      <div class="nav-item" onclick="navigate('history')"><span class="nav-icon">üìÖ</span> History</div>
      <div class="nav-item" onclick="navigate('import')"><span class="nav-icon">üì•</span> Import Data</div>
      <div class="nav-item" onclick="navigate('sheets')"><span class="nav-icon">üìä</span> Google Sheets</div>
      <div class="nav-item" onclick="navigate('profile')"><span class="nav-icon">üë§</span> My Profile</div>
      <div class="nav-item" onclick="navigate('progress')"><span class="nav-icon">üì∏</span> Progress</div>
      <div class="nav-item" onclick="navigate('users')"><span class="nav-icon">üë•</span> Switch User</div>
      <div class="nav-item" id="nav-admin" style="display:none;" onclick="navigate('admin')"><span class="nav-icon">üõ°Ô∏è</span> Admin Panel</div>
      <div class="nav-item" onclick="navigate('install')"><span class="nav-icon">üì≤</span> Install App</div>
    </div>
    <div class="sidebar-bottom">
      <div id="sidebar-whatsapp" style="display:none;margin-bottom:10px;">
        <button class="btn btn-whatsapp btn-full" onclick="openWhatsApp()" style="justify-content:center;gap:8px;">
          <span style="font-size:18px;">üí¨</span> Open WhatsApp Group
        </button>
      </div>
      <button class="btn btn-outline btn-full btn-sm" onclick="doLogout()">Sign Out</button>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main">

    <!-- ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ -->
    <div class="page active" id="page-dashboard">
      <!-- Header row: greeting + date nav -->
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:6px;">
        <!-- Left: hamburger + greeting -->
        <div style="display:flex;align-items:center;gap:12px;">
          <div>
            <div class="page-title" id="dash-greeting" style="margin-bottom:2px;">Good morning, Sarah</div>
            <div class="page-sub" id="dash-date" style="margin-bottom:0;">Wednesday, February 18, 2026</div>
          </div>
        </div>
        <!-- Right: share + date navigator -->
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <button class="btn btn-outline btn-sm" onclick="shareDashboardPDF()" style="display:flex;align-items:center;gap:6px;">
            <span>üì§</span> Share Day
          </button>
          <div style="display:flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px 14px;">
            <button onclick="changeDashDate(-1)" style="background:none;border:none;color:var(--text-dim);font-size:18px;cursor:pointer;padding:0 4px;line-height:1;transition:color 0.15s;" onmouseover="this.style.color='var(--green)'" onmouseout="this.style.color='var(--text-dim)'">&#8249;</button>
            <div style="text-align:center;min-width:110px;">
              <div id="dash-nav-date" style="font-size:13px;font-weight:600;color:var(--text);">Today</div>
              <div id="dash-nav-day" style="font-size:11px;color:var(--text-muted);">Feb 18</div>
            </div>
            <button onclick="changeDashDate(1)" id="dash-next-btn" style="background:none;border:none;color:var(--text-dim);font-size:18px;cursor:pointer;padding:0 4px;line-height:1;transition:color 0.15s;" onmouseover="this.style.color='var(--green)'" onmouseout="this.style.color='var(--text-dim)'">&#8250;</button>
          </div>
        </div>
      </div>

      <!-- "Viewing past day" banner -->
      <div id="dash-past-banner" style="display:none;background:rgba(250,204,21,0.08);border:1px solid rgba(250,204,21,0.2);border-radius:var(--radius);padding:10px 16px;margin-bottom:16px;font-size:13px;color:var(--accent);display:none;align-items:center;justify-content:space-between;">
        <span>&#128337; Viewing a past day&#39;s metrics</span>
        <button onclick="jumpDashToday()" style="background:none;border:1px solid rgba(250,204,21,0.3);border-radius:6px;padding:4px 10px;color:var(--accent);font-size:12px;cursor:pointer;font-family:'DM Sans',sans-serif;">Back to Today</button>
      </div>

      <!-- Nutrition stat cards -->
      <div class="stats-grid" style="margin-top:16px;">
        <div class="stat-card calories">
          <div><span class="stat-value" id="d-cals">0</span><span class="stat-unit">kcal</span></div>
          <div class="stat-label">Calories</div>
          <div class="stat-goal" id="d-cals-goal">Goal: 1800 kcal</div>
          <div class="stat-bar"><div class="stat-bar-fill" id="d-cals-bar" style="width:0%"></div></div>
        </div>
        <div class="stat-card protein">
          <div><span class="stat-value" id="d-protein">0</span><span class="stat-unit">g</span></div>
          <div class="stat-label">Protein</div>
          <div class="stat-goal" id="d-protein-goal">Goal: 120g</div>
          <div class="stat-bar"><div class="stat-bar-fill" id="d-protein-bar" style="width:0%"></div></div>
        </div>
        <div class="stat-card fat">
          <div><span class="stat-value" id="d-fat">0</span><span class="stat-unit">g</span></div>
          <div class="stat-label">Fat</div>
          <div class="stat-goal" id="d-fat-goal">Goal: 60g</div>
          <div class="stat-bar"><div class="stat-bar-fill" id="d-fat-bar" style="width:0%"></div></div>
        </div>
        <div class="stat-card carbs">
          <div><span class="stat-value" id="d-carbs">0</span><span class="stat-unit">g</span></div>
          <div class="stat-label">Carbs</div>
          <div class="stat-goal" id="d-carbs-goal">Goal: 200g</div>
          <div class="stat-bar"><div class="stat-bar-fill" id="d-carbs-bar" style="width:0%"></div></div>
        </div>
      </div>

      <!-- Sleep & Calories Burned row -->
      <div class="stats-grid" style="grid-template-columns:1fr 1fr;margin-bottom:16px;" id="d-recovery-row">
        <!-- Sleep stat -->
        <div class="stat-card" style="border-top:3px solid var(--blue);cursor:pointer;transition:transform 0.15s,box-shadow 0.15s;" onclick="navigate('sleep-log')" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(96,165,250,0.15)'" onmouseout="this.style.transform='';this.style.boxShadow=''">
          <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:6px;">
            <div>
              <div><span class="stat-value" id="d-sleep-hrs" style="color:var(--blue);">‚Äî</span><span class="stat-unit" style="color:var(--blue);">hrs</span></div>
              <div class="stat-label">Sleep Last Night</div>
            </div>
            <span style="font-size:24px;opacity:0.7;">üò¥</span>
          </div>
          <div id="d-sleep-quality" class="stat-goal" style="margin-bottom:6px;">Not logged</div>
          <div class="stat-bar"><div class="stat-bar-fill" id="d-sleep-bar" style="width:0%;background:var(--blue);"></div></div>
          <div style="font-size:10px;color:var(--text-muted);margin-top:5px;">Tap to log sleep ‚Üí</div>
        </div>
        <!-- Calories burned stat -->
        <div class="stat-card" style="border-top:3px solid #f97316;cursor:pointer;transition:transform 0.15s,box-shadow 0.15s;" onclick="navigate('workout-log')" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(249,115,22,0.15)'" onmouseout="this.style.transform='';this.style.boxShadow=''">
          <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:6px;">
            <div>
              <div><span class="stat-value" id="d-cals-burned">0</span><span class="stat-unit" style="color:#f97316;">kcal</span></div>
              <div class="stat-label">Calories Burned</div>
            </div>
            <span style="font-size:24px;opacity:0.7;">üî•</span>
          </div>
          <div id="d-burned-detail" class="stat-goal" style="margin-bottom:6px;">No workouts logged</div>
          <div class="stat-bar"><div class="stat-bar-fill" id="d-burned-bar" style="width:0%;background:#f97316;"></div></div>
          <div id="d-net-cals" style="font-size:11px;color:var(--text-muted);margin-top:5px;">Net: ‚Äî kcal</div>
        </div>
      </div>

      <!-- Weekly Plan quick-access card -->
      <div class="card" id="d-weekly-plan-card" style="margin-bottom:16px;cursor:pointer;border-left:3px solid var(--green);transition:transform 0.15s,box-shadow 0.15s;" onclick="navigate('weekly-plan')" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(74,222,128,0.15)'" onmouseout="this.style.transform='';this.style.boxShadow=''">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0;" id="d-wp-header">
          <div style="display:flex;align-items:center;gap:10px;">
            <span style="font-size:26px;">üìÖ</span>
            <div>
              <div class="card-title" style="margin-bottom:2px;">Today's Plan</div>
              <div id="d-wp-day-name" style="font-size:12px;color:var(--text-muted);">Loading...</div>
            </div>
          </div>
          <div style="font-size:18px;color:var(--text-muted);">‚Ä∫</div>
        </div>
        <div id="d-wp-preview" style="margin-top:12px;display:none;">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div style="background:var(--surface2);border-radius:8px;padding:10px 12px;border:1px solid var(--border);">
              <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);margin-bottom:6px;">üçΩÔ∏è Meals</div>
              <div id="d-wp-meals" style="font-size:12px;color:var(--text-dim);line-height:1.7;"></div>
            </div>
            <div style="background:var(--surface2);border-radius:8px;padding:10px 12px;border:1px solid var(--border);">
              <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);margin-bottom:6px;">üèãÔ∏è Workout</div>
              <div id="d-wp-workout" style="font-size:12px;color:var(--text-dim);line-height:1.7;"></div>
            </div>
          </div>
          <div style="margin-top:8px;text-align:right;font-size:11px;color:var(--green);font-weight:600;">View full week ‚Üí</div>
        </div>
        <div id="d-wp-no-plan" style="margin-top:8px;font-size:12px;color:var(--text-muted);">No AI plan generated yet. <span style="color:var(--green);font-weight:600;" onclick="event.stopPropagation();navigate('ai-plan')">Generate one ‚Üí</span></div>
      </div>

      <!-- Daily Weigh-In card -->
      <div class="card" style="margin-bottom:16px;border-left:3px solid #a78bfa;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
          <div style="display:flex;align-items:center;gap:10px;">
            <span style="font-size:24px;">‚öñÔ∏è</span>
            <div>
              <div class="card-title" style="margin-bottom:2px;">Daily Weigh-In</div>
              <div id="d-weight-subtitle" style="font-size:12px;color:var(--text-muted);">Track your weight every day</div>
            </div>
          </div>
          <button class="btn btn-outline btn-sm" onclick="navigate('progress')" style="white-space:nowrap;">üìà History</button>
        </div>

        <!-- Current weight display -->
        <div style="display:flex;align-items:flex-end;gap:16px;margin-bottom:14px;flex-wrap:wrap;">
          <div>
            <div style="font-family:'Bebas Neue',sans-serif;font-size:48px;line-height:1;color:#a78bfa;" id="d-weight-display">‚Äî</div>
            <div style="font-size:11px;text-transform:uppercase;letter-spacing:0.8px;color:var(--text-muted);">lbs today</div>
          </div>
          <div id="d-weight-change-badge" style="display:none;padding:6px 12px;border-radius:20px;font-size:13px;font-weight:700;margin-bottom:6px;"></div>
          <div id="d-weight-7day" style="font-size:12px;color:var(--text-muted);margin-bottom:6px;"></div>
        </div>

        <!-- Mini sparkline -->
        <div id="d-weight-sparkline" style="margin-bottom:12px;"></div>

        <!-- Today's progress photo thumbnail (shown after logging) -->
        <div id="d-weigh-photo-preview" style="display:none;margin-bottom:12px;">
          <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--text-muted);margin-bottom:6px;">üì∏ Today's Progress Photo</div>
          <div style="display:flex;gap:10px;align-items:flex-start;">
            <div style="position:relative;width:80px;height:100px;border-radius:10px;overflow:hidden;border:2px solid #a78bfa;flex-shrink:0;">
              <img id="d-weigh-photo-thumb" src="" alt="Progress photo" style="width:100%;height:100%;object-fit:cover;">
              <button onclick="dashDeletePhoto()" style="position:absolute;top:3px;right:3px;width:20px;height:20px;border-radius:50%;background:rgba(248,113,113,0.9);border:none;color:#fff;font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;line-height:1;">‚úï</button>
            </div>
            <div style="font-size:12px;color:var(--text-muted);line-height:1.6;">
              Photo saved with today's weigh-in.<br>
              <span style="color:#a78bfa;font-weight:600;cursor:pointer;" onclick="navigate('progress')">View all photos ‚Üí</span>
            </div>
          </div>
        </div>

        <!-- Quick log row -->
        <div style="background:var(--surface2);border-radius:var(--radius);border:1px solid var(--border);overflow:hidden;">
          <!-- Weight input row -->
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:12px;">
            <span style="font-size:13px;color:var(--text-dim);font-weight:600;white-space:nowrap;">Log today:</span>
            <input type="number" id="d-weigh-input" placeholder="e.g. 182.5" step="0.1"
              style="width:110px;font-size:15px;font-weight:600;padding:9px 12px;"
              onkeydown="if(event.key==='Enter')dashLogWeight()">
            <span style="font-size:12px;color:var(--text-muted);">lbs</span>
            <button class="btn btn-primary btn-sm" onclick="dashLogWeight()" style="padding:9px 16px;background:#a78bfa;border-color:#a78bfa;">üíæ Save</button>
          </div>
          <!-- Photo buttons row -->
          <div style="border-top:1px solid var(--border);padding:10px 12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <span style="font-size:12px;color:var(--text-muted);font-weight:600;">Add progress photo:</span>
            <button class="btn btn-outline btn-sm" onclick="dashOpenCamera()" style="display:flex;align-items:center;gap:5px;font-size:12px;padding:7px 12px;">üì∑ Camera</button>
            <button class="btn btn-outline btn-sm" onclick="document.getElementById('d-weigh-photo-file').click()" style="display:flex;align-items:center;gap:5px;font-size:12px;padding:7px 12px;">üñºÔ∏è Upload</button>
            <input type="file" id="d-weigh-photo-file" accept="image/*" style="display:none;" onchange="dashHandlePhotoUpload(event)">
            <span id="d-weigh-photo-status" style="font-size:11px;color:var(--green);display:none;font-weight:600;">‚úì Photo ready</span>
          </div>
        </div>

        <!-- Camera panel -->
        <div id="d-weigh-camera-panel" style="display:none;margin-top:10px;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;">
          <div style="padding:10px 14px;background:var(--surface2);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;">
            <div style="font-size:13px;font-weight:600;">üì∑ Progress Photo</div>
            <button class="btn btn-outline btn-sm" onclick="dashCloseCamera()" style="padding:4px 8px;font-size:11px;">‚úï Close</button>
          </div>
          <div style="padding:12px;background:var(--surface);">
            <!-- Shot type -->
            <div style="display:flex;gap:6px;margin-bottom:10px;">
              <button class="src-btn src-active" id="dw-shot-Front" onclick="setDwShot('Front')">Front</button>
              <button class="src-btn" id="dw-shot-Side" onclick="setDwShot('Side')">Side</button>
              <button class="src-btn" id="dw-shot-Back" onclick="setDwShot('Back')">Back</button>
            </div>
            <div style="position:relative;background:#000;border-radius:8px;overflow:hidden;min-height:200px;display:flex;align-items:center;justify-content:center;margin-bottom:10px;">
              <video id="d-weigh-video" style="width:100%;max-height:280px;object-fit:cover;display:block;" playsinline autoplay muted></video>
              <canvas id="d-weigh-canvas" style="display:none;"></canvas>
              <div id="d-weigh-cam-placeholder" style="position:absolute;text-align:center;color:#666;">
                <div style="font-size:28px;">üì∑</div>
                <div style="font-size:11px;margin-top:4px;">Starting camera...</div>
              </div>
            </div>
            <button class="btn btn-primary btn-full" id="d-weigh-snap-btn" onclick="dashSnapPhoto()" style="display:none;background:#a78bfa;border-color:#a78bfa;padding:12px;font-size:14px;">üì∏ Take Photo</button>
          </div>
        </div>

        <div id="d-weigh-msg" style="display:none;font-size:12px;color:var(--green);margin-top:8px;font-weight:600;">‚úì Weight logged!</div>
      </div>

      <!-- Food summary card -->
      <div class="card" style="margin-bottom:16px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
          <div class="card-title" style="margin-bottom:0;">&#127829; Food Log</div>
          <button class="btn btn-outline btn-sm" onclick="navigate('food-log')">Log Food &#43;</button>
        </div>
        <div id="dash-food-summary" style="color:var(--text-dim); font-size:14px;">No food logged. Head to the Food Log tab to get started!</div>
      </div>

      <!-- Workout summary card -->
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
          <div class="card-title" style="margin-bottom:0;">&#127947; Workout Summary</div>
          <button class="btn btn-outline btn-sm" onclick="navigate('workout-log')">Log Workout &#43;</button>
        </div>
        <div id="dash-workout-summary">
          <div style="color:var(--text-dim);font-size:14px;">No workouts logged. Head to the Workout Log tab!</div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ FOOD LOG ‚îÄ‚îÄ -->
    <div class="page" id="page-food-log">
      <div class="page-title">Food Log</div>
      <div class="page-sub">Search any food, scan a barcode, or üì∑ snap a photo to auto-log</div>

      <div class="date-bar">
        <div class="date-nav">
          <button onclick="changeLogDate(-1)">‚Äπ</button>
          <button onclick="changeLogDate(1)">‚Ä∫</button>
        </div>
        <div class="date-label" id="log-date-label">Today</div>
      </div>

      <!-- SEARCH BAR -->
      <div class="food-search-bar">
        <div style="position:relative; flex:1;">
          <input type="text" id="food-search-input" placeholder="Search any food or packaged product..." oninput="onFoodSearch(this.value)" onkeydown="if(event.key==='Enter') doFoodSearch()" autocomplete="off">
          <div id="search-spinner" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);display:none;"><div class="spinner"></div></div>
        </div>
        <button class="btn btn-primary" onclick="doFoodSearch()">Search</button>
        <button class="btn btn-outline" onclick="openScanner()" title="Scan Barcode" style="padding:13px 16px;font-size:20px;line-height:1;">&#128247;</button>
        <button class="btn btn-outline" onclick="openFoodCamera()" title="Analyse Food Photo" style="padding:13px 16px;font-size:20px;line-height:1;">&#128065;&#65039;</button>
        <button class="btn btn-outline" onclick="openManualEntry()" title="Log Manually" style="padding:13px 16px;font-size:13px;font-weight:600;white-space:nowrap;">&#9997;&#65039; Manual</button>
      </div>

      <!-- SEARCH SOURCE TOGGLE -->
      <div style="display:flex;gap:8px;margin-bottom:20px;margin-top:-4px;flex-wrap:wrap;">
        <button class="src-btn src-active" id="src-both" onclick="setSearchSource('both')">&#127775; All Foods</button>
        <button class="src-btn" id="src-packaged" onclick="setSearchSource('packaged')">&#128230; Packaged Products (Open Food Facts)</button>
        <button class="src-btn" id="src-local" onclick="setSearchSource('local')">&#129367; Basic Foods (offline)</button>
      </div>

      <!-- SEARCH RESULTS DROPDOWN -->
      <div class="search-results" style="margin-bottom:24px;position:relative;">
        <div id="search-dropdown" class="search-dropdown" style="display:none;"></div>
      </div>

      <!-- FOOD PHOTO ANALYSER PANEL -->
      <div id="food-camera-panel" style="display:none;margin-bottom:24px;">
        <div class="card" style="padding:0;overflow:hidden;">
          <div style="background:var(--surface2);padding:16px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);">
            <div>
              <div style="font-weight:600;font-size:15px;">üì∑ Analyse Food Photo</div>
              <div style="font-size:12px;color:var(--text-dim);margin-top:2px;">Take a photo or upload an image ‚Äî Claude AI will identify the food and estimate nutrition</div>
            </div>
            <button class="btn btn-outline btn-sm" onclick="closeFoodCamera()">‚úï Close</button>
          </div>

          <!-- Camera / Upload area -->
          <div style="padding:16px 20px;">

            <!-- Mode toggle (desktop only) -->
            <div style="display:flex;gap:8px;margin-bottom:16px;">
              <button class="src-btn src-active" id="cam-mode-live" onclick="setCamMode('live')">üì∑ Live Camera</button>
              <button class="src-btn" id="cam-mode-upload" onclick="setCamMode('upload')">üñºÔ∏è Upload Photo</button>
            </div>

            <!-- Live camera view -->
            <div id="cam-live-view">
              <div style="position:relative;background:#000;border-radius:var(--radius);overflow:hidden;min-height:200px;display:flex;align-items:center;justify-content:center;margin-bottom:12px;">
                <video id="food-camera-video" style="width:100%;max-height:280px;display:block;object-fit:cover;" playsinline autoplay muted></video>
                <canvas id="food-camera-canvas" style="display:none;"></canvas>
                <div id="cam-placeholder" style="position:absolute;text-align:center;color:#666;">
                  <div style="font-size:36px;margin-bottom:8px;">üì∑</div>
                  <div style="font-size:13px;">Camera will appear here</div>
                </div>
              </div>
              <button class="btn btn-primary btn-full" id="cam-snap-btn" onclick="snapFoodPhoto()" style="display:none;padding:14px;font-size:15px;">
                üì∏ Take Photo &amp; Analyse
              </button>
            </div>

            <!-- Upload view -->
            <div id="cam-upload-view" style="display:none;">
              <div id="cam-drop-zone" style="border:2px dashed var(--border);border-radius:var(--radius);padding:28px 20px;text-align:center;cursor:pointer;transition:all 0.2s;margin-bottom:12px;"
                onclick="document.getElementById('food-photo-input').click()"
                ondragover="event.preventDefault();this.style.borderColor='var(--green)'"
                ondragleave="this.style.borderColor='var(--border)'"
                ondrop="handlePhotoDrop(event)">
                <div style="font-size:36px;margin-bottom:8px;">üñºÔ∏è</div>
                <div style="font-weight:600;font-size:14px;margin-bottom:4px;">Tap to choose a photo</div>
                <div style="font-size:12px;color:var(--text-muted);">JPG, PNG, WEBP</div>
              </div>
              <input type="file" id="food-photo-input" accept="image/*" style="display:none;" onchange="handlePhotoUpload(event)">
            </div>

            <!-- Preview + result area -->
            <div id="cam-preview-area" style="display:none;margin-top:16px;">

              <!-- Photo preview -->
              <img id="cam-preview-img" style="width:100%;max-height:260px;object-fit:cover;border-radius:var(--radius);border:1px solid var(--border);display:block;margin-bottom:16px;" src="" alt="Food photo">

              <!-- Analysing spinner -->
              <div id="cam-analysing" style="display:none;text-align:center;padding:24px 0;">
                <div class="spinner" style="width:32px;height:32px;border-width:3px;margin:0 auto 12px;"></div>
                <div style="font-weight:700;font-size:15px;margin-bottom:6px;">AI is analysing your food...</div>
                <div style="font-size:12px;color:var(--text-muted);">Identifying ingredients &amp; estimating nutrition</div>
              </div>

              <!-- Result card -->
              <div id="cam-result" style="display:none;">

                <!-- Food name + description -->
                <div style="margin-bottom:14px;">
                  <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:6px;">AI identified:</div>
                  <div id="cam-food-name" style="font-family:'Bebas Neue',sans-serif;font-size:26px;line-height:1.1;margin-bottom:6px;"></div>
                  <div id="cam-food-desc" style="font-size:13px;color:var(--text-dim);line-height:1.6;"></div>
                  <div id="cam-notes" style="display:none;font-size:12px;color:var(--text-muted);margin-top:6px;padding:8px 10px;background:rgba(250,204,21,0.06);border-radius:8px;border:1px solid rgba(250,204,21,0.15);"></div>
                </div>

                <!-- Macro grid -->
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px;">
                  <div style="background:var(--surface2);border-radius:10px;padding:12px 6px;text-align:center;">
                    <div id="cam-kcal" style="font-family:'Bebas Neue',sans-serif;font-size:24px;color:var(--accent);line-height:1;">-</div>
                    <div style="font-size:9px;font-weight:700;text-transform:uppercase;color:var(--text-muted);margin-top:2px;">kcal</div>
                  </div>
                  <div style="background:var(--surface2);border-radius:10px;padding:12px 6px;text-align:center;">
                    <div id="cam-protein" style="font-family:'Bebas Neue',sans-serif;font-size:24px;color:var(--green);line-height:1;">-</div>
                    <div style="font-size:9px;font-weight:700;text-transform:uppercase;color:var(--text-muted);margin-top:2px;">protein</div>
                  </div>
                  <div style="background:var(--surface2);border-radius:10px;padding:12px 6px;text-align:center;">
                    <div id="cam-carbs" style="font-family:'Bebas Neue',sans-serif;font-size:24px;color:var(--blue);line-height:1;">-</div>
                    <div style="font-size:9px;font-weight:700;text-transform:uppercase;color:var(--text-muted);margin-top:2px;">carbs</div>
                  </div>
                  <div style="background:var(--surface2);border-radius:10px;padding:12px 6px;text-align:center;">
                    <div id="cam-fat" style="font-family:'Bebas Neue',sans-serif;font-size:24px;color:var(--accent2);line-height:1;">-</div>
                    <div style="font-size:9px;font-weight:700;text-transform:uppercase;color:var(--text-muted);margin-top:2px;">fat</div>
                  </div>
                </div>

                <!-- Meal select -->
                <div style="margin-bottom:12px;">
                  <div style="font-size:12px;font-weight:600;color:var(--text-muted);margin-bottom:6px;">Log to which meal?</div>
                  <select id="cam-meal-select" style="width:100%;padding:12px 14px;font-size:15px;border-radius:10px;">
                    <option value="breakfast">üåÖ Breakfast</option>
                    <option value="lunch" selected>‚òÄÔ∏è Lunch</option>
                    <option value="dinner">üåô Dinner</option>
                    <option value="snack">üçé Snack</option>
                  </select>
                </div>

                <!-- Action buttons -->
                <div style="display:flex;flex-direction:column;gap:10px;">
                  <button class="btn btn-accent btn-full" onclick="logPhotoFood()" style="font-size:17px;padding:16px;font-weight:800;letter-spacing:0.5px;">
                    ‚úÖ Yes, Log This Food
                  </button>
                  <button class="btn btn-outline btn-full" onclick="retakePhoto()" style="font-size:14px;padding:12px;">
                    üì∑ Take Another Photo
                  </button>
                </div>

              </div><!-- end cam-result -->

              <div id="cam-error" style="display:none;margin-top:12px;"></div>

            </div><!-- end cam-preview-area -->

          </div><!-- end padding -->
        </div><!-- end card -->
      </div>

      <!-- BARCODE SCANNER PANEL -->
      <div id="scanner-panel" style="display:none;margin-bottom:24px;">
        <div class="card" style="padding:0;overflow:hidden;">
          <div style="background:var(--surface2);padding:16px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);">
            <div>
              <div style="font-weight:600;font-size:15px;">&#128247; Barcode &amp; QR Scanner</div>
              <div style="font-size:12px;color:var(--text-dim);margin-top:2px;">Scan any product barcode or QR code to get nutrition info instantly</div>
            </div>
            <button class="btn btn-outline btn-sm" onclick="closeScanner()">&#10005; Close</button>
          </div>

          <!-- Camera viewfinder (desktop/supported browsers) -->
          <div id="scanner-cam-area">
            <div style="position:relative;background:#000;min-height:240px;display:flex;align-items:center;justify-content:center;">
              <video id="scanner-video" style="width:100%;max-height:300px;display:block;object-fit:cover;" playsinline autoplay muted></video>
              <canvas id="scanner-canvas" style="display:none;"></canvas>
              <div style="position:absolute;inset:0;pointer-events:none;display:flex;align-items:center;justify-content:center;">
                <div style="width:240px;height:120px;border:3px solid var(--green);border-radius:12px;box-shadow:0 0 0 9999px rgba(0,0,0,0.5);position:relative;">
                  <div style="position:absolute;top:-3px;left:-3px;width:26px;height:26px;border-top:5px solid var(--green);border-left:5px solid var(--green);border-radius:5px 0 0 0;"></div>
                  <div style="position:absolute;top:-3px;right:-3px;width:26px;height:26px;border-top:5px solid var(--green);border-right:5px solid var(--green);border-radius:0 5px 0 0;"></div>
                  <div style="position:absolute;bottom:-3px;left:-3px;width:26px;height:26px;border-bottom:5px solid var(--green);border-left:5px solid var(--green);border-radius:0 0 0 5px;"></div>
                  <div style="position:absolute;bottom:-3px;right:-3px;width:26px;height:26px;border-bottom:5px solid var(--green);border-right:5px solid var(--green);border-radius:0 0 5px 0;"></div>
                  <div id="scan-line" style="position:absolute;left:8px;right:8px;height:2px;background:linear-gradient(90deg,transparent,var(--green),transparent);top:50%;animation:scanline 2s ease-in-out infinite;"></div>
                </div>
              </div>
            </div>
            <div id="scanner-status" style="padding:12px 20px;font-size:13px;color:var(--text-dim);text-align:center;min-height:44px;display:flex;align-items:center;justify-content:center;gap:8px;border-top:1px solid var(--border);">
              <div class="spinner"></div> Requesting camera access...
            </div>
          </div>

          <!-- Mobile photo-scan option -->
          <div id="scanner-photo-area" style="display:none;padding:20px;text-align:center;">
            <div style="font-size:36px;margin-bottom:10px;">üì∏</div>
            <div style="font-weight:600;font-size:14px;margin-bottom:6px;">Take a Photo of the Barcode</div>
            <div style="font-size:12px;color:var(--text-muted);margin-bottom:14px;">Point your camera at the barcode or QR code on the product packaging</div>
            <button class="btn btn-accent btn-full" onclick="openBarcodeCamera()" style="padding:14px;font-size:15px;">üì∑ Scan Barcode / QR Code</button>
          </div>

          <!-- Result card (shown after scan) -->
          <div id="scanner-result" style="display:none;padding:20px;">
            <div id="scanner-result-inner"></div>
          </div>

          <!-- Manual entry -->
          <div style="padding:0 20px 20px;border-top:1px solid var(--border);">
            <div style="font-size:12px;color:var(--text-muted);margin:12px 0 8px;">Enter barcode number manually:</div>
            <div style="display:flex;gap:8px;">
              <input type="number" id="manual-barcode" placeholder="e.g. 036800379442" style="flex:1;" onkeydown="if(event.key==='Enter') lookupBarcode(this.value)">
              <button class="btn btn-outline btn-sm" onclick="lookupBarcode(document.getElementById('manual-barcode').value)">Look Up</button>
            </div>
          </div>
        </div>
      </div>

      <!-- MEALS -->
      <div id="meals-container">
        <div class="meal-section">
          <div class="meal-header">
            <span class="meal-label">üåÖ Breakfast</span>
            <span class="meal-cals" id="meal-cal-breakfast">0 kcal</span>
          </div>
          <div id="meal-breakfast" class="food-empty">Nothing logged yet</div>
        </div>
        <div class="meal-section">
          <div class="meal-header">
            <span class="meal-label">‚òÄÔ∏è Lunch</span>
            <span class="meal-cals" id="meal-cal-lunch">0 kcal</span>
          </div>
          <div id="meal-lunch" class="food-empty">Nothing logged yet</div>
        </div>
        <div class="meal-section">
          <div class="meal-header">
            <span class="meal-label">üåô Dinner</span>
            <span class="meal-cals" id="meal-cal-dinner">0 kcal</span>
          </div>
          <div id="meal-dinner" class="food-empty">Nothing logged yet</div>
        </div>
        <div class="meal-section">
          <div class="meal-header">
            <span class="meal-label">üçé Snacks</span>
            <span class="meal-cals" id="meal-cal-snack">0 kcal</span>
          </div>
          <div id="meal-snack" class="food-empty">Nothing logged yet</div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ WORKOUT LOG ‚îÄ‚îÄ -->
    <div class="page" id="page-workout-log">
      <div class="page-title">Workout Log</div>
      <div class="page-sub">Track your exercises, sets, reps, and weights</div>

      <div class="date-bar">
        <div class="date-nav">
          <button onclick="changeWorkoutDate(-1)">‚Äπ</button>
          <button onclick="changeWorkoutDate(1)">‚Ä∫</button>
        </div>
        <div class="date-label" id="workout-date-label">Today</div>
      </div>

      <!-- START WORKOUT BUTTON -->
      <div style="display:flex;gap:12px;margin-bottom:24px;flex-wrap:wrap;align-items:center;">
        <button class="btn btn-primary" onclick="openAddWorkout()">Ôºã Log New Workout</button>
        <div id="workout-streak" style="font-size:13px;color:var(--text-dim);"></div>
      </div>

      <!-- WORKOUTS FOR THE DAY -->
      <div id="workout-sessions-container">
        <div id="workout-empty-state" style="text-align:center;padding:48px 20px;color:var(--text-muted);font-size:14px;border:1px dashed var(--border);border-radius:var(--radius-lg);">
          <div style="font-size:40px;margin-bottom:12px;">üèãÔ∏è</div>
          <div style="font-weight:600;margin-bottom:6px;color:var(--text-dim);">No workouts logged today</div>
          <div>Click "Log New Workout" to get started</div>
        </div>
      </div>

      <!-- WORKOUT HISTORY SUMMARY -->
      <div id="workout-history-card" style="display:none;margin-top:32px;">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
            <div class="card-title" style="margin-bottom:0;">üìÖ Recent Workouts</div>
            <button class="btn btn-outline btn-sm" onclick="navigate('workout-history')">View All ‚Üí</button>
          </div>
          <div id="workout-recent-list"></div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ WORKOUT HISTORY ‚îÄ‚îÄ -->
    <div class="page" id="page-workout-history">
      <div class="page-title">Workout History</div>
      <div class="page-sub">All your logged workouts over time</div>
      <div style="margin-bottom:20px;display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn btn-outline btn-sm" onclick="navigate('workout-log')">‚Üê Back</button>
        <button class="btn btn-outline btn-sm" onclick="exportWorkoutCSV()">‚¨á Export CSV</button>
      </div>
      <div id="workout-history-full"></div>
    </div>

        <!-- ‚îÄ‚îÄ SLEEP LOG ‚îÄ‚îÄ -->
    <div class="page" id="page-sleep-log">
      <div class="page-title">Sleep Log</div>
      <div class="page-sub">Track your sleep quality and duration for better recovery</div>

      <!-- Date bar -->
      <div class="date-bar">
        <div class="date-nav">
          <button onclick="changeSleepDate(-1)">‚Äπ</button>
          <button onclick="changeSleepDate(1)">‚Ä∫</button>
        </div>
        <div class="date-label" id="sleep-date-label">Today</div>
      </div>

      <!-- Sleep stats row -->
      <div class="stats-grid" style="margin-bottom:20px;" id="sleep-stats-row">
        <div class="stat-card" style="border-top-color:var(--blue);">
          <div><span class="stat-value" id="sl-hours" style="color:var(--blue);">‚Äî</span><span class="stat-unit">hrs</span></div>
          <div class="stat-label">Duration</div>
          <div class="stat-goal">Goal: 8 hours</div>
        </div>
        <div class="stat-card" style="border-top-color:var(--green);">
          <div><span class="stat-value" id="sl-quality" style="color:var(--green);">‚Äî</span></div>
          <div class="stat-label">Quality</div>
          <div class="stat-goal" id="sl-quality-label">Not logged</div>
        </div>
        <div class="stat-card" style="border-top-color:var(--accent);">
          <div><span class="stat-value" id="sl-streak" style="color:var(--accent);">0</span></div>
          <div class="stat-label">Day Streak</div>
          <div class="stat-goal">Days logged</div>
        </div>
        <div class="stat-card" style="border-top-color:#a78bfa;">
          <div><span class="stat-value" id="sl-avg" style="color:#a78bfa;">‚Äî</span><span class="stat-unit">hrs</span></div>
          <div class="stat-label">7-Day Avg</div>
          <div class="stat-goal">Weekly average</div>
        </div>
      </div>

      <!-- Log sleep card -->
      <div class="card" style="margin-bottom:20px;">
        <div class="card-title">üåô Log Sleep</div>
        <div class="ai-form-grid">
          <div class="form-group">
            <label>Bedtime</label>
            <input type="time" id="sl-bedtime" value="22:30">
          </div>
          <div class="form-group">
            <label>Wake Time</label>
            <input type="time" id="sl-waketime" value="06:30">
          </div>
          <div class="form-group">
            <label>Sleep Quality</label>
            <select id="sl-quality-input">
              <option value="">‚Äî Select ‚Äî</option>
              <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Excellent</option>
              <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê Good</option>
              <option value="3">‚≠ê‚≠ê‚≠ê Average</option>
              <option value="2">‚≠ê‚≠ê Poor</option>
              <option value="1">‚≠ê Very Poor</option>
            </select>
          </div>
          <div class="form-group">
            <label>Feeling on Wake</label>
            <select id="sl-feeling">
              <option value="">‚Äî Select ‚Äî</option>
              <option value="Refreshed">üòä Refreshed</option>
              <option value="Okay">üòê Okay</option>
              <option value="Groggy">üò¥ Groggy</option>
              <option value="Tired">üò© Tired</option>
              <option value="Exhausted">üíÄ Exhausted</option>
            </select>
          </div>
          <div class="form-group full">
            <label>Notes (optional)</label>
            <input type="text" id="sl-notes" placeholder="e.g. woke up twice, had caffeine late, great recovery...">
          </div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;">
          <button class="btn btn-primary" onclick="logSleep()">üíæ Save Sleep Log</button>
          <button class="btn btn-outline btn-sm" onclick="deleteSleepLog()">üóë Clear Today</button>
        </div>
        <div id="sl-save-msg" class="success-msg" style="display:none;margin-top:8px;">‚úì Sleep logged!</div>
      </div>

      <!-- Sleep tips -->
      <div class="card" style="margin-bottom:20px;">
        <div class="card-title">üí° Recovery Insights</div>
        <div id="sl-insights">
          <div style="color:var(--text-muted);font-size:13px;">Log a few nights of sleep to see personalised insights.</div>
        </div>
      </div>

      <!-- Sleep history chart (last 7 days) -->
      <div class="card">
        <div class="card-title">üìä Last 7 Nights</div>
        <div id="sl-history-chart" style="margin-top:8px;"></div>
      </div>
    </div>

<!-- ‚îÄ‚îÄ MEAL IDEAS ‚îÄ‚îÄ -->
    <div class="page" id="page-meal-ideas">
      <div class="page-title">üßë‚Äçüç≥ Meal Ideas</div>
      <div class="page-sub">üì∑ Scan your fridge &amp; cupboards, or type ingredients ‚Äî get meal ideas tailored to your AI fitness plan</div>


      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;" id="mi-input-grid">

        <!-- Fridge -->
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:8px;">
              <span style="font-size:22px;">üßä</span>
              <div class="card-title" style="margin-bottom:0;">Fridge / Freezer</div>
            </div>
            <button class="btn btn-outline btn-sm" onclick="openIngredientScanner('fridge')" style="display:flex;align-items:center;gap:5px;font-size:12px;padding:6px 10px;">
              üì∑ Scan
            </button>
          </div>
          <!-- Fridge scanner panel -->
          <div id="fridge-scanner-panel" style="display:none;margin-bottom:12px;">
            <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;">
              <div style="padding:10px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;">
                <div style="font-size:13px;font-weight:600;">üì∑ Scan Fridge Contents</div>
                <button class="btn btn-outline btn-sm" onclick="closeIngredientScanner('fridge')" style="padding:4px 8px;font-size:11px;">‚úï</button>
              </div>
              <div style="padding:12px;">
                <div style="display:flex;gap:6px;margin-bottom:10px;">
                  <button class="src-btn src-active" id="fridge-scan-mode-live" onclick="setIngredientScanMode('fridge','live')">üì∑ Camera</button>
                  <button class="src-btn" id="fridge-scan-mode-upload" onclick="setIngredientScanMode('fridge','upload')">üñºÔ∏è Upload</button>
                </div>
                <div id="fridge-scan-live">
                  <div style="position:relative;background:#000;border-radius:8px;overflow:hidden;min-height:180px;display:flex;align-items:center;justify-content:center;margin-bottom:8px;">
                    <video id="fridge-scan-video" style="width:100%;max-height:220px;object-fit:cover;display:block;" playsinline autoplay muted></video>
                    <canvas id="fridge-scan-canvas" style="display:none;"></canvas>
                    <div id="fridge-scan-placeholder" style="position:absolute;text-align:center;color:#666;">
                      <div style="font-size:28px;">üì∑</div><div style="font-size:11px;margin-top:4px;">Camera loading...</div>
                    </div>
                  </div>
                  <button class="btn btn-primary btn-full" id="fridge-snap-btn" onclick="snapIngredientPhoto('fridge')" style="display:none;font-size:13px;padding:10px;">üì∏ Analyse Contents</button>
                </div>
                <div id="fridge-scan-upload" style="display:none;">
                  <div style="border:2px dashed var(--border);border-radius:8px;padding:20px;text-align:center;cursor:pointer;margin-bottom:8px;"
                    onclick="document.getElementById('fridge-photo-file').click()"
                    ondragover="event.preventDefault();this.style.borderColor='var(--green)'"
                    ondragleave="this.style.borderColor='var(--border)'"
                    ondrop="handleIngredientDrop(event,'fridge')">
                    <div style="font-size:24px;margin-bottom:6px;">üñºÔ∏è</div>
                    <div style="font-size:12px;color:var(--text-muted);">Tap to upload a photo of your fridge</div>
                  </div>
                  <input type="file" id="fridge-photo-file" accept="image/*" style="display:none;" onchange="handleIngredientUpload(event,'fridge')">
                </div>
                <div id="fridge-scan-status" style="display:none;padding:8px 0;font-size:12px;color:var(--text-dim);text-align:center;">
                  <div style="display:flex;align-items:center;justify-content:center;gap:8px;"><div class="spinner" style="width:14px;height:14px;border-width:2px;"></div> Identifying ingredients...</div>
                </div>
              </div>
            </div>
          </div>
          <div class="ingredient-chip-row" id="fridge-chips"></div>
          <div style="display:flex;gap:8px;">
            <input type="text" id="fridge-input" placeholder="e.g. chicken breast, eggs..." style="flex:1;font-size:13px;" onkeydown="if(event.key==='Enter')addIngredient('fridge')">
            <button class="btn btn-outline btn-sm" onclick="addIngredient('fridge')">Ôºã Add</button>
          </div>
          <div class="quick-add-grid" style="margin-top:12px;">
            <button class="quick-add-btn" onclick="quickAdd('fridge','ü•ö Eggs')">ü•ö Eggs</button>
            <button class="quick-add-btn" onclick="quickAdd('fridge','üçó Chicken')">üçó Chicken</button>
            <button class="quick-add-btn" onclick="quickAdd('fridge','ü•© Ground Beef')">ü•© Ground Beef</button>
            <button class="quick-add-btn" onclick="quickAdd('fridge','üêü Salmon')">üêü Salmon</button>
            <button class="quick-add-btn" onclick="quickAdd('fridge','ü•õ Milk')">ü•õ Milk</button>
            <button class="quick-add-btn" onclick="quickAdd('fridge','üßÄ Cheese')">üßÄ Cheese</button>
            <button class="quick-add-btn" onclick="quickAdd('fridge','ü•¶ Broccoli')">ü•¶ Broccoli</button>
            <button class="quick-add-btn" onclick="quickAdd('fridge','ü•¨ Spinach')">ü•¨ Spinach</button>
            <button class="quick-add-btn" onclick="quickAdd('fridge','üçÖ Tomatoes')">üçÖ Tomatoes</button>
            <button class="quick-add-btn" onclick="quickAdd('fridge','ü´ë Bell Pepper')">ü´ë Bell Pepper</button>
            <button class="quick-add-btn" onclick="quickAdd('fridge','ü•ï Carrots')">ü•ï Carrots</button>
            <button class="quick-add-btn" onclick="quickAdd('fridge','üßÖ Onion')">üßÖ Onion</button>
          </div>
        </div>

        <!-- Cupboard -->
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:8px;">
              <span style="font-size:22px;">üóÑÔ∏è</span>
              <div class="card-title" style="margin-bottom:0;">Cupboard / Pantry</div>
            </div>
            <button class="btn btn-outline btn-sm" onclick="openIngredientScanner('cupboard')" style="display:flex;align-items:center;gap:5px;font-size:12px;padding:6px 10px;">
              üì∑ Scan
            </button>
          </div>
          <!-- Cupboard scanner panel -->
          <div id="cupboard-scanner-panel" style="display:none;margin-bottom:12px;">
            <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;">
              <div style="padding:10px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;">
                <div style="font-size:13px;font-weight:600;">üì∑ Scan Cupboard Contents</div>
                <button class="btn btn-outline btn-sm" onclick="closeIngredientScanner('cupboard')" style="padding:4px 8px;font-size:11px;">‚úï</button>
              </div>
              <div style="padding:12px;">
                <div style="display:flex;gap:6px;margin-bottom:10px;">
                  <button class="src-btn src-active" id="cupboard-scan-mode-live" onclick="setIngredientScanMode('cupboard','live')">üì∑ Camera</button>
                  <button class="src-btn" id="cupboard-scan-mode-upload" onclick="setIngredientScanMode('cupboard','upload')">üñºÔ∏è Upload</button>
                </div>
                <div id="cupboard-scan-live">
                  <div style="position:relative;background:#000;border-radius:8px;overflow:hidden;min-height:180px;display:flex;align-items:center;justify-content:center;margin-bottom:8px;">
                    <video id="cupboard-scan-video" style="width:100%;max-height:220px;object-fit:cover;display:block;" playsinline autoplay muted></video>
                    <canvas id="cupboard-scan-canvas" style="display:none;"></canvas>
                    <div id="cupboard-scan-placeholder" style="position:absolute;text-align:center;color:#666;">
                      <div style="font-size:28px;">üì∑</div><div style="font-size:11px;margin-top:4px;">Camera loading...</div>
                    </div>
                  </div>
                  <button class="btn btn-primary btn-full" id="cupboard-snap-btn" onclick="snapIngredientPhoto('cupboard')" style="display:none;font-size:13px;padding:10px;">üì∏ Analyse Contents</button>
                </div>
                <div id="cupboard-scan-upload" style="display:none;">
                  <div style="border:2px dashed var(--border);border-radius:8px;padding:20px;text-align:center;cursor:pointer;margin-bottom:8px;"
                    onclick="document.getElementById('cupboard-photo-file').click()"
                    ondragover="event.preventDefault();this.style.borderColor='var(--green)'"
                    ondragleave="this.style.borderColor='var(--border)'"
                    ondrop="handleIngredientDrop(event,'cupboard')">
                    <div style="font-size:24px;margin-bottom:6px;">üñºÔ∏è</div>
                    <div style="font-size:12px;color:var(--text-muted);">Tap to upload a photo of your cupboard</div>
                  </div>
                  <input type="file" id="cupboard-photo-file" accept="image/*" style="display:none;" onchange="handleIngredientUpload(event,'cupboard')">
                </div>
                <div id="cupboard-scan-status" style="display:none;padding:8px 0;font-size:12px;color:var(--text-dim);text-align:center;">
                  <div style="display:flex;align-items:center;justify-content:center;gap:8px;"><div class="spinner" style="width:14px;height:14px;border-width:2px;"></div> Identifying ingredients...</div>
                </div>
              </div>
            </div>
          </div>
          <div class="ingredient-chip-row" id="cupboard-chips"></div>
          <div style="display:flex;gap:8px;">
            <input type="text" id="cupboard-input" placeholder="e.g. rice, olive oil..." style="flex:1;font-size:13px;" onkeydown="if(event.key==='Enter')addIngredient('cupboard')">
            <button class="btn btn-outline btn-sm" onclick="addIngredient('cupboard')">Ôºã Add</button>
          </div>
          <div class="quick-add-grid" style="margin-top:12px;">
            <button class="quick-add-btn" onclick="quickAdd('cupboard','üçö Rice')">üçö Rice</button>
            <button class="quick-add-btn" onclick="quickAdd('cupboard','üçù Pasta')">üçù Pasta</button>
            <button class="quick-add-btn" onclick="quickAdd('cupboard','ü•´ Canned Tuna')">ü•´ Canned Tuna</button>
            <button class="quick-add-btn" onclick="quickAdd('cupboard','ü´ò Black Beans')">ü´ò Black Beans</button>
            <button class="quick-add-btn" onclick="quickAdd('cupboard','ü•ú Peanut Butter')">ü•ú Peanut Butter</button>
            <button class="quick-add-btn" onclick="quickAdd('cupboard','üåæ Oats')">üåæ Oats</button>
            <button class="quick-add-btn" onclick="quickAdd('cupboard','ü´ô Olive Oil')">ü´ô Olive Oil</button>
            <button class="quick-add-btn" onclick="quickAdd('cupboard','üßÑ Garlic')">üßÑ Garlic</button>
            <button class="quick-add-btn" onclick="quickAdd('cupboard','üçû Bread')">üçû Bread</button>
            <button class="quick-add-btn" onclick="quickAdd('cupboard','üåΩ Corn')">üåΩ Corn</button>
            <button class="quick-add-btn" onclick="quickAdd('cupboard','ü•£ Protein Powder')">ü•£ Protein Powder</button>
            <button class="quick-add-btn" onclick="quickAdd('cupboard','üßÇ Spices')">üßÇ Spices</button>
          </div>
        </div>
      </div>

      <!-- Preferences row -->
      <div class="card" style="margin-bottom:20px;">
        <div class="card-title">‚öôÔ∏è Meal Preferences</div>
        <div class="ai-form-grid">
          <div class="form-group">
            <label>Meal Type</label>
            <select id="mi-meal-type">
              <option value="any">Any / All</option>
              <option value="breakfast">Breakfast</option>
              <option value="lunch">Lunch</option>
              <option value="dinner">Dinner</option>
              <option value="snack">Snack / Post-workout</option>
            </select>
          </div>
          <div class="form-group">
            <label>Number of Ideas</label>
            <select id="mi-count">
              <option value="3">3 meals</option>
              <option value="5" selected>5 meals</option>
              <option value="7">7 meals</option>
            </select>
          </div>
          <div class="form-group">
            <label>Dietary Restrictions</label>
            <input type="text" id="mi-restrictions" placeholder="e.g. no dairy, gluten-free, low-carb">
          </div>
          <div class="form-group">
            <label>Max Prep Time</label>
            <select id="mi-time">
              <option value="any">No limit</option>
              <option value="15">Under 15 mins</option>
              <option value="30" selected>Under 30 mins</option>
              <option value="60">Under 1 hour</option>
            </select>
          </div>
        </div>
        <div class="form-group" style="margin-bottom:0;">
          <label>Additional Notes <span style="font-size:11px;font-weight:400;color:var(--text-muted);">(optional)</span></label>
          <input type="text" id="mi-notes" placeholder="e.g. I want something high protein, I hate mushrooms, keep it simple...">
        </div>
      </div>

      <!-- Generate button -->
      <button class="btn btn-primary btn-full" id="mi-gen-btn" onclick="generateMealIdeas()" style="font-size:15px;padding:16px;margin-bottom:24px;">
        ‚ú® Generate Meal Ideas (Aligned to My Fitness Plan)
      </button>

      <!-- Results area -->
      <div id="mi-results" style="display:none;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px;">
          <div class="card-title" style="margin-bottom:0;">üçΩÔ∏è Your Personalised Meal Ideas</div>
          <div style="display:flex;gap:8px;">
            <button class="btn btn-outline btn-sm" onclick="saveMealIdeasToRecipes()">üìñ Save All to Recipes</button>
            <button class="btn btn-outline btn-sm" onclick="generateMealIdeas()">üîÑ Regenerate</button>
          </div>
        </div>
        <div id="mi-results-content"></div>
      </div>

      <!-- Empty state -->
      <div id="mi-empty-state" style="text-align:center;padding:48px 20px;color:var(--text-muted);">
        <div style="font-size:48px;margin-bottom:12px;">üßë‚Äçüç≥</div>
        <div style="font-weight:600;color:var(--text-dim);margin-bottom:6px;">Add ingredients to get started</div>
        <div style="font-size:13px;">Enter what's in your fridge and cupboards above, then hit Generate</div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ AI PLAN ‚îÄ‚îÄ -->
    <div class="page" id="page-ai-plan">
      <div class="page-title">AI Fitness Plan</div>
      <div class="page-sub">Fill in your details below ‚Äî ChatGPT will generate your personalised plan</div>

      <!-- API Key override box -->
      <div class="card" id="api-key-override-card" style="margin-bottom:16px;border-color:rgba(250,204,21,0.3);">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
          <div style="font-size:13px;font-weight:700;color:var(--accent);">üîë Paste Your OpenAI API Key</div>
          <div id="api-key-saved-badge" style="display:none;font-size:11px;background:rgba(74,222,128,0.15);color:var(--green);padding:3px 10px;border-radius:20px;font-weight:700;">‚úì Saved</div>
        </div>
        <div style="font-size:12px;color:var(--text-muted);margin-bottom:10px;">Copy your key from <a href="https://platform.openai.com/api-keys" target="_blank" style="color:var(--green);">platform.openai.com/api-keys</a> and paste it here. It stays on your device only.</div>
        <div style="display:flex;gap:8px;">
          <input type="text" id="api-key-override-input" placeholder="sk-proj-..." 
            style="flex:1;font-size:13px;font-family:monospace;" 
            autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
          <button class="btn btn-primary" onclick="saveOverrideKey()" style="padding:0 16px;white-space:nowrap;">Save</button>
        </div>
        <div id="api-key-override-status" style="font-size:12px;margin-top:8px;display:none;"></div>
      </div>


      <div class="card">
        <div class="card-title">Your Stats & Goals</div>
        <div class="ai-form-grid">
          <div class="form-group">
            <label>Age</label>
            <input type="number" id="ai-age" placeholder="25">
          </div>
          <div class="form-group">
            <label>Gender</label>
            <select id="ai-gender">
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>Height (inches)</label>
            <input type="number" id="ai-height" placeholder="68">
          </div>
          <div class="form-group">
            <label>Weight (lbs)</label>
            <input type="number" id="ai-weight" placeholder="160">
          </div>
          <div class="form-group">
            <label>Activity Level</label>
            <select id="ai-activity">
              <option value="sedentary">Sedentary (desk job, no exercise)</option>
              <option value="light">Lightly active (1-2 days/week)</option>
              <option value="moderate">Moderately active (3-4 days/week)</option>
              <option value="very">Very active (5-6 days/week)</option>
              <option value="extreme">Extremely active (daily intense)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Primary Goal</label>
            <select id="ai-goal">
              <option value="lose weight">Lose Weight</option>
              <option value="build muscle">Build Muscle</option>
              <option value="maintain weight">Maintain Weight</option>
              <option value="improve endurance">Improve Endurance</option>
              <option value="improve overall fitness">Improve Overall Fitness</option>
            </select>
          </div>
          <div class="form-group">
            <label>Target Weight (lbs, optional)</label>
            <input type="number" id="ai-target" placeholder="150">
          </div>
          <div class="form-group">
            <label>Timeframe</label>
            <select id="ai-timeframe">
              <option value="4 weeks">4 Weeks</option>
              <option value="8 weeks">8 Weeks</option>
              <option value="12 weeks">12 Weeks</option>
              <option value="6 months">6 Months</option>
            </select>
          </div>
          <div class="form-group full">
            <label>Any injuries, dietary restrictions, or preferences?</label>
            <textarea id="ai-notes" placeholder="e.g. bad knees, vegetarian, no gym equipment..." rows="2"></textarea>
          </div>
          <div class="form-group full" style="margin-top:4px;">
            <label style="display:flex;align-items:center;gap:8px;">
              <span>üéØ Describe Your Personal Goals</span>
              <span style="font-size:11px;color:var(--text-muted);font-weight:400;text-transform:none;letter-spacing:0;">‚Äî the more detail, the better your plan</span>
            </label>
            <textarea id="ai-custom-goals" rows="5" placeholder="Tell Claude AI exactly what you want to achieve in your own words. For example:&#10;&#10;‚Ä¢ I want to be more muscular with visible abs&#10;‚Ä¢ I want to increase my cardio endurance for a 5K&#10;‚Ä¢ I am training for an Ironman triathlon in 6 months&#10;‚Ä¢ I want to lose my belly fat and tone my arms&#10;‚Ä¢ I want to build functional strength for hiking&#10;&#10;Be as specific as you like ‚Äî no goal is too big!"></textarea>
            <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px;" id="goal-chips">
              <span style="font-size:11px;color:var(--text-muted);align-self:center;margin-right:2px;">Quick add:</span>
              <button type="button" class="goal-chip" onclick="addGoalChip(this)">üí™ Be more muscular</button>
              <button type="button" class="goal-chip" onclick="addGoalChip(this)">üèÉ Increase cardio</button>
              <button type="button" class="goal-chip" onclick="addGoalChip(this)">üèä Train for an Ironman</button>
              <button type="button" class="goal-chip" onclick="addGoalChip(this)">üî• Lose belly fat</button>
              <button type="button" class="goal-chip" onclick="addGoalChip(this)">üßò Improve flexibility</button>
              <button type="button" class="goal-chip" onclick="addGoalChip(this)">‚ö° Boost energy levels</button>
              <button type="button" class="goal-chip" onclick="addGoalChip(this)">üèãÔ∏è Build functional strength</button>
              <button type="button" class="goal-chip" onclick="addGoalChip(this)">üö¥ Train for a marathon</button>
              <button type="button" class="goal-chip" onclick="addGoalChip(this)">ü§∏ Tone and define arms</button>
              <button type="button" class="goal-chip" onclick="addGoalChip(this)">üò¥ Improve sleep & recovery</button>
            </div>
          </div>
        </div>
        <button class="btn btn-accent btn-full" id="gen-plan-btn" onclick="generatePlan()" style="font-size:16px;padding:16px;margin-bottom:8px;">‚ú® Generate My Plan</button>
        <div id="plan-output" class="plan-output" style="display:none;padding:16px;"></div>
        <div id="goals-adjusted-banner" style="display:none;"></div>
        <div id="plan-actions" class="plan-actions" style="display:none;flex-direction:column;gap:10px;margin-top:16px;">
          <div style="background:rgba(74,222,128,0.08);border:1px solid rgba(74,222,128,0.25);border-radius:10px;padding:12px 16px;font-size:13px;color:var(--green);text-align:center;">
            ‚úÖ Your weekly plan has been updated automatically
          </div>
          <button class="btn btn-accent btn-full" onclick="navigate('weekly-plan')" style="font-size:15px;padding:16px;display:flex;align-items:center;justify-content:center;gap:8px;">üìÖ View My Weekly Plan ‚Üí</button>
          <button class="btn btn-outline btn-full" onclick="printAIPlan()" style="font-size:14px;padding:13px;">üñ®Ô∏è Save as PDF</button>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ WEEKLY PLAN ‚îÄ‚îÄ -->
    <div class="page" id="page-weekly-plan">
      <div class="page-title">üìÖ Weekly Plan</div>
      <div class="page-sub">Your personalised meals & workouts day by day ‚Äî tap a day to explore</div>

      <!-- No plan state -->
      <div id="wp-no-plan" style="display:none;">
        <div class="card" style="text-align:center;padding:40px 20px;">
          <div style="font-size:48px;margin-bottom:16px;">ü§ñ</div>
          <div style="font-weight:700;font-size:16px;margin-bottom:8px;">No plan generated yet</div>
          <div style="color:var(--text-muted);font-size:13px;margin-bottom:20px;">Generate your AI fitness plan first, then come back here to see your week broken down day by day.</div>
          <button class="btn btn-accent" onclick="navigate('ai-plan')">‚ú® Generate My Plan ‚Üí</button>
        </div>
      </div>

      <!-- Plan loaded state -->
      <div id="wp-plan-loaded">
        <!-- Day selector strip -->
        <div id="wp-day-strip" style="display:flex;gap:6px;overflow-x:auto;padding-bottom:8px;margin-bottom:20px;scrollbar-width:none;-webkit-scrollbar:{display:none};"></div>

        <!-- Day detail card -->
        <div id="wp-day-detail" class="card" style="padding:0;overflow:hidden;">
          <div id="wp-day-header" style="padding:16px 20px;background:linear-gradient(135deg,var(--green-glow),var(--surface2));border-bottom:1px solid var(--border);">
            <div id="wp-day-title" style="font-family:'Bebas Neue',sans-serif;font-size:26px;letter-spacing:1px;"></div>
            <div id="wp-day-date" style="font-size:12px;color:var(--text-muted);margin-top:2px;"></div>
          </div>
          <div style="padding:20px;">
            <!-- Meals section -->
            <div style="margin-bottom:24px;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                <span style="font-size:18px;">üçΩÔ∏è</span>
                <div style="font-weight:700;font-size:14px;text-transform:uppercase;letter-spacing:0.5px;">Meals</div>
              </div>
              <div id="wp-meals-content"></div>
            </div>
            <!-- Workout section -->
            <div style="margin-bottom:24px;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                <span style="font-size:18px;">üèãÔ∏è</span>
                <div style="font-weight:700;font-size:14px;text-transform:uppercase;letter-spacing:0.5px;">Workout</div>
              </div>
              <div id="wp-workout-content"></div>
            </div>
            <!-- Calendar section -->
            <div style="border-top:1px solid var(--border);padding-top:16px;">
              <div style="font-weight:600;font-size:13px;margin-bottom:10px;">üìÜ Add to Calendar</div>
              <div style="display:flex;flex-wrap:wrap;gap:8px;">
                <button class="btn btn-outline btn-sm" onclick="addDayToCalendar('google')" style="display:flex;align-items:center;gap:6px;">
                  <img src="https://www.gstatic.com/images/branding/product/1x/calendar_2020q4_32dp.png" style="width:14px;height:14px;"> Google Calendar
                </button>
                <button class="btn btn-outline btn-sm" onclick="addDayToCalendar('apple')" style="display:flex;align-items:center;gap:6px;">
                  üçé Apple Calendar (.ics)
                </button>
                <button class="btn btn-outline btn-sm" onclick="addDayToCalendar('ics')" style="display:flex;align-items:center;gap:6px;">
                  üìÖ Other (.ics)
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Action bar -->
        <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:20px;">
          <button class="btn btn-outline" onclick="printWeeklyPlan()">üñ®Ô∏è Print Full Week PDF</button>
          <button class="btn btn-outline" onclick="exportWeekToCalendar('google')">
            <img src="https://www.gstatic.com/images/branding/product/1x/calendar_2020q4_32dp.png" style="width:14px;height:14px;vertical-align:middle;margin-right:4px;"> Export Week to Google
          </button>
          <button class="btn btn-outline" onclick="exportWeekToCalendar('apple')">üçé Export Week (.ics)</button>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ RECIPES ‚îÄ‚îÄ -->
    <div class="page" id="page-recipes">
      <div class="page-title">Community Recipes</div>
      <div class="page-sub">Healthy recipes shared by everyone in your group</div>

      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px;">
        <div class="recipes-search-bar" style="flex:1;min-width:200px;margin-bottom:0;">
          <input type="text" id="recipe-search" placeholder="Search recipes..." oninput="renderRecipes()" autocomplete="off" style="flex:1;">
        </div>
        <button class="btn btn-primary" onclick="openAddRecipe()">Ôºã Share a Recipe</button>
      </div>

      <div class="recipes-filter-row">
        <button class="filter-chip active" data-cat="all" onclick="setRecipeFilter(this,'all')">üçΩÔ∏è All</button>
        <button class="filter-chip" data-cat="breakfast" onclick="setRecipeFilter(this,'breakfast')">üåÖ Breakfast</button>
        <button class="filter-chip" data-cat="lunch" onclick="setRecipeFilter(this,'lunch')">‚òÄÔ∏è Lunch</button>
        <button class="filter-chip" data-cat="dinner" onclick="setRecipeFilter(this,'dinner')">üåô Dinner</button>
        <button class="filter-chip" data-cat="snack" onclick="setRecipeFilter(this,'snack')">üçé Snack</button>
        <button class="filter-chip" data-cat="smoothie" onclick="setRecipeFilter(this,'smoothie')">ü•§ Smoothie</button>
        <button class="filter-chip" data-cat="dessert" onclick="setRecipeFilter(this,'dessert')">üçì Dessert</button>
      </div>

      <div id="recipe-grid" class="recipe-grid"></div>
      <div id="recipe-empty" class="recipe-empty" style="display:none;">
        <div class="recipe-empty-icon">üë®‚Äçüç≥</div>
        <div style="font-weight:600;color:var(--text-dim);margin-bottom:6px;">No recipes yet</div>
        <div>Be the first to share a healthy recipe with the group!</div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ -->
    <div class="page" id="page-history">
      <div class="page-title">Food History</div>
      <div class="page-sub">All your logged meals across all days</div>
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
          <div class="card-title" style="margin-bottom:0">Log History</div>
          <button class="btn btn-outline btn-sm" onclick="exportCSV()">‚¨á Export CSV</button>
        </div>
        <div class="table-wrap">
          <table id="history-table">
            <thead>
              <tr><th>Date</th><th>Meal</th><th>Food</th><th>Qty</th><th>Calories</th><th>Protein</th><th>Carbs</th><th>Fat</th></tr>
            </thead>
            <tbody id="history-tbody"></tbody>
          </table>
        </div>
        <div id="history-empty" style="text-align:center;color:var(--text-muted);padding:32px;font-size:14px;">No history yet. Start logging your food!</div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ IMPORT DATA ‚îÄ‚îÄ -->
    <div class="page" id="page-import">
      <div class="page-title">Import Health Data</div>
      <div class="page-sub">Bring in your history from Fitbit, MyFitnessPal, or Apple Health</div>

      <!-- Platform tabs -->
      <div class="import-source-tabs">
        <button class="import-tab active" onclick="switchImportTab('fitbit',this)">
          <span class="tab-icon">‚åö</span> Fitbit
        </button>
        <button class="import-tab" onclick="switchImportTab('mfp',this)">
          <span class="tab-icon">ü•ó</span> MyFitnessPal
        </button>
        <button class="import-tab" onclick="switchImportTab('apple',this)">
          <span class="tab-icon">üçé</span> Apple Health
        </button>
        <button class="import-tab" onclick="switchImportTab('csv',this)">
          <span class="tab-icon">üìÑ</span> Generic CSV
        </button>
      </div>

      <!-- ‚îÄ‚îÄ FITBIT PANEL ‚îÄ‚îÄ -->
      <div class="platform-panel active" id="import-panel-fitbit">
        <div class="card" style="margin-bottom:20px;">
          <div class="card-title">‚åö How to Export from Fitbit</div>
          <div class="import-step">
            <div class="import-step-num">1</div>
            <div class="import-step-body">
              <h4>Go to your Fitbit Dashboard</h4>
              <p>Open a browser and go to <a href="https://www.fitbit.com/settings/data/export" target="_blank" style="color:var(--green);">fitbit.com/settings/data/export</a> and log in to your account.</p>
            </div>
          </div>
          <div class="import-step">
            <div class="import-step-num">2</div>
            <div class="import-step-body">
              <h4>Request your data export</h4>
              <p>Click <strong>"Export Account Archive"</strong>. Fitbit will email you a ZIP file ‚Äî this can take up to 24 hours. Once you get the email, download and unzip it.</p>
            </div>
          </div>
          <div class="import-step">
            <div class="import-step-num">3</div>
            <div class="import-step-body">
              <h4>Find the food log CSV</h4>
              <p>Inside the ZIP, open the <code>Foods</code> folder. Look for files named <code>food_log_YYYY-MM-DD.csv</code> ‚Äî these contain your logged meals. You can also find <code>activities</code> CSVs in the <code>Activities</code> folder for workout history.</p>
            </div>
          </div>
          <div class="import-step">
            <div class="import-step-num">4</div>
            <div class="import-step-body">
              <h4>Upload your CSV files below</h4>
              <p>Upload one or more Fitbit CSV files. The app will automatically detect whether it's food or activity data and import it into your history.</p>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Upload Fitbit Export Files</div>
          <div class="drop-zone" id="dz-fitbit" onclick="document.getElementById('file-fitbit').click()" ondragover="handleDragOver(event,'fitbit')" ondragleave="handleDragLeave('fitbit')" ondrop="handleDrop(event,'fitbit','fitbit')">
            <div class="drop-zone-icon">üìÇ</div>
            <div class="drop-zone-title">Drop CSV files here or click to browse</div>
            <div class="drop-zone-sub">Supports food_log_*.csv and exercise_*.csv files</div>
          </div>
          <input type="file" id="file-fitbit" accept=".csv,.json" multiple style="display:none" onchange="handleFileSelect(event,'fitbit')">
          <div id="import-preview-fitbit"></div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ MYFITNESSPAL PANEL ‚îÄ‚îÄ -->
      <div class="platform-panel" id="import-panel-mfp">
        <div class="card" style="margin-bottom:20px;">
          <div class="card-title">ü•ó How to Export from MyFitnessPal</div>
          <div class="import-step">
            <div class="import-step-num">1</div>
            <div class="import-step-body">
              <h4>Open MyFitnessPal on desktop</h4>
              <p>Go to <a href="https://www.myfitnesspal.com" target="_blank" style="color:var(--green);">myfitnesspal.com</a> in a browser and log in. Data export is only available on the website, not the mobile app.</p>
            </div>
          </div>
          <div class="import-step">
            <div class="import-step-num">2</div>
            <div class="import-step-body">
              <h4>Navigate to Export</h4>
              <p>Click your profile name ‚Üí <strong>My Account</strong> ‚Üí <strong>Export Data</strong>. Or go directly to <a href="https://www.myfitnesspal.com/account/export" target="_blank" style="color:var(--green);">myfitnesspal.com/account/export</a>. Note: this feature requires a <strong>Premium</strong> account.</p>
            </div>
          </div>
          <div class="import-step">
            <div class="import-step-num">3</div>
            <div class="import-step-body">
              <h4>Download your nutrition export</h4>
              <p>Select a date range and click <strong>"Export to CSV"</strong>. You'll get a file called <code>Nutrition Summary.csv</code> or <code>Nutrition Details.csv</code>. Both are supported.</p>
            </div>
          </div>
          <div class="import-step">
            <div class="import-step-num">4</div>
            <div class="import-step-body">
              <h4>Upload below</h4>
              <p>Drop your exported CSV into the upload area. The app will parse your daily calorie and macro totals into your food history.</p>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Upload MyFitnessPal CSV</div>
          <div class="drop-zone" id="dz-mfp" onclick="document.getElementById('file-mfp').click()" ondragover="handleDragOver(event,'mfp')" ondragleave="handleDragLeave('mfp')" ondrop="handleDrop(event,'mfp','mfp')">
            <div class="drop-zone-icon">üìÇ</div>
            <div class="drop-zone-title">Drop CSV file here or click to browse</div>
            <div class="drop-zone-sub">Supports Nutrition Summary.csv and Nutrition Details.csv</div>
          </div>
          <input type="file" id="file-mfp" accept=".csv" multiple style="display:none" onchange="handleFileSelect(event,'mfp')">
          <div id="import-preview-mfp"></div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ APPLE HEALTH PANEL ‚îÄ‚îÄ -->
      <div class="platform-panel" id="import-panel-apple">
        <div class="card" style="margin-bottom:20px;">
          <div class="card-title">üçé How to Export from Apple Health</div>
          <div class="import-step">
            <div class="import-step-num">1</div>
            <div class="import-step-body">
              <h4>Open the Health app on your iPhone</h4>
              <p>Go to the <strong>Health</strong> app (white icon with a red heart). Make sure you're on iOS 12 or later.</p>
            </div>
          </div>
          <div class="import-step">
            <div class="import-step-num">2</div>
            <div class="import-step-body">
              <h4>Export your data</h4>
              <p>Tap your profile picture in the top-right ‚Üí scroll down ‚Üí tap <strong>"Export All Health Data"</strong> ‚Üí tap <strong>"Export"</strong> to confirm. This creates a ZIP file.</p>
            </div>
          </div>
          <div class="import-step">
            <div class="import-step-num">3</div>
            <div class="import-step-body">
              <h4>Transfer the ZIP to your computer</h4>
              <p>Share the ZIP to your computer via AirDrop, email, or iCloud Drive. Once on your computer, unzip it ‚Äî you'll find a file called <code>export.xml</code> inside the <code>apple_health_export</code> folder.</p>
            </div>
          </div>
          <div class="import-step">
            <div class="import-step-num">4</div>
            <div class="import-step-body">
              <h4>Upload the XML file below</h4>
              <p>The app will parse your workout history (active calories, exercise minutes, steps) and any nutrition data logged through Health-connected apps.</p>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Upload Apple Health Export</div>
          <div class="drop-zone" id="dz-apple" onclick="document.getElementById('file-apple').click()" ondragover="handleDragOver(event,'apple')" ondragleave="handleDragLeave('apple')" ondrop="handleDrop(event,'apple','apple')">
            <div class="drop-zone-icon">üìÇ</div>
            <div class="drop-zone-title">Drop export.xml here or click to browse</div>
            <div class="drop-zone-sub">Supports Apple Health export.xml files</div>
          </div>
          <input type="file" id="file-apple" accept=".xml,.zip" multiple style="display:none" onchange="handleFileSelect(event,'apple')">
          <div id="import-preview-apple"></div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ GENERIC CSV PANEL ‚îÄ‚îÄ -->
      <div class="platform-panel" id="import-panel-csv">
        <div class="card" style="margin-bottom:20px;">
          <div class="card-title">üìÑ Import from any CSV</div>
          <p style="font-size:14px;color:var(--text-dim);line-height:1.7;margin-bottom:16px;">
            Upload any CSV file with health data. The app will try to auto-detect columns for date, calories, protein, carbs, fat, and workout data. You can also map columns manually after uploading.
          </p>
          <div style="background:var(--surface2);border-radius:var(--radius);padding:14px 16px;font-size:13px;color:var(--text-dim);">
            <div style="font-weight:600;margin-bottom:8px;color:var(--text);">Expected column names (any order, case-insensitive):</div>
            <div style="display:flex;flex-wrap:wrap;gap:6px;">
              <code style="background:var(--surface3);padding:3px 8px;border-radius:4px;font-family:'DM Mono',monospace;font-size:12px;color:var(--green);">date</code>
              <code style="background:var(--surface3);padding:3px 8px;border-radius:4px;font-family:'DM Mono',monospace;font-size:12px;color:var(--green);">calories</code>
              <code style="background:var(--surface3);padding:3px 8px;border-radius:4px;font-family:'DM Mono',monospace;font-size:12px;color:var(--green);">protein</code>
              <code style="background:var(--surface3);padding:3px 8px;border-radius:4px;font-family:'DM Mono',monospace;font-size:12px;color:var(--green);">carbs / carbohydrates</code>
              <code style="background:var(--surface3);padding:3px 8px;border-radius:4px;font-family:'DM Mono',monospace;font-size:12px;color:var(--green);">fat</code>
              <code style="background:var(--surface3);padding:3px 8px;border-radius:4px;font-family:'DM Mono',monospace;font-size:12px;color:var(--green);">meal / type</code>
              <code style="background:var(--surface3);padding:3px 8px;border-radius:4px;font-family:'DM Mono',monospace;font-size:12px;color:var(--green);">food / name</code>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Upload CSV</div>
          <div class="drop-zone" id="dz-csv" onclick="document.getElementById('file-csv').click()" ondragover="handleDragOver(event,'csv')" ondragleave="handleDragLeave('csv')" ondrop="handleDrop(event,'csv','csv')">
            <div class="drop-zone-icon">üìÇ</div>
            <div class="drop-zone-title">Drop CSV here or click to browse</div>
            <div class="drop-zone-sub">Any CSV with date + nutrition/workout columns</div>
          </div>
          <input type="file" id="file-csv" accept=".csv" multiple style="display:none" onchange="handleFileSelect(event,'csv')">
          <div id="import-preview-csv"></div>
        </div>
      </div>

      <!-- Global import log -->
      <div id="import-log" style="margin-top:20px;display:none;">
        <div class="card">
          <div class="card-title">üìã Import Log</div>
          <div id="import-log-content" style="font-size:13px;font-family:'DM Mono',monospace;color:var(--text-dim);line-height:2;max-height:200px;overflow-y:auto;"></div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ GOOGLE SHEETS ‚îÄ‚îÄ -->
    <div class="page" id="page-sheets">
      <div class="page-title">Google Sheets Sync</div>
      <div class="page-sub">Automatically send your food log data to a Google Sheet for analysis & sharing</div>

      <div id="sheets-connected-banner" class="sheets-connected" style="display:none;">
        ‚úÖ Connected to Google Sheets! Data syncs automatically when you log food.
      </div>

      <div class="card" style="margin-bottom:24px;">
        <div class="card-title">Quick Export</div>
        <p style="font-size:14px;color:var(--text-dim);margin-bottom:16px;">Download all your data as a CSV file and import it directly into Google Sheets in seconds.</p>
        <button class="btn btn-primary" onclick="exportCSV()">‚¨á Download CSV Export</button>
      </div>

      <div class="card" style="margin-bottom:24px;">
        <div class="card-title">Google Sheets API Integration</div>
        <p style="font-size:14px;color:var(--text-dim);margin-bottom:20px;">Set up automatic syncing so every food entry is instantly recorded in your Google Sheet. Follow these steps:</p>
        
        <div class="sheets-step">
          <div class="step-num">1</div>
          <div class="step-content">
            <h4>Create a Google Cloud Project</h4>
            <p>Go to <strong>console.cloud.google.com</strong>, create a new project, then enable the <strong>Google Sheets API</strong> and <strong>Google Drive API</strong> under APIs & Services ‚Üí Library.</p>
          </div>
        </div>
        <div class="sheets-step">
          <div class="step-num">2</div>
          <div class="step-content">
            <h4>Create OAuth 2.0 Credentials</h4>
            <p>Go to APIs & Services ‚Üí Credentials ‚Üí Create Credentials ‚Üí <strong>OAuth 2.0 Client ID</strong>. Select "Web Application." Add your app's domain to the Authorized JavaScript Origins. Copy the <strong>Client ID</strong>.</p>
          </div>
        </div>
        <div class="sheets-step">
          <div class="step-num">3</div>
          <div class="step-content">
            <h4>Create Your Google Sheet</h4>
            <p>Create a new Google Sheet. Add this header row in Row 1: <code>Date, User, Meal, Food Name, Quantity, Calories, Protein(g), Carbs(g), Fat(g)</code>. Copy the <strong>Sheet ID</strong> from the URL.</p>
          </div>
        </div>
        <div class="sheets-step">
          <div class="step-num">4</div>
          <div class="step-content">
            <h4>Enter Your Credentials Below</h4>
            <p>Paste your OAuth Client ID and Sheet ID below. Click Connect, then authorize access with your Google account. All future food log entries will sync in real time.</p>
          </div>
        </div>

        <div class="divider"></div>

        <div class="ai-form-grid">
          <div class="form-group">
            <label>Google OAuth Client ID</label>
            <input type="text" id="goog-client-id" placeholder="123456789.apps.googleusercontent.com">
          </div>
          <div class="form-group">
            <label>Google Sheet ID</label>
            <input type="text" id="goog-sheet-id" placeholder="1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgVE2upms">
          </div>
        </div>
        <button class="btn btn-primary" onclick="connectGoogleSheets()">Connect to Google Sheets</button>
        <div class="success-msg" id="sheets-msg" style="margin-top:10px;">‚úì Connected! New food entries will sync automatically.</div>
        <div class="error-msg" id="sheets-err" style="margin-top:10px;">Please enter both Client ID and Sheet ID.</div>
      </div>

      <div class="card">
        <div class="card-title">Manual Sync</div>
        <p style="font-size:14px;color:var(--text-dim);margin-bottom:16px;">Push all your current data to Google Sheets now.</p>
        <button class="btn btn-outline" onclick="manualSyncSheets()">üîÑ Sync All Data to Sheets Now</button>
        <div class="success-msg" id="sync-msg" style="margin-top:10px;">‚úì All data synced to Google Sheets!</div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ -->
    <div class="page" id="page-profile">
      <div class="page-title">My Profile</div>
      <div class="page-sub">Manage your personal stats and goals</div>
      <div class="profile-grid">
        <div class="card">
          <div class="avatar-big" id="profile-avatar">S</div>
          <div class="form-group">
            <label>Full Name</label>
            <input type="text" id="profile-name">
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="profile-email">
          </div>
          <div class="form-group">
            <label>Age</label>
            <input type="number" id="profile-age">
          </div>
          <div class="form-group">
            <label>Gender</label>
            <select id="profile-gender">
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="other">Other</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
        </div>



          <div class="success-msg" id="profile-saved" style="display:none;margin-top:8px;">‚úì Profile saved!</div>
        </div>
        <div>
          <!-- Unit System Toggle -->
          <div class="card" style="margin-bottom:16px;">
            <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;">
              <div>
                <div class="card-title" style="margin-bottom:2px;">üìê Unit System</div>
                <div style="font-size:12px;color:var(--text-muted);">Applies to weight, height and measurements across the app</div>
              </div>
              <div style="display:flex;gap:0;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;">
                <button id="unit-btn-imperial" onclick="setUnitSystem('imperial')"
                  style="padding:9px 20px;border:none;cursor:pointer;font-size:13px;font-weight:600;font-family:'DM Sans',sans-serif;transition:all 0.15s;background:var(--green);color:#0d0f0e;">
                  üá∫üá∏ Standard
                </button>
                <button id="unit-btn-metric" onclick="setUnitSystem('metric')"
                  style="padding:9px 20px;border:none;cursor:pointer;font-size:13px;font-weight:600;font-family:'DM Sans',sans-serif;transition:all 0.15s;background:transparent;color:var(--text-dim);">
                  üåç Metric
                </button>
              </div>
            </div>
          </div>

          <div class="card" style="margin-bottom:16px;">
            <div class="card-title">Body Stats</div>
            <div class="ai-form-grid">
              <div class="form-group">
                <label id="profile-height-label">Height (inches)</label>
                <input type="number" id="profile-height" step="0.1">
              </div>
              <div class="form-group">
                <label id="profile-weight-label">Current Weight (lbs)</label>
                <input type="number" id="profile-weight" step="0.1" oninput="updateWeightPreview(this.value)">
              </div>
            </div>
            <!-- Quick weight log -->
            <div style="border-top:1px solid var(--border);margin-top:12px;padding-top:14px;">
              <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--text-muted);margin-bottom:10px;">‚öñÔ∏è Log Today's Weight</div>
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <input type="number" id="quick-weight-input" placeholder="e.g. 182.5" step="0.1" style="width:120px;font-size:15px;font-weight:600;" oninput="updateWeightPreview(this.value)">
                <span id="quick-weight-unit-lbl" style="font-size:13px;color:var(--text-muted);">lbs</span>
                <button class="btn btn-primary btn-sm" onclick="logWeight()" style="padding:10px 18px;">üíæ Log Weight</button>
                <button class="btn btn-outline btn-sm" onclick="navigate('progress')">üìà View History</button>
              </div>
              <div id="weight-log-msg" style="display:none;font-size:12px;color:var(--green);margin-top:8px;">‚úì Weight logged!</div>
              <!-- Mini sparkline -->
              <div id="weight-mini-chart" style="margin-top:12px;"></div>
            </div>
          </div>
          <div class="card" style="margin-bottom:16px;">
            <div class="card-title">Daily Nutrition Goals</div>
            <div class="ai-form-grid">
              <div class="form-group">
                <label>Calorie Goal</label>
                <input type="number" id="profile-cal-goal" placeholder="1800">
              </div>
              <div class="form-group">
                <label>Protein Goal (g)</label>
                <input type="number" id="profile-protein-goal" placeholder="120">
              </div>
              <div class="form-group">
                <label>Fat Goal (g)</label>
                <input type="number" id="profile-fat-goal" placeholder="60">
              </div>
              <div class="form-group">
                <label>Carbs Goal (g)</label>
                <input type="number" id="profile-carbs-goal" placeholder="200">
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-title">Primary Goal</div>
            <div class="form-group">
              <select id="profile-goal">
                <option value="lose_weight">Lose Weight</option>
                <option value="build_muscle">Build Muscle</option>
                <option value="maintain">Maintain Weight</option>
                <option value="improve_fitness">Improve Overall Fitness</option>
              </select>
            </div>
            <button class="btn btn-primary" onclick="saveProfile()">Save All</button>
          </div>

          <!-- WhatsApp Group Card -->
          <div class="card" style="border-color:rgba(37,211,102,0.3);">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px;">
              <span style="font-size:22px;">üí¨</span>
              <div class="card-title" style="margin-bottom:0;">WhatsApp Group Shortcut</div>
            </div>
            <p style="font-size:13px;color:var(--text-dim);margin-bottom:16px;line-height:1.6;">
              Paste your WhatsApp group invite link below. A shortcut button will appear in the sidebar so you can jump straight to the chat anytime.
            </p>
            <div class="form-group">
              <label>WhatsApp Group Link</label>
              <input type="url" id="profile-whatsapp" placeholder="https://chat.whatsapp.com/..." autocomplete="off">
              <div style="font-size:11px;color:var(--text-muted);margin-top:6px;">To get your link: open WhatsApp ‚Üí group chat ‚Üí group info ‚Üí Invite via link ‚Üí Copy link</div>
            </div>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
              <button class="btn btn-whatsapp" onclick="saveWhatsApp()">üíæ Save Link</button>
              <button class="btn btn-outline btn-sm" id="wa-test-btn" onclick="openWhatsApp()" style="display:none;">‚Üó Open Group</button>
              <button class="btn btn-outline btn-sm" id="wa-clear-btn" onclick="clearWhatsApp()" style="display:none;color:var(--red);border-color:rgba(248,113,113,0.3);">‚úï Remove</button>
            </div>
            <div class="success-msg" id="wa-saved" style="display:none;margin-top:10px;">‚úì WhatsApp link saved! Check your sidebar.</div>
            <div class="error-msg" id="wa-error" style="margin-top:10px;">Please enter a valid WhatsApp link (starts with https://chat.whatsapp.com/)</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ -->
    <div class="page" id="page-progress">
      <div class="page-title">üì∏ Progress Tracker</div>
      <div class="page-sub">Log your weight, track body photos, and generate a time-lapse of your transformation</div>

      <!-- ‚ïê‚ïê WEIGHT SECTION ‚ïê‚ïê -->
      <div class="card" style="margin-bottom:16px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
          <div class="card-title" style="margin-bottom:0;">‚öñÔ∏è Weight History</div>
          <div style="display:flex;gap:8px;">
            <button class="btn btn-outline btn-sm" onclick="exportWeightCSV()">üì§ Export</button>
          </div>
        </div>

        <!-- Log form -->
        <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;padding:14px;background:var(--surface2);border-radius:var(--radius);border:1px solid var(--border);margin-bottom:16px;">
          <div class="form-group" style="margin-bottom:0;flex:1;min-width:120px;">
            <label>Weight (lbs)</label>
            <input type="number" id="pg-weight-input" placeholder="182.5" step="0.1" style="font-size:16px;font-weight:600;">
          </div>
          <div class="form-group" style="margin-bottom:0;flex:1;min-width:130px;">
            <label>Date</label>
            <input type="date" id="pg-weight-date">
          </div>
          <div class="form-group" style="margin-bottom:0;flex:1;min-width:140px;">
            <label>Note (optional)</label>
            <input type="text" id="pg-weight-note" placeholder="e.g. morning, post-workout">
          </div>
          <button class="btn btn-primary" onclick="logWeightFull()" style="padding:13px 20px;white-space:nowrap;">üíæ Log Weight</button>
        </div>
        <div id="pg-weight-saved" style="display:none;font-size:12px;color:var(--green);margin-bottom:12px;">‚úì Weight logged!</div>

        <!-- Stats row -->
        <div id="pg-weight-stats" style="display:none;margin-bottom:16px;">
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;">
            <div style="background:var(--surface2);border-radius:var(--radius);padding:12px;border:1px solid var(--border);text-align:center;">
              <div style="font-family:'Bebas Neue',sans-serif;font-size:24px;color:var(--green);" id="pg-stat-current">‚Äî</div>
              <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.8px;color:var(--text-muted);">Current</div>
            </div>
            <div style="background:var(--surface2);border-radius:var(--radius);padding:12px;border:1px solid var(--border);text-align:center;">
              <div style="font-family:'Bebas Neue',sans-serif;font-size:24px;" id="pg-stat-start">‚Äî</div>
              <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.8px;color:var(--text-muted);">Starting</div>
            </div>
            <div style="background:var(--surface2);border-radius:var(--radius);padding:12px;border:1px solid var(--border);text-align:center;">
              <div style="font-family:'Bebas Neue',sans-serif;font-size:24px;" id="pg-stat-change">‚Äî</div>
              <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.8px;color:var(--text-muted);">Total Change</div>
            </div>
            <div style="background:var(--surface2);border-radius:var(--radius);padding:12px;border:1px solid var(--border);text-align:center;">
              <div style="font-family:'Bebas Neue',sans-serif;font-size:24px;color:var(--accent);" id="pg-stat-target">‚Äî</div>
              <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.8px;color:var(--text-muted);">Goal Weight</div>
            </div>
          </div>
        </div>

        <!-- Chart -->
        <div id="pg-weight-chart" style="margin-bottom:8px;"></div>

        <!-- History list -->
        <div id="pg-weight-history"></div>
      </div>

      <!-- ‚ïê‚ïê GOAL WEIGHT ‚ïê‚ïê -->
      <div class="card" style="margin-bottom:16px;">
        <div class="card-title">üéØ Goal Weight</div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
          <input type="number" id="pg-goal-weight" placeholder="e.g. 165" step="0.5" style="width:130px;">
          <span style="font-size:13px;color:var(--text-muted);">lbs</span>
          <button class="btn btn-primary btn-sm" onclick="saveGoalWeight()">Save Goal</button>
          <div id="pg-goal-weight-info" style="font-size:12px;color:var(--text-muted);"></div>
        </div>
        <div id="pg-goal-progress-bar-wrap" style="display:none;margin-top:12px;">
          <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text-muted);margin-bottom:4px;">
            <span id="pg-goal-bar-start-lbl"></span>
            <span id="pg-goal-bar-pct-lbl"></span>
            <span id="pg-goal-bar-end-lbl"></span>
          </div>
          <div style="height:12px;background:var(--surface2);border-radius:6px;overflow:hidden;border:1px solid var(--border);">
            <div id="pg-goal-bar-fill" style="height:100%;border-radius:6px;background:var(--green);transition:width 0.5s;"></div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê PROGRESS PHOTOS ‚ïê‚ïê -->
      <div class="card" style="margin-bottom:16px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
          <div class="card-title" style="margin-bottom:0;">üì∑ Progress Photos</div>
          <div style="display:flex;gap:8px;">
            <button class="btn btn-outline btn-sm" id="pg-cam-btn" onclick="openProgressCamera()">üì∑ Camera</button>
            <button class="btn btn-outline btn-sm" onclick="document.getElementById('pg-photo-upload').click()">üñºÔ∏è Upload</button>
            <input type="file" id="pg-photo-upload" accept="image/*" multiple style="display:none;" onchange="handleProgressUpload(event)">
          </div>
        </div>

        <!-- Camera panel -->
        <div id="pg-camera-panel" style="display:none;margin-bottom:14px;">
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;">
            <div style="padding:10px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;">
              <div style="font-size:13px;font-weight:600;">üì∑ Take Progress Photo</div>
              <button class="btn btn-outline btn-sm" onclick="closeProgressCamera()" style="padding:4px 8px;font-size:11px;">‚úï</button>
            </div>
            <div style="padding:12px;">
              <div style="position:relative;background:#000;border-radius:8px;overflow:hidden;min-height:220px;margin-bottom:10px;display:flex;align-items:center;justify-content:center;">
                <video id="pg-video" style="width:100%;max-height:320px;object-fit:cover;display:block;" playsinline autoplay muted></video>
                <canvas id="pg-canvas" style="display:none;"></canvas>
                <div id="pg-cam-placeholder" style="position:absolute;text-align:center;color:#666;">
                  <div style="font-size:32px;">üì∑</div><div style="font-size:11px;margin-top:6px;">Starting camera...</div>
                </div>
              </div>
              <!-- Shot type selector -->
              <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px;">
                <button class="src-btn src-active" id="pg-shot-front" onclick="setPgShot('Front')">Front</button>
                <button class="src-btn" id="pg-shot-side" onclick="setPgShot('Side')">Side</button>
                <button class="src-btn" id="pg-shot-back" onclick="setPgShot('Back')">Back</button>
              </div>
              <button class="btn btn-primary btn-full" id="pg-snap-btn" onclick="snapProgressPhoto()" style="display:none;font-size:14px;padding:12px;">üì∏ Take Photo</button>
            </div>
          </div>
        </div>

        <!-- Photo tip -->
        <div style="background:rgba(74,222,128,0.06);border:1px solid rgba(74,222,128,0.2);border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:12px;color:var(--text-dim);">
          üí° <strong>Tip:</strong> For accurate comparison, take photos at the same time of day, same distance, same lighting, and same position each time.
        </div>

        <!-- Photo filter -->
        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;" id="pg-filter-row">
          <button class="src-btn src-active" id="pg-filter-all" onclick="setPgFilter('all')">All Photos</button>
          <button class="src-btn" id="pg-filter-front" onclick="setPgFilter('Front')">Front</button>
          <button class="src-btn" id="pg-filter-side" onclick="setPgFilter('Side')">Side</button>
          <button class="src-btn" id="pg-filter-back" onclick="setPgFilter('Back')">Back</button>
        </div>

        <!-- Photo grid -->
        <div id="pg-photo-grid" class="photo-grid"></div>
        <div id="pg-no-photos" style="text-align:center;padding:30px;color:var(--text-muted);font-size:13px;">
          No progress photos yet.<br>Take your first photo to start tracking your transformation!
        </div>
      </div>

      <!-- ‚ïê‚ïê TIME-LAPSE VIDEO ‚ïê‚ïê -->
      <div class="card">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
          <span style="font-size:24px;">üé¨</span>
          <div class="card-title" style="margin-bottom:0;">Time-lapse Video</div>
        </div>
        <div style="font-size:13px;color:var(--text-dim);margin-bottom:16px;line-height:1.6;">
          Turn your progress photos into a time-lapse video showing your transformation journey. You need at least 3 photos to generate one.
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:12px;">
          <div class="form-group" style="margin-bottom:0;">
            <label>Photo type to use</label>
            <select id="tl-shot-type" style="width:140px;">
              <option value="all">All Photos</option>
              <option value="Front">Front only</option>
              <option value="Side">Side only</option>
              <option value="Back">Back only</option>
            </select>
          </div>
          <div class="form-group" style="margin-bottom:0;">
            <label>Speed (sec per frame)</label>
            <select id="tl-speed" style="width:140px;">
              <option value="0.3">Fast (0.3s)</option>
              <option value="0.6" selected>Medium (0.6s)</option>
              <option value="1.0">Slow (1.0s)</option>
              <option value="2.0">Very Slow (2s)</option>
            </select>
          </div>
        </div>
        <button class="btn btn-accent btn-full" id="tl-gen-btn" onclick="generateTimelapse()" style="padding:14px;font-size:15px;margin-bottom:12px;">
          üé¨ Generate Time-lapse Video
        </button>
        <div id="tl-status" style="display:none;font-size:12px;color:var(--text-dim);margin-bottom:8px;"></div>
        <div id="tl-progress-wrap" style="display:none;" class="tlapse-progress">
          <div id="tl-progress-fill" class="tlapse-progress-fill" style="width:0%;"></div>
        </div>
        <div id="tl-output" style="display:none;margin-top:14px;">
          <video id="tl-video" controls style="width:100%;border-radius:var(--radius);border:1px solid var(--border);background:#000;max-height:400px;"></video>
          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;">
            <a id="tl-download-btn" class="btn btn-primary btn-sm" download="chingone-timelapse.webm">‚¨áÔ∏è Download Video</a>
            <button class="btn btn-outline btn-sm" onclick="document.getElementById('tl-output').style.display='none';">‚úï Close</button>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê AI BODY VISUALISER ‚ïê‚ïê -->
      <div class="card" style="margin-bottom:16px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
          <div class="card-title" style="margin-bottom:0;">ü™Ñ AI Body Visualiser</div>
          <span style="background:linear-gradient(135deg,var(--accent),var(--green));color:#0d0f0e;font-size:10px;font-weight:800;padding:3px 10px;border-radius:20px;">NEW</span>
        </div>
        <div style="font-size:13px;color:var(--text-dim);margin-bottom:16px;line-height:1.6;">
          Take a photo of yourself, enter your goal weight, and AI will generate a realistic side-by-side showing what you could look like at your goal.
        </div>

        <!-- Step 1: Photo -->
        <div id="bv-step1" style="margin-bottom:14px;">
          <div style="font-size:12px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:8px;">Step 1 ‚Äî Take or upload your photo</div>
          <div id="bv-photo-preview" style="display:none;margin-bottom:10px;">
            <img id="bv-preview-img" style="width:100%;max-height:280px;object-fit:cover;border-radius:12px;border:1px solid var(--border);display:block;" src="" alt="Your photo">
            <button class="btn btn-outline btn-sm" onclick="bvClearPhoto()" style="margin-top:8px;width:100%;">üîÑ Change Photo</button>
          </div>
          <div id="bv-photo-btns">
            <button class="btn btn-primary btn-full" onclick="bvOpenCamera()" style="padding:14px;font-size:15px;margin-bottom:8px;">üì∑ Take Photo Now</button>
            <button class="btn btn-outline btn-full" onclick="document.getElementById('bv-file-input').click()" style="padding:12px;font-size:14px;">üñºÔ∏è Upload from Camera Roll</button>
            <input type="file" id="bv-file-input" accept="image/*" style="display:none;" onchange="bvHandleUpload(event)">
          </div>
        </div>

        <!-- Step 2: Goal inputs -->
        <div style="background:var(--surface2);border-radius:12px;padding:14px;margin-bottom:14px;">
          <div style="font-size:12px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:10px;">Step 2 ‚Äî Your details</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
            <div class="form-group" style="margin-bottom:0;">
              <label>Current Weight (lbs)</label>
              <input type="number" id="bv-current-weight" placeholder="180">
            </div>
            <div class="form-group" style="margin-bottom:0;">
              <label>Goal Weight (lbs)</label>
              <input type="number" id="bv-goal-weight" placeholder="155">
            </div>
            <div class="form-group" style="margin-bottom:0;">
              <label>Height</label>
              <input type="text" id="bv-height" placeholder="5'10&quot;">
            </div>
            <div class="form-group" style="margin-bottom:0;">
              <label>Gender</label>
              <select id="bv-gender">
                <option value="male">Male</option>
                <option value="female">Female</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Generate button -->
        <button class="btn btn-accent btn-full" id="bv-generate-btn" onclick="generateBodyVisualisation()" style="font-size:16px;padding:16px;font-weight:800;margin-bottom:14px;">
          ü™Ñ Generate My Transformation
        </button>

        <!-- Status / progress -->
        <div id="bv-status" style="display:none;text-align:center;padding:20px 0;">
          <div class="spinner" style="width:36px;height:36px;border-width:3px;margin:0 auto 14px;"></div>
          <div id="bv-status-msg" style="font-weight:700;font-size:15px;margin-bottom:6px;">Analysing your photo...</div>
          <div style="font-size:12px;color:var(--text-muted);">This takes about 15‚Äì30 seconds</div>
        </div>

        <!-- Result -->
        <div id="bv-result" style="display:none;">
          <div style="font-size:13px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:12px;text-align:center;">Your Transformation</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
            <div>
              <div style="font-size:11px;font-weight:700;text-align:center;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase;">NOW</div>
              <img id="bv-before-img" style="width:100%;border-radius:12px;border:2px solid var(--border);display:block;" src="" alt="Current">
              <div id="bv-current-label" style="text-align:center;font-size:12px;color:var(--text-dim);margin-top:4px;"></div>
            </div>
            <div>
              <div style="font-size:11px;font-weight:700;text-align:center;color:var(--green);margin-bottom:6px;text-transform:uppercase;">GOAL</div>
              <img id="bv-after-img" style="width:100%;border-radius:12px;border:2px solid var(--green);display:block;" src="" alt="Goal">
              <div id="bv-goal-label" style="text-align:center;font-size:12px;color:var(--green);margin-top:4px;font-weight:600;"></div>
            </div>
          </div>
          <div id="bv-ai-description" style="background:var(--surface2);border-radius:10px;padding:12px 14px;font-size:13px;color:var(--text-dim);line-height:1.7;margin-bottom:12px;"></div>
          <div style="font-size:11px;color:var(--text-muted);text-align:center;margin-bottom:12px;">‚ö†Ô∏è AI-generated illustration ‚Äî not a medical prediction. Results vary.</div>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <button class="btn btn-outline btn-full" onclick="bvSaveResult()" style="padding:12px;font-size:14px;">üíæ Save to Progress Photos</button>
            <button class="btn btn-outline btn-full" onclick="bvReset()" style="padding:12px;font-size:14px;">üîÑ Generate Again</button>
          </div>
        </div>

        <!-- Error -->
        <div id="bv-error" style="display:none;"></div>
      </div>

    </div>

    <!-- ‚îÄ‚îÄ USERS ‚îÄ‚îÄ -->
    <div class="page" id="page-users">
      <div class="page-title">Switch User</div>
      <div class="page-sub">Select a profile or create a new one</div>
      <div class="users-grid" id="users-grid"></div>
      <div style="margin-top:20px;">
        <button class="btn btn-outline" onclick="switchAuthTab('register'); document.getElementById('app').classList.remove('visible'); document.getElementById('auth-screen').style.display='flex'; document.getElementById('app').classList.remove('visible');">+ Add New User</button>
      </div>
    </div>

  <!-- ‚îÄ‚îÄ ADMIN PANEL ‚îÄ‚îÄ -->
    <div class="page" id="page-admin">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:4px;">
        <div class="page-title" style="margin-bottom:0;">Admin Panel</div>
        <span class="admin-badge">üõ°Ô∏è Admin</span>
      </div>
      <div class="page-sub">Manage users, permissions, and app settings</div>

      <div class="admin-panel-card">
        <div class="card-title">üë• User Management</div>
        <div id="admin-user-list">Loading...</div>
      </div>

      <div class="admin-panel-card">
        <div class="card-title">üìñ Recipe Management</div>
        <p style="font-size:14px;color:var(--text-dim);margin-bottom:16px;">As admin you can delete any recipe shared by any user.</p>
        <div id="admin-recipe-list">Loading...</div>
      </div>

      <div class="admin-panel-card" style="border-color:rgba(248,113,113,0.25);">
        <div class="card-title" style="color:var(--red);">‚ö†Ô∏è Danger Zone</div>
        <p style="font-size:14px;color:var(--text-dim);margin-bottom:16px;">Permanently delete all demo accounts (sarah &amp; mike). This cannot be undone.</p>
        <button class="btn btn-danger btn-sm" onclick="adminDeleteDemoUsers()">üóë Remove Demo Users</button>
      </div>
    </div>

  <!-- ‚îÄ‚îÄ INSTALL APP ‚îÄ‚îÄ -->
    <div class="page" id="page-install">
      <div class="page-title">üì≤ Install the App</div>
      <div class="page-sub">Add Chingone Life Tracker to your home screen for the full app experience</div>

      <!-- Install prompt (shown on Android Chrome) -->
      <div id="install-prompt-card" style="display:none;margin-bottom:20px;">
        <div class="card" style="border-color:rgba(74,222,128,0.4);background:var(--green-glow);">
          <div style="display:flex;align-items:center;gap:14px;">
            <div style="font-size:40px;">üéâ</div>
            <div style="flex:1;">
              <div style="font-weight:700;font-size:15px;margin-bottom:4px;">Ready to install!</div>
              <div style="font-size:13px;color:var(--text-dim);">Your browser supports direct installation. Tap the button below to add Chingone to your home screen.</div>
            </div>
          </div>
          <button class="btn btn-primary btn-full" style="margin-top:16px;font-size:15px;padding:14px;" onclick="triggerPWAInstall()">‚¨áÔ∏è Install Chingone Life Tracker</button>
        </div>
      </div>

      <!-- App preview card -->
      <div class="card" style="margin-bottom:20px;text-align:center;padding:32px 20px;">
        <div style="width:88px;height:88px;border-radius:22px;background:#0d0f0e;border:2px solid #4ade80;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;box-shadow:0 0 32px rgba(74,222,128,0.25);">
          <span style="font-family:'Bebas Neue',sans-serif;font-size:52px;color:#4ade80;line-height:1;">C</span>
        </div>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:1px;margin-bottom:4px;">Chingone Life Tracker</div>
        <div style="font-size:13px;color:var(--text-dim);">Food ¬∑ Workouts ¬∑ AI Plans ¬∑ Recipes</div>
        <div style="display:flex;justify-content:center;gap:16px;margin-top:20px;flex-wrap:wrap;">
          <div style="text-align:center;"><div style="font-size:22px;">üì¥</div><div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Works Offline</div></div>
          <div style="text-align:center;"><div style="font-size:22px;">‚ö°</div><div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Instant Load</div></div>
          <div style="text-align:center;"><div style="font-size:22px;">üîí</div><div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Data Stays Private</div></div>
          <div style="text-align:center;"><div style="font-size:22px;">üîÑ</div><div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Auto Updates</div></div>
        </div>
      </div>

      <!-- iPhone instructions -->
      <div class="card" style="margin-bottom:16px;">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
          <span style="font-size:26px;">üçé</span>
          <div class="card-title" style="margin-bottom:0;">Install on iPhone / iPad</div>
        </div>
        <div class="import-step">
          <div class="import-step-num">1</div>
          <div class="import-step-body">
            <h4>Open in Safari</h4>
            <p>This <strong>must</strong> be done in <strong>Safari</strong> ‚Äî not Chrome or Firefox. If you're reading this in another browser, copy the URL and open it in Safari.</p>
          </div>
        </div>
        <div class="import-step">
          <div class="import-step-num">2</div>
          <div class="import-step-body">
            <h4>Tap the Share button</h4>
            <p>At the bottom of Safari, tap the <strong>Share icon</strong> ‚Äî it looks like a box with an arrow pointing up <span style="font-size:16px;">‚¨ÜÔ∏è</span></p>
          </div>
        </div>
        <div class="import-step">
          <div class="import-step-num">3</div>
          <div class="import-step-body">
            <h4>Tap "Add to Home Screen"</h4>
            <p>Scroll down in the share sheet and tap <strong>"Add to Home Screen"</strong>. The app name will show as <strong>Chingone</strong>. Tap <strong>Add</strong> in the top-right corner.</p>
          </div>
        </div>
        <div class="import-step" style="border-bottom:none;">
          <div class="import-step-num">4</div>
          <div class="import-step-body">
            <h4>Open from your home screen</h4>
            <p>Find the <strong>Chingone</strong> icon on your home screen and tap it. It will open fullscreen like a native app ‚Äî no browser bar, no address bar.</p>
          </div>
        </div>
        <div style="background:rgba(250,204,21,0.08);border:1px solid rgba(250,204,21,0.2);border-radius:var(--radius);padding:12px 14px;margin-top:12px;font-size:12px;color:var(--accent);">
          üí° <strong>Tip:</strong> The app must be hosted at a URL (not opened as a local file) for "Add to Home Screen" to show the custom icon. See hosting options below.
        </div>
      </div>

      <!-- Android instructions -->
      <div class="card" style="margin-bottom:16px;">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
          <span style="font-size:26px;">ü§ñ</span>
          <div class="card-title" style="margin-bottom:0;">Install on Android</div>
        </div>
        <div class="import-step">
          <div class="import-step-num">1</div>
          <div class="import-step-body">
            <h4>Open in Chrome</h4>
            <p>Open the app URL in <strong>Google Chrome</strong> on your Android phone. Chrome has the best PWA support on Android.</p>
          </div>
        </div>
        <div class="import-step">
          <div class="import-step-num">2</div>
          <div class="import-step-body">
            <h4>Tap the install banner or menu</h4>
            <p>Chrome may automatically show an <strong>"Add to Home screen"</strong> banner at the bottom. If not, tap the <strong>‚ãÆ three-dot menu</strong> in the top-right and select <strong>"Add to Home screen"</strong> or <strong>"Install app"</strong>.</p>
          </div>
        </div>
        <div class="import-step" style="border-bottom:none;">
          <div class="import-step-num">3</div>
          <div class="import-step-body">
            <h4>Tap Install and you're done</h4>
            <p>Confirm the install. The Chingone icon appears on your home screen. It opens fullscreen with no browser UI ‚Äî just like a real Android app.</p>
          </div>
        </div>
      </div>

      <!-- Hosting options -->
      <div class="card" style="margin-bottom:16px;">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
          <span style="font-size:26px;">üåê</span>
          <div class="card-title" style="margin-bottom:0;">How to Host It (Free Options)</div>
        </div>
        <p style="font-size:13px;color:var(--text-dim);margin-bottom:16px;line-height:1.7;">The app needs to be at a public URL so your group can access it. Here are the easiest free options:</p>

        <div style="display:flex;flex-direction:column;gap:12px;">
          <div style="background:var(--surface2);border-radius:var(--radius);padding:16px;">
            <div style="font-weight:700;font-size:14px;margin-bottom:4px;">‚ö° Netlify Drop <span style="background:var(--green);color:#0d0f0e;font-size:10px;padding:2px 7px;border-radius:10px;font-weight:700;margin-left:6px;">Easiest</span></div>
            <div style="font-size:13px;color:var(--text-dim);line-height:1.7;margin-bottom:8px;">Go to <a href="https://app.netlify.com/drop" target="_blank" style="color:var(--green);">app.netlify.com/drop</a>, drag and drop your HTML file onto the page, and you instantly get a public URL like <code style="font-size:11px;background:var(--surface3);padding:2px 5px;border-radius:4px;">yoursite.netlify.app</code>. Free, no account needed to start.</div>
          </div>
          <div style="background:var(--surface2);border-radius:var(--radius);padding:16px;">
            <div style="font-weight:700;font-size:14px;margin-bottom:4px;">üêô GitHub Pages</div>
            <div style="font-size:13px;color:var(--text-dim);line-height:1.7;">Create a free GitHub account, make a repository, upload the HTML file as <code style="font-size:11px;background:var(--surface3);padding:2px 5px;border-radius:4px;">index.html</code>, and enable GitHub Pages in settings. Free forever.</div>
          </div>
          <div style="background:var(--surface2);border-radius:var(--radius);padding:16px;">
            <div style="font-weight:700;font-size:14px;margin-bottom:4px;">üî• Firebase Hosting</div>
            <div style="font-size:13px;color:var(--text-dim);line-height:1.7;">Google's free hosting. Gives you a clean URL and excellent performance. Requires a Google account and the Firebase CLI tool.</div>
          </div>
        </div>
      </div>

      <!-- Share with group -->
      <div class="card">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
          <span style="font-size:26px;">üí¨</span>
          <div class="card-title" style="margin-bottom:0;">Share with Your Group</div>
        </div>
        <p style="font-size:13px;color:var(--text-dim);line-height:1.7;margin-bottom:14px;">Once hosted, share the URL in your WhatsApp group. Anyone who opens it can create an account and install it on their phone. No app store, no download ‚Äî just open and install.</p>
        <div id="share-url-section">
          <div class="form-group">
            <label>Your App URL (paste it here once hosted)</label>
            <input type="url" id="app-url-input" placeholder="https://yourapp.netlify.app" oninput="updateShareMessage()">
          </div>
          <div id="share-message-box" style="display:none;background:var(--surface2);border-radius:var(--radius);padding:14px;margin-top:10px;">
            <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:8px;">Share Message Preview</div>
            <div id="share-message-text" style="font-size:13px;color:var(--text-dim);line-height:1.8;white-space:pre-wrap;"></div>
            <button class="btn btn-outline btn-sm" style="margin-top:10px;" onclick="copyShareMessage()">üìã Copy Message</button>
            <div id="share-copied" style="display:none;font-size:12px;color:var(--green);margin-top:6px;">‚úì Copied to clipboard!</div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- end main -->

  <!-- ‚îÄ‚îÄ BOTTOM TAB BAR (mobile) ‚îÄ‚îÄ -->
  <nav class="bottom-tab-bar" id="bottom-tab-bar">
    <button class="tab-btn active" id="tab-dashboard" onclick="navigate('dashboard')">
      <span class="tab-icon">üìä</span>
      <span class="tab-label">Dashboard</span>
    </button>
    <button class="tab-btn" id="tab-food-log" onclick="navigate('food-log')">
      <span class="tab-icon">ü•ó</span>
      <span class="tab-label">Food</span>
    </button>
    <button class="tab-btn" id="tab-workout-log" onclick="navigate('workout-log')">
      <span class="tab-icon">üèãÔ∏è</span>
      <span class="tab-label">Workout</span>
    </button>
    <button class="tab-btn" id="tab-meal-ideas" onclick="navigate('meal-ideas')">
      <span class="tab-icon">üßë‚Äçüç≥</span>
      <span class="tab-label">Meals</span>
    </button>
    <button class="tab-btn" id="tab-more" onclick="openMoreMenu()">
      <span class="tab-icon">‚ò∞</span>
      <span class="tab-label">More</span>
    </button>
  </nav>

  <!-- More menu (slides up from bottom tab bar) -->
  <div class="more-menu-overlay" id="more-menu-overlay" onclick="closeMoreMenu()"></div>
  <div class="more-menu" id="more-menu">
    <div class="more-menu-handle"></div>
    <div class="more-menu-title">More Options</div>
    <div class="more-menu-grid">
      <button class="more-menu-item" id="mtab-ai-plan" onclick="navigate('ai-plan');closeMoreMenu()">
        <span class="mi-icon">ü§ñ</span>AI Plan
      </button>
      <button class="more-menu-item" id="mtab-recipes" onclick="navigate('recipes');closeMoreMenu()">
        <span class="mi-icon">üìñ</span>Recipes
      </button>
      <button class="more-menu-item" id="mtab-history" onclick="navigate('history');closeMoreMenu()">
        <span class="mi-icon">üìÖ</span>History
      </button>
      <button class="more-menu-item" id="mtab-import" onclick="navigate('import');closeMoreMenu()">
        <span class="mi-icon">üì•</span>Import
      </button>
      <button class="more-menu-item" id="mtab-sheets" onclick="navigate('sheets');closeMoreMenu()">
        <span class="mi-icon">üìä</span>Sheets
      </button>
      <button class="more-menu-item" id="mtab-profile" onclick="navigate('profile');closeMoreMenu()">
        <span class="mi-icon">üë§</span>Profile
      </button>
      <button class="more-menu-item" id="mtab-users" onclick="navigate('users');closeMoreMenu()">
        <span class="mi-icon">üë•</span>Switch User
      </button>
      <button class="more-menu-item" id="mtab-admin" style="display:none;" onclick="navigate('admin');closeMoreMenu()">
        <span class="mi-icon">üõ°Ô∏è</span>Admin
      </button>
      <button class="more-menu-item" id="mtab-install" onclick="navigate('install');closeMoreMenu()">
        <span class="mi-icon">üì≤</span>Install
      </button>
    </div>
  </div>

</div><!-- end app -->

<!-- PDF SHARE MODAL -->
<div class="modal-overlay" id="pdf-modal">
  <div class="modal pdf-modal">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
      <div class="modal-title" style="margin-bottom:0;">üì§ Share Day Summary</div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-primary btn-sm" onclick="printDashboardPDF()">üñ®Ô∏è Save / Print PDF</button>
        <button class="btn btn-outline btn-sm" onclick="document.getElementById('pdf-modal').classList.remove('open')">‚úï Close</button>
      </div>
    </div>
    <p style="font-size:13px;color:var(--text-dim);margin-bottom:16px;">Preview your day summary below. Hit <strong>Save / Print PDF</strong> ‚Äî on mobile choose <strong>"Save as PDF"</strong> or share directly to WhatsApp.</p>

    <!-- Live preview rendered here -->
    <div id="pdf-preview-container"></div>
  </div>
</div>

<!-- Hidden print frame (only visible during print) -->
<div id="pdf-print-frame"></div>

<!-- CONTACT ADMIN MODAL -->
<div class="modal-overlay" id="contact-admin-modal">
  <div class="modal" style="max-width:420px;text-align:center;">
    <div style="font-size:48px;margin-bottom:12px;">üîí</div>
    <div class="modal-title">Admin Permission Required</div>
    <div class="modal-sub" style="margin-bottom:16px;">You need admin access to <span id="contact-admin-msg">perform this action</span>.</div>
    <div class="contact-banner" style="text-align:left;margin-bottom:20px;">
      <span style="font-size:20px;">üìß</span>
      <div>
        <div style="font-weight:600;margin-bottom:2px;">Contact the App Admin</div>
        <a href="/cdn-cgi/l/email-protection#6d0f1f040f181e0559592d0a000c0401430e0200" style="color:var(--blue);text-decoration:none;font-size:13px;"><span class="__cf_email__" data-cfemail="3654445f5443455e020276515b575f5a1855595b">[email&#160;protected]</span></a>
      </div>
    </div>
    <button class="btn btn-outline btn-full" onclick="document.getElementById('contact-admin-modal').classList.remove('open')">Close</button>
  </div>
</div>

<!-- ADD WORKOUT MODAL -->
<div class="modal-overlay" id="add-workout-modal">
  <div class="modal" style="max-width:600px;max-height:90vh;overflow-y:auto;">
    <div class="modal-title" id="wm-title">üèãÔ∏è Log Workout</div>
    <div class="modal-sub">Add exercises, sets, reps, and weights</div>

    <!-- Activity type -->
    <div class="form-group">
      <label>Activity Type</label>
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:4px;" id="activity-chips">
        <button type="button" class="activity-chip active" onclick="selectActivity(this,'Weightlifting')">üèãÔ∏è Weightlifting</button>
        <button type="button" class="activity-chip" onclick="selectActivity(this,'Cardio')">üèÉ Cardio</button>
        <button type="button" class="activity-chip" onclick="selectActivity(this,'HIIT')">‚ö° HIIT</button>
        <button type="button" class="activity-chip" onclick="selectActivity(this,'Yoga')">üßò Yoga</button>
        <button type="button" class="activity-chip" onclick="selectActivity(this,'Swimming')">üèä Swimming</button>
        <button type="button" class="activity-chip" onclick="selectActivity(this,'Cycling')">üö¥ Cycling</button>
        <button type="button" class="activity-chip" onclick="selectActivity(this,'Running')">üèÉ Running</button>
        <button type="button" class="activity-chip" onclick="selectActivity(this,'Sports')">‚öΩ Sports</button>
        <button type="button" class="activity-chip" onclick="selectActivity(this,'Other')">‚ûï Other</button>
      </div>
      <input type="text" id="wm-activity-custom" placeholder="Or type a custom activity..." style="margin-top:8px;display:none;">
    </div>

    <div class="ai-form-grid">
      <div class="form-group">
        <label>Workout Name (optional)</label>
        <input type="text" id="wm-name" placeholder="e.g. Chest Day, Leg Day, Morning Run">
      </div>
      <div class="form-group">
        <label>Duration (minutes)</label>
        <input type="number" id="wm-duration" placeholder="60" min="1">
      </div>
      <div class="form-group">
        <label>Intensity</label>
        <select id="wm-intensity">
          <option value="Light">Light</option>
          <option value="Moderate" selected>Moderate</option>
          <option value="Hard">Hard</option>
          <option value="Max Effort">Max Effort</option>
        </select>
      </div>
      <div class="form-group">
        <label>Calories Burned (est.)</label>
        <input type="number" id="wm-calories" placeholder="0" min="0">
      </div>
    </div>

    <!-- EXERCISES TABLE -->
    <div style="margin:4px 0 12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
        <label style="margin-bottom:0;">Exercises</label>
        <button type="button" class="btn btn-outline btn-sm" onclick="addExerciseRow()">Ôºã Add Exercise</button>
      </div>
      <div id="exercise-rows-container">
        <!-- rows injected here -->
      </div>
      <div id="no-exercises-msg" style="padding:16px;text-align:center;color:var(--text-muted);font-size:13px;border:1px dashed var(--border);border-radius:var(--radius);">
        No exercises added yet ‚Äî click "+ Add Exercise" above
      </div>
    </div>

    <div class="form-group">
      <label>Notes (optional)</label>
      <textarea id="wm-notes" rows="2" placeholder="How did it feel? Any PRs? Anything to remember..."></textarea>
    </div>

    <div class="error-msg" id="wm-error" style="margin-bottom:12px;">Please select an activity type.</div>
    <div class="modal-actions">
      <button class="btn btn-primary" style="flex:1;" onclick="confirmAddWorkout()">‚úì Save Workout</button>
      <button class="btn btn-outline" onclick="closeWorkoutModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- ADD RECIPE MODAL -->
<div class="modal-overlay" id="add-recipe-modal">
  <div class="modal recipe-detail-modal">
    <div class="modal-title">üë®‚Äçüç≥ Share a Recipe</div>
    <div class="modal-sub">Your recipe will be visible to everyone using the app</div>

    <!-- Emoji picker -->
    <div class="form-group">
      <label>Choose an Icon</label>
      <div class="emoji-picker-row" id="recipe-emoji-picker">
        <span class="emoji-opt selected" data-emoji="ü•ó" onclick="selectRecipeEmoji(this)">ü•ó</span>
        <span class="emoji-opt" data-emoji="üç≥" onclick="selectRecipeEmoji(this)">üç≥</span>
        <span class="emoji-opt" data-emoji="ü•ò" onclick="selectRecipeEmoji(this)">ü•ò</span>
        <span class="emoji-opt" data-emoji="üç≤" onclick="selectRecipeEmoji(this)">üç≤</span>
        <span class="emoji-opt" data-emoji="ü•ô" onclick="selectRecipeEmoji(this)">ü•ô</span>
        <span class="emoji-opt" data-emoji="üåÆ" onclick="selectRecipeEmoji(this)">üåÆ</span>
        <span class="emoji-opt" data-emoji="ü•ë" onclick="selectRecipeEmoji(this)">ü•ë</span>
        <span class="emoji-opt" data-emoji="üç±" onclick="selectRecipeEmoji(this)">üç±</span>
        <span class="emoji-opt" data-emoji="ü•£" onclick="selectRecipeEmoji(this)">ü•£</span>
        <span class="emoji-opt" data-emoji="ü•§" onclick="selectRecipeEmoji(this)">ü•§</span>
        <span class="emoji-opt" data-emoji="ü´ô" onclick="selectRecipeEmoji(this)">ü´ô</span>
        <span class="emoji-opt" data-emoji="üçú" onclick="selectRecipeEmoji(this)">üçú</span>
        <span class="emoji-opt" data-emoji="ü•¶" onclick="selectRecipeEmoji(this)">ü•¶</span>
        <span class="emoji-opt" data-emoji="üçó" onclick="selectRecipeEmoji(this)">üçó</span>
        <span class="emoji-opt" data-emoji="ü•©" onclick="selectRecipeEmoji(this)">ü•©</span>
        <span class="emoji-opt" data-emoji="üêü" onclick="selectRecipeEmoji(this)">üêü</span>
        <span class="emoji-opt" data-emoji="üçì" onclick="selectRecipeEmoji(this)">üçì</span>
        <span class="emoji-opt" data-emoji="ü´ê" onclick="selectRecipeEmoji(this)">ü´ê</span>
      </div>
    </div>

    <div class="ai-form-grid">
      <div class="form-group full">
        <label>Recipe Name <span style="color:var(--red)">*</span></label>
        <input type="text" id="r-name" placeholder="e.g. High-Protein Chicken Bowl">
      </div>
      <div class="form-group full">
        <label>Short Description</label>
        <input type="text" id="r-desc" placeholder="e.g. A quick, macro-friendly lunch packed with lean protein">
      </div>
      <div class="form-group">
        <label>Category</label>
        <select id="r-category">
          <option value="breakfast">üåÖ Breakfast</option>
          <option value="lunch" selected>‚òÄÔ∏è Lunch</option>
          <option value="dinner">üåô Dinner</option>
          <option value="snack">üçé Snack</option>
          <option value="smoothie">ü•§ Smoothie</option>
          <option value="dessert">üçì Dessert</option>
        </select>
      </div>
      <div class="form-group">
        <label>Servings</label>
        <input type="number" id="r-servings" placeholder="2" min="1" value="2">
      </div>
      <div class="form-group">
        <label>Prep Time</label>
        <input type="text" id="r-prep" placeholder="e.g. 10 mins">
      </div>
      <div class="form-group">
        <label>Cook Time</label>
        <input type="text" id="r-cook" placeholder="e.g. 20 mins">
      </div>
    </div>

    <!-- Nutrition per serving -->
    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:16px;">
      <div class="card-title" style="margin-bottom:12px;">Nutrition Per Serving <span style="font-size:11px;color:var(--text-muted);font-weight:400;text-transform:none;letter-spacing:0;">(optional but helpful)</span></div>
      <div class="ai-form-grid">
        <div class="form-group" style="margin-bottom:8px;">
          <label style="color:var(--accent)">Calories</label>
          <input type="number" id="r-kcal" placeholder="0" min="0">
        </div>
        <div class="form-group" style="margin-bottom:8px;">
          <label style="color:var(--green)">Protein (g)</label>
          <input type="number" id="r-protein" placeholder="0" min="0" step="0.1">
        </div>
        <div class="form-group" style="margin-bottom:8px;">
          <label style="color:var(--blue)">Carbs (g)</label>
          <input type="number" id="r-carbs" placeholder="0" min="0" step="0.1">
        </div>
        <div class="form-group" style="margin-bottom:8px;">
          <label style="color:var(--accent2)">Fat (g)</label>
          <input type="number" id="r-fat" placeholder="0" min="0" step="0.1">
        </div>
      </div>
    </div>

    <!-- Ingredients -->
    <div style="margin-bottom:16px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
        <label style="margin-bottom:0;">Ingredients <span style="color:var(--red)">*</span></label>
        <button type="button" class="btn btn-outline btn-sm" onclick="addIngredientRow()">Ôºã Add</button>
      </div>
      <div style="display:grid;grid-template-columns:80px 65px 1fr 24px;gap:6px;margin-bottom:6px;">
        <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--text-muted);">Amount</div>
        <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--text-muted);">Unit</div>
        <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--text-muted);">Ingredient</div>
        <div></div>
      </div>
      <div id="ingredients-container"></div>
      <div id="no-ingredients-msg" style="font-size:13px;color:var(--text-muted);padding:8px 0;">Click "+ Add" to add ingredients</div>
    </div>

    <!-- Steps -->
    <div style="margin-bottom:16px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
        <label style="margin-bottom:0;">Instructions <span style="color:var(--red)">*</span></label>
        <button type="button" class="btn btn-outline btn-sm" onclick="addStepRow()">Ôºã Add Step</button>
      </div>
      <div id="steps-container"></div>
      <div id="no-steps-msg" style="font-size:13px;color:var(--text-muted);padding:8px 0;">Click "+ Add Step" to add cooking instructions</div>
    </div>

    <!-- Tags -->
    <div class="form-group">
      <label>Tags <span style="font-size:11px;color:var(--text-muted);font-weight:400;text-transform:none;letter-spacing:0;">(comma separated, optional)</span></label>
      <input type="text" id="r-tags" placeholder="e.g. high-protein, gluten-free, meal-prep, vegan">
    </div>

    <div class="error-msg" id="r-error" style="margin-bottom:12px;">Please enter a recipe name and at least one ingredient.</div>
    <div class="modal-actions">
      <button class="btn btn-primary" style="flex:1;" onclick="confirmAddRecipe()">üìñ Share Recipe</button>
      <button class="btn btn-outline" onclick="closeRecipeModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- RECIPE DETAIL MODAL -->
<div class="modal-overlay" id="recipe-detail-modal">
  <div class="modal recipe-detail-modal">
    <div id="recipe-detail-content"></div>
    <div class="modal-actions" style="margin-top:20px;">
      <button class="btn btn-outline" style="flex:1;" onclick="document.getElementById('recipe-detail-modal').classList.remove('open')">Close</button>
      <button class="btn btn-danger btn-sm" id="recipe-delete-btn" onclick="deleteCurrentRecipe()">üóë Delete</button>
    </div>
  </div>
</div>

<!-- ADD FOOD MODAL -->
<div class="modal-overlay" id="add-food-modal">
  <div class="modal">
    <div class="modal-title" id="modal-food-name">Chicken Breast</div>
    <div class="modal-sub" id="modal-food-brand">Per 100g serving</div>
    <div class="macro-grid">
      <div class="macro-item"><div class="macro-val" id="modal-cals" style="color:var(--accent)">0</div><div class="macro-lbl">Calories</div></div>
      <div class="macro-item"><div class="macro-val" id="modal-protein" style="color:var(--green)">0g</div><div class="macro-lbl">Protein</div></div>
      <div class="macro-item"><div class="macro-val" id="modal-carbs" style="color:var(--blue)">0g</div><div class="macro-lbl">Carbs</div></div>
      <div class="macro-item"><div class="macro-val" id="modal-fat" style="color:var(--accent2)">0g</div><div class="macro-lbl">Fat</div></div>
    </div>
    <div class="form-group">
      <label>Quantity (grams)</label>
      <input type="number" id="modal-qty" value="100" min="1" oninput="updateModalMacros()">
    </div>
    <div class="form-group">
      <label>Meal</label>
      <select id="modal-meal">
        <option value="breakfast">Breakfast</option>
        <option value="lunch">Lunch</option>
        <option value="dinner">Dinner</option>
        <option value="snack">Snack</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" style="flex:1" onclick="confirmAddFood()">Add to Log</button>
      <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- MANUAL FOOD ENTRY MODAL -->
<div class="modal-overlay" id="manual-food-modal">
  <div class="modal" style="max-width:540px;">
    <div class="modal-title">&#9997;&#65039; Log Food Manually</div>
    <div class="modal-sub">Enter any food with your own nutritional values</div>

    <div class="form-group">
      <label>Food Name <span style="color:var(--red)">*</span></label>
      <input type="text" id="mf-name" placeholder="e.g. Mom's Chicken Soup, Protein Bar, etc.">
    </div>
    <div class="form-group">
      <label>Brand / Notes (optional)</label>
      <input type="text" id="mf-brand" placeholder="e.g. Homemade, Quest, Kirkland...">
    </div>

    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:16px;">
      <div style="font-size:12px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(--text-dim);margin-bottom:14px;">Nutrition Per Serving</div>
      <div class="ai-form-grid">
        <div class="form-group" style="margin-bottom:10px;">
          <label style="color:var(--accent)">Calories (kcal) <span style="color:var(--red)">*</span></label>
          <input type="number" id="mf-kcal" placeholder="0" min="0" oninput="previewManualMacros()">
        </div>
        <div class="form-group" style="margin-bottom:10px;">
          <label>Serving Size</label>
          <div style="display:flex;gap:8px;">
            <input type="number" id="mf-serving" placeholder="100" min="1" style="flex:1;" oninput="previewManualMacros()">
            <select id="mf-serving-unit" style="width:80px;">
              <option value="g">g</option>
              <option value="ml">ml</option>
              <option value="oz">oz</option>
              <option value="cup">cup</option>
              <option value="tsp">tsp</option>
              <option value="tbsp">tbsp</option>
              <option value="piece">piece</option>
            </select>
          </div>
        </div>
        <div class="form-group" style="margin-bottom:10px;">
          <label style="color:var(--green)">Protein (g)</label>
          <input type="number" id="mf-protein" placeholder="0" min="0" step="0.1" oninput="previewManualMacros()">
        </div>
        <div class="form-group" style="margin-bottom:10px;">
          <label style="color:var(--blue)">Carbohydrates (g)</label>
          <input type="number" id="mf-carbs" placeholder="0" min="0" step="0.1" oninput="previewManualMacros()">
        </div>
        <div class="form-group" style="margin-bottom:10px;">
          <label style="color:var(--accent2)">Fat (g)</label>
          <input type="number" id="mf-fat" placeholder="0" min="0" step="0.1" oninput="previewManualMacros()">
        </div>
        <div class="form-group" style="margin-bottom:10px;">
          <label>Fiber (g)</label>
          <input type="number" id="mf-fiber" placeholder="0" min="0" step="0.1">
        </div>
        <div class="form-group" style="margin-bottom:10px;">
          <label>Sugar (g)</label>
          <input type="number" id="mf-sugar" placeholder="0" min="0" step="0.1">
        </div>
        <div class="form-group" style="margin-bottom:10px;">
          <label>Sodium (mg)</label>
          <input type="number" id="mf-sodium" placeholder="0" min="0">
        </div>
      </div>
    </div>

    <!-- Live preview -->
    <div id="mf-preview" style="display:none;background:var(--surface3);border-radius:var(--radius);padding:12px 16px;margin-bottom:16px;">
      <div style="font-size:11px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(--text-muted);margin-bottom:8px;">Preview ¬∑ 1 serving</div>
      <div style="display:flex;gap:16px;flex-wrap:wrap;">
        <div style="text-align:center;"><div style="font-family:'Bebas Neue',sans-serif;font-size:26px;color:var(--accent)" id="mf-prev-cals">0</div><div style="font-size:11px;color:var(--text-dim)">KCAL</div></div>
        <div style="text-align:center;"><div style="font-family:'Bebas Neue',sans-serif;font-size:26px;color:var(--green)" id="mf-prev-protein">0g</div><div style="font-size:11px;color:var(--text-dim)">PROTEIN</div></div>
        <div style="text-align:center;"><div style="font-family:'Bebas Neue',sans-serif;font-size:26px;color:var(--blue)" id="mf-prev-carbs">0g</div><div style="font-size:11px;color:var(--text-dim)">CARBS</div></div>
        <div style="text-align:center;"><div style="font-family:'Bebas Neue',sans-serif;font-size:26px;color:var(--accent2)" id="mf-prev-fat">0g</div><div style="font-size:11px;color:var(--text-dim)">FAT</div></div>
      </div>
    </div>

    <div class="form-group">
      <label>Log to Meal</label>
      <select id="mf-meal">
        <option value="breakfast">&#127745; Breakfast</option>
        <option value="lunch">&#9728;&#65039; Lunch</option>
        <option value="dinner">&#127769; Dinner</option>
        <option value="snack">&#127822; Snack</option>
      </select>
    </div>

    <div class="form-group">
      <label>How many servings?</label>
      <input type="number" id="mf-servings" value="1" min="0.25" step="0.25" oninput="previewManualMacros()">
    </div>

    <div class="error-msg" id="mf-error" style="margin-bottom:12px;">Please enter a food name and at least the calories.</div>

    <div class="modal-actions">
      <button class="btn btn-primary" style="flex:1" onclick="confirmManualFood()">&#10003; Add to Log</button>
      <button class="btn btn-outline" onclick="closeManualModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ IMMEDIATE STARTUP: purge any stale error HTML saved as aiPlan ‚îÄ‚îÄ
(function() {
  try {
    var raw = localStorage.getItem('vt_users');
    if (!raw) return;
    var users = JSON.parse(raw);
    var changed = false;
    var bad = ['API Key','api-key','Failed to fetch','Could not','Please enter','key above','NetworkError','fetch error'];
    Object.keys(users).forEach(function(k) {
      var u = users[k];
      if (u && u.aiPlan && typeof u.aiPlan === 'string') {
        var isBad = bad.some(function(p){ return u.aiPlan.indexOf(p) !== -1; })
          || (u.aiPlan.trim().charAt(0) === '<' && u.aiPlan.length < 800);
        if (isBad) { u.aiPlan = ''; changed = true; }
      }
    });
    if (changed) localStorage.setItem('vt_users', JSON.stringify(users));
  } catch(e) {}
})();
</script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INSTALL PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderInstallPage() {
  // Show the Android install prompt card if available
  const card = document.getElementById('install-prompt-card');
  if (card) card.style.display = deferredInstallPrompt ? 'block' : 'none';
  // Restore saved app URL if user entered one before
  const saved = localStorage.getItem('vt_app_url') || '';
  const urlInput = document.getElementById('app-url-input');
  if (urlInput && saved) {
    urlInput.value = saved;
    updateShareMessage();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MOBILE SIDEBAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openSidebar() {
  document.querySelector('.sidebar').classList.add('open');
  document.getElementById('sidebar-overlay').classList.add('open');
}
function closeSidebar() {
  document.querySelector('.sidebar').classList.remove('open');
  document.getElementById('sidebar-overlay').classList.remove('open');
}
// Bottom tab bar handles mobile navigation ‚Äî sidebar auto-hidden on mobile

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentUser = null;
let allUsers = {};
let currentLogDate = getTodayStr();
let selectedFood = null;
let gSheetsConfig = null;
let searchTimeout = null;

function getTodayStr() {
  return new Date().toISOString().split('T')[0];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STORAGE HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadStorage() {
  try { allUsers = JSON.parse(localStorage.getItem('vt_users') || '{}'); } catch(e) { allUsers = {}; }
  gSheetsConfig = JSON.parse(localStorage.getItem('vt_sheets') || 'null');
  // Purge any error HTML that got accidentally saved as aiPlan
  Object.values(allUsers).forEach(u => {
    if (u.aiPlan && (
      u.aiPlan.includes('API Key') || u.aiPlan.includes('api-key') ||
      u.aiPlan.includes('Failed to fetch') || u.aiPlan.includes('Could not') ||
      u.aiPlan.includes('Please enter') || u.aiPlan.includes('key above') ||
      (u.aiPlan.trim().startsWith('<div') && u.aiPlan.length < 600)
    )) { u.aiPlan = ''; }
  });
  
  // Seed admin account (always ensure it exists with correct password & role)
  allUsers['bribush44'] = Object.assign({
    username: 'bribush44', password: 'Lynsbri3844!', name: 'Admin',
    email: 'bribush44@gmail.com', age: 0, gender: 'other',
    height: 0, weight: 0, goal: 'improve_fitness',
    cals_goal: 2000, protein_goal: 120, fat_goal: 60, carbs_goal: 250,
    foodLog: {}, workoutLog: {}, aiPlan: '', isAdmin: true, isSuperAdmin: true
  }, allUsers['bribush44'] || {}, { password: 'Lynsbri3844!', isAdmin: true, isSuperAdmin: true });

  // Seed demo users
  if (!allUsers['sarah']) {
    allUsers['sarah'] = {
      username: 'sarah', password: 'demo123', name: 'Sarah Johnson',
      email: 'sarah@demo.com', age: 28, gender: 'female',
      height: 65, weight: 135, goal: 'lose_weight',
      cals_goal: 1500, protein_goal: 100, fat_goal: 50, carbs_goal: 180,
      foodLog: {}, aiPlan: ''
    };
  }
  if (!allUsers['mike']) {
    allUsers['mike'] = {
      username: 'mike', password: 'demo123', name: 'Mike Chen',
      email: 'mike@demo.com', age: 32, gender: 'male',
      height: 71, weight: 185, goal: 'build_muscle',
      cals_goal: 2800, protein_goal: 180, fat_goal: 80, carbs_goal: 300,
      foodLog: {}, aiPlan: ''
    };
  }
  saveStorage();

  // ‚îÄ‚îÄ Auto-login: restore last signed-in user ‚îÄ‚îÄ
  const saved = localStorage.getItem('vt_current');
  if (saved && allUsers[saved]) {
    currentUser = saved;
    launchApp();
  }
}

function saveStorage() {
  localStorage.setItem('vt_users', JSON.stringify(allUsers));
  if (gSheetsConfig) localStorage.setItem('vt_sheets', JSON.stringify(gSheetsConfig));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchAuthTab(tab) {
  document.querySelectorAll('.auth-tab').forEach((t,i) => t.classList.toggle('active', (tab==='login' ? i===0 : i===1)));
  document.getElementById('login-form').style.display = tab === 'login' ? 'block' : 'none';
  document.getElementById('register-form').style.display = tab === 'register' ? 'block' : 'none';
}

function doLogin() {
  const uname = document.getElementById('login-username').value.trim().toLowerCase();
  const pass = document.getElementById('login-password').value;
  const err = document.getElementById('login-error');
  if (allUsers[uname] && allUsers[uname].password === pass) {
    err.style.display = 'none';
    currentUser = uname;
    localStorage.setItem('vt_current', uname);
    launchApp();
  } else {
    err.style.display = 'block';
  }
}

function doRegister() {
  const uname = document.getElementById('reg-username').value.trim().toLowerCase();
  const pass = document.getElementById('reg-password').value;
  const err = document.getElementById('reg-error');
  // Always hide error first
  err.style.display = 'none';
  err.textContent = '';
  if (!uname || !pass) { err.textContent = 'Username and password are required.'; err.style.display = 'block'; return; }
  if (allUsers[uname]) { err.textContent = 'Username already taken.'; err.style.display = 'block'; return; }
  allUsers[uname] = {
    username: uname,
    password: pass,
    name: document.getElementById('reg-name').value || uname,
    email: document.getElementById('reg-email').value,
    age: parseInt(document.getElementById('reg-age').value) || 25,
    gender: document.getElementById('reg-gender').value,
    height: parseInt(document.getElementById('reg-height').value) || 68,
    weight: parseInt(document.getElementById('reg-weight').value) || 160,
    goal: document.getElementById('reg-goal').value,
    cals_goal: 1800, protein_goal: 120, fat_goal: 60, carbs_goal: 200,
    foodLog: {}, aiPlan: ''
  };
  saveStorage();
  err.style.display = 'none';
  currentUser = uname;
  localStorage.setItem('vt_current', uname);
  launchApp();
}

function doLogout() {
  currentUser = null;
  localStorage.removeItem('vt_current');
  document.getElementById('app').classList.remove('visible');
  document.getElementById('auth-screen').style.display = 'flex';
}

function launchApp() {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app').classList.add('visible');
  refreshSidebarUser();
  refreshUnitLabels();
  seedDemoRecipes();
  refreshSidebarWhatsApp();
  // Show/hide admin nav item
  const adminNav = document.getElementById('nav-admin');
  if (adminNav) adminNav.style.display = isAdmin() ? 'flex' : 'none';
  navigate('dashboard');
  syncBottomTabs('dashboard');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openMoreMenu() {
  document.getElementById('more-menu').classList.add('open');
  document.getElementById('more-menu-overlay').classList.add('open');
}
function closeMoreMenu() {
  document.getElementById('more-menu').classList.remove('open');
  document.getElementById('more-menu-overlay').classList.remove('open');
}

// Pages shown in the main bottom tab bar
const MAIN_TABS = ['dashboard','food-log','workout-log','meal-ideas'];
// Pages that live in the More menu
const MORE_TABS = ['ai-plan','recipes','history','import','sheets','profile','users','admin','install'];

function syncBottomTabs(page) {
  // Reset all main tabs
  MAIN_TABS.forEach(t => {
    const el = document.getElementById('tab-' + t);
    if (el) el.classList.remove('active');
  });
  // Reset all more-menu items
  MORE_TABS.forEach(t => {
    const el = document.getElementById('mtab-' + t);
    if (el) el.classList.remove('active');
  });
  // Highlight the more button if on a more-menu page
  const moreBtn = document.getElementById('tab-more');
  if (moreBtn) moreBtn.classList.toggle('active', MORE_TABS.includes(page));
  // Highlight the correct main tab or more-menu item
  const mainTab = document.getElementById('tab-' + page);
  if (mainTab) mainTab.classList.add('active');
  const moreItem = document.getElementById('mtab-' + page);
  if (moreItem) moreItem.classList.add('active');
  // Show/hide admin in more menu
  const adminItem = document.getElementById('mtab-admin');
  if (adminItem) adminItem.style.display = isAdmin() ? 'flex' : 'none';
}

function navigate(page) {
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  // Highlight the correct nav item by matching its onclick attribute
  document.querySelectorAll('.nav-item').forEach(n => {
    if (n.getAttribute('onclick') && n.getAttribute('onclick').includes("'" + page + "'")) {
      n.classList.add('active');
    }
  });
  const pg = document.getElementById('page-' + page);
  if (pg) pg.classList.add('active');
  if (page === 'dashboard') renderDashboard();
  if (page === 'food-log') renderFoodLog();
  if (page === 'workout-log') renderWorkoutLog();
  if (page === 'history') renderHistory();
  if (page === 'profile') loadProfileForm();
  if (page === 'users') renderUsersGrid();
  if (page === 'ai-plan') { loadAIPage(); refreshUnitLabels(); }
  if (page === 'sheets') loadSheetsPage();
  if (page === 'recipes') renderRecipes();
  if (page === 'workout-history') renderWorkoutHistory();
  if (page === 'sleep-log') { currentSleepDate = todayStr(); renderSleepLog(); }
  if (page === 'weekly-plan') loadWeeklyPlan();
  if (page === 'progress') loadProgressPage();
  if (page === 'meal-ideas') loadMealIdeasPage();
  if (page === 'import') renderImportPage();
  if (page === 'admin') { if (isAdmin()) renderAdminPanel(); else showContactAdmin('access the Admin Panel'); }
  if (page === 'install') renderInstallPage();
  syncBottomTabs(page);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SIDEBAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function refreshSidebarUser() {
  const u = allUsers[currentUser];
  if (!u) return;
  document.getElementById('sidebar-avatar').textContent = u.name.charAt(0).toUpperCase();
  document.getElementById('sidebar-username').textContent = u.name.split(' ')[0];
  // Admin badge
  let badge = document.getElementById('sidebar-admin-badge');
  if (isAdmin()) {
    if (!badge) {
      badge = document.createElement('span');
      badge.id = 'sidebar-admin-badge';
      badge.className = 'admin-badge';
      badge.style.marginLeft = '4px';
      badge.textContent = 'üõ°Ô∏è Admin';
      const userChip = document.querySelector('.user-chip');
      if (userChip) userChip.appendChild(badge);
    }
    badge.style.display = 'inline-flex';
  } else {
    if (badge) badge.style.display = 'none';
  }
  // Show/hide admin nav item
  const adminNav = document.getElementById('nav-admin');
  if (adminNav) adminNav.style.display = isAdmin() ? 'flex' : 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let dashViewDate = getTodayStr();

function changeDashDate(delta) {
  const d = new Date(dashViewDate + 'T12:00:00');
  d.setDate(d.getDate() + delta);
  const today = new Date();
  today.setHours(23,59,59,999);
  if (d > today) return; // can't go past today
  dashViewDate = d.toISOString().split('T')[0];
  renderDashboard();
}

function jumpDashToday() {
  dashViewDate = getTodayStr();
  renderDashboard();
}

function renderDashboard() {
  const u = allUsers[currentUser];
  if (!u) return;
  const isToday = dashViewDate === getTodayStr();
  const viewDate = new Date(dashViewDate + 'T12:00:00');

  // ‚îÄ‚îÄ Header ‚îÄ‚îÄ
  if (isToday) {
    const hour = new Date().getHours();
    const greet = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
    document.getElementById('dash-greeting').textContent = greet + ', ' + u.name.split(' ')[0];
    document.getElementById('dash-date').textContent = new Date().toLocaleDateString('en-US', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
    document.getElementById('dash-nav-date').textContent = 'Today';
    document.getElementById('dash-next-btn').style.opacity = '0.3';
    document.getElementById('dash-next-btn').style.cursor = 'default';
  } else {
    document.getElementById('dash-greeting').textContent = u.name.split(' ')[0] + "'s Summary";
    document.getElementById('dash-date').textContent = viewDate.toLocaleDateString('en-US', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
    document.getElementById('dash-nav-date').textContent = viewDate.toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric'});
    document.getElementById('dash-next-btn').style.opacity = '1';
    document.getElementById('dash-next-btn').style.cursor = 'pointer';
  }
  document.getElementById('dash-nav-day').textContent = viewDate.toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});

  // ‚îÄ‚îÄ Past day banner ‚îÄ‚îÄ
  const banner = document.getElementById('dash-past-banner');
  banner.style.display = isToday ? 'none' : 'flex';

  // ‚îÄ‚îÄ Nutrition stats ‚îÄ‚îÄ
  const totals = getDayTotals(dashViewDate);
  const goals = { cals: u.cals_goal || 1800, protein: u.protein_goal || 120, fat: u.fat_goal || 60, carbs: u.carbs_goal || 200 };

  document.getElementById('d-cals').textContent    = Math.round(totals.cals);
  document.getElementById('d-protein').textContent = Math.round(totals.protein);
  document.getElementById('d-fat').textContent     = Math.round(totals.fat);
  document.getElementById('d-carbs').textContent   = Math.round(totals.carbs);
  document.getElementById('d-cals-goal').textContent    = 'Goal: ' + goals.cals + ' kcal';
  document.getElementById('d-protein-goal').textContent = 'Goal: ' + goals.protein + 'g';
  document.getElementById('d-fat-goal').textContent     = 'Goal: ' + goals.fat + 'g';
  document.getElementById('d-carbs-goal').textContent   = 'Goal: ' + goals.carbs + 'g';

  const pct = (v, g) => Math.min(100, Math.round(v / g * 100)) + '%';
  document.getElementById('d-cals-bar').style.width    = pct(totals.cals, goals.cals);
  document.getElementById('d-protein-bar').style.width = pct(totals.protein, goals.protein);
  document.getElementById('d-fat-bar').style.width     = pct(totals.fat, goals.fat);
  document.getElementById('d-carbs-bar').style.width   = pct(totals.carbs, goals.carbs);

  // ‚îÄ‚îÄ Food summary ‚îÄ‚îÄ
  const log = (u.foodLog || {})[dashViewDate];
  const sumEl = document.getElementById('dash-food-summary');
  if (!log || Object.values(log).every(m => !m.length)) {
    sumEl.innerHTML = '<span style="color:var(--text-muted)">No food logged ' + (isToday ? 'today' : 'on this day') + '.</span>';
  } else {
    const mealIcons = {breakfast:'üåÖ',lunch:'‚òÄÔ∏è',dinner:'üåô',snack:'üçé'};
    const parts = [];
    ['breakfast','lunch','dinner','snack'].forEach(meal => {
      if (log[meal] && log[meal].length) {
        const mealCals = log[meal].reduce((s,item) => s + (item.kcal||0)*((item.qty||100)/100), 0);
        parts.push(`<div style="display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--border);">
          <div style="display:flex;align-items:center;gap:8px;">
            <span>${mealIcons[meal]}</span>
            <span style="font-size:14px;font-weight:500;">${meal.charAt(0).toUpperCase()+meal.slice(1)}</span>
            <span style="font-size:12px;color:var(--text-muted);">${log[meal].length} item${log[meal].length!==1?'s':''}</span>
          </div>
          <span style="font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--accent);">${Math.round(mealCals)} <span style="font-size:12px;font-family:'DM Sans',sans-serif;color:var(--text-dim);">kcal</span></span>
        </div>`);
      }
    });
    const totalCals = Math.round(totals.cals);
    const remaining = goals.cals - totalCals;
    sumEl.innerHTML = parts.join('') +
      `<div style="display:flex;justify-content:space-between;align-items:center;padding-top:10px;margin-top:2px;">
        <span style="font-size:13px;font-weight:600;color:var(--text-dim);">Total Calories</span>
        <span style="font-family:'Bebas Neue',sans-serif;font-size:24px;color:var(--accent);">${totalCals} <span style="font-size:12px;font-family:'DM Sans',sans-serif;color:${remaining>=0?'var(--green)':'var(--red)'};">${remaining>=0?remaining+' remaining':Math.abs(remaining)+' over'}</span></span>
      </div>`;
  }

  // ‚îÄ‚îÄ Workout summary ‚îÄ‚îÄ
  const workouts = ((u.workoutLog || {})[dashViewDate]) || [];
  const wEl = document.getElementById('dash-workout-summary');
  if (!workouts.length) {
    wEl.innerHTML = '<div style="color:var(--text-muted);font-size:14px;">No workouts logged ' + (isToday ? 'today.' : 'on this day.') + '</div>';
  } else {
    const totalDuration = workouts.reduce((s,w) => s + (parseInt(w.duration)||0), 0);
    const totalCalsBurned = workouts.reduce((s,w) => s + (parseInt(w.calories)||0), 0);
    const totalExercises = workouts.reduce((s,w) => s + (w.exercises||[]).length, 0);
    const totalSets = workouts.reduce((s,w) => s + (w.exercises||[]).reduce((es,e) => es + (e.sets||[]).length, 0), 0);
    const totalVol = workouts.reduce((s,w) =>
      s + (w.exercises||[]).reduce((es,e) =>
        es + (e.sets||[]).reduce((ss,set) => ss + (parseFloat(set.weight)||0)*(parseInt(set.reps)||0), 0), 0), 0);

    // Stat pills row
    const pills = [
      totalDuration ? `<div class="dash-workout-pill"><span style="color:var(--green);font-family:'Bebas Neue',sans-serif;font-size:22px;">${totalDuration}</span><span style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;"> min</span></div>` : '',
      totalCalsBurned ? `<div class="dash-workout-pill"><span style="color:var(--red);font-family:'Bebas Neue',sans-serif;font-size:22px;">${totalCalsBurned}</span><span style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;"> burned</span></div>` : '',
      totalExercises ? `<div class="dash-workout-pill"><span style="color:var(--blue);font-family:'Bebas Neue',sans-serif;font-size:22px;">${totalExercises}</span><span style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;"> exercise${totalExercises!==1?'s':''}</span></div>` : '',
      totalSets ? `<div class="dash-workout-pill"><span style="color:var(--accent2);font-family:'Bebas Neue',sans-serif;font-size:22px;">${totalSets}</span><span style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;"> sets</span></div>` : '',
      totalVol > 0 ? `<div class="dash-workout-pill"><span style="color:var(--accent);font-family:'Bebas Neue',sans-serif;font-size:22px;">${Math.round(totalVol).toLocaleString()}</span><span style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;"> lbs vol</span></div>` : '',
    ].filter(Boolean).join('');

    // Per-workout breakdown
    const sessionRows = workouts.map((w, wi) => {
      const exerciseList = (w.exercises || []).map(ex => {
        const setsSummary = (ex.sets || []).filter(s => s.weight || s.reps).map(s =>
          [s.weight ? s.weight+'lbs' : '', s.reps ? s.reps+' reps' : ''].filter(Boolean).join(' √ó ')
        ).join(' ¬∑ ');
        return `<div style="padding:6px 0 6px 12px;border-left:2px solid var(--border);margin-bottom:4px;">
          <div style="font-size:13px;font-weight:600;">üí™ ${escHtml(ex.name)}</div>
          ${setsSummary ? `<div style="font-size:12px;color:var(--text-muted);margin-top:2px;font-family:'DM Mono',monospace;">${escHtml(setsSummary)}</div>` : ''}
        </div>`;
      }).join('');

      return `<div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;margin-bottom:10px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:6px;">
          <div>
            <span style="font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:0.5px;">${escHtml(w.activity)}${w.name ? ' ‚Äî ' + escHtml(w.name) : ''}</span>
            <div style="margin-top:2px;display:flex;gap:10px;flex-wrap:wrap;">
              ${w.duration ? `<span style="font-size:12px;color:var(--text-muted);">‚è± ${w.duration} min</span>` : ''}
              ${w.calories ? `<span style="font-size:12px;color:var(--text-muted);">üî• ${w.calories} kcal burned</span>` : ''}
              <span style="font-size:11px;padding:2px 8px;border-radius:10px;" class="intensity-badge intensity-${w.intensity||'Moderate'}">${w.intensity||'Moderate'}</span>
            </div>
          </div>
        </div>
        ${exerciseList}
        ${w.notes ? `<div style="margin-top:8px;font-size:12px;color:var(--text-dim);font-style:italic;border-top:1px solid var(--border);padding-top:8px;">üìù ${escHtml(w.notes)}</div>` : ''}
      </div>`;
    }).join('');

    wEl.innerHTML = `
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px;">${pills}</div>
      ${sessionRows}
    `;
  }

  // ‚îÄ‚îÄ Sleep stat (last night = yesterday's sleep entry or today's) ‚îÄ‚îÄ
  const sleepLog = u.sleepLog || {};
  // Try today first, then yesterday (since you log sleep in the morning for last night)
  const yesterday = new Date(new Date(dashViewDate + 'T12:00:00').getTime() - 86400000).toISOString().slice(0,10);
  const sleepEntry = sleepLog[dashViewDate] || sleepLog[yesterday] || null;

  const sleepHrsEl    = document.getElementById('d-sleep-hrs');
  const sleepQualEl   = document.getElementById('d-sleep-quality');
  const sleepBarEl    = document.getElementById('d-sleep-bar');

  if (sleepEntry) {
    const hrs = calcSleepHours(sleepEntry.bedtime, sleepEntry.waketime);
    if (sleepHrsEl) sleepHrsEl.textContent = hrs.toFixed(1);
    // Progress bar: 8hrs = 100%
    if (sleepBarEl) sleepBarEl.style.width = Math.min(100, (hrs / 8) * 100) + '%';
    const qualLabels = {'5':'‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Excellent','4':'‚≠ê‚≠ê‚≠ê‚≠ê Good','3':'‚≠ê‚≠ê‚≠ê Average','2':'‚≠ê‚≠ê Poor','1':'‚≠ê Very Poor'};
    const feelEmoji  = {'Refreshed':'üòä','Okay':'üòê','Groggy':'üò¥','Tired':'üò©','Exhausted':'üíÄ'};
    let qualText = sleepEntry.quality ? qualLabels[sleepEntry.quality] : '';
    if (sleepEntry.feeling) qualText += (qualText ? '  ' : '') + (feelEmoji[sleepEntry.feeling] || '') + ' ' + sleepEntry.feeling;
    if (sleepQualEl) sleepQualEl.textContent = qualText || 'Logged';
  } else {
    if (sleepHrsEl)  sleepHrsEl.textContent  = '‚Äî';
    if (sleepQualEl) sleepQualEl.textContent = 'Not logged yet';
    if (sleepBarEl)  sleepBarEl.style.width  = '0%';
  }

  // ‚îÄ‚îÄ Calories burned stat ‚îÄ‚îÄ
  const burnedEl      = document.getElementById('d-cals-burned');
  const burnedDetailEl = document.getElementById('d-burned-detail');
  const burnedBarEl   = document.getElementById('d-burned-bar');
  const netCalsEl     = document.getElementById('d-net-cals');
  const totalBurned   = workouts.reduce((s,w) => s + (parseInt(w.calories)||0), 0);
  const totalDur      = workouts.reduce((s,w) => s + (parseInt(w.duration)||0), 0);

  if (burnedEl) burnedEl.textContent = totalBurned;
  // Progress bar: 600 kcal = 100%
  if (burnedBarEl) burnedBarEl.style.width = Math.min(100, (totalBurned / 600) * 100) + '%';
  if (burnedDetailEl) {
    if (!workouts.length) {
      burnedDetailEl.textContent = 'No workouts logged';
    } else {
      burnedDetailEl.textContent = workouts.length + ' workout' + (workouts.length !== 1 ? 's' : '') + (totalDur ? '  ¬∑  ' + totalDur + ' min' : '');
    }
  }
  if (netCalsEl) {
    const netCals = Math.round(totals.cals) - totalBurned;
    netCalsEl.textContent = totalBurned > 0
      ? 'Net: ' + netCals + ' kcal (' + Math.round(totals.cals) + ' eaten ‚àí ' + totalBurned + ' burned)'
      : 'Log a workout to see net calories';
    netCalsEl.style.color = netCals > goals.cals ? 'var(--accent)' : 'var(--text-muted)';
  }

  // ‚îÄ‚îÄ Daily Weigh-In card ‚îÄ‚îÄ
  const today = getTodayStr();
  const wLog  = (u.weightLog || []);
  const todayEntry     = wLog.find(e => e.date === today);
  const yesterdayDate  = new Date(new Date(dashViewDate + 'T12:00:00').getTime() - 86400000).toISOString().slice(0,10);
  const yesterdayEntry = wLog.find(e => e.date === yesterdayDate);

  const displayEl   = document.getElementById('d-weight-display');
  const subtitleEl  = document.getElementById('d-weight-subtitle');
  const badgeEl     = document.getElementById('d-weight-change-badge');
  const day7El      = document.getElementById('d-weight-7day');
  const sparkEl     = document.getElementById('d-weight-sparkline');
  const weightInput = document.getElementById('d-weigh-input');

  if (displayEl) {
    if (todayEntry) {
      const u2 = allUsers[currentUser];
      displayEl.textContent = (u2 && u2.units === 'metric') ? lbsToKg(todayEntry.weight) : todayEntry.weight;
    } else { displayEl.textContent = '‚Äî'; }
  }
  // Dashboard unit label
  const dwUnitLbl = document.querySelector('#d-weight-display ~ div');
  if (dwUnitLbl && dwUnitLbl.textContent.includes('today')) {
    dwUnitLbl.textContent = weightUnit() + ' today';
  }

  // Pre-fill input if already logged today
  if (weightInput) weightInput.value = todayEntry ? todayEntry.weight : '';

  // Show today's saved progress photo if one exists
  const todayPhoto = (u.progressPhotos || []).find(p => p.date === today);
  const dwPreview  = document.getElementById('d-weigh-photo-preview');
  const dwThumb    = document.getElementById('d-weigh-photo-thumb');
  if (todayPhoto && dwPreview && dwThumb) {
    dwThumb.src = 'data:image/jpeg;base64,' + todayPhoto.b64;
    dwPreview.style.display = 'block';
  } else if (dwPreview) {
    dwPreview.style.display = 'none';
  }

  if (subtitleEl) {
    subtitleEl.textContent = todayEntry
      ? 'Logged today ¬∑ ' + new Date().toLocaleDateString('en-US', { weekday:'long', month:'short', day:'numeric' })
      : 'Not logged yet today ‚Äî tap to record';
  }

  // Change badge vs yesterday
  if (badgeEl) {
    if (todayEntry && yesterdayEntry) {
      const delta = Math.round((todayEntry.weight - yesterdayEntry.weight) * 10) / 10;
      badgeEl.style.display = 'inline-block';
      badgeEl.textContent   = (delta > 0 ? '+' : '') + delta + ' lbs vs yesterday';
      badgeEl.style.background = delta < 0 ? 'rgba(74,222,128,0.15)'  : delta > 0 ? 'rgba(248,113,113,0.15)' : 'rgba(167,139,250,0.15)';
      badgeEl.style.color       = delta < 0 ? 'var(--green)'           : delta > 0 ? 'var(--red)'             : '#a78bfa';
      badgeEl.style.border      = '1px solid ' + (delta < 0 ? 'rgba(74,222,128,0.3)' : delta > 0 ? 'rgba(248,113,113,0.3)' : 'rgba(167,139,250,0.3)');
    } else { badgeEl.style.display = 'none'; }
  }

  // 7-day trend
  if (day7El) {
    const last7 = wLog.filter(e => e.date >= new Date(Date.now() - 7*86400000).toISOString().slice(0,10));
    if (last7.length >= 2) {
      const trend = Math.round((last7[last7.length-1].weight - last7[0].weight) * 10) / 10;
      day7El.textContent = '7-day trend: ' + (trend > 0 ? '+' : '') + trend + ' lbs';
      day7El.style.color = trend < 0 ? 'var(--green)' : trend > 0 ? 'var(--red)' : 'var(--text-muted)';
    } else { day7El.textContent = ''; }
  }

  // Inline sparkline (last 14 days)
  if (sparkEl) {
    const last14 = wLog.slice(-14);
    if (last14.length >= 2) {
      const wts  = last14.map(e => e.weight);
      const minW = Math.min(...wts) - 0.5, maxW = Math.max(...wts) + 0.5;
      const range = maxW - minW || 1;
      const W = 400, H = 44, pL = 2, pR = 2, pT = 4, pB = 4;
      const pts = last14.map((e, i) => [pL + (i/(last14.length-1))*(W-pL-pR), pT + (1-(e.weight-minW)/range)*(H-pT-pB)]);
      let path = 'M' + pts[0];
      for (let i = 1; i < pts.length; i++) {
        const cpx = (pts[i-1][0]+pts[i][0])/2;
        path += ' C'+cpx+','+pts[i-1][1]+' '+cpx+','+pts[i][1]+' '+pts[i];
      }
      const area = path + ' L'+pts[pts.length-1][0]+','+H+' L'+pL+','+H+' Z';
      const dots = pts.map((p,i) => '<circle cx="'+p[0]+'" cy="'+p[1]+'" r="2.5" fill="#a78bfa"><title>'+last14[i].date+': '+last14[i].weight+' lbs</title></circle>').join('');
      sparkEl.innerHTML = '<svg viewBox="0 0 '+W+' '+H+'" style="width:100%;height:36px;display:block;" xmlns="http://www.w3.org/2000/svg">'
        + '<defs><linearGradient id="wdGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#a78bfa" stop-opacity="0.35"/><stop offset="100%" stop-color="#a78bfa" stop-opacity="0.02"/></linearGradient></defs>'
        + '<path d="'+area+'" fill="url(#wdGrad)"/>'
        + '<path d="'+path+'" fill="none" stroke="#a78bfa" stroke-width="2" stroke-linecap="round"/>'
        + dots + '</svg>';
    } else { sparkEl.innerHTML = ''; }
  }

  // ‚îÄ‚îÄ Weekly Plan preview ‚îÄ‚îÄ
  const wpNoEl      = document.getElementById('d-wp-no-plan');
  const wpPreviewEl = document.getElementById('d-wp-preview');
  const wpDayEl     = document.getElementById('d-wp-day-name');
  const wpMealsEl   = document.getElementById('d-wp-meals');
  const wpWorkoutEl = document.getElementById('d-wp-workout');

  if (u.aiPlan) {
    if (wpNoEl) wpNoEl.style.display = 'none';
    if (wpPreviewEl) wpPreviewEl.style.display = 'block';

    // Use cached _wpDays or parse now
    if (!_wpDays.length) _wpDays = parseWeekFromPlan(u.aiPlan);

    // Find today's day in the plan
    const todayName = new Date().toLocaleDateString('en-US', { weekday:'long' });
    const todayPlan = _wpDays.find(d => d.day === todayName) || _wpDays[0];

    if (wpDayEl) wpDayEl.textContent = todayName + ' ¬∑ ' + (todayPlan?.date?.toLocaleDateString('en-US',{month:'short',day:'numeric'}) || '');

    if (wpMealsEl && todayPlan) {
      wpMealsEl.innerHTML = todayPlan.meals.length
        ? todayPlan.meals.slice(0,3).map(m =>
            '<div><strong style="color:var(--text-dim);text-transform:capitalize;">' + m.type + ':</strong> ' + escHtml(m.name.slice(0,35)) + (m.name.length > 35 ? '‚Ä¶' : '') + '</div>'
          ).join('') + (todayPlan.meals.length > 3 ? '<div style="color:var(--text-muted);">+' + (todayPlan.meals.length-3) + ' more‚Ä¶</div>' : '')
        : '<div style="color:var(--text-muted);">See full plan</div>';
    }

    if (wpWorkoutEl && todayPlan) {
      const w = todayPlan.workout;
      wpWorkoutEl.innerHTML = (!w || w.type === 'rest')
        ? '<div>üò¥ Rest Day</div>'
        : '<div><strong style="color:var(--green);">' + escHtml(w.type) + '</strong>' + (w.focus ? '<br><span style="color:var(--text-muted);">' + escHtml(w.focus.slice(0,40)) + '</span>' : '') + '</div>'
          + (w.exercises.length ? '<div style="color:var(--text-muted);margin-top:4px;">' + w.exercises.slice(0,3).map(e => '‚Ä¢ ' + e.slice(0,30)).join('<br>') + '</div>' : '');
    }
  } else {
    if (wpNoEl) wpNoEl.style.display = 'block';
    if (wpPreviewEl) wpPreviewEl.style.display = 'none';
    if (wpDayEl) wpDayEl.textContent = new Date().toLocaleDateString('en-US', { weekday:'long' });
  }
}

function getDayTotals(dateStr) {
  const u = allUsers[currentUser];
  const log = (u.foodLog || {})[dateStr] || {};
  let cals=0, protein=0, fat=0, carbs=0, fiber=0, sugar=0, sodium=0;
  ['breakfast','lunch','dinner','snack'].forEach(meal => {
    (log[meal] || []).forEach(item => {
      const factor = (item.qty || 100) / 100;
      cals += (item.kcal || 0) * factor;
      protein += (item.protein || 0) * factor;
      fat += (item.fat || 0) * factor;
      carbs += (item.carbs || 0) * factor;
      fiber += (item.fiber || 0) * factor;
      sugar += (item.sugar || 0) * factor;
      sodium += (item.sodium || 0) * factor;
    });
  });
  return { cals, protein, fat, carbs, fiber, sugar, sodium };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FOOD LOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderFoodLog() {
  const u = allUsers[currentUser];
  const log = (u.foodLog || {})[currentLogDate] || {};
  
  document.getElementById('log-date-label').textContent = currentLogDate === getTodayStr() ? 
    'Today ‚Äî ' + new Date().toLocaleDateString('en-US',{month:'short',day:'numeric'}) :
    new Date(currentLogDate + 'T12:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'});
  
  ['breakfast','lunch','dinner','snack'].forEach(meal => {
    const items = log[meal] || [];
    const container = document.getElementById('meal-' + meal);
    const calEl = document.getElementById('meal-cal-' + meal);
    
    if (!items.length) {
      container.outerHTML = `<div id="meal-${meal}" class="food-empty">Nothing logged yet ‚Äî search above to add food</div>`;
      document.getElementById('meal-' + meal);
    } else {
      let mealCals = 0;
      const html = items.map((item, idx) => {
        const factor = (item.qty || 100) / 100;
        const cals = Math.round((item.kcal || 0) * factor);
        const prot = Math.round((item.protein || 0) * factor * 10) / 10;
        const carb = Math.round((item.carbs || 0) * factor * 10) / 10;
        const fat = Math.round((item.fat || 0) * factor * 10) / 10;
        mealCals += cals;
        const manualBadge = item._manual ? ' <span style="font-size:10px;background:rgba(250,204,21,0.15);color:var(--accent);padding:2px 6px;border-radius:8px;font-weight:600;letter-spacing:0.3px;">&#9997;&#65039; MANUAL</span>' : '';
        const qtyDisplay = item._manual && item.unit && item.unit !== 'g'
          ? (Math.round(item.qty) + item.unit)
          : (Math.round(item.qty || 100) + 'g');
        return `<div class="food-item">
          <div style="flex:1;min-width:0;">
            <div class="food-item-name">${item.name}${manualBadge}</div>
            <div class="food-item-macros">${qtyDisplay} &middot; P: ${prot}g &middot; C: ${carb}g &middot; F: ${fat}g</div>
          </div>
          <div style="display:flex;align-items:center;gap:12px;flex-shrink:0;">
            <div class="food-item-cals">${cals}</div>
            <button class="btn btn-danger btn-sm" onclick="removeFood('${meal}', ${idx})">&#10005;</button>
          </div>
        </div>`;
      }).join('');
      document.getElementById('meal-' + meal).outerHTML = `<div id="meal-${meal}">${html}</div>`;
      calEl.textContent = mealCals + ' kcal';
    }
  });
}

function changeLogDate(delta) {
  const d = new Date(currentLogDate + 'T12:00:00');
  d.setDate(d.getDate() + delta);
  const today = new Date();
  if (d > today) return;
  currentLogDate = d.toISOString().split('T')[0];
  renderFoodLog();
}

function removeFood(meal, idx) {
  const u = allUsers[currentUser];
  if (!u.foodLog) u.foodLog = {};
  if (!u.foodLog[currentLogDate]) u.foodLog[currentLogDate] = {};
  if (!u.foodLog[currentLogDate][meal]) return;
  u.foodLog[currentLogDate][meal].splice(idx, 1);
  saveStorage();
  renderFoodLog();
}

// ‚îÄ‚îÄ BUILT-IN FOOD DATABASE (100+ common foods, always works offline) ‚îÄ‚îÄ
const FOOD_DB = [
  // ‚îÄ‚îÄ PROTEINS ‚îÄ‚îÄ
  {name:'Chicken Breast (cooked)',category:'Protein',kcal:165,protein:31,carbs:0,fat:3.6,fiber:0,sugar:0,sodium:74},
  {name:'Chicken Thigh (cooked)',category:'Protein',kcal:209,protein:26,carbs:0,fat:11,fiber:0,sugar:0,sodium:88},
  {name:'Chicken Wings',category:'Protein',kcal:290,protein:27,carbs:0,fat:19,fiber:0,sugar:0,sodium:96},
  {name:'Turkey Breast (cooked)',category:'Protein',kcal:135,protein:30,carbs:0,fat:1,fiber:0,sugar:0,sodium:77},
  {name:'Ground Turkey (93% lean)',category:'Protein',kcal:170,protein:21,carbs:0,fat:9,fiber:0,sugar:0,sodium:78},
  {name:'Ground Beef (80% lean)',category:'Protein',kcal:254,protein:17,carbs:0,fat:20,fiber:0,sugar:0,sodium:75},
  {name:'Ground Beef (93% lean)',category:'Protein',kcal:185,protein:21,carbs:0,fat:11,fiber:0,sugar:0,sodium:80},
  {name:'Steak (sirloin)',category:'Protein',kcal:207,protein:26,carbs:0,fat:11,fiber:0,sugar:0,sodium:68},
  {name:'Steak (ribeye)',category:'Protein',kcal:291,protein:24,carbs:0,fat:21,fiber:0,sugar:0,sodium:68},
  {name:'Salmon (Atlantic)',category:'Protein',kcal:208,protein:20,carbs:0,fat:13,fiber:0,sugar:0,sodium:59},
  {name:'Tuna (canned in water)',category:'Protein',kcal:116,protein:26,carbs:0,fat:1,fiber:0,sugar:0,sodium:333},
  {name:'Tuna (fresh)',category:'Protein',kcal:144,protein:24,carbs:0,fat:5,fiber:0,sugar:0,sodium:50},
  {name:'Tilapia',category:'Protein',kcal:96,protein:20,carbs:0,fat:1.7,fiber:0,sugar:0,sodium:57},
  {name:'Cod',category:'Protein',kcal:82,protein:18,carbs:0,fat:0.7,fiber:0,sugar:0,sodium:61},
  {name:'Shrimp',category:'Protein',kcal:99,protein:24,carbs:0,fat:0.3,fiber:0,sugar:0,sodium:111},
  {name:'Pork Tenderloin',category:'Protein',kcal:143,protein:21,carbs:0,fat:6,fiber:0,sugar:0,sodium:48},
  {name:'Pork Chop',category:'Protein',kcal:231,protein:25,carbs:0,fat:14,fiber:0,sugar:0,sodium:53},
  {name:'Bacon',category:'Protein',kcal:541,protein:37,carbs:1.4,fat:42,fiber:0,sugar:0,sodium:1717},
  {name:'Ham (deli)',category:'Protein',kcal:107,protein:15,carbs:3.7,fat:3.4,fiber:0,sugar:2.1,sodium:1248},
  {name:'Eggs (whole)',category:'Protein',kcal:155,protein:13,carbs:1.1,fat:11,fiber:0,sugar:1.1,sodium:124},
  {name:'Egg Whites',category:'Protein',kcal:52,protein:11,carbs:0.7,fat:0.2,fiber:0,sugar:0.7,sodium:166},
  {name:'Hard Boiled Egg',category:'Protein',kcal:155,protein:13,carbs:1.1,fat:11,fiber:0,sugar:1.1,sodium:124},
  {name:'Tofu (firm)',category:'Protein',kcal:76,protein:8,carbs:1.9,fat:4.3,fiber:0.3,sugar:0.7,sodium:7},
  {name:'Tempeh',category:'Protein',kcal:193,protein:19,carbs:9.4,fat:11,fiber:0,sugar:0,sodium:9},
  {name:'Edamame',category:'Protein',kcal:122,protein:11,carbs:9.9,fat:5.2,fiber:5.2,sugar:2.2,sodium:6},
  {name:'Black Beans',category:'Protein',kcal:132,protein:8.9,carbs:24,fat:0.5,fiber:8.7,sugar:0.3,sodium:1},
  {name:'Chickpeas',category:'Protein',kcal:164,protein:8.9,carbs:27,fat:2.6,fiber:7.6,sugar:4.8,sodium:7},
  {name:'Lentils',category:'Protein',kcal:116,protein:9,carbs:20,fat:0.4,fiber:7.9,sugar:1.8,sodium:2},
  {name:'Kidney Beans',category:'Protein',kcal:127,protein:8.7,carbs:23,fat:0.5,fiber:7.4,sugar:0.3,sodium:2},
  {name:'Cottage Cheese (low fat)',category:'Protein',kcal:72,protein:12,carbs:2.7,fat:1,fiber:0,sugar:2.7,sodium:406},
  {name:'Greek Yogurt (plain, 0%)',category:'Protein',kcal:59,protein:10,carbs:3.6,fat:0.4,fiber:0,sugar:3.2,sodium:36},
  {name:'Greek Yogurt (plain, 2%)',category:'Protein',kcal:73,protein:10,carbs:4.0,fat:2.0,fiber:0,sugar:3.9,sodium:50},
  {name:'Whey Protein Powder',category:'Protein',kcal:352,protein:75,carbs:8,fat:3,fiber:0,sugar:5,sodium:200},
  {name:'Protein Bar (Quest)',category:'Protein',kcal:190,protein:20,carbs:22,fat:7,fiber:13,sugar:1,sodium:230},

  // ‚îÄ‚îÄ GRAINS & CARBS ‚îÄ‚îÄ
  {name:'White Rice (cooked)',category:'Grains',kcal:130,protein:2.7,carbs:28,fat:0.3,fiber:0.4,sugar:0,sodium:1},
  {name:'Brown Rice (cooked)',category:'Grains',kcal:123,protein:2.7,carbs:26,fat:1,fiber:1.8,sugar:0,sodium:5},
  {name:'Jasmine Rice (cooked)',category:'Grains',kcal:130,protein:2.7,carbs:29,fat:0.3,fiber:0.4,sugar:0,sodium:1},
  {name:'Quinoa (cooked)',category:'Grains',kcal:120,protein:4.4,carbs:21,fat:1.9,fiber:2.8,sugar:0.9,sodium:7},
  {name:'Oats (rolled, dry)',category:'Grains',kcal:389,protein:17,carbs:66,fat:7,fiber:10,sugar:1.1,sodium:6},
  {name:'Oatmeal (cooked)',category:'Grains',kcal:68,protein:2.4,carbs:12,fat:1.4,fiber:1.7,sugar:0,sodium:49},
  {name:'White Bread',category:'Grains',kcal:265,protein:9,carbs:49,fat:3.2,fiber:2.7,sugar:5,sodium:491},
  {name:'Whole Wheat Bread',category:'Grains',kcal:247,protein:13,carbs:41,fat:4.2,fiber:6,sugar:5.7,sodium:455},
  {name:'Sourdough Bread',category:'Grains',kcal:274,protein:10,carbs:52,fat:2,fiber:2,sugar:3,sodium:592},
  {name:'Bagel (plain)',category:'Grains',kcal:245,protein:10,carbs:48,fat:1.5,fiber:2,sugar:5,sodium:449},
  {name:'English Muffin',category:'Grains',kcal:227,protein:9,carbs:44,fat:2,fiber:2,sugar:5,sodium:375},
  {name:'Tortilla (flour, 10")',category:'Grains',kcal:218,protein:6,carbs:37,fat:5,fiber:2.3,sugar:2,sodium:477},
  {name:'Tortilla (corn)',category:'Grains',kcal:218,protein:6,carbs:45,fat:3,fiber:4,sugar:0.8,sodium:251},
  {name:'Pasta (cooked)',category:'Grains',kcal:131,protein:5,carbs:25,fat:1.1,fiber:1.8,sugar:0.6,sodium:1},
  {name:'Spaghetti (cooked)',category:'Grains',kcal:158,protein:5.8,carbs:31,fat:0.9,fiber:1.8,sugar:0.6,sodium:1},
  {name:'Whole Wheat Pasta (cooked)',category:'Grains',kcal:124,protein:5.3,carbs:26,fat:0.5,fiber:3.9,sugar:0.4,sodium:4},
  {name:'Sweet Potato (baked)',category:'Grains',kcal:86,protein:1.6,carbs:20,fat:0.1,fiber:3,sugar:4.2,sodium:55},
  {name:'White Potato (baked)',category:'Grains',kcal:93,protein:2.5,carbs:21,fat:0.1,fiber:2.2,sugar:1,sodium:10},
  {name:'Potato (boiled)',category:'Grains',kcal:77,protein:1.9,carbs:17,fat:0.1,fiber:1.8,sugar:0.8,sodium:4},
  {name:'French Fries',category:'Grains',kcal:312,protein:3.4,carbs:41,fat:15,fiber:3.8,sugar:0.3,sodium:210},
  {name:'Corn Tortilla Chips',category:'Grains',kcal:489,protein:6.5,carbs:65,fat:23,fiber:5,sugar:0.7,sodium:469},
  {name:'Popcorn (air-popped)',category:'Grains',kcal:387,protein:13,carbs:78,fat:5,fiber:15,sugar:0.9,sodium:8},
  {name:'Rice Cakes',category:'Grains',kcal:387,protein:8,carbs:82,fat:3,fiber:2,sugar:0.4,sodium:10},
  {name:'Granola',category:'Grains',kcal:471,protein:10,carbs:64,fat:20,fiber:5.2,sugar:24,sodium:15},
  {name:'Cereal (corn flakes)',category:'Grains',kcal:357,protein:8,carbs:79,fat:0.4,fiber:2.2,sugar:8,sodium:830},

  // ‚îÄ‚îÄ VEGETABLES ‚îÄ‚îÄ
  {name:'Broccoli',category:'Vegetables',kcal:34,protein:2.8,carbs:7,fat:0.4,fiber:2.6,sugar:1.7,sodium:33},
  {name:'Spinach',category:'Vegetables',kcal:23,protein:2.9,carbs:3.6,fat:0.4,fiber:2.2,sugar:0.4,sodium:79},
  {name:'Kale',category:'Vegetables',kcal:49,protein:4.3,carbs:9,fat:0.9,fiber:3.6,sugar:2.3,sodium:38},
  {name:'Romaine Lettuce',category:'Vegetables',kcal:17,protein:1.2,carbs:3.3,fat:0.3,fiber:2.1,sugar:1.2,sodium:8},
  {name:'Mixed Greens',category:'Vegetables',kcal:20,protein:2,carbs:3.3,fat:0.3,fiber:1.8,sugar:0.5,sodium:26},
  {name:'Bell Pepper (red)',category:'Vegetables',kcal:31,protein:1,carbs:6,fat:0.3,fiber:2.1,sugar:4.2,sodium:4},
  {name:'Bell Pepper (green)',category:'Vegetables',kcal:20,protein:0.9,carbs:4.6,fat:0.2,fiber:1.7,sugar:2.4,sodium:3},
  {name:'Cucumber',category:'Vegetables',kcal:15,protein:0.7,carbs:3.6,fat:0.1,fiber:0.5,sugar:1.7,sodium:2},
  {name:'Tomato',category:'Vegetables',kcal:18,protein:0.9,carbs:3.9,fat:0.2,fiber:1.2,sugar:2.6,sodium:5},
  {name:'Cherry Tomatoes',category:'Vegetables',kcal:18,protein:0.9,carbs:3.9,fat:0.2,fiber:1.2,sugar:2.6,sodium:5},
  {name:'Carrot',category:'Vegetables',kcal:41,protein:0.9,carbs:10,fat:0.2,fiber:2.8,sugar:4.7,sodium:69},
  {name:'Celery',category:'Vegetables',kcal:16,protein:0.7,carbs:3,fat:0.2,fiber:1.6,sugar:1.3,sodium:80},
  {name:'Onion',category:'Vegetables',kcal:40,protein:1.1,carbs:9.3,fat:0.1,fiber:1.7,sugar:4.2,sodium:4},
  {name:'Garlic',category:'Vegetables',kcal:149,protein:6.4,carbs:33,fat:0.5,fiber:2.1,sugar:1,sodium:17},
  {name:'Cauliflower',category:'Vegetables',kcal:25,protein:1.9,carbs:5,fat:0.3,fiber:2,sugar:1.9,sodium:30},
  {name:'Brussels Sprouts',category:'Vegetables',kcal:43,protein:3.4,carbs:8.9,fat:0.3,fiber:3.8,sugar:2.2,sodium:25},
  {name:'Asparagus',category:'Vegetables',kcal:20,protein:2.2,carbs:3.9,fat:0.1,fiber:2.1,sugar:1.9,sodium:2},
  {name:'Zucchini',category:'Vegetables',kcal:17,protein:1.2,carbs:3.1,fat:0.3,fiber:1,sugar:2.5,sodium:8},
  {name:'Green Beans',category:'Vegetables',kcal:31,protein:1.8,carbs:7,fat:0.2,fiber:2.7,sugar:3.3,sodium:6},
  {name:'Mushrooms',category:'Vegetables',kcal:22,protein:3.1,carbs:3.3,fat:0.3,fiber:1,sugar:2,sodium:5},
  {name:'Corn (cooked)',category:'Vegetables',kcal:86,protein:3.2,carbs:19,fat:1.2,fiber:2,sugar:3.2,sodium:15},
  {name:'Peas',category:'Vegetables',kcal:81,protein:5.4,carbs:14,fat:0.4,fiber:5.1,sugar:5.6,sodium:5},
  {name:'Beets',category:'Vegetables',kcal:43,protein:1.6,carbs:10,fat:0.2,fiber:2.8,sugar:6.8,sodium:78},
  {name:'Arugula',category:'Vegetables',kcal:25,protein:2.6,carbs:3.7,fat:0.7,fiber:1.6,sugar:2.1,sodium:27},
  {name:'Cabbage',category:'Vegetables',kcal:25,protein:1.3,carbs:6,fat:0.1,fiber:2.5,sugar:3.2,sodium:18},
  {name:'Eggplant',category:'Vegetables',kcal:25,protein:1,carbs:6,fat:0.2,fiber:3,sugar:3.5,sodium:2},

  // ‚îÄ‚îÄ FRUITS ‚îÄ‚îÄ
  {name:'Apple',category:'Fruits',kcal:52,protein:0.3,carbs:14,fat:0.2,fiber:2.4,sugar:10,sodium:1},
  {name:'Banana',category:'Fruits',kcal:89,protein:1.1,carbs:23,fat:0.3,fiber:2.6,sugar:12,sodium:1},
  {name:'Orange',category:'Fruits',kcal:47,protein:0.9,carbs:12,fat:0.1,fiber:2.4,sugar:9.4,sodium:0},
  {name:'Strawberries',category:'Fruits',kcal:32,protein:0.7,carbs:7.7,fat:0.3,fiber:2,sugar:4.9,sodium:1},
  {name:'Blueberries',category:'Fruits',kcal:57,protein:0.7,carbs:14,fat:0.3,fiber:2.4,sugar:10,sodium:1},
  {name:'Raspberries',category:'Fruits',kcal:52,protein:1.2,carbs:12,fat:0.7,fiber:6.5,sugar:4.4,sodium:1},
  {name:'Mango',category:'Fruits',kcal:60,protein:0.8,carbs:15,fat:0.4,fiber:1.6,sugar:13.7,sodium:1},
  {name:'Pineapple',category:'Fruits',kcal:50,protein:0.5,carbs:13,fat:0.1,fiber:1.4,sugar:10,sodium:1},
  {name:'Grapes',category:'Fruits',kcal:69,protein:0.7,carbs:18,fat:0.2,fiber:0.9,sugar:15,sodium:2},
  {name:'Watermelon',category:'Fruits',kcal:30,protein:0.6,carbs:7.6,fat:0.2,fiber:0.4,sugar:6.2,sodium:1},
  {name:'Peach',category:'Fruits',kcal:39,protein:0.9,carbs:10,fat:0.3,fiber:1.5,sugar:8.4,sodium:0},
  {name:'Pear',category:'Fruits',kcal:57,protein:0.4,carbs:15,fat:0.1,fiber:3.1,sugar:9.8,sodium:1},
  {name:'Cherries',category:'Fruits',kcal:63,protein:1.1,carbs:16,fat:0.2,fiber:2.1,sugar:12.8,sodium:0},
  {name:'Avocado',category:'Fruits',kcal:160,protein:2,carbs:9,fat:15,fiber:7,sugar:0.7,sodium:7},
  {name:'Kiwi',category:'Fruits',kcal:61,protein:1.1,carbs:15,fat:0.5,fiber:3,sugar:9,sodium:3},
  {name:'Pomegranate',category:'Fruits',kcal:83,protein:1.7,carbs:19,fat:1.2,fiber:4,sugar:14,sodium:3},
  {name:'Cantaloupe',category:'Fruits',kcal:34,protein:0.8,carbs:8.2,fat:0.2,fiber:0.9,sugar:7.9,sodium:16},

  // ‚îÄ‚îÄ DAIRY ‚îÄ‚îÄ
  {name:'Whole Milk',category:'Dairy',kcal:61,protein:3.2,carbs:4.8,fat:3.3,fiber:0,sugar:5.1,sodium:43},
  {name:'2% Milk',category:'Dairy',kcal:50,protein:3.3,carbs:4.9,fat:2,fiber:0,sugar:5.1,sodium:47},
  {name:'Skim Milk',category:'Dairy',kcal:34,protein:3.4,carbs:5,fat:0.2,fiber:0,sugar:5.1,sodium:52},
  {name:'Almond Milk (unsweetened)',category:'Dairy',kcal:17,protein:0.6,carbs:1.5,fat:1.1,fiber:0.3,sugar:0,sodium:92},
  {name:'Oat Milk',category:'Dairy',kcal:47,protein:1,carbs:7.3,fat:1.5,fiber:0.5,sugar:4,sodium:100},
  {name:'Cheddar Cheese',category:'Dairy',kcal:403,protein:25,carbs:1.3,fat:33,fiber:0,sugar:0.5,sodium:621},
  {name:'Mozzarella Cheese',category:'Dairy',kcal:300,protein:22,carbs:2.2,fat:22,fiber:0,sugar:1,sodium:627},
  {name:'Parmesan Cheese',category:'Dairy',kcal:431,protein:38,carbs:4.1,fat:29,fiber:0,sugar:0.4,sodium:1529},
  {name:'Cream Cheese',category:'Dairy',kcal:342,protein:6,carbs:4.1,fat:34,fiber:0,sugar:3.2,sodium:321},
  {name:'Sour Cream',category:'Dairy',kcal:198,protein:2.4,carbs:4.6,fat:19,fiber:0,sugar:0.7,sodium:53},
  {name:'Butter',category:'Dairy',kcal:717,protein:0.9,carbs:0.1,fat:81,fiber:0,sugar:0.1,sodium:11},
  {name:'Regular Yogurt (plain)',category:'Dairy',kcal:61,protein:3.5,carbs:4.7,fat:3.3,fiber:0,sugar:4.7,sodium:46},
  {name:'Ice Cream (vanilla)',category:'Dairy',kcal:207,protein:3.5,carbs:24,fat:11,fiber:0.7,sugar:21,sodium:80},

  // ‚îÄ‚îÄ FATS & OILS ‚îÄ‚îÄ
  {name:'Olive Oil',category:'Fats',kcal:884,protein:0,carbs:0,fat:100,fiber:0,sugar:0,sodium:2},
  {name:'Coconut Oil',category:'Fats',kcal:862,protein:0,carbs:0,fat:100,fiber:0,sugar:0,sodium:0},
  {name:'Avocado Oil',category:'Fats',kcal:884,protein:0,carbs:0,fat:100,fiber:0,sugar:0,sodium:0},
  {name:'Peanut Butter',category:'Fats',kcal:588,protein:25,carbs:20,fat:50,fiber:6,sugar:9.4,sodium:459},
  {name:'Almond Butter',category:'Fats',kcal:614,protein:21,carbs:22,fat:56,fiber:10,sugar:4.4,sodium:3},
  {name:'Mixed Nuts',category:'Fats',kcal:607,protein:16,carbs:22,fat:55,fiber:7,sugar:4.6,sodium:236},
  {name:'Almonds',category:'Fats',kcal:579,protein:21,carbs:22,fat:50,fiber:12.5,sugar:4.4,sodium:1},
  {name:'Walnuts',category:'Fats',kcal:654,protein:15,carbs:14,fat:65,fiber:6.7,sugar:2.6,sodium:2},
  {name:'Cashews',category:'Fats',kcal:553,protein:18,carbs:30,fat:44,fiber:3.3,sugar:5.9,sodium:12},
  {name:'Sunflower Seeds',category:'Fats',kcal:584,protein:21,carbs:20,fat:51,fiber:8.6,sugar:2.6,sodium:9},
  {name:'Chia Seeds',category:'Fats',kcal:486,protein:17,carbs:42,fat:31,fiber:34,sugar:0,sodium:16},
  {name:'Flaxseeds',category:'Fats',kcal:534,protein:18,carbs:29,fat:42,fiber:27,sugar:1.6,sodium:30},

  // ‚îÄ‚îÄ FAST FOOD & RESTAURANTS ‚îÄ‚îÄ
  {name:'McDonalds Big Mac',category:'Fast Food',kcal:550,protein:25,carbs:46,fat:30,fiber:3,sugar:9,sodium:1010},
  {name:'McDonalds McDouble',category:'Fast Food',kcal:390,protein:23,carbs:34,fat:19,fiber:2,sugar:7,sodium:850},
  {name:'McDonalds French Fries (medium)',category:'Fast Food',kcal:320,protein:4,carbs:43,fat:15,fiber:3,sugar:0,sodium:400},
  {name:'McDonalds Chicken McNuggets (10pc)',category:'Fast Food',kcal:480,protein:30,carbs:29,fat:28,fiber:0,sugar:0,sodium:930},
  {name:'Chick-fil-A Sandwich',category:'Fast Food',kcal:470,protein:28,carbs:56,fat:15,fiber:2,sugar:8,sodium:1350},
  {name:'Chick-fil-A Nuggets (8pc)',category:'Fast Food',kcal:260,protein:26,carbs:11,fat:12,fiber:1,sugar:1,sodium:1090},
  {name:'Chipotle Chicken Bowl (w/rice,beans,cheese)',category:'Fast Food',kcal:735,protein:51,carbs:68,fat:24,fiber:13,sugar:4,sodium:1600},
  {name:'Chipotle Burrito (chicken)',category:'Fast Food',kcal:1000,protein:56,carbs:118,fat:30,fiber:14,sugar:6,sodium:2100},
  {name:'Subway 6" Turkey Sandwich',category:'Fast Food',kcal:280,protein:18,carbs:46,fat:3.5,fiber:4,sugar:7,sodium:720},
  {name:'Dominos Pepperoni Pizza (2 slices)',category:'Fast Food',kcal:530,protein:22,carbs:56,fat:24,fiber:3,sugar:4,sodium:1200},
  {name:'Starbucks Latte (grande, 2% milk)',category:'Fast Food',kcal:190,protein:13,carbs:19,fat:7,fiber:0,sugar:18,sodium:170},
  {name:'Starbucks Frappuccino (mocha, grande)',category:'Fast Food',kcal:420,protein:6,carbs:62,fat:16,fiber:1,sugar:61,sodium:230},

  // ‚îÄ‚îÄ BREAKFAST FOODS ‚îÄ‚îÄ
  {name:'Pancakes (2 medium)',category:'Breakfast',kcal:227,protein:6.2,carbs:40,fat:5.9,fiber:1.6,sugar:8,sodium:412},
  {name:'Waffles (2)',category:'Breakfast',kcal:291,protein:8.5,carbs:45,fat:10,fiber:1.8,sugar:6,sodium:688},
  {name:'Scrambled Eggs (2)',category:'Breakfast',kcal:200,protein:14,carbs:2.2,fat:15,fiber:0,sugar:1.2,sodium:342},
  {name:'Fried Eggs (2)',category:'Breakfast',kcal:185,protein:12,carbs:0.4,fat:14,fiber:0,sugar:0.4,sodium:328},
  {name:'French Toast (2 slices)',category:'Breakfast',kcal:285,protein:10,carbs:39,fat:10,fiber:2,sugar:10,sodium:422},
  {name:'Breakfast Burrito (egg & cheese)',category:'Breakfast',kcal:450,protein:22,carbs:44,fat:20,fiber:3,sugar:3,sodium:980},
  {name:'Bagel with Cream Cheese',category:'Breakfast',kcal:395,protein:13,carbs:54,fat:14,fiber:2,sugar:7,sodium:690},
  {name:'Toast with Peanut Butter',category:'Breakfast',kcal:310,protein:12,carbs:36,fat:14,fiber:5,sugar:7,sodium:480},
  {name:'Overnight Oats (plain)',category:'Breakfast',kcal:215,protein:10,carbs:35,fat:5,fiber:5,sugar:8,sodium:120},
  {name:'Smoothie (banana, almond milk, protein)',category:'Breakfast',kcal:280,protein:25,carbs:32,fat:4,fiber:4,sugar:14,sodium:200},

  // ‚îÄ‚îÄ SNACKS ‚îÄ‚îÄ
  {name:'Protein Shake (whey, water)',category:'Snacks',kcal:120,protein:25,carbs:3,fat:1.5,fiber:0,sugar:2,sodium:150},
  {name:'Apple with Peanut Butter (2 tbsp)',category:'Snacks',kcal:266,protein:7,carbs:32,fat:15,fiber:6,sugar:19,sodium:148},
  {name:'Banana with Almond Butter',category:'Snacks',kcal:270,protein:8,carbs:36,fat:13,fiber:6,sugar:17,sodium:5},
  {name:'Hummus (2 tbsp) with Carrots',category:'Snacks',kcal:80,protein:3,carbs:10,fat:3,fiber:3,sugar:4,sodium:150},
  {name:'Cheese & Crackers (1 serving)',category:'Snacks',kcal:280,protein:9,carbs:26,fat:16,fiber:1,sugar:3,sodium:580},
  {name:'Trail Mix',category:'Snacks',kcal:462,protein:11,carbs:49,fat:27,fiber:5,sugar:22,sodium:143},
  {name:'Clif Bar',category:'Snacks',kcal:250,protein:11,carbs:45,fat:6,fiber:5,sugar:20,sodium:270},
  {name:'RXBAR (chocolate sea salt)',category:'Snacks',kcal:210,protein:12,carbs:24,fat:9,fiber:5,sugar:15,sodium:260},
  {name:'Rice Cake with Avocado',category:'Snacks',kcal:130,protein:2,carbs:16,fat:7,fiber:4,sugar:0.5,sodium:65},
  {name:'Edamame (1 cup)',category:'Snacks',kcal:189,protein:17,carbs:15,fat:8,fiber:8,sugar:3.4,sodium:9},
  {name:'Beef Jerky (1 oz)',category:'Snacks',kcal:116,protein:9.4,carbs:3.1,fat:7.3,fiber:0.5,sugar:2.6,sodium:506},
  {name:'Pretzels (1 oz)',category:'Snacks',kcal:108,protein:2.9,carbs:22,fat:0.8,fiber:0.9,sugar:0.7,sodium:352},
  {name:'Potato Chips (1 oz)',category:'Snacks',kcal:152,protein:2,carbs:15,fat:10,fiber:1.3,sugar:0.2,sodium:149},
  {name:'Dark Chocolate (70%, 1 oz)',category:'Snacks',kcal:170,protein:2,carbs:13,fat:12,fiber:3,sugar:7,sodium:6},

  // ‚îÄ‚îÄ SOUPS & PREPARED MEALS ‚îÄ‚îÄ
  {name:'Chicken Noodle Soup (1 cup)',category:'Meals',kcal:75,protein:6,carbs:9,fat:2,fiber:0.7,sugar:1,sodium:866},
  {name:'Tomato Soup (1 cup)',category:'Meals',kcal:74,protein:1.9,carbs:17,fat:0.5,fiber:2,sugar:8,sodium:744},
  {name:'Beef Stew (1 cup)',category:'Meals',kcal:218,protein:16,carbs:16,fat:10,fiber:2,sugar:3,sodium:699},
  {name:'Chili with Beans (1 cup)',category:'Meals',kcal:287,protein:19,carbs:30,fat:11,fiber:9,sugar:5,sodium:772},
  {name:'Stir Fry (chicken & vegetables)',category:'Meals',kcal:175,protein:18,carbs:14,fat:5,fiber:3,sugar:5,sodium:620},
  {name:'Caesar Salad (with dressing)',category:'Meals',kcal:184,protein:8,carbs:10,fat:14,fiber:2,sugar:2,sodium:440},
  {name:'Grilled Cheese Sandwich',category:'Meals',kcal:390,protein:16,carbs:35,fat:20,fiber:2,sugar:4,sodium:840},
  {name:'Burrito Bowl (homemade)',category:'Meals',kcal:550,protein:35,carbs:60,fat:15,fiber:12,sugar:3,sodium:900},
  {name:'Sushi Roll (california, 8 pcs)',category:'Meals',kcal:255,protein:9,carbs:38,fat:7,fiber:3.5,sugar:4,sodium:490},
  {name:'Fried Rice (1 cup)',category:'Meals',kcal:333,protein:7,carbs:55,fat:10,fiber:1.5,sugar:2,sodium:570},
  {name:'Mac & Cheese (homemade)',category:'Meals',kcal:360,protein:15,carbs:42,fat:15,fiber:1.5,sugar:5,sodium:740},
  {name:'Grilled Salmon with Vegetables',category:'Meals',kcal:310,protein:30,carbs:12,fat:16,fiber:3,sugar:4,sodium:380},
  {name:'Chicken & Rice (meal prep)',category:'Meals',kcal:400,protein:38,carbs:38,fat:8,fiber:1.5,sugar:1,sodium:460},

  // ‚îÄ‚îÄ BEVERAGES ‚îÄ‚îÄ
  {name:'Water',category:'Beverages',kcal:0,protein:0,carbs:0,fat:0,fiber:0,sugar:0,sodium:0},
  {name:'Black Coffee',category:'Beverages',kcal:2,protein:0.3,carbs:0,fat:0,fiber:0,sugar:0,sodium:5},
  {name:'Coffee with Cream & Sugar',category:'Beverages',kcal:80,protein:1,carbs:12,fat:3,fiber:0,sugar:10,sodium:30},
  {name:'Orange Juice (8oz)',category:'Beverages',kcal:112,protein:1.7,carbs:26,fat:0.5,fiber:0.5,sugar:21,sodium:2},
  {name:'Apple Juice (8oz)',category:'Beverages',kcal:114,protein:0.1,carbs:28,fat:0.3,fiber:0.2,sugar:24,sodium:10},
  {name:'Sports Drink (Gatorade, 12oz)',category:'Beverages',kcal:80,protein:0,carbs:21,fat:0,fiber:0,sugar:21,sodium:160},
  {name:'Protein Shake (ready to drink)',category:'Beverages',kcal:160,protein:30,carbs:5,fat:3,fiber:0,sugar:2,sodium:260},
  {name:'Beer (12oz, regular)',category:'Beverages',kcal:153,protein:1.6,carbs:13,fat:0,fiber:0,sugar:0,sodium:14},
  {name:'Wine (red, 5oz)',category:'Beverages',kcal:125,protein:0.1,carbs:3.8,fat:0,fiber:0,sugar:0.9,sodium:6},
  {name:'Kombucha (8oz)',category:'Beverages',kcal:30,protein:0,carbs:7,fat:0,fiber:0,sugar:2,sodium:10},
  {name:'Green Tea',category:'Beverages',kcal:2,protein:0,carbs:0,fat:0,fiber:0,sugar:0,sodium:2},

  // ‚îÄ‚îÄ CONDIMENTS ‚îÄ‚îÄ
  {name:'Ketchup',category:'Condiments',kcal:100,protein:1.3,carbs:25,fat:0.1,fiber:0.3,sugar:22,sodium:907},
  {name:'Mustard',category:'Condiments',kcal:66,protein:4.4,carbs:5.8,fat:3.5,fiber:3.2,sugar:1.4,sodium:1124},
  {name:'Hot Sauce',category:'Condiments',kcal:31,protein:1.4,carbs:5.7,fat:0.5,fiber:0.8,sugar:1.9,sodium:1731},
  {name:'Mayonnaise',category:'Condiments',kcal:680,protein:1,carbs:0.6,fat:75,fiber:0,sugar:0.4,sodium:635},
  {name:'Soy Sauce',category:'Condiments',kcal:53,protein:8.1,carbs:4.9,fat:0.1,fiber:0.1,sugar:1.7,sodium:5493},
  {name:'Salsa',category:'Condiments',kcal:36,protein:2,carbs:8,fat:0.4,fiber:1.9,sugar:4.7,sodium:864},
  {name:'Ranch Dressing',category:'Condiments',kcal:476,protein:2.3,carbs:6,fat:49,fiber:0,sugar:4.5,sodium:867},
  {name:'Olive Oil (1 tbsp)',category:'Condiments',kcal:119,protein:0,carbs:0,fat:13.5,fiber:0,sugar:0,sodium:0},
  {name:'Sriracha',category:'Condiments',kcal:93,protein:2.7,carbs:19,fat:0.3,fiber:0.7,sugar:12,sodium:2327},
  {name:'Balsamic Vinegar',category:'Condiments',kcal:88,protein:0.5,carbs:17,fat:0,fiber:0,sugar:15,sodium:23},
  {name:'Greek Vinaigrette (2 tbsp)',category:'Condiments',kcal:130,protein:0,carbs:3,fat:13,fiber:0,sugar:2,sodium:310},
  {name:'Honey',category:'Condiments',kcal:304,protein:0.3,carbs:82,fat:0,fiber:0.2,sugar:82,sodium:4},
  {name:'Maple Syrup',category:'Condiments',kcal:260,protein:0,carbs:67,fat:0.1,fiber:0,sugar:60,sodium:12},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SLEEP LOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentSleepDate = todayStr();

function todayStr() {
  return new Date().toISOString().slice(0, 10);
}

function changeSleepDate(delta) {
  const d = new Date(currentSleepDate + 'T12:00:00');
  d.setDate(d.getDate() + delta);
  const newDate = d.toISOString().slice(0, 10);
  const today = todayStr();
  if (newDate > today) return;
  currentSleepDate = newDate;
  renderSleepLog();
}

function renderSleepLog() {
  const u = allUsers[currentUser];
  if (!u) return;
  if (!u.sleepLog) u.sleepLog = {};

  // Update date label
  const today = todayStr();
  const yesterday = new Date(Date.now() - 86400000).toISOString().slice(0, 10);
  const d = new Date(currentSleepDate + 'T12:00:00');
  const label = currentSleepDate === today ? 'Today'
    : currentSleepDate === yesterday ? 'Yesterday'
    : d.toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric' });
  const lbl = document.getElementById('sleep-date-label');
  if (lbl) lbl.textContent = label;

  // Load existing entry if present
  const entry = u.sleepLog[currentSleepDate];
  if (entry) {
    if (document.getElementById('sl-bedtime'))   document.getElementById('sl-bedtime').value   = entry.bedtime  || '22:30';
    if (document.getElementById('sl-waketime'))  document.getElementById('sl-waketime').value  = entry.waketime || '06:30';
    if (document.getElementById('sl-quality-input')) document.getElementById('sl-quality-input').value = entry.quality || '';
    if (document.getElementById('sl-feeling'))   document.getElementById('sl-feeling').value   = entry.feeling  || '';
    if (document.getElementById('sl-notes'))     document.getElementById('sl-notes').value     = entry.notes    || '';
  } else {
    if (document.getElementById('sl-bedtime'))   document.getElementById('sl-bedtime').value   = '22:30';
    if (document.getElementById('sl-waketime'))  document.getElementById('sl-waketime').value  = '06:30';
    if (document.getElementById('sl-quality-input')) document.getElementById('sl-quality-input').value = '';
    if (document.getElementById('sl-feeling'))   document.getElementById('sl-feeling').value   = '';
    if (document.getElementById('sl-notes'))     document.getElementById('sl-notes').value     = '';
  }

  updateSleepStats();
  renderSleepChart();
  renderSleepInsights();
}

function calcSleepHours(bedtime, waketime) {
  if (!bedtime || !waketime) return 0;
  const [bh, bm] = bedtime.split(':').map(Number);
  const [wh, wm] = waketime.split(':').map(Number);
  let mins = (wh * 60 + wm) - (bh * 60 + bm);
  if (mins < 0) mins += 24 * 60; // crossed midnight
  return Math.round(mins / 6) / 10; // 1 decimal
}

function updateSleepStats() {
  const u = allUsers[currentUser];
  if (!u || !u.sleepLog) return;

  const entry = u.sleepLog[currentSleepDate];
  const hours = entry ? calcSleepHours(entry.bedtime, entry.waketime) : null;

  // Duration
  const hoursEl = document.getElementById('sl-hours');
  if (hoursEl) hoursEl.textContent = hours !== null ? hours.toFixed(1) : '‚Äî';

  // Quality stars
  const qualEl   = document.getElementById('sl-quality');
  const qualLabel = document.getElementById('sl-quality-label');
  const qualMap   = { '5':'‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê','4':'‚≠ê‚≠ê‚≠ê‚≠ê','3':'‚≠ê‚≠ê‚≠ê','2':'‚≠ê‚≠ê','1':'‚≠ê' };
  const qualText  = { '5':'Excellent','4':'Good','3':'Average','2':'Poor','1':'Very Poor' };
  if (qualEl) qualEl.textContent = entry?.quality ? qualMap[entry.quality] : '‚Äî';
  if (qualLabel) qualLabel.textContent = entry?.quality ? qualText[entry.quality] : 'Not logged';

  // Streak
  let streak = 0;
  const today = todayStr();
  for (let i = 0; i < 365; i++) {
    const d = new Date(Date.now() - i * 86400000).toISOString().slice(0, 10);
    if (u.sleepLog[d]) streak++;
    else break;
  }
  const strEl = document.getElementById('sl-streak');
  if (strEl) strEl.textContent = streak;

  // 7-day average
  let total7 = 0, count7 = 0;
  for (let i = 0; i < 7; i++) {
    const d = new Date(Date.now() - i * 86400000).toISOString().slice(0, 10);
    const e = u.sleepLog[d];
    if (e) { const h = calcSleepHours(e.bedtime, e.waketime); if (h > 0) { total7 += h; count7++; } }
  }
  const avgEl = document.getElementById('sl-avg');
  if (avgEl) avgEl.textContent = count7 > 0 ? (total7 / count7).toFixed(1) : '‚Äî';
}

function logSleep() {
  const bedtime  = document.getElementById('sl-bedtime').value;
  const waketime = document.getElementById('sl-waketime').value;
  const quality  = document.getElementById('sl-quality-input').value;
  const feeling  = document.getElementById('sl-feeling').value;
  const notes    = document.getElementById('sl-notes').value.trim();

  if (!bedtime || !waketime) { alert('Please enter both bedtime and wake time.'); return; }

  const u = allUsers[currentUser];
  if (!u) return;
  if (!u.sleepLog) u.sleepLog = {};

  u.sleepLog[currentSleepDate] = { bedtime, waketime, quality, feeling, notes,
    hours: calcSleepHours(bedtime, waketime), loggedAt: new Date().toISOString() };

  saveStorage();
  updateSleepStats();
  renderSleepChart();
  renderSleepInsights();

  const msg = document.getElementById('sl-save-msg');
  if (msg) { msg.style.display = 'block'; setTimeout(() => msg.style.display = 'none', 2000); }
}

function deleteSleepLog() {
  const u = allUsers[currentUser];
  if (!u || !u.sleepLog) return;
  delete u.sleepLog[currentSleepDate];
  saveStorage();
  renderSleepLog();
}

function renderSleepChart() {
  const container = document.getElementById('sl-history-chart');
  if (!container) return;
  const u = allUsers[currentUser];
  if (!u || !u.sleepLog) { container.innerHTML = '<div style="color:var(--text-muted);font-size:13px;">No sleep data yet.</div>'; return; }

  const GOAL = 8;
  const days = [];
  for (let i = 6; i >= 0; i--) {
    const d = new Date(Date.now() - i * 86400000);
    const ds = d.toISOString().slice(0, 10);
    const entry = u.sleepLog[ds];
    const hours = entry ? calcSleepHours(entry.bedtime, entry.waketime) : 0;
    days.push({ label: d.toLocaleDateString('en-US', { weekday:'short' }), hours, entry });
  }

  const qualColour = { '5':'var(--green)','4':'#86efac','3':'var(--accent)','2':'#f97316','1':'var(--red)' };
  const html = days.map(day => {
    const pct = Math.min(100, (day.hours / GOAL) * 100);
    const col = day.entry?.quality ? qualColour[day.entry.quality] : (day.hours >= GOAL ? 'var(--green)' : day.hours >= 6 ? 'var(--accent)' : day.hours > 0 ? 'var(--red)' : 'var(--surface3)');
    const label = day.hours > 0 ? day.hours.toFixed(1) + 'h' : '‚Äî';
    return `<div class="sleep-bar-wrap">
      <div class="sleep-bar-label">${day.label}</div>
      <div class="sleep-bar-track">
        <div class="sleep-bar-fill" style="width:${pct}%;background:${col};">${pct > 15 ? label : ''}</div>
      </div>
      <div class="sleep-bar-date">${pct <= 15 && day.hours > 0 ? label : ''}</div>
    </div>`;
  }).join('');

  container.innerHTML = html +
    `<div style="display:flex;align-items:center;gap:6px;margin-top:12px;font-size:11px;color:var(--text-muted);">
      <div style="width:10px;height:10px;border-radius:2px;background:var(--border);flex-shrink:0;"></div> 0‚Äì5h (not enough) &nbsp;
      <div style="width:10px;height:10px;border-radius:2px;background:var(--accent);flex-shrink:0;"></div> 6‚Äì7h (okay) &nbsp;
      <div style="width:10px;height:10px;border-radius:2px;background:var(--green);flex-shrink:0;"></div> 8h+ (great)
    </div>`;
}

function renderSleepInsights() {
  const container = document.getElementById('sl-insights');
  if (!container) return;
  const u = allUsers[currentUser];
  if (!u || !u.sleepLog) return;

  // Gather last 7 days
  const entries = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(Date.now() - i * 86400000).toISOString().slice(0, 10);
    if (u.sleepLog[d]) entries.push({ ...u.sleepLog[d], date: d });
  }

  if (entries.length < 2) {
    container.innerHTML = '<div style="color:var(--text-muted);font-size:13px;">Log at least 2 nights to see insights.</div>';
    return;
  }

  const hours = entries.map(e => calcSleepHours(e.bedtime, e.waketime)).filter(h => h > 0);
  const avg   = hours.reduce((a, b) => a + b, 0) / hours.length;
  const qualities = entries.filter(e => e.quality).map(e => parseInt(e.quality));
  const avgQuality = qualities.length ? qualities.reduce((a, b) => a + b, 0) / qualities.length : null;
  const best  = Math.max(...hours);
  const worst = Math.min(...hours);

  const tips = [];
  if (avg < 7)   tips.push({ icon:'‚ö†Ô∏è', text:`Your average of <strong>${avg.toFixed(1)}h</strong> is below the recommended 7‚Äì9 hours. Try going to bed 30 minutes earlier.` });
  if (avg >= 8)  tips.push({ icon:'‚úÖ', text:`Great job! You're averaging <strong>${avg.toFixed(1)}h</strong> ‚Äî right in the optimal range for recovery.` });
  if (avgQuality !== null && avgQuality < 3) tips.push({ icon:'üí§', text:'Your sleep quality ratings are low. Try limiting screens 1 hour before bed and keeping your room cooler.' });
  if (avgQuality !== null && avgQuality >= 4) tips.push({ icon:'üåü', text:'Excellent sleep quality! Your recovery is optimised ‚Äî keep your current bedtime routine.' });
  if (best - worst > 2) tips.push({ icon:'üìÖ', text:`Your sleep varies a lot (${worst.toFixed(1)}h to ${best.toFixed(1)}h). Consistent sleep and wake times improve sleep quality.` });

  const feelingCounts = {};
  entries.filter(e => e.feeling).forEach(e => { feelingCounts[e.feeling] = (feelingCounts[e.feeling] || 0) + 1; });
  const topFeeling = Object.entries(feelingCounts).sort((a,b) => b[1]-a[1])[0];
  if (topFeeling) {
    const feelMap = { Refreshed:'üòä', Okay:'üòê', Groggy:'üò¥', Tired:'üò©', Exhausted:'üíÄ' };
    tips.push({ icon: feelMap[topFeeling[0]] || 'üòê', text:`You most often wake feeling <strong>${topFeeling[0]}</strong>.` });
  }

  if (!tips.length) tips.push({ icon:'üìä', text:'Keep logging to build a clearer picture of your sleep patterns.' });

  container.innerHTML = tips.map(t =>
    `<div style="display:flex;align-items:flex-start;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);">
      <span style="font-size:18px;flex-shrink:0;">${t.icon}</span>
      <div style="font-size:13px;color:var(--text-dim);line-height:1.6;">${t.text}</div>
    </div>`
  ).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FOOD PHOTO ANALYSER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _foodCamStream    = null;
let _camMode          = 'live';
let _capturedPhotoB64 = null;
let _photoFoodData    = null;

function openFoodCamera() {
  const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
  if (isMobile) {
    // Open native phone camera, then show result card with full panel
    let camInput = document.getElementById('_mobile_cam_input');
    if (!camInput) {
      camInput = document.createElement('input');
      camInput.type = 'file';
      camInput.id = '_mobile_cam_input';
      camInput.accept = 'image/*';
      camInput.setAttribute('capture', 'environment');
      camInput.style.display = 'none';
      camInput.addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
          // Show the panel so result card is visible
          const panel = document.getElementById('food-camera-panel');
          panel.style.display = 'block';
          setTimeout(() => panel.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
          handlePhotoUpload(e);
        }
      });
      document.body.appendChild(camInput);
    }
    camInput.click();
    return;
  }
  // Desktop ‚Äî use the in-app camera panel
  const panel = document.getElementById('food-camera-panel');
  panel.style.display = 'block';
  panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
  setCamMode('live');
}

function closeFoodCamera() {
  document.getElementById('food-camera-panel').style.display = 'none';
  stopFoodCamStream();
  resetCamUI();
}

function setCamMode(mode) {
  _camMode = mode;
  document.getElementById('cam-mode-live').classList.toggle('src-active', mode === 'live');
  document.getElementById('cam-mode-upload').classList.toggle('src-active', mode === 'upload');
  document.getElementById('cam-live-view').style.display   = mode === 'live'   ? 'block' : 'none';
  document.getElementById('cam-upload-view').style.display = mode === 'upload' ? 'block' : 'none';
  resetCamUI();
  if (mode === 'live') startFoodCam();
  else stopFoodCamStream();
}

async function startFoodCam() {
  const placeholder = document.getElementById('cam-placeholder');
  const video   = document.getElementById('food-camera-video');
  const snapBtn = document.getElementById('cam-snap-btn');
  // On mobile opened as file://, getUserMedia won't work ‚Äî auto-switch to upload
  if (window.location.protocol === 'file:' && /iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
    setCamMode('upload');
    return;
  }
  try {
    _foodCamStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } }
    });
    video.srcObject = _foodCamStream;
    video.style.display = 'block';
    if (placeholder) placeholder.style.display = 'none';
    if (snapBtn) snapBtn.style.display = 'block';
  } catch(e) {
    if (placeholder) {
      placeholder.style.display = 'flex';
      placeholder.style.flexDirection = 'column';
      placeholder.style.alignItems = 'center';
      placeholder.innerHTML = '<div style="font-size:32px;margin-bottom:8px;">üö´</div><div style="font-size:13px;color:var(--red);text-align:center;">Camera access denied.<br>Switch to Upload Photo.</div>';
    }
    setCamMode('upload');
  }
}

function stopFoodCamStream() {
  if (_foodCamStream) {
    _foodCamStream.getTracks().forEach(t => t.stop());
    _foodCamStream = null;
  }
  const v = document.getElementById('food-camera-video');
  if (v) v.srcObject = null;
}

function snapFoodPhoto() {
  const video  = document.getElementById('food-camera-video');
  const canvas = document.getElementById('food-camera-canvas');
  if (!video || !video.videoWidth) return;
  canvas.width  = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  const b64 = canvas.toDataURL('image/jpeg', 0.85).split(',')[1];
  stopFoodCamStream();
  showPhotoPreview('data:image/jpeg;base64,' + b64, b64);
}

function handlePhotoUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  readPhotoFile(file);
}

function handlePhotoDrop(e) {
  e.preventDefault();
  document.getElementById('cam-drop-zone').style.borderColor = 'var(--border)';
  const file = e.dataTransfer.files[0];
  if (!file || !file.type.startsWith('image/')) return;
  readPhotoFile(file);
}

function readPhotoFile(file) {
  const reader = new FileReader();
  reader.onload = ev => {
    const dataUrl = ev.target.result;
    const b64 = dataUrl.split(',')[1];
    showPhotoPreview(dataUrl, b64);
  };
  reader.readAsDataURL(file);
}

function showPhotoPreview(dataUrl, b64) {
  _capturedPhotoB64 = b64;
  document.getElementById('cam-preview-img').src     = dataUrl;
  document.getElementById('cam-preview-area').style.display = 'block';
  document.getElementById('cam-result').style.display       = 'none';
  document.getElementById('cam-error').style.display        = 'none';
  const snapBtn = document.getElementById('cam-snap-btn');
  if (snapBtn) snapBtn.style.display = 'none';
  analysePhotoWithClaude(b64);
}

async function analysePhotoWithClaude(b64) {
  const apiAuth = getUserApiKey();

  // Show analysing state
  document.getElementById('cam-analysing').style.display = 'block';
  document.getElementById('cam-result').style.display    = 'none';
  document.getElementById('cam-error').style.display     = 'none';

  // Update the "analysing" label to show which AI is being used
  const analysingLabel = document.querySelector('#cam-analysing div[style*="font-weight"]');
  const aiLabel = apiAuth.provider === 'claude' ? 'Claude' : 'ChatGPT';
  if (analysingLabel) analysingLabel.textContent = aiLabel + ' is analysing your food...';



  const u = allUsers[currentUser] || {};
  const goalMap = {
    lose_weight: 'losing weight (lower calorie options preferred)',
    build_muscle: 'building muscle (high protein)',
    maintain: 'maintaining weight',
    improve_fitness: 'general fitness'
  };
  const userGoal = goalMap[u.goal] || 'general health';

  const prompt = `You are a professional nutrition analyst. Analyse this food photo carefully.
User goal: ${userGoal}
Respond ONLY with valid JSON ‚Äî no markdown, no text outside the JSON:
{
  "name": "Specific food name e.g. Grilled Chicken with Rice",
  "description": "1-2 sentences describing what you see and estimated portion",
  "meal_type": "breakfast|lunch|dinner|snack",
  "serving_description": "e.g. 1 plate ~380g",
  "kcal": 480,
  "protein": 38,
  "carbs": 45,
  "fat": 10,
  "fiber": 3,
  "sugar": 4,
  "sodium": 480,
  "confidence": "high|medium|low",
  "notes": "Any important caveats or assumptions"
}
Base estimates on visible portion size. If multiple items are on the plate, estimate the full meal total.`;

  try {
    let rawText = '';

    if (apiAuth.provider === 'claude') {
      const res = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-api-key': apiAuth.key, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
        body: JSON.stringify({
          model: 'claude-opus-4-6', max_tokens: 600,
          messages: [{ role: 'user', content: [
            { type: 'image', source: { type: 'base64', media_type: 'image/jpeg', data: b64 } },
            { type: 'text', text: prompt }
          ]}]
        })
      });
      if (!res.ok) { const e = await res.json().catch(()=>({})); throw new Error(e.error?.message || 'Claude error ' + res.status); }
      const data = await res.json();
      rawText = (data.content || []).map(c => c.text || '').join('').trim();
    } else {
      const res = await openAIFetch('/v1/chat/completions', {
        body: JSON.stringify({
          model: 'gpt-4o', max_tokens: 600,
          messages: [{ role: 'user', content: [
            { type: 'image_url', image_url: { url: 'data:image/jpeg;base64,' + b64 } },
            { type: 'text', text: prompt }
          ]}]
        })
      });
      if (!res.ok) { const e = await res.json().catch(()=>({})); throw new Error(e.error?.message || 'OpenAI error ' + res.status); }
      const data = await res.json();
      rawText = (data.choices?.[0]?.message?.content || '').trim();
    }

    const match = rawText.match(/\{[\s\S]*\}/);
    if (!match) throw new Error('Could not read food data from AI response');
    const food = JSON.parse(match[0]);
    _photoFoodData = food;

    document.getElementById('cam-analysing').style.display = 'none';
    document.getElementById('cam-result').style.display    = 'block';

    // Confidence badge
    const confColour = { high: 'var(--green)', medium: 'var(--accent)', low: 'var(--red)' }[food.confidence] || 'var(--text-muted)';
    const confBadge  = food.confidence
      ? ` <span style="font-size:10px;padding:2px 8px;border-radius:10px;background:rgba(74,222,128,0.1);color:${confColour};font-weight:700;vertical-align:middle;">${food.confidence.toUpperCase()} CONFIDENCE</span>`
      : '';

    document.getElementById('cam-food-name').innerHTML   = escHtml(food.name || 'Unknown Food') + confBadge;
    document.getElementById('cam-food-desc').textContent = (food.description || '') + (food.serving_description ? ' ¬∑ ' + food.serving_description : '');
    document.getElementById('cam-kcal').textContent      = Math.round(food.kcal    || 0);
    document.getElementById('cam-protein').textContent   = Math.round(food.protein || 0) + 'g';
    document.getElementById('cam-carbs').textContent     = Math.round(food.carbs   || 0) + 'g';
    document.getElementById('cam-fat').textContent       = Math.round(food.fat     || 0) + 'g';

    // Add notes if present
    const notesEl = document.getElementById('cam-notes');
    if (notesEl) {
      if (food.notes) { notesEl.textContent = 'üí¨ ' + food.notes; notesEl.style.display = 'block'; }
      else notesEl.style.display = 'none';
    }

    // Smart meal-time default
    const mealSel = document.getElementById('cam-meal-select');
    if (mealSel) {
      const hr = new Date().getHours();
      mealSel.value = food.meal_type || (hr < 11 ? 'breakfast' : hr < 15 ? 'lunch' : hr < 20 ? 'dinner' : 'snack');
    }

  } catch(e) {
    document.getElementById('cam-analysing').style.display = 'none';
    document.getElementById('cam-error').style.display     = 'block';
    document.getElementById('cam-error').innerHTML =
      `<div style="background:rgba(248,113,113,0.08);border:1px solid rgba(248,113,113,0.25);border-radius:10px;padding:14px;">` +
      `<div style="font-weight:700;color:var(--red);margin-bottom:6px;">‚ùå Analysis failed</div>` +
      `<div style="font-size:13px;color:var(--text-dim);margin-bottom:8px;">${escHtml(e.message)}</div>` +
      `<div style="font-size:12px;color:var(--text-muted);">Check your API key in AI Plan, then try again.</div>` +
      `<button class="btn btn-outline btn-sm" onclick="retakePhoto()" style="margin-top:10px;">üì∑ Try Again</button>` +
      `</div>`;
  }
}

function logPhotoFood() {
  if (!_photoFoodData) return;
  const meal = (document.getElementById('cam-meal-select') || {}).value || 'lunch';
  const u = allUsers[currentUser];
  if (!u) return;
  if (!u.foodLog) u.foodLog = {};
  if (!u.foodLog[currentLogDate]) u.foodLog[currentLogDate] = {};
  if (!u.foodLog[currentLogDate][meal]) u.foodLog[currentLogDate][meal] = [];

  u.foodLog[currentLogDate][meal].push({
    name:    _photoFoodData.name    || 'Photo Food',
    brand:   'üì∑ AI Identified',
    kcal:    Math.round(_photoFoodData.kcal    || 0),
    protein: +(_photoFoodData.protein || 0).toFixed(1),
    carbs:   +(_photoFoodData.carbs   || 0).toFixed(1),
    fat:     +(_photoFoodData.fat     || 0).toFixed(1),
    fiber:   +(_photoFoodData.fiber   || 0).toFixed(1),
    sugar:   +(_photoFoodData.sugar   || 0).toFixed(1),
    sodium:  Math.round(_photoFoodData.sodium  || 0),
    qty: 100
  });

  saveStorage();
  renderFoodLog();

  const mealEmoji = { breakfast:'üåÖ', lunch:'‚òÄÔ∏è', dinner:'üåô', snack:'üçé' }[meal] || 'üçΩÔ∏è';

  // Replace preview area with big success card
  document.getElementById('cam-preview-area').innerHTML = `
    <div style="text-align:center;padding:28px 20px;">
      <div style="font-size:56px;margin-bottom:12px;">‚úÖ</div>
      <div style="font-family:'Bebas Neue',sans-serif;font-size:22px;margin-bottom:6px;">${escHtml(_photoFoodData.name)}</div>
      <div style="font-size:14px;color:var(--text-dim);margin-bottom:4px;">has been logged to ${mealEmoji} ${meal}</div>
      <div style="font-size:28px;font-family:'Bebas Neue',sans-serif;color:var(--accent);margin:12px 0;">${Math.round(_photoFoodData.kcal||0)} <span style="font-size:14px;color:var(--text-muted);">kcal</span></div>
      <div style="display:flex;justify-content:center;gap:16px;margin-bottom:20px;">
        <div style="text-align:center;"><span style="color:var(--green);font-weight:700;">${Math.round(_photoFoodData.protein||0)}g</span><br><span style="font-size:10px;color:var(--text-muted);">protein</span></div>
        <div style="text-align:center;"><span style="color:var(--blue);font-weight:700;">${Math.round(_photoFoodData.carbs||0)}g</span><br><span style="font-size:10px;color:var(--text-muted);">carbs</span></div>
        <div style="text-align:center;"><span style="color:var(--accent2);font-weight:700;">${Math.round(_photoFoodData.fat||0)}g</span><br><span style="font-size:10px;color:var(--text-muted);">fat</span></div>
      </div>
      <div style="display:flex;flex-direction:column;gap:10px;">
        <button class="btn btn-accent btn-full" onclick="retakePhoto()" style="padding:14px;font-size:15px;">üì∑ Log Another Food</button>
        <button class="btn btn-outline btn-full" onclick="closeFoodCamera()" style="padding:12px;font-size:14px;">‚úï Done</button>
      </div>
    </div>`;
  document.getElementById('cam-preview-area').style.display = 'block';
}

function retakePhoto() {
  _capturedPhotoB64 = null;
  _photoFoodData    = null;
  document.getElementById('cam-preview-area').style.display = 'none';
  resetCamUI();
  if (_camMode === 'live') {
    startFoodCam();
  } else {
    const inp = document.getElementById('food-photo-input');
    if (inp) inp.value = '';
  }
}

function resetCamUI() {
  document.getElementById('cam-preview-area').style.display = 'none';
  document.getElementById('cam-analysing').style.display    = 'none';
  document.getElementById('cam-result').style.display       = 'none';
  document.getElementById('cam-error').style.display        = 'none';
  const snapBtn = document.getElementById('cam-snap-btn');
  if (snapBtn) snapBtn.style.display = 'none';
}

// ‚îÄ‚îÄ SEARCH STATE ‚îÄ‚îÄ
let searchSource = 'both'; // 'both' | 'packaged' | 'local'

function setSearchSource(src) {
  searchSource = src;
  ['both','packaged','local'].forEach(s => {
    const el = document.getElementById('src-' + s);
    if (el) el.classList.toggle('src-active', s === src);
  });
  const q = document.getElementById('food-search-input').value.trim();
  if (q) doFoodSearch();
}

// ‚îÄ‚îÄ Search cache: avoids repeat API calls for same term ‚îÄ‚îÄ
const _searchCache = new Map();

function onFoodSearch(val) {
  clearTimeout(searchTimeout);
  const dd = document.getElementById('search-dropdown');
  if (!val.trim()) { dd.style.display = 'none'; return; }

  const ql = val.trim().toLowerCase();

  // 1. Show local results INSTANTLY (no delay)
  if (searchSource !== 'packaged') {
    const localResults = FOOD_DB
      .filter(f => f.name.toLowerCase().includes(ql) || f.category.toLowerCase().includes(ql))
      .slice(0, 6)
      .map(f => ({ ...f, _src: 'local' }));
    if (localResults.length) {
      window._searchResults = localResults;
      renderSearchResults(localResults);
      dd.style.display = 'block';
    }
  }

  // 2. Check cache before making any network call
  if (_searchCache.has(ql)) {
    const cached = _searchCache.get(ql);
    window._searchResults = cached;
    renderSearchResults(cached);
    dd.style.display = 'block';
    return;
  }

  // 3. Debounce the network call (500ms ‚Äî user still typing)
  searchTimeout = setTimeout(() => doFoodSearch(val.trim()), 500);
}

async function doFoodSearch(q) {
  if (!q) return;
  const ql = q.toLowerCase();
  const dd = document.getElementById('search-dropdown');
  const spinner = document.getElementById('search-spinner');
  dd.style.display = 'block';
  if (spinner) spinner.style.display = 'block';

  // Local results
  const localResults = (searchSource !== 'packaged')
    ? FOOD_DB.filter(f => f.name.toLowerCase().includes(ql) || f.category.toLowerCase().includes(ql))
        .slice(0, 6).map(f => ({ ...f, _src: 'local' }))
    : [];

  // Remote search
  let remoteResults = [];
  if (searchSource !== 'local') {
    try {
      remoteResults = await searchOpenFoodFacts(q);
    } catch(e) {
      console.log('Remote search failed:', e.message);
    }
  }

  if (spinner) spinner.style.display = 'none';

  // Merge: remote first, then local
  const seen = new Set();
  const merged = [];
  remoteResults.forEach(r => { const k = r.name.toLowerCase(); if (!seen.has(k)) { seen.add(k); merged.push({...r, _src:'off'}); } });
  if (searchSource !== 'packaged') {
    localResults.forEach(r => { const k = r.name.toLowerCase(); if (!seen.has(k)) { seen.add(k); merged.push({...r, _src:'local'}); } });
  }

  // Only update if this is still the current search term
  const currentVal = (document.getElementById('food-search-input') || {}).value || '';
  if (!currentVal.toLowerCase().startsWith(ql.slice(0, 3))) return;

  if (!merged.length) {
    dd.innerHTML = '<div style="padding:16px 20px;color:var(--text-dim);font-size:13px;">No results found. Try a different search term.</div>';
    dd.style.display = 'block';
    return;
  }

  // Cache the result (keep cache small)
  _searchCache.set(ql, merged);
  if (_searchCache.size > 30) _searchCache.delete(_searchCache.keys().next().value);

  window._searchResults = merged;
  renderSearchResults(merged);
}

function renderSearchResults(results) {
  const dd = document.getElementById('search-dropdown');
  dd.style.display = 'block';
  dd.innerHTML = results.map((f, i) => {
    const kcal = Math.round(f.kcal || 0);
    const prot = Math.round((f.protein || 0) * 10) / 10;
    const carb = Math.round((f.carbs || 0) * 10) / 10;
    const fat  = Math.round((f.fat || 0) * 10) / 10;
    const srcBadge = f._src === 'off'
      ? '<span class="sri-source off">Open Food Facts</span>'
      : '<span class="sri-source local">Basic Foods</span>';
    return `<div class="search-result-item" onclick="selectFood(${i})">
      <div style="display:flex;justify-content:space-between;align-items:start;gap:10px;">
        <div style="flex:1;min-width:0;">
          <div class="sri-name" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escHtml(f.name)}${srcBadge}</div>
          <div class="sri-brand">${escHtml(f.brand || f.category || '')} ¬∑ per 100g</div>
        </div>
        <div class="sri-cals" style="flex-shrink:0;">${kcal} kcal</div>
      </div>
      <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">P: ${prot}g &nbsp;C: ${carb}g &nbsp;F: ${fat}g</div>
    </div>`;
  }).join('');
}

function escHtml(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// Open Food Facts search ‚Äî races ALL endpoints simultaneously, uses whichever responds first
function parseOFFProducts(data) {
  return (data.products || [])
    .filter(p => p.product_name && p.nutriments)
    .map(p => {
      const n = p.nutriments;
      return {
        name: p.product_name,
        brand: p.brands || '',
        kcal: n['energy-kcal_100g'] || (n['energy-kcal'] ? n['energy-kcal'] / 10 : 0),
        protein: n['proteins_100g'] || 0,
        carbs: n['carbohydrates_100g'] || 0,
        fat: n['fat_100g'] || 0,
        fiber: n['fiber_100g'] || 0,
        sugar: n['sugars_100g'] || 0,
        sodium: n['sodium_100g'] || 0
      };
    });
}

async function searchOpenFoodFacts(query) {
  const encoded = encodeURIComponent(query);
  const base = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encoded}&search_simple=1&action=process&json=1&page_size=12&fields=product_name,brands,nutriments`;

  const urls = [
    base,
    `https://corsproxy.io/?${encodeURIComponent(base)}`,
    `https://api.allorigins.win/raw?url=${encodeURIComponent(base)}`
  ];

  // Helper: fetch one URL with a timeout, returns null on any failure
  const tryFetch = async (url) => {
    try {
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), 3000); // 3s per request
      const res = await fetch(url, {
        signal: controller.signal,
        headers: { 'Accept': 'application/json' }
      });
      clearTimeout(timer);
      if (!res.ok) return null;
      const data = await res.json();
      const products = parseOFFProducts(data);
      return products.length ? products : null;
    } catch(e) {
      return null;
    }
  };

  // Race all URLs simultaneously ‚Äî use the first one that returns results
  return new Promise(resolve => {
    let resolved = false;
    let pending = urls.length;

    urls.forEach(url => {
      tryFetch(url).then(products => {
        pending--;
        if (products && !resolved) {
          resolved = true;
          resolve(products);
        } else if (pending === 0 && !resolved) {
          resolve([]); // all failed
        }
      });
    });
  });
}

// Barcode lookup
async function lookupBarcode(barcode) {
  barcode = String(barcode).trim().replace(/\D/g,'');
  if (!barcode) return;

  const resultEl = document.getElementById('scanner-result');
  const innerEl  = document.getElementById('scanner-result-inner');
  resultEl.style.display = 'block';
  innerEl.innerHTML = '<div style="text-align:center;padding:16px 0;">'
    + '<div class="spinner" style="width:28px;height:28px;border-width:3px;margin:0 auto 10px;"></div>'
    + '<div style="font-size:14px;font-weight:700;margin-bottom:4px;">Looking up product...</div>'
    + '<div style="font-size:12px;color:var(--text-muted);">Barcode: ' + barcode + '</div>'
    + '</div>';

  setStatus('scanner-status', '&#128269; Looking up ' + barcode + '...');

  const urls = [
    'https://world.openfoodfacts.org/api/v0/product/' + barcode + '.json',
    'https://corsproxy.io/?' + encodeURIComponent('https://world.openfoodfacts.org/api/v0/product/' + barcode + '.json'),
    'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://world.openfoodfacts.org/api/v0/product/' + barcode + '.json')
  ];

  for (const url of urls) {
    try {
      const res = await Promise.race([
        fetch(url),
        new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), 7000))
      ]);
      if (!res.ok) continue;
      const data = await res.json();
      if (data.status === 1 && data.product) {
        const p = data.product;
        const n = p.nutriments || {};
        _barcodeFood = {
          name:    p.product_name || p.product_name_en || 'Unknown Product',
          brand:   p.brands || '',
          kcal:    Math.round(n['energy-kcal_100g'] || (n['energy-kcal'] ? n['energy-kcal'] / 10 : 0)),
          protein: Math.round((n['proteins_100g'] || 0) * 10) / 10,
          carbs:   Math.round((n['carbohydrates_100g'] || 0) * 10) / 10,
          fat:     Math.round((n['fat_100g'] || 0) * 10) / 10,
          fiber:   Math.round((n['fiber_100g'] || 0) * 10) / 10,
          sugar:   Math.round((n['sugars_100g'] || 0) * 10) / 10,
          sodium:  Math.round((n['sodium_100g'] || 0) * 1000)
        };
        showBarcodeFoodCard(_barcodeFood, innerEl);
        setStatus('scanner-status', '&#10003; Product found!');
        return;
      } else {
        innerEl.innerHTML = '<div style="background:rgba(248,113,113,0.08);border:1px solid rgba(248,113,113,0.2);border-radius:10px;padding:16px;text-align:center;">'
          + '<div style="font-size:24px;margin-bottom:8px;">üîç</div>'
          + '<div style="font-weight:700;font-size:14px;margin-bottom:6px;">Product not found</div>'
          + '<div style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">Barcode <strong>' + barcode + '</strong> is not in the database yet.</div>'
          + '<button class="btn btn-outline btn-sm" onclick="openBarcodeCamera ? openBarcodeCamera() : openScanner()">üì∑ Try Another</button>'
          + '</div>';
        setStatus('scanner-status', '&#10060; Not found ‚Äî try another barcode');
        return;
      }
    } catch(e) { continue; }
  }

  innerEl.innerHTML = '<div style="background:rgba(248,113,113,0.08);border:1px solid rgba(248,113,113,0.2);border-radius:10px;padding:16px;text-align:center;">'
    + '<div style="font-size:14px;font-weight:700;color:var(--red);margin-bottom:6px;">‚ùå Lookup failed</div>'
    + '<div style="font-size:12px;color:var(--text-muted);">Check your internet connection and try again, or enter the barcode number manually below.</div>'
    + '</div>';
  setStatus('scanner-status', '&#10060; Lookup failed');
}

function showBarcodeFoodCard(food, container) {
  const hr = new Date().getHours();
  const defaultMeal = hr < 11 ? 'breakfast' : hr < 15 ? 'lunch' : hr < 20 ? 'dinner' : 'snack';
  container.innerHTML = `
    <div style="margin-bottom:14px;">
      <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:6px;">Product found:</div>
      <div style="font-family:'Bebas Neue',sans-serif;font-size:26px;line-height:1.1;margin-bottom:4px;">${escHtml(food.name)}</div>
      ${food.brand ? '<div style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">' + escHtml(food.brand) + ' ¬∑ per 100g</div>' : '<div style="margin-bottom:12px;"></div>'}
    </div>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px;">
      <div style="background:var(--surface2);border-radius:10px;padding:12px 6px;text-align:center;">
        <div style="font-family:'Bebas Neue',sans-serif;font-size:24px;color:var(--accent);line-height:1;">${food.kcal}</div>
        <div style="font-size:9px;font-weight:700;text-transform:uppercase;color:var(--text-muted);margin-top:2px;">kcal</div>
      </div>
      <div style="background:var(--surface2);border-radius:10px;padding:12px 6px;text-align:center;">
        <div style="font-family:'Bebas Neue',sans-serif;font-size:24px;color:var(--green);line-height:1;">${food.protein}g</div>
        <div style="font-size:9px;font-weight:700;text-transform:uppercase;color:var(--text-muted);margin-top:2px;">protein</div>
      </div>
      <div style="background:var(--surface2);border-radius:10px;padding:12px 6px;text-align:center;">
        <div style="font-family:'Bebas Neue',sans-serif;font-size:24px;color:var(--blue);line-height:1;">${food.carbs}g</div>
        <div style="font-size:9px;font-weight:700;text-transform:uppercase;color:var(--text-muted);margin-top:2px;">carbs</div>
      </div>
      <div style="background:var(--surface2);border-radius:10px;padding:12px 6px;text-align:center;">
        <div style="font-family:'Bebas Neue',sans-serif;font-size:24px;color:var(--accent2);line-height:1;">${food.fat}g</div>
        <div style="font-size:9px;font-weight:700;text-transform:uppercase;color:var(--text-muted);margin-top:2px;">fat</div>
      </div>
    </div>
    <div style="margin-bottom:12px;">
      <div style="font-size:12px;font-weight:600;color:var(--text-muted);margin-bottom:6px;">Log to which meal?</div>
      <select id="barcode-meal-select" style="width:100%;padding:12px 14px;font-size:15px;border-radius:10px;">
        <option value="breakfast" ${defaultMeal==='breakfast'?'selected':''}>üåÖ Breakfast</option>
        <option value="lunch" ${defaultMeal==='lunch'?'selected':''}>‚òÄÔ∏è Lunch</option>
        <option value="dinner" ${defaultMeal==='dinner'?'selected':''}>üåô Dinner</option>
        <option value="snack" ${defaultMeal==='snack'?'selected':''}>üçé Snack</option>
      </select>
    </div>
    <div style="display:flex;flex-direction:column;gap:10px;">
      <button class="btn btn-accent btn-full" onclick="logBarcodeFood()" style="font-size:17px;padding:16px;font-weight:800;">
        ‚úÖ Yes, Log This Food
      </button>
      <button class="btn btn-outline btn-full" onclick="resetBarcodeScanner()" style="font-size:14px;padding:12px;">
        üì∑ Scan Another Product
      </button>
    </div>`;
}

function logBarcodeFood() {
  if (!_barcodeFood) return;
  const meal = (document.getElementById('barcode-meal-select') || {}).value || 'lunch';
  const u = allUsers[currentUser];
  if (!u) return;
  if (!u.foodLog) u.foodLog = {};
  if (!u.foodLog[currentLogDate]) u.foodLog[currentLogDate] = {};
  if (!u.foodLog[currentLogDate][meal]) u.foodLog[currentLogDate][meal] = [];
  u.foodLog[currentLogDate][meal].push({ ..._barcodeFood, brand: _barcodeFood.brand || 'üì∑ Barcode Scan', qty: 100 });
  saveStorage();
  renderFoodLog();

  const mealEmoji = { breakfast:'üåÖ', lunch:'‚òÄÔ∏è', dinner:'üåô', snack:'üçé' }[meal] || 'üçΩÔ∏è';
  const innerEl = document.getElementById('scanner-result-inner');
  innerEl.innerHTML = `
    <div style="text-align:center;padding:24px 0;">
      <div style="font-size:52px;margin-bottom:12px;">‚úÖ</div>
      <div style="font-family:'Bebas Neue',sans-serif;font-size:22px;margin-bottom:6px;">${escHtml(_barcodeFood.name)}</div>
      <div style="font-size:14px;color:var(--text-dim);margin-bottom:4px;">logged to ${mealEmoji} ${meal}</div>
      <div style="font-size:28px;font-family:'Bebas Neue',sans-serif;color:var(--accent);margin:12px 0;">${_barcodeFood.kcal} <span style="font-size:14px;color:var(--text-muted);">kcal</span></div>
      <div style="display:flex;justify-content:center;gap:20px;margin-bottom:20px;">
        <div><span style="color:var(--green);font-weight:700;">${_barcodeFood.protein}g</span><br><span style="font-size:10px;color:var(--text-muted);">protein</span></div>
        <div><span style="color:var(--blue);font-weight:700;">${_barcodeFood.carbs}g</span><br><span style="font-size:10px;color:var(--text-muted);">carbs</span></div>
        <div><span style="color:var(--accent2);font-weight:700;">${_barcodeFood.fat}g</span><br><span style="font-size:10px;color:var(--text-muted);">fat</span></div>
      </div>
      <div style="display:flex;flex-direction:column;gap:10px;">
        <button class="btn btn-accent btn-full" onclick="resetBarcodeScanner()" style="padding:14px;font-size:15px;">üì∑ Scan Another Product</button>
        <button class="btn btn-outline btn-full" onclick="closeScanner()" style="padding:12px;font-size:14px;">‚úï Done</button>
      </div>
    </div>`;
  _barcodeFood = null;
}

function resetBarcodeScanner() {
  _barcodeFood = null;
  document.getElementById('scanner-result').style.display = 'none';
  const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
  if (isMobile) {
    document.getElementById('scanner-photo-area').style.display = 'block';
  } else {
    setStatus('scanner-status', '&#128247; Point at a barcode or QR code');
  }
}



function setStatus(id, html) {
  const el = document.getElementById(id);
  if (el) el.innerHTML = html;
}

// ‚îÄ‚îÄ BARCODE SCANNER ‚îÄ‚îÄ
let scannerStream = null;
let scannerInterval = null;
let barcodeDetector = null;
let _barcodeFood = null; // food data from barcode lookup

async function openScanner() {
  document.getElementById('scanner-panel').style.display = 'block';
  document.getElementById('scanner-panel').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  document.getElementById('scanner-result').style.display = 'none';
  _barcodeFood = null;

  const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

  if (isMobile) {
    // On mobile, show the photo-capture option instead of live stream
    document.getElementById('scanner-cam-area').style.display = 'none';
    document.getElementById('scanner-photo-area').style.display = 'block';
    return;
  }

  // Desktop: try live camera + BarcodeDetector / ZXing
  document.getElementById('scanner-cam-area').style.display = 'block';
  document.getElementById('scanner-photo-area').style.display = 'none';
  setStatus('scanner-status', '<div class="spinner"></div>&nbsp; Requesting camera access...');

  try {
    scannerStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
    });
    const video = document.getElementById('scanner-video');
    video.srcObject = scannerStream;
    await video.play();
    setStatus('scanner-status', '&#128247; Camera ready ‚Äî point at a barcode or QR code');

    if ('BarcodeDetector' in window) {
      barcodeDetector = new BarcodeDetector({ formats: ['ean_13','ean_8','upc_a','upc_e','code_128','code_39','qr_code','data_matrix','aztec'] });
      startNativeScanning(video);
    } else {
      setStatus('scanner-status', '<div class="spinner"></div>&nbsp; Loading barcode library...');
      await loadZXing();
    }
  } catch(e) {
    // Fall back to photo capture if camera fails
    document.getElementById('scanner-cam-area').style.display = 'none';
    document.getElementById('scanner-photo-area').style.display = 'block';
    setStatus('scanner-status', e.name === 'NotAllowedError'
      ? '&#128683; Camera permission denied ‚Äî use photo capture below'
      : '&#9888; Camera unavailable ‚Äî use photo capture below');
  }
}

// ‚îÄ‚îÄ Native BarcodeDetector (Chrome/Android) ‚îÄ‚îÄ
function startNativeScanning(video) {
  clearInterval(scannerInterval);
  scannerInterval = setInterval(async () => {
    if (!barcodeDetector || video.readyState < 2) return;
    try {
      const barcodes = await barcodeDetector.detect(video);
      if (barcodes.length > 0) {
        const code = barcodes[0].rawValue;
        clearInterval(scannerInterval);
        setStatus('scanner-status', '&#10003; Code detected: ' + code);
        await lookupBarcode(code);
      }
    } catch(e) {}
  }, 300);
}

// ‚îÄ‚îÄ ZXing fallback (desktop) ‚îÄ‚îÄ
async function loadZXing() {
  return new Promise((resolve, reject) => {
    if (window.ZXing) { resolve(); startZXingScanning(); return; }
    const s = document.createElement('script');
    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/zxing-js/0.19.1/zxing.min.js';
    s.onload = () => { resolve(); startZXingScanning(); };
    s.onerror = () => {
      setStatus('scanner-status', '&#9888; Barcode library failed ‚Äî use manual entry below.');
      reject();
    };
    document.head.appendChild(s);
  });
}

function startZXingScanning() {
  try {
    const codeReader = new ZXing.BrowserMultiFormatReader();
    const video = document.getElementById('scanner-video');
    setStatus('scanner-status', '&#128247; Scanning ‚Äî point at a barcode or QR code');
    codeReader.decodeFromStream(scannerStream, video, (result, err) => {
      if (result) {
        codeReader.reset();
        const code = result.getText();
        setStatus('scanner-status', '&#10003; Code detected: ' + code);
        lookupBarcode(code);
      }
    });
    window._zxingReader = codeReader;
  } catch(e) {
    setStatus('scanner-status', '&#9888; Scanner error ‚Äî use manual entry below.');
  }
}

// ‚îÄ‚îÄ Mobile: open native camera to photograph barcode ‚îÄ‚îÄ
function openBarcodeCamera() {
  let input = document.getElementById('_barcode_cam_input');
  if (!input) {
    input = document.createElement('input');
    input.type = 'file';
    input.id = '_barcode_cam_input';
    input.accept = 'image/*';
    input.setAttribute('capture', 'environment');
    input.style.display = 'none';
    input.addEventListener('change', async function(e) {
      const file = e.target.files[0];
      if (!file) return;
      input.value = '';
      // Show scanning state
      document.getElementById('scanner-photo-area').style.display = 'none';
      const resultEl = document.getElementById('scanner-result');
      const innerEl  = document.getElementById('scanner-result-inner');
      resultEl.style.display = 'block';
      innerEl.innerHTML = '<div style="text-align:center;padding:20px 0;">'
        + '<div class="spinner" style="width:32px;height:32px;border-width:3px;margin:0 auto 12px;"></div>'
        + '<div style="font-weight:700;font-size:15px;margin-bottom:4px;">Reading barcode...</div>'
        + '<div style="font-size:12px;color:var(--text-muted);">AI is identifying the product</div>'
        + '</div>';

      // Try BarcodeDetector on the image first (works in Chrome on Android)
      try {
        if ('BarcodeDetector' in window) {
          const bd = new BarcodeDetector({ formats: ['ean_13','ean_8','upc_a','upc_e','code_128','code_39','qr_code','data_matrix','aztec'] });
          const img = new Image();
          const blobUrl = URL.createObjectURL(file);
          await new Promise(r => { img.onload = r; img.src = blobUrl; });
          const barcodes = await bd.detect(img);
          URL.revokeObjectURL(blobUrl);
          if (barcodes.length > 0) {
            const code = barcodes[0].rawValue;
            innerEl.innerHTML = '<div style="text-align:center;padding:8px 0;font-size:13px;color:var(--green);">‚úì Barcode: ' + escHtml(code) + '</div>';
            await lookupBarcode(code);
            return;
          }
        }
      } catch(e2) {}

      // Fallback: send image to AI vision to read the barcode
      const reader = new FileReader();
      reader.onload = async function(ev) {
        const b64 = ev.target.result.split(',')[1];
        await readBarcodeWithAI(b64, innerEl);
      };
      reader.readAsDataURL(file);
    });
    document.body.appendChild(input);
  }
  input.click();
}

// ‚îÄ‚îÄ AI vision fallback to read barcode from photo ‚îÄ‚îÄ
async function readBarcodeWithAI(b64, statusEl) {
  const apiAuth = getUserApiKey();

  const prompt = 'Look at this image. Find the barcode or QR code number printed on the product. Respond with ONLY the barcode number digits (e.g. 5000159407236), nothing else. If you cannot find a barcode, respond with exactly: NOT_FOUND';
  try {
    let code = '';
    if (apiAuth.provider === 'claude') {
      const res = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: { 'Content-Type':'application/json', 'x-api-key':apiAuth.key, 'anthropic-version':'2023-06-01', 'anthropic-dangerous-direct-browser-access':'true' },
        body: JSON.stringify({ model:'claude-opus-4-6', max_tokens:50, messages:[{ role:'user', content:[
          { type:'image', source:{ type:'base64', media_type:'image/jpeg', data:b64 } },
          { type:'text', text:prompt }
        ]}]})
      });
      const d = await res.json(); code = (d.content?.[0]?.text || '').trim();
    } else {
      const res = await openAIFetch('/v1/chat/completions', {
        body: JSON.stringify({ model:'gpt-4o', max_tokens:50, messages:[{ role:'user', content:[
          { type:'image_url', image_url:{ url:'data:image/jpeg;base64,'+b64 } },
          { type:'text', text:prompt }
        ]}]})
      });
      const d = await res.json(); code = (d.choices?.[0]?.message?.content || '').trim();
    }
    code = code.replace(/\D/g,'');
    if (!code || code.length < 6) {
      if (statusEl) statusEl.innerHTML = '<div style="color:var(--red);font-size:13px;padding:8px 0;">‚ùå Could not read barcode from photo. Try better lighting or enter it manually below.</div>'
        + '<button class="btn btn-outline btn-sm" onclick="openBarcodeCamera()" style="margin-top:8px;">üì∑ Try Again</button>';
      return;
    }
    if (statusEl) statusEl.innerHTML = '<div style="font-size:13px;color:var(--green);padding:4px 0;">‚úì Barcode: ' + code + '</div>';
    await lookupBarcode(code);
  } catch(e) {
    if (statusEl) statusEl.innerHTML = '<div style="color:var(--red);font-size:13px;">‚ùå ' + escHtml(e.message) + '</div>';
  }
}

function closeScanner() {
  clearInterval(scannerInterval);
  if (window._zxingReader) { try { window._zxingReader.reset(); } catch(e) {} window._zxingReader = null; }
  if (scannerStream) { scannerStream.getTracks().forEach(t => t.stop()); scannerStream = null; }
  document.getElementById('scanner-panel').style.display = 'none';
  document.getElementById('scanner-video').srcObject = null;
  _barcodeFood = null;
}

function selectFood(idx) {
  const f = window._searchResults[idx];
  selectedFood = { ...f };
  document.getElementById('search-dropdown').style.display = 'none';
  document.getElementById('food-search-input').value = '';
  openAddModal();
}

function openAddModal() {
  if (!selectedFood) return;
  document.getElementById('modal-food-name').textContent = selectedFood.name.substring(0, 50);
  document.getElementById('modal-food-brand').textContent = (selectedFood.brand || 'Unknown brand') + ' ¬∑ per 100g';
  document.getElementById('modal-qty').value = 100;
  updateModalMacros();
  document.getElementById('add-food-modal').classList.add('open');
}

function updateModalMacros() {
  if (!selectedFood) return;
  const qty = parseFloat(document.getElementById('modal-qty').value) || 100;
  const f = qty / 100;
  document.getElementById('modal-cals').textContent = Math.round(selectedFood.kcal * f);
  document.getElementById('modal-protein').textContent = Math.round(selectedFood.protein * f * 10) / 10 + 'g';
  document.getElementById('modal-carbs').textContent = Math.round(selectedFood.carbs * f * 10) / 10 + 'g';
  document.getElementById('modal-fat').textContent = Math.round(selectedFood.fat * f * 10) / 10 + 'g';
}

function confirmAddFood() {
  if (!selectedFood) return;
  const meal = document.getElementById('modal-meal').value;
  const qty = parseFloat(document.getElementById('modal-qty').value) || 100;
  const u = allUsers[currentUser];
  if (!u.foodLog) u.foodLog = {};
  if (!u.foodLog[currentLogDate]) u.foodLog[currentLogDate] = {};
  if (!u.foodLog[currentLogDate][meal]) u.foodLog[currentLogDate][meal] = [];
  u.foodLog[currentLogDate][meal].push({ ...selectedFood, qty });
  saveStorage();
  closeModal();
  renderFoodLog();
  // Auto-sync to sheets if connected
  if (gSheetsConfig && gSheetsConfig.connected) syncEntryToSheets(selectedFood, meal, qty);
}

function closeModal() {
  document.getElementById('add-food-modal').classList.remove('open');
  selectedFood = null;
}

// ‚îÄ‚îÄ MANUAL FOOD ENTRY ‚îÄ‚îÄ
function openManualEntry() {
  // Clear all fields
  ['mf-name','mf-brand','mf-kcal','mf-protein','mf-carbs','mf-fat',
   'mf-fiber','mf-sugar','mf-sodium'].forEach(id => {
    document.getElementById(id).value = '';
  });
  document.getElementById('mf-serving').value = '100';
  document.getElementById('mf-serving-unit').value = 'g';
  document.getElementById('mf-servings').value = '1';
  document.getElementById('mf-meal').value = 'breakfast';
  document.getElementById('mf-error').style.display = 'none';
  document.getElementById('mf-preview').style.display = 'none';
  document.getElementById('manual-food-modal').classList.add('open');
  setTimeout(() => document.getElementById('mf-name').focus(), 100);
}

function closeManualModal() {
  document.getElementById('manual-food-modal').classList.remove('open');
}

function previewManualMacros() {
  const kcal    = parseFloat(document.getElementById('mf-kcal').value)    || 0;
  const protein = parseFloat(document.getElementById('mf-protein').value) || 0;
  const carbs   = parseFloat(document.getElementById('mf-carbs').value)   || 0;
  const fat     = parseFloat(document.getElementById('mf-fat').value)     || 0;
  const srvs    = parseFloat(document.getElementById('mf-servings').value) || 1;

  if (kcal || protein || carbs || fat) {
    document.getElementById('mf-preview').style.display = 'block';
    document.getElementById('mf-prev-cals').textContent    = Math.round(kcal * srvs);
    document.getElementById('mf-prev-protein').textContent = Math.round(protein * srvs * 10) / 10 + 'g';
    document.getElementById('mf-prev-carbs').textContent   = Math.round(carbs * srvs * 10) / 10 + 'g';
    document.getElementById('mf-prev-fat').textContent     = Math.round(fat * srvs * 10) / 10 + 'g';
  } else {
    document.getElementById('mf-preview').style.display = 'none';
  }
}

function confirmManualFood() {
  const name    = document.getElementById('mf-name').value.trim();
  const kcal    = parseFloat(document.getElementById('mf-kcal').value) || 0;
  const errEl   = document.getElementById('mf-error');

  if (!name) {
    errEl.textContent = 'Please enter a food name.';
    errEl.style.display = 'block';
    document.getElementById('mf-name').focus();
    return;
  }
  if (!kcal && kcal !== 0) {
    errEl.textContent = 'Please enter the calorie count (can be 0).';
    errEl.style.display = 'block';
    return;
  }
  errEl.style.display = 'none';

  const brand   = document.getElementById('mf-brand').value.trim();
  const protein = parseFloat(document.getElementById('mf-protein').value) || 0;
  const carbs   = parseFloat(document.getElementById('mf-carbs').value)   || 0;
  const fat     = parseFloat(document.getElementById('mf-fat').value)     || 0;
  const fiber   = parseFloat(document.getElementById('mf-fiber').value)   || 0;
  const sugar   = parseFloat(document.getElementById('mf-sugar').value)   || 0;
  const sodium  = parseFloat(document.getElementById('mf-sodium').value)  || 0;
  const serving = parseFloat(document.getElementById('mf-serving').value) || 100;
  const unit    = document.getElementById('mf-serving-unit').value;
  const srvs    = parseFloat(document.getElementById('mf-servings').value) || 1;
  const meal    = document.getElementById('mf-meal').value;

  // Store with _manual flag; qty = serving * servings for display
  // We store kcal/macros as-per-serving-size, qty = total grams logged
  const u = allUsers[currentUser];
  if (!u.foodLog) u.foodLog = {};
  if (!u.foodLog[currentLogDate]) u.foodLog[currentLogDate] = {};
  if (!u.foodLog[currentLogDate][meal]) u.foodLog[currentLogDate][meal] = [];

  // Normalize: store per-100g equivalent so existing render logic works
  // qty will be stored as serving*srvs, kcal/macros per 100g equivalent
  const totalQty = serving * srvs;
  const per100   = totalQty > 0 ? (100 / totalQty) : 1;

  const entry = {
    name:    name,
    brand:   brand,
    kcal:    kcal    * per100,
    protein: protein * per100,
    carbs:   carbs   * per100,
    fat:     fat     * per100,
    fiber:   fiber   * per100,
    sugar:   sugar   * per100,
    sodium:  sodium  * per100,
    qty:     totalQty,
    unit:    unit,
    _manual: true
  };

  u.foodLog[currentLogDate][meal].push(entry);
  saveStorage();
  closeManualModal();
  renderFoodLog();
  if (gSheetsConfig && gSheetsConfig.connected) syncEntryToSheets(entry, meal, totalQty);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI PLAN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function loadAIPage() {
  loadOverrideKeyUI();
  const u = allUsers[currentUser];
  if (!u) return;
  document.getElementById('ai-age').value    = u.age    || '';
  document.getElementById('ai-gender').value = u.gender || 'male';
  document.getElementById('ai-height').value = u.height || '';
  document.getElementById('ai-weight').value = u.weight || '';
  const goalMap = { lose_weight:'lose weight', build_muscle:'build muscle', maintain:'maintain weight', improve_fitness:'improve overall fitness' };
  document.getElementById('ai-goal').value = goalMap[u.goal] || 'lose weight';

  if (u.aiPlan) {
    // Clear any old error messages that got saved as aiPlan
    const looksLikeError = u.aiPlan.includes('API Key') || u.aiPlan.includes('api-key') || u.aiPlan.includes('Failed to fetch') || u.aiPlan.includes('Could not') || (u.aiPlan.trim().startsWith('<div') && u.aiPlan.length < 400);
    if (looksLikeError) {
      u.aiPlan = '';
      saveStorage();
    } else {
      const po = document.getElementById('plan-output');
      po.innerHTML = renderPlanHTML(u.aiPlan);
      po.style.display = 'block';
      const pa = document.getElementById('plan-actions');
      if (pa) pa.style.display = 'flex';
      const banner = document.getElementById('goals-adjusted-banner');
      if (banner && u.cals_goal) {
        banner.style.display = 'block';
        banner.innerHTML = '<div style="background:rgba(74,222,128,0.08);border:1px solid rgba(74,222,128,0.25);border-radius:10px;padding:12px 16px;margin-top:12px;font-size:12px;color:var(--green);">&#x2705; Goals applied from this plan ‚Äî Calories: ' + u.cals_goal + ' ¬∑ Protein: ' + u.protein_goal + 'g ¬∑ Carbs: ' + u.carbs_goal + 'g ¬∑ Fat: ' + u.fat_goal + 'g</div>';
      }
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WEEKLY PLAN ‚Äî parse AI plan + calendar export
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _wpDays     = [];   // parsed day objects [{day, date, meals:[], workout:{}}]
let _wpSelected = 0;    // currently selected day index (0=Mon)

const WP_DAY_NAMES = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
const WP_MEAL_ICONS = { breakfast:'üåÖ', lunch:'‚òÄÔ∏è', dinner:'üåô', snack:'üçé', 'post-workout':'‚ö°', default:'üçΩÔ∏è' };

function loadWeeklyPlan() {
  const u = allUsers[currentUser];
  if (!u) return;
  const plan = u.aiPlan || '';
  const noEl = document.getElementById('wp-no-plan');
  const loadEl = document.getElementById('wp-plan-loaded');
  if (!plan) {
    if (noEl) noEl.style.display = 'block';
    if (loadEl) loadEl.style.display = 'none';
    return;
  }
  if (noEl) noEl.style.display = 'none';
  if (loadEl) loadEl.style.display = 'block';
  _wpDays = parseWeekFromPlan(plan);
  renderDayStrip();
  selectWpDay(0);
}

function parseWeekFromPlan(planText) {
  // Build a 7-day array by looking for day-labelled sections in the plan
  const days = WP_DAY_NAMES.map((name, i) => {
    const today = new Date();
    // Find next Monday as start of week
    const monday = new Date(today);
    const dayOfWeek = today.getDay(); // 0=Sun
    const diff = dayOfWeek === 0 ? 1 : (8 - dayOfWeek) % 7 || 7;
    monday.setDate(today.getDate() + (dayOfWeek === 1 ? 0 : diff === 7 ? 0 : diff));
    const dayDate = new Date(monday);
    dayDate.setDate(monday.getDate() + i);
    return { day: name, date: dayDate, meals: [], workout: null, rawText: '' };
  });

  // Try to extract per-day sections
  // Pattern: "Day 1", "Day 2", "Monday", "Tuesday" etc.
  const dayPatterns = [
    /day\s+(\d)/gi,
    /\b(monday|tuesday|wednesday|thursday|friday|saturday|sunday)\b/gi
  ];

  const dayIndexMap = {
    'monday':0,'tuesday':1,'wednesday':2,'thursday':3,
    'friday':4,'saturday':5,'sunday':6,
    '1':0,'2':1,'3':2,'4':3,'5':4,'6':5,'7':6
  };

  // Split plan into lines for analysis
  const lines = planText.split('\n');
  let currentDayIdx = -1;
  const dayTexts = { 0:'', 1:'', 2:'', 3:'', 4:'', 5:'', 6:'' };

  for (const line of lines) {
    const lower = line.toLowerCase().trim();

    // Check if this line marks a new day
    let matched = false;
    for (const [key, idx] of Object.entries(dayIndexMap)) {
      if (lower.includes('day ' + key) || lower.includes(key + ':') ||
          (lower.startsWith(key) && lower.length < 30)) {
        currentDayIdx = idx;
        matched = true;
        break;
      }
    }

    if (currentDayIdx >= 0) {
      dayTexts[currentDayIdx] += line + '\n';
    }
  }

  // If we couldn't extract by day, divide the plan roughly into 7 equal sections
  const hasAnyContent = Object.values(dayTexts).some(t => t.trim().length > 50);
  if (!hasAnyContent) {
    const chunks = Math.floor(lines.length / 7);
    for (let i = 0; i < 7; i++) {
      dayTexts[i] = lines.slice(i * chunks, (i + 1) * chunks).join('\n');
    }
  }

  // Parse meals and workout from each day's text
  days.forEach((day, i) => {
    day.rawText = dayTexts[i] || '';
    day.meals   = parseMealsFromText(dayTexts[i] || planText, i);
    day.workout = parseWorkoutFromText(dayTexts[i] || planText, i, day.day);
  });

  return days;
}

function parseMealsFromText(text, dayIdx, fullPlan) {
  const meals = [];
  const lines  = text.split('\n');
  const mealTypes = ['breakfast','lunch','dinner','snack','post-workout','pre-workout'];

  for (const line of lines) {
    const lower = line.toLowerCase();
    for (const mt of mealTypes) {
      if (lower.includes(mt)) {
        // Extract anything after the colon if present, else use the rest of the line
        const colonIdx = line.indexOf(':');
        let description = colonIdx >= 0 ? line.slice(colonIdx + 1).trim() : line.replace(/breakfast|lunch|dinner|snack|post.workout|pre.workout/gi, '').trim();
        description = description.replace(/^[\s\-‚Äì*‚Ä¢]+/, '').trim();
        if (description.length > 3) {
          // Parse macros from same or next line
          const macros = extractMacros(line);
          meals.push({ type: mt, name: description.slice(0, 80), macros });
        }
        break;
      }
    }
  }

  // Dedupe by type (keep first of each)
  const seen = new Set();
  return meals.filter(m => { if (seen.has(m.type)) return false; seen.add(m.type); return true; });
}

function parseWorkoutFromText(text, dayIdx, dayName) {
  const lower = text.toLowerCase();
  // Rest day detection
  if (/rest\s*day|active recovery|off day|no workout|recovery day/i.test(text)) {
    return { type: 'rest', description: 'Rest / Active Recovery', exercises: [] };
  }
  // Look for workout type
  const types = ['weightlifting','strength','cardio','hiit','yoga','swimming','cycling','running','pilates','crossfit'];
  let wType = 'Training';
  for (const t of types) {
    if (lower.includes(t)) { wType = t.charAt(0).toUpperCase() + t.slice(1); break; }
  }
  // Extract exercises (lines with sets/reps)
  const exercises = [];
  const lines = text.split('\n');
  for (const line of lines) {
    if (/(\d+\s*x\s*\d+|\d+\s*sets?|\d+\s*reps?)/i.test(line)) {
      const ex = line.replace(/^[\s\-‚Äì*‚Ä¢\d\.]+/, '').trim();
      if (ex.length > 3 && ex.length < 100) exercises.push(ex);
    }
  }
  // Look for a focus area
  const focusMatch = text.match(/focus[:\s]+([^\n]+)/i) || text.match(/(chest|back|legs?|shoulders?|arms?|full body|upper body|lower body)\s*day/i);
  const focus = focusMatch ? focusMatch[1].trim().slice(0, 40) : '';
  return { type: wType, focus, exercises: exercises.slice(0, 8), description: focus || wType + ' session' };
}

function extractMacros(text) {
  const calMatch = text.match(/(\d{2,4})\s*(?:kcal|cal|calories)/i);
  const proMatch = text.match(/(\d+)\s*g?\s*protein/i);
  const carbMatch = text.match(/(\d+)\s*g?\s*carb/i);
  const fatMatch  = text.match(/(\d+)\s*g?\s*fat/i);
  return {
    kcal: calMatch  ? parseInt(calMatch[1])  : null,
    protein: proMatch ? parseInt(proMatch[1]) : null,
    carbs:  carbMatch ? parseInt(carbMatch[1]) : null,
    fat:    fatMatch  ? parseInt(fatMatch[1])  : null,
  };
}

function renderDayStrip() {
  const strip = document.getElementById('wp-day-strip');
  if (!strip) return;
  const todayStr = new Date().toDateString();
  strip.innerHTML = _wpDays.map((d, i) => {
    const isToday = d.date.toDateString() === todayStr;
    const hasMeals = d.meals.length > 0;
    return '<div class="wp-day-btn' + (i === _wpSelected ? ' active' : '') + (isToday ? ' today' : '') + '" onclick="selectWpDay(' + i + ')" id="wp-day-' + i + '">'
      + '<div class="wp-day-name">' + d.day.slice(0, 3) + '</div>'
      + '<div class="wp-day-num">' + d.date.getDate() + '</div>'
      + (hasMeals ? '<div class="wp-day-dot"></div>' : '')
      + '</div>';
  }).join('');
}

function selectWpDay(idx) {
  _wpSelected = idx;
  // Update strip active state
  document.querySelectorAll('.wp-day-btn').forEach((btn, i) => {
    btn.classList.toggle('active', i === idx);
  });
  renderWpDayDetail(idx);
}

function renderWpDayDetail(idx) {
  const day = _wpDays[idx];
  if (!day) return;

  const titleEl = document.getElementById('wp-day-title');
  const dateEl  = document.getElementById('wp-day-date');
  const mealsEl = document.getElementById('wp-meals-content');
  const wkoutEl = document.getElementById('wp-workout-content');

  if (titleEl) titleEl.textContent = day.day;
  if (dateEl)  dateEl.textContent  = day.date.toLocaleDateString('en-US', { month:'long', day:'numeric', year:'numeric' });

  // Meals
  if (mealsEl) {
    if (!day.meals.length) {
      mealsEl.innerHTML = '<div style="color:var(--text-muted);font-size:13px;padding:8px 0;">No specific meals found for this day. Check your full AI plan for details.</div>';
    } else {
      mealsEl.innerHTML = day.meals.map(m => {
        const icon = WP_MEAL_ICONS[m.type] || WP_MEAL_ICONS.default;
        const macroStr = m.macros.kcal ? (m.macros.kcal + ' kcal' + (m.macros.protein ? ' ¬∑ ' + m.macros.protein + 'g protein' : '')) : '';
        return '<div class="wp-meal-row">'
          + '<div class="wp-meal-icon">' + icon + '</div>'
          + '<div class="wp-meal-info">'
          + '<div class="wp-meal-type">' + m.type + '</div>'
          + '<div class="wp-meal-name">' + escHtml(m.name) + '</div>'
          + (macroStr ? '<div class="wp-meal-macros">' + macroStr + '</div>' : '')
          + '</div></div>';
      }).join('');
    }
  }

  // Workout
  if (wkoutEl) {
    if (!day.workout || day.workout.type === 'rest') {
      wkoutEl.innerHTML = '<div class="wp-rest-badge">üò¥ Rest Day ‚Äî Focus on recovery</div>';
    } else {
      const w = day.workout;
      wkoutEl.innerHTML = '<div style="margin-bottom:8px;">'
        + '<span class="wp-workout-chip">üèãÔ∏è ' + escHtml(w.type) + '</span>'
        + (w.focus ? '<span class="wp-workout-chip">üéØ ' + escHtml(w.focus) + '</span>' : '')
        + '</div>'
        + (w.exercises.length
          ? '<div style="font-size:12px;color:var(--text-dim);">'
            + w.exercises.map(ex => '<div style="padding:4px 0;border-bottom:1px solid var(--border);">‚Ä¢ ' + escHtml(ex) + '</div>').join('')
            + '</div>'
          : '<div style="font-size:12px;color:var(--text-muted);">See your full AI plan for detailed exercises.</div>');
    }
  }
}

function addDayToCalendar(provider) {
  const day = _wpDays[_wpSelected];
  if (!day) return;

  const dateStr = day.date.toISOString().slice(0, 10).replace(/-/g, '');
  const title   = day.day + ': ' + (day.workout && day.workout.type !== 'rest' ? day.workout.type + ' + ' : 'Rest + ') + 'Meal Plan';

  const mealsSummary = day.meals.length
    ? day.meals.map(m => m.type.charAt(0).toUpperCase() + m.type.slice(1) + ': ' + m.name).join('\n')
    : 'See AI plan for meal details.';

  const workoutSummary = (day.workout && day.workout.type !== 'rest')
    ? 'Workout: ' + day.workout.type + (day.workout.focus ? ' ‚Äî ' + day.workout.focus : '')
      + (day.workout.exercises.length ? '\n' + day.workout.exercises.slice(0,5).map(e => '‚Ä¢ '+e).join('\n') : '')
    : 'Rest Day';

  const description = 'MEALS\n' + mealsSummary + '\n\n' + workoutSummary + '\n\nGenerated by Chingone Life Tracker';

  if (provider === 'google') {
    const startTime = dateStr + 'T070000';
    const endTime   = dateStr + 'T073000';
    const url = 'https://calendar.google.com/calendar/render?action=TEMPLATE'
      + '&text=' + encodeURIComponent(title)
      + '&dates=' + startTime + '/' + endTime
      + '&details=' + encodeURIComponent(description)
      + '&sf=true&output=xml';
    window.open(url, '_blank');
  } else {
    downloadICS([{ date: day.date, title, description }]);
  }
}

function exportWeekToCalendar(provider) {
  if (provider === 'google') {
    // Google doesn't support bulk multi-event exports easily ‚Äî open them one by one or show instructions
    const msg = 'To add all 7 days to Google Calendar:\n\n'
      + '1. Click each day in the strip above\n'
      + '2. Tap "Google Calendar" for each\n\n'
      + 'OR: Export the .ics file and import it into Google Calendar via\nSettings ‚Üí Import & Export ‚Üí Import.';
    if (confirm(msg + '\n\nWould you like to export as .ics for bulk import instead?')) {
      exportWeekToCalendar('apple');
    }
    return;
  }
  // Build all 7 days as .ics events
  const events = _wpDays.map(day => {
    const mealsSummary = day.meals.length
      ? day.meals.map(m => m.type.charAt(0).toUpperCase() + m.type.slice(1) + ': ' + m.name).join('\\n')
      : 'See AI plan for meal details.';
    const workoutSummary = (day.workout && day.workout.type !== 'rest')
      ? 'Workout: ' + day.workout.type + (day.workout.focus ? ' - ' + day.workout.focus : '')
      : 'Rest Day';
    return {
      date: day.date,
      title: day.day + ' ‚Äî ' + (day.workout && day.workout.type !== 'rest' ? day.workout.type + ' Day' : 'Rest Day'),
      description: 'MEALS\n' + mealsSummary + '\n\n' + workoutSummary + '\n\nChingone Life Tracker'
    };
  });
  downloadICS(events);
}

function downloadICS(events) {
  const fmt = (d, allDay) => {
    if (allDay) return d.toISOString().slice(0,10).replace(/-/g,'');
    const s = new Date(d);
    s.setHours(7, 0, 0);
    return s.toISOString().replace(/[-:]/g,'').slice(0,15) + 'Z';
  };
  const fmtEnd = (d, allDay) => {
    if (allDay) {
      const e = new Date(d);
      e.setDate(e.getDate() + 1);
      return e.toISOString().slice(0,10).replace(/-/g,'');
    }
    const e = new Date(d);
    e.setHours(7, 30, 0);
    return e.toISOString().replace(/[-:]/g,'').slice(0,15) + 'Z';
  };

  let ics = 'BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//Chingone Life Tracker//EN\r\nCALSCALE:GREGORIAN\r\nMETHOD:PUBLISH\r\n';
  events.forEach(ev => {
    const uid = 'chingone-' + ev.date.toISOString().slice(0,10) + '-' + Date.now() + '@chingone';
    const desc = ev.description.replace(/\n/g, '\\n').replace(/,/g, '\\,');
    ics += 'BEGIN:VEVENT\r\n'
      + 'UID:' + uid + '\r\n'
      + 'DTSTAMP:' + new Date().toISOString().replace(/[-:]/g,'').slice(0,15) + 'Z\r\n'
      + 'DTSTART;VALUE=DATE:' + fmt(ev.date, true) + '\r\n'
      + 'DTEND;VALUE=DATE:' + fmtEnd(ev.date, true) + '\r\n'
      + 'SUMMARY:' + ev.title.replace(/,/g,'\\,') + '\r\n'
      + 'DESCRIPTION:' + desc + '\r\n'
      + 'END:VEVENT\r\n';
  });
  ics += 'END:VCALENDAR';

  const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = events.length === 1
    ? 'chingone-' + events[0].date.toISOString().slice(0,10) + '.ics'
    : 'chingone-weekly-plan.ics';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}

function printWeeklyPlan() {
  const u = allUsers[currentUser];
  if (!u || !u.aiPlan) { alert('No plan generated yet.'); return; }
  if (!_wpDays.length) { alert('Please open Weekly Plan first to load your plan.'); return; }

  const date   = new Date().toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
  const weekStart = _wpDays[0]?.date?.toLocaleDateString('en-US', { month:'short', day:'numeric' }) || '';
  const weekEnd   = _wpDays[6]?.date?.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' }) || '';

  const dayCards = _wpDays.map(day => {
    const mealRows = day.meals.length
      ? day.meals.map(m => {
          const macroStr = m.macros.kcal ? m.macros.kcal + ' kcal' + (m.macros.protein ? ' ¬∑ ' + m.macros.protein + 'g protein' : '') : '';
          return '<tr><td style="padding:4px 8px;font-size:11px;font-weight:600;color:#16a34a;text-transform:capitalize;width:90px;">' + m.type + '</td>'
            + '<td style="padding:4px 8px;font-size:11px;color:#333;">' + m.name + '</td>'
            + '<td style="padding:4px 8px;font-size:10px;color:#888;text-align:right;">' + macroStr + '</td></tr>';
        }).join('')
      : '<tr><td colspan="3" style="padding:4px 8px;font-size:11px;color:#aaa;">See full plan for meal details.</td></tr>';

    const workoutHtml = (!day.workout || day.workout.type === 'rest')
      ? '<span style="color:#888;font-size:11px;">üò¥ Rest Day</span>'
      : '<strong style="color:#166534;font-size:11px;">' + day.workout.type + (day.workout.focus ? ' ‚Äî ' + day.workout.focus : '') + '</strong>'
        + (day.workout.exercises.length
          ? '<div style="margin-top:4px;">' + day.workout.exercises.slice(0,5).map(e => '<span style="font-size:10px;color:#555;">‚Ä¢ ' + e + '</span><br>').join('') + '</div>'
          : '');

    return '<div style="break-inside:avoid;margin-bottom:16px;border:1px solid #e5e7eb;border-radius:10px;overflow:hidden;">'
      + '<div style="padding:8px 12px;background:linear-gradient(135deg,#f0fdf4,#dcfce7);border-bottom:1px solid #bbf7d0;display:flex;justify-content:space-between;align-items:center;">'
      + '<strong style="font-size:13px;color:#0d0f0e;">' + day.day + '</strong>'
      + '<span style="font-size:11px;color:#6b7280;">' + day.date.toLocaleDateString('en-US',{month:'short',day:'numeric'}) + '</span>'
      + '</div>'
      + '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0;">'
      + '<div style="padding:10px 12px;border-right:1px solid #e5e7eb;">'
      + '<div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:#6b7280;margin-bottom:6px;">üçΩÔ∏è Meals</div>'
      + '<table style="width:100%;border-collapse:collapse;">' + mealRows + '</table></div>'
      + '<div style="padding:10px 12px;">'
      + '<div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:#6b7280;margin-bottom:6px;">üèãÔ∏è Workout</div>'
      + workoutHtml + '</div>'
      + '</div></div>';
  }).join('');

  const html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Weekly Plan</title>'
    + '<style>@page{margin:15mm 14mm;size:A4}body{font-family:Arial,sans-serif;background:#fff;margin:0;padding:0}'
    + '.header{border-bottom:3px solid #0d0f0e;padding-bottom:12px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:flex-start}'
    + '.logo{font-family:Arial Black,sans-serif;font-size:20px;letter-spacing:1px}'
    + '.logo span{color:#4ade80}</style></head><body>'
    + '<div class="header"><div><div class="logo">CHINGONE <span>LIFE TRACKER</span></div>'
    + '<div style="font-size:11px;color:#888;margin-top:4px;">Weekly Fitness Plan &nbsp;¬∑&nbsp; <span style="padding:2px 8px;background:#f0fdf4;border:1px solid #86efac;border-radius:10px;font-size:10px;color:#16a34a;font-weight:600;">AI Generated</span></div></div>'
    + '<div style="text-align:right;font-size:11px;color:#666;"><div style="font-weight:700;font-size:13px;color:#0d0f0e;">' + (u.name || 'User') + '</div>'
    + '<div>' + weekStart + ' ‚Äì ' + weekEnd + '</div></div></div>'
    + dayCards
    + '<div style="margin-top:16px;padding-top:10px;border-top:1px solid #e5e7eb;display:flex;justify-content:space-between;font-size:10px;color:#aaa;">'
    + '<span>Chingone Life Tracker</span><span>Printed ' + date + '</span></div>'
    + '</body></html>';

  const win = window.open('', '_blank');
  if (!win) { alert('Please allow popups to print.'); return; }
  win.document.write(html);
  win.document.close();
  win.onload = () => { win.focus(); win.print(); };
}

function printAIPlan() {
  const planText = (allUsers[currentUser] || {}).aiPlan || document.getElementById('plan-output').textContent;
  if (!planText || planText.includes('is crafting')) return;

  const u      = allUsers[currentUser] || {};
  const aiName = 'ChatGPT (OpenAI)';
  const date   = new Date().toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });

  // Convert plain text plan to styled HTML paragraphs
  const htmlLines = planText.split('\n').map(line => {
    const t = line.trim();
    if (!t) return '<div style="height:6px"></div>';
    if (/^#{1,3}\s/.test(t)) {
      return `<h2 style="font-family:Arial Black,sans-serif;font-size:15px;color:#0d0f0e;margin:18px 0 6px;text-transform:uppercase;letter-spacing:0.5px;border-bottom:2px solid #4ade80;padding-bottom:4px;">${t.replace(/^#+\s*/, '')}</h2>`;
    }
    if (/^\d+\.\s/.test(t)) {
      return `<h2 style="font-family:Arial Black,sans-serif;font-size:15px;color:#0d0f0e;margin:18px 0 6px;text-transform:uppercase;letter-spacing:0.5px;border-bottom:2px solid #4ade80;padding-bottom:4px;">${t}</h2>`;
    }
    if (t.startsWith('‚Ä¢') || t.startsWith('-') || t.startsWith('*')) {
      return `<div style="padding:2px 0 2px 16px;font-size:12px;color:#444;line-height:1.6;position:relative;">
        <span style="position:absolute;left:4px;color:#4ade80;">‚Ä¢</span>${t.replace(/^[‚Ä¢\-*]\s*/, '')}</div>`;
    }
    if (/^[A-Z][A-Z\s:]+:/.test(t) || t.endsWith(':')) {
      return `<div style="font-weight:700;font-size:12px;color:#0d0f0e;margin-top:10px;margin-bottom:2px;">${t}</div>`;
    }
    return `<p style="font-size:12px;color:#444;line-height:1.7;margin:3px 0;">${t}</p>`;
  }).join('');

  const printHTML = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Fitness Plan ‚Äî ${u.name || 'User'}</title>
<style>
  @page { margin: 18mm 16mm; size: A4; }
  body { font-family: 'DM Sans', Arial, sans-serif; background:#fff; color:#1a1a1a; margin:0; padding:0; }
  .header { display:flex; justify-content:space-between; align-items:flex-start; border-bottom:3px solid #0d0f0e; padding-bottom:12px; margin-bottom:16px; }
  .logo { font-family:Arial Black,sans-serif; font-size:22px; letter-spacing:1px; color:#0d0f0e; }
  .logo span { color:#4ade80; }
  .user-block { text-align:right; font-size:11px; color:#666; line-height:1.6; }
  .stats-row { display:flex; gap:10px; margin-bottom:14px; flex-wrap:wrap; }
  .stat-pill { background:#f1fdf5; border:1px solid #86efac; border-radius:8px; padding:6px 12px; font-size:11px; color:#166534; font-weight:600; }
  .plan-body { font-size:12px; }
  .footer { margin-top:20px; padding-top:10px; border-top:1px solid #e5e7eb; display:flex; justify-content:space-between; font-size:10px; color:#aaa; }
  .ai-badge { display:inline-block; padding:2px 8px; background:#f0fdf4; border:1px solid #86efac; border-radius:10px; font-size:10px; color:#16a34a; font-weight:600; }
</style>
</head>
<body>
  <div class="header">
    <div>
      <div class="logo">CHINGONE <span>LIFE TRACKER</span></div>
      <div style="font-size:11px;color:#888;margin-top:4px;">Personalised Fitness Plan &nbsp;¬∑&nbsp; <span class="ai-badge">Generated by ${aiName}</span></div>
    </div>
    <div class="user-block">
      <div style="font-weight:700;font-size:13px;color:#0d0f0e;">${u.name || 'User'}</div>
      <div>${date}</div>
    </div>
  </div>

  <div class="stats-row">
    ${u.age    ? `<span class="stat-pill">Age: ${u.age}</span>` : ''}
    ${u.weight ? `<span class="stat-pill">Weight: ${u.weight} lbs</span>` : ''}
    ${u.height ? `<span class="stat-pill">Height: ${u.height}"</span>` : ''}
    ${u.goal   ? `<span class="stat-pill">Goal: ${u.goal.replace(/_/g,' ')}</span>` : ''}
    ${u.cals_goal ? `<span class="stat-pill">Calories: ${u.cals_goal} kcal/day</span>` : ''}
    ${u.protein_goal ? `<span class="stat-pill">Protein: ${u.protein_goal}g</span>` : ''}
  </div>

  <div class="plan-body">${htmlLines}</div>

  <div class="footer">
    <span>Chingone Life Tracker</span>
    <span>Printed ${new Date().toLocaleDateString()}</span>
  </div>
</body>
</html>`;

  const win = window.open('', '_blank');
  if (!win) { alert('Please allow popups to print the PDF.'); return; }
  win.document.write(printHTML);
  win.document.close();
  win.onload = () => { win.focus(); win.print(); };
}


function addGoalChip(btn) {
  const textarea = document.getElementById('ai-custom-goals');
  // Toggle selected state
  const isSelected = btn.classList.contains('selected');
  if (isSelected) {
    // Remove from textarea
    btn.classList.remove('selected');
    const label = btn.textContent.trim().replace(/^[\p{Emoji}\u200d\uFE0F\s]+/u, '').trim();
    textarea.value = textarea.value
      .replace('\n\u2022 ' + label, '')
      .replace('\u2022 ' + label + '\n', '')
      .replace('\u2022 ' + label, '')
      .trim();
  } else {
    // Add to textarea
    btn.classList.add('selected');
    const label = btn.textContent.trim().replace(/^[\p{Emoji}\u200d\uFE0F\s]+/u, '').trim();
    const current = textarea.value.trim();
    textarea.value = current ? current + '\n\u2022 ' + label : '\u2022 ' + label;
    textarea.focus();
    // Flash feedback
    btn.classList.add('added');
    setTimeout(() => btn.classList.remove('added'), 400);
  }
}

// ‚îÄ‚îÄ Helper: get user's saved API key (Anthropic or OpenAI) ‚îÄ‚îÄ
function openNetlify() { window.open('https://app.netlify.com/drop', '_blank'); }

// API key ‚Äî reads from localStorage if set, otherwise uses built-in
const _OPENAI_KEY = localStorage.getItem('vt_user_openai_key') || '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';
function getUserApiKey() {
  const key = localStorage.getItem('vt_user_openai_key') || _OPENAI_KEY;
  return { key, provider: 'chatgpt' };
}
function selectAIProvider() {}
function saveAIKey() {}

function saveOverrideKey() {
  const input = document.getElementById('api-key-override-input');
  const status = document.getElementById('api-key-override-status');
  const badge  = document.getElementById('api-key-saved-badge');
  const key = (input.value || '').trim();
  if (!key.startsWith('sk-')) {
    status.style.display = 'block';
    status.style.color = 'var(--red)';
    status.textContent = '‚úó Invalid key ‚Äî it should start with sk-proj-';
    return;
  }
  localStorage.setItem('vt_user_openai_key', key);
  input.value = '';
  input.placeholder = key.slice(0,8) + '...' + key.slice(-4) + ' (saved)';
  status.style.display = 'block';
  status.style.color = 'var(--green)';
  status.textContent = '‚úì Key saved! Try generating your plan now.';
  badge.style.display = 'block';
  setTimeout(() => { status.style.display = 'none'; }, 4000);
}

function loadOverrideKeyUI() {
  const saved = localStorage.getItem('vt_user_openai_key');
  if (saved) {
    const input = document.getElementById('api-key-override-input');
    const badge = document.getElementById('api-key-saved-badge');
    if (input) input.placeholder = saved.slice(0,8) + '...' + saved.slice(-4) + ' (saved)';
    if (badge) badge.style.display = 'block';
  }
}

// Central OpenAI fetch ‚Äî routes through Netlify function to avoid iOS Safari CORS blocks
async function openAIFetch(endpoint, body) {
  const userKey = localStorage.getItem('vt_user_openai_key');

  // Try our Netlify proxy first (works on all browsers including iOS Safari)
  try {
    const res = await Promise.race([
      fetch('/api/openai', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ endpoint, payload: body, userKey })
      }),
      new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), 20000))
    ]);
    if (res && res.status) return res;
  } catch(e) {
    console.warn('Netlify proxy failed:', e.message);
  }

  // Fallback: try direct (works on desktop/Android Chrome)
  const key = userKey || _OPENAI_KEY;
  const url = 'https://api.openai.com' + endpoint;
  const headers = { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + key };
  try {
    const res = await Promise.race([
      fetch(url, { method: 'POST', headers, body: JSON.stringify(body) }),
      new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), 20000))
    ]);
    if (res && res.status) return res;
  } catch(e) {
    console.warn('Direct fetch failed:', e.message);
    throw new Error('Connection failed: ' + e.message + '. Please check your internet connection.');
  }
  throw new Error('Could not connect to OpenAI. Please try again.');
}



// ‚îÄ‚îÄ Build the fitness plan prompt from form inputs ‚îÄ‚îÄ
function buildFitnessPlanPrompt() {
  const age         = document.getElementById('ai-age').value;
  const gender      = document.getElementById('ai-gender').value;
  const height      = document.getElementById('ai-height').value;
  const weight      = document.getElementById('ai-weight').value;
  const activity    = document.getElementById('ai-activity').value;
  const goal        = document.getElementById('ai-goal').value;
  const target      = document.getElementById('ai-target').value;
  const timeframe   = document.getElementById('ai-timeframe').value;
  const notes       = document.getElementById('ai-notes').value;
  const customGoals = document.getElementById('ai-custom-goals').value.trim();
  return `You are a certified personal trainer and nutritionist. Create a detailed, personalized fitness and nutrition plan:

- Age: ${age||'not specified'}, Gender: ${gender}
- Height: ${height||'not specified'} inches, Weight: ${weight||'not specified'} lbs${target ? ', Target: '+target+' lbs' : ''}
- Activity: ${activity}, Goal: ${goal}, Timeframe: ${timeframe}
${notes ? '- Notes: '+notes+'\n' : ''}${customGoals ? '- Personal goals: '+customGoals : ''}

Provide: 1) WEEKLY WORKOUT PLAN (7-day schedule, exercises/sets/reps) 2) DAILY NUTRITION PLAN (calories, macros, sample meals) 3) TIPS & MOTIVATION (3-5 actionable tips). Format with clear headings.`;
}



// ‚îÄ‚îÄ Render plan markdown to nice HTML ‚îÄ‚îÄ
function renderPlanHTML(text) {
  return text
    .split('\n')
    .map(line => {
      if (/^###\s/.test(line)) return '<h4 style="margin:16px 0 6px;font-size:14px;color:var(--green);text-transform:uppercase;letter-spacing:0.5px;">' + escHtml(line.replace(/^###\s*/,'')) + '</h4>';
      if (/^##\s/.test(line))  return '<h3 style="margin:20px 0 8px;font-size:16px;font-weight:700;color:var(--text);border-bottom:1px solid var(--border);padding-bottom:6px;">' + escHtml(line.replace(/^##\s*/,'')) + '</h3>';
      if (/^#\s/.test(line))   return '<h2 style="margin:24px 0 10px;font-size:18px;font-weight:800;color:var(--accent);">' + escHtml(line.replace(/^#\s*/,'')) + '</h2>';
      if (/^- /.test(line))    return '<div style="padding:3px 0 3px 14px;border-left:2px solid var(--border);margin:2px 0;color:var(--text-dim);">' + escHtml(line.replace(/^- /,'')) + '</div>';
      if (/^\d+\.\s/.test(line)) return '<div style="padding:4px 0;color:var(--text-dim);">' + escHtml(line) + '</div>';
      if (line.trim() === '')  return '<div style="height:8px;"></div>';
      return '<div style="padding:2px 0;color:var(--text-dim);line-height:1.7;">' + escHtml(line).replace(/\*\*(.+?)\*\*/g,'<strong style="color:var(--text);">$1</strong>') + '</div>';
    })
    .join('');
}

async function generatePlan() {
  const apiAuth = getUserApiKey();
  const output  = document.getElementById('plan-output');
  const btn     = document.getElementById('gen-plan-btn');
  const actions = document.getElementById('plan-actions');
  const prompt  = buildFitnessPlanPrompt();



  const aiLabel = apiAuth.provider === 'claude' ? 'Claude' : 'ChatGPT';
  btn.innerHTML = '<div class="spinner"></div> ' + aiLabel + ' is generating your plan...';
  btn.disabled  = true;
  output.style.display = 'block';
  output.classList.add('loading');
  if (actions) actions.style.display = 'none';
  setTimeout(() => output.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);

  output.innerHTML = '<div style="padding:4px 0;">'
    + '<div style="font-size:13px;color:var(--green);margin-bottom:12px;display:flex;align-items:center;gap:8px;">'
    + '<div class="spinner" style="width:14px;height:14px;border-width:2px;flex-shrink:0;"></div>'
    + '<span>' + aiLabel + ' is writing your personalised plan...</span></div>'
    + '<div id="plan-stream-text" style="font-size:13px;color:var(--text-dim);line-height:1.8;"></div>'
    + '</div>';

  let fullPlan = '';

  try {
    // Non-streaming fetch ‚Äî works on all browsers including iOS Safari
    const res = await openAIFetch('/v1/chat/completions', {
      model: 'gpt-4o',
      max_tokens: 4096,
      stream: false,
      messages: [{ role: 'user', content: prompt }]
    });

    if (!res.ok) {
      const e = await res.json().catch(() => ({}));
      const msg = (e.error && e.error.message) ? e.error.message : ('OpenAI error ' + res.status);
      throw new Error(msg);
    }

    const data = await res.json();
    fullPlan = (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) || '';
    if (!fullPlan.trim()) throw new Error('No response received. Please try again.');

    output.classList.remove('loading');
    output.innerHTML = renderPlanHTML(fullPlan);
    const u = allUsers[currentUser];
    if (u) { u.aiPlan = fullPlan; saveStorage(); }
    autoApplyGoalsFromPlan(fullPlan);
    // Auto-populate weekly plan
    _wpDays = parseWeekFromPlan(fullPlan);
    if (actions) actions.style.display = 'flex';
    showPlanSavedToast('‚úì Plan saved, goals & weekly plan updated!');

  } catch(err) {
    output.classList.remove('loading');
    // Try to get more info about the error type
    let detail = err.message || 'Unknown error';
    let advice = '';
    if (detail.includes('401') || detail.includes('Unauthorized') || detail.includes('invalid_api_key')) {
      advice = '&#x1F511; API key rejected ‚Äî the key may be inactive or restricted. Visit <a href="https://platform.openai.com/api-keys" target="_blank" style="color:var(--green);">platform.openai.com/api-keys</a> to check.';
    } else if (detail.includes('429') || detail.includes('quota') || detail.includes('billing') || detail.includes('insufficient')) {
      advice = '&#x1F4B3; No credits ‚Äî add funds at <a href="https://platform.openai.com/settings/organization/billing" target="_blank" style="color:var(--green);">platform.openai.com/billing</a>.';
    } else if (detail.includes('403')) {
      advice = '&#x1F6AB; Access forbidden ‚Äî your service account key may not have GPT-4 permissions. Try creating a standard project key instead.';
    } else {
      advice = '&#x1F4F6; Connection failed on all attempts. Try: 1) Hard refresh the page, 2) Switch from WiFi to mobile data, 3) Disable any VPN or ad blocker.';
    }
    output.innerHTML = '<div style="background:rgba(248,113,113,0.08);border:1px solid rgba(248,113,113,0.25);border-radius:12px;padding:20px;">'
      + '<div style="font-size:15px;font-weight:700;color:var(--red);margin-bottom:10px;">&#x26A0; Could not generate plan</div>'
      + '<div style="font-family:monospace;font-size:12px;background:var(--surface2);padding:8px 12px;border-radius:6px;margin-bottom:12px;word-break:break-all;">' + escHtml(detail) + '</div>'
      + '<div style="font-size:13px;color:var(--accent);line-height:1.6;">' + advice + '</div>'
      + '</div>';
  } finally {
    btn.innerHTML = '&#x2728; Generate My Plan';
    btn.disabled  = false;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI BODY VISUALISER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _bvPhotoB64 = null;
let _bvResultImgUrl = null;

function bvOpenCamera() {
  let input = document.getElementById('_bv_cam_input');
  if (!input) {
    input = document.createElement('input');
    input.type = 'file';
    input.id = '_bv_cam_input';
    input.accept = 'image/*';
    input.setAttribute('capture', 'user'); // front camera for selfie
    input.style.display = 'none';
    input.addEventListener('change', bvHandleUpload);
    document.body.appendChild(input);
  }
  input.click();
}

function bvHandleUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const dataUrl = ev.target.result;
    _bvPhotoB64 = dataUrl.split(',')[1];
    document.getElementById('bv-preview-img').src = dataUrl;
    document.getElementById('bv-photo-preview').style.display = 'block';
    document.getElementById('bv-photo-btns').style.display = 'none';
    // Pre-fill weight from profile
    const u = allUsers[currentUser] || {};
    if (u.weight && !document.getElementById('bv-current-weight').value) document.getElementById('bv-current-weight').value = u.weight;
    if (u.goal_weight && !document.getElementById('bv-goal-weight').value) document.getElementById('bv-goal-weight').value = u.goal_weight;
    if (u.height && !document.getElementById('bv-height').value) document.getElementById('bv-height').value = u.height;
    if (u.gender && !document.getElementById('bv-gender').value) document.getElementById('bv-gender').value = u.gender || 'male';
  };
  reader.readAsDataURL(file);
}

function bvClearPhoto() {
  _bvPhotoB64 = null;
  document.getElementById('bv-photo-preview').style.display = 'none';
  document.getElementById('bv-photo-btns').style.display = 'block';
  document.getElementById('bv-result').style.display = 'none';
  document.getElementById('bv-error').style.display = 'none';
}

async function generateBodyVisualisation() {
  const apiAuth = getUserApiKey();
  if (!apiAuth.key) {
    bvShowError('üîë API key missing ‚Äî contact support.');
    return;
  }
  if (!_bvPhotoB64) {
    bvShowError('üì∏ Please take or upload a photo of yourself first.');
    return;
  }
  const currentWeight = document.getElementById('bv-current-weight').value;
  const goalWeight    = document.getElementById('bv-goal-weight').value;
  const height        = document.getElementById('bv-height').value || '5\'8"';
  const gender        = document.getElementById('bv-gender').value || 'male';

  if (!currentWeight || !goalWeight) {
    bvShowError('‚öñÔ∏è Please enter your current weight and goal weight.');
    return;
  }

  const weightDiff = Math.abs(parseFloat(currentWeight) - parseFloat(goalWeight));
  const isLosing   = parseFloat(goalWeight) < parseFloat(currentWeight);

  // Show status
  document.getElementById('bv-generate-btn').disabled = true;
  document.getElementById('bv-result').style.display = 'none';
  document.getElementById('bv-error').style.display  = 'none';
  document.getElementById('bv-status').style.display = 'block';
  bvSetStatus('Analysing your photo with GPT-4o...');

  try {
    // ‚îÄ‚îÄ STEP 1: Describe the person in the photo ‚îÄ‚îÄ
    const describeRes = await openAIFetch('/v1/chat/completions', {
      model: 'gpt-4o',
      max_tokens: 400,
      messages: [{ role: 'user', content: [
        { type: 'image_url', image_url: { url: 'data:image/jpeg;base64,' + _bvPhotoB64 } },
        { type: 'text', text: 'Describe this person appearance for DALL-E: age, skin tone, hair colour/style, face shape, body build, clothing. Be specific, comma-separated, under 100 words. No names.' }
      ]}]
    });
    if (!describeRes.ok) { const e = await describeRes.json().catch(()=>({})); throw new Error(e.error?.message || 'Vision error ' + describeRes.status); }
    const describeData = await describeRes.json();
    const personDesc = (describeData.choices?.[0]?.message?.content || '').trim();

    bvSetStatus('Generating your transformation image with DALL-E 3...');

    // ‚îÄ‚îÄ STEP 2: Generate goal-weight image with DALL-E 3 ‚îÄ‚îÄ
    const weightChange = weightDiff + ' lbs ' + (isLosing ? 'lighter' : 'heavier');
    const bodyChange   = isLosing
      ? 'visibly slimmer, more toned, reduced body fat, healthier and more energetic appearance'
      : 'more muscular, increased muscle mass, broader shoulders, stronger build';

    const imagePrompt = `Full body portrait photograph of a ${gender}, ${personDesc}. This is a fitness transformation "after" photo showing them ${weightChange} ‚Äî ${bodyChange}. The person looks fit, healthy, confident, and happy. Same facial features, same hair, same clothing style but fitted. Natural studio lighting, clean white background, photorealistic. Professional fitness photography style.`;

    const imageRes = await openAIFetch('/v1/images/generations', {
      model: 'dall-e-3',
      prompt: imagePrompt,
      n: 1,
      size: '1024x1024',
      quality: 'standard',
      style: 'natural'
    });
    if (!imageRes.ok) { const e = await imageRes.json().catch(()=>({})); throw new Error(e.error?.message || 'DALL-E error ' + imageRes.status); }
    const imageData = await imageRes.json();
    const generatedUrl = imageData.data?.[0]?.url;
    if (!generatedUrl) throw new Error('No image returned from DALL-E');
    _bvResultImgUrl = generatedUrl;

    bvSetStatus('Building your side-by-side comparison...');

    // ‚îÄ‚îÄ STEP 3: Generate motivational description ‚îÄ‚îÄ
    const motivationRes = await openAIFetch('/v1/chat/completions', {
      model: 'gpt-4o-mini',
      max_tokens: 150,
      messages: [{ role: 'user', content: 'Write 2 short motivational sentences for someone losing ' + weightDiff + ' lbs to reach ' + goalWeight + 'lbs. Focus on how they will feel and look. Be positive and specific.' }]
    });
    const motivData = await motivationRes.json();
    const motivText = (motivData.choices?.[0]?.message?.content || '').trim();

    // ‚îÄ‚îÄ Show result ‚îÄ‚îÄ
    document.getElementById('bv-status').style.display = 'none';
    document.getElementById('bv-before-img').src = 'data:image/jpeg;base64,' + _bvPhotoB64;
    document.getElementById('bv-after-img').src  = generatedUrl;
    document.getElementById('bv-current-label').textContent = currentWeight + ' lbs';
    document.getElementById('bv-goal-label').textContent    = goalWeight + ' lbs  ‚úì Goal';
    document.getElementById('bv-ai-description').textContent = motivText;
    document.getElementById('bv-result').style.display = 'block';

  } catch(err) {
    document.getElementById('bv-status').style.display = 'none';
    bvShowError('‚ùå ' + err.message + (err.message.includes('billing') || err.message.includes('quota')
      ? '<br><br>Tip: DALL-E 3 requires OpenAI credits. Add credits at <a href="https://platform.openai.com/settings/organization/billing" target="_blank" style="color:var(--green);">platform.openai.com/billing</a>'
      : '<br><br>Check your API key is correct and has enough credits.'));
  } finally {
    document.getElementById('bv-generate-btn').disabled = false;
  }
}

function bvSetStatus(msg) {
  document.getElementById('bv-status-msg').textContent = msg;
}

function bvShowError(html) {
  const el = document.getElementById('bv-error');
  el.style.display = 'block';
  el.innerHTML = '<div style="background:rgba(248,113,113,0.08);border:1px solid rgba(248,113,113,0.25);border-radius:12px;padding:16px;font-size:13px;color:var(--text-dim);line-height:1.6;">' + html + '</div>';
}

function bvReset() {
  document.getElementById('bv-result').style.display = 'none';
  document.getElementById('bv-error').style.display  = 'none';
  _bvResultImgUrl = null;
}

async function bvSaveResult() {
  if (!_bvResultImgUrl) return;
  try {
    // Fetch the generated image and save as progress photo
    const res = await fetch(_bvResultImgUrl);
    const blob = await res.blob();
    const reader = new FileReader();
    reader.onload = ev => {
      const b64 = ev.target.result.split(',')[1];
      const u = allUsers[currentUser];
      if (!u) return;
      if (!u.progressPhotos) u.progressPhotos = [];
      u.progressPhotos.push({ b64, date: new Date().toISOString().slice(0,10), shot: 'ai-goal', note: 'AI Goal Visualisation' });
      saveStorage();
      renderProgressPhotos();
      showPlanSavedToast('‚úì Saved to Progress Photos!');
    };
    reader.readAsDataURL(blob);
  } catch(e) {
    // If CORS blocks the fetch, just notify user
    showPlanSavedToast('Open the image and save it manually from your browser.');
  }
}

// ‚îÄ‚îÄ Toast notification ‚îÄ‚îÄ
function showPlanSavedToast(msg) {
  let toast = document.getElementById('plan-saved-toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'plan-saved-toast';
    toast.style.cssText = 'position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:var(--green);color:#0d0f0e;font-weight:700;font-size:13px;padding:12px 22px;border-radius:30px;z-index:9999;opacity:0;transition:opacity 0.3s;pointer-events:none;white-space:nowrap;box-shadow:0 4px 20px rgba(74,222,128,0.4);';
    document.body.appendChild(toast);
  }
  toast.textContent = msg || '‚úì Plan saved!';
  toast.style.opacity = '1';
  setTimeout(() => { toast.style.opacity = '0'; }, 3500);
}

// ‚îÄ‚îÄ Silently extract nutrition goals from plan and apply to profile ‚îÄ‚îÄ
async function autoApplyGoalsFromPlan(planText) {
  try {
    const apiAuth = getUserApiKey();
    if (!apiAuth.key) return;
    const extractPrompt = 'From this fitness plan, extract the recommended daily nutrition targets. Return ONLY valid JSON with keys: cals, protein, carbs, fat (numbers only, no units). If not specified use null.\n\nPLAN:\n' + planText.slice(0, 2500);
    let jsonText = '';
    if (apiAuth.provider === 'claude') {
      const res = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: { 'Content-Type':'application/json', 'x-api-key':apiAuth.key, 'anthropic-version':'2023-06-01', 'anthropic-dangerous-direct-browser-access':'true' },
        body: JSON.stringify({ model:'claude-opus-4-6', max_tokens:200, messages:[{ role:'user', content:extractPrompt }] })
      });
      const d = await res.json();
      jsonText = (d.content?.[0]?.text || '').trim();
    } else {
      const res = await openAIFetch('/v1/chat/completions', { model:'gpt-4o-mini', max_tokens:200, messages:[{ role:'user', content:extractPrompt }] });
      const d = await res.json();
      jsonText = (d.choices?.[0]?.message?.content || '').trim();
    }
    const match = jsonText.match(/\{[\s\S]*\}/);
    if (!match) return;
    const goals = JSON.parse(match[0]);
    const u = allUsers[currentUser];
    if (!u) return;
    if (goals.cals    > 0) u.cals_goal    = Math.round(goals.cals);
    if (goals.protein > 0) u.protein_goal = Math.round(goals.protein);
    if (goals.carbs   > 0) u.carbs_goal   = Math.round(goals.carbs);
    if (goals.fat     > 0) u.fat_goal     = Math.round(goals.fat);
    saveStorage();
    const banner = document.getElementById('goals-adjusted-banner');
    if (banner) {
      banner.style.display = 'block';
      banner.innerHTML = '<div style="background:rgba(74,222,128,0.08);border:1px solid rgba(74,222,128,0.25);border-radius:10px;padding:12px 16px;margin-top:12px;">'
        + '<div style="font-size:13px;font-weight:700;color:var(--green);margin-bottom:8px;">&#x2705; Goals auto-updated from your plan</div>'
        + '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;text-align:center;">'
        + '<div style="background:var(--surface2);border-radius:8px;padding:8px 4px;"><div style="font-size:16px;font-weight:800;color:var(--accent);">' + u.cals_goal + '</div><div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;">cal</div></div>'
        + '<div style="background:var(--surface2);border-radius:8px;padding:8px 4px;"><div style="font-size:16px;font-weight:800;color:var(--green);">' + u.protein_goal + 'g</div><div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;">protein</div></div>'
        + '<div style="background:var(--surface2);border-radius:8px;padding:8px 4px;"><div style="font-size:16px;font-weight:800;color:var(--blue);">' + u.carbs_goal + 'g</div><div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;">carbs</div></div>'
        + '<div style="background:var(--surface2);border-radius:8px;padding:8px 4px;"><div style="font-size:16px;font-weight:800;color:var(--accent2);">' + u.fat_goal + 'g</div><div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;">fat</div></div>'
        + '</div></div>';
    }
    if (document.getElementById('page-dashboard').classList.contains('active')) renderDashboard();
  } catch(_) { /* silent */ }
}

function renderHistory() {
  const u = allUsers[currentUser];
  const log = u.foodLog || {};
  const rows = [];
  
  Object.keys(log).sort().reverse().forEach(date => {
    ['breakfast','lunch','dinner','snack'].forEach(meal => {
      (log[date][meal] || []).forEach(item => {
        const f = (item.qty || 100) / 100;
        rows.push({ date, meal, ...item, f });
      });
    });
  });
  
  const tbody = document.getElementById('history-tbody');
  const empty = document.getElementById('history-empty');
  
  if (!rows.length) { tbody.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';
  
  tbody.innerHTML = rows.map(r => `<tr>
    <td>${r.date}</td>
    <td><span class="badge badge-green">${r.meal}</span></td>
    <td>${r.name}</td>
    <td>${r.qty}g</td>
    <td style="color:var(--accent);font-family:'DM Mono',monospace">${Math.round((r.kcal||0)*r.f)}</td>
    <td style="color:var(--green)">${Math.round((r.protein||0)*r.f*10)/10}g</td>
    <td style="color:var(--blue)">${Math.round((r.carbs||0)*r.f*10)/10}g</td>
    <td style="color:var(--accent2)">${Math.round((r.fat||0)*r.f*10)/10}g</td>
  </tr>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROFILE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROGRESS TRACKER ‚Äî Weight + Photos + Timelapse
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let _pgFilter  = 'all';
let _pgShot    = 'Front';
let _pgStream  = null;
let _pgLightboxIdx = -1;

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getWeightLog() {
  const u = allUsers[currentUser];
  if (!u) return [];
  if (!u.weightLog) u.weightLog = [];
  return u.weightLog; // [{date, weight, note}] sorted oldest first
}

function getProgressPhotos() {
  const u = allUsers[currentUser];
  if (!u) return [];
  if (!u.progressPhotos) u.progressPhotos = [];
  return u.progressPhotos; // [{id, date, shot, b64, weight}]
}

// ‚îÄ‚îÄ Navigate to page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadProgressPage() {
  const today = new Date().toISOString().slice(0,10);
  const pgDateEl = document.getElementById('pg-weight-date');
  if (pgDateEl) pgDateEl.value = today;
  const pgGoalEl = document.getElementById('pg-goal-weight');
  if (pgGoalEl) pgGoalEl.value = (allUsers[currentUser] || {}).goalWeight || '';
  refreshUnitLabels();
  renderWeightChart();
  renderWeightHistory();
  renderWeightStats();
  renderGoalProgress();
  renderPhotoGrid();
}

// ‚îÄ‚îÄ Dashboard Quick Weigh-In ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚îÄ‚îÄ Dashboard Weigh-In: state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _dwStream   = null;   // active camera stream
let _dwShot     = 'Front'; // selected shot type
let _dwPendingB64 = null; // base64 photo waiting to be saved with weight

function dashLogWeight() {
  const input = document.getElementById('d-weigh-input');
  const val   = parseFloat(input ? input.value : 0);
  if (!val || val < 10 || val > 1000) {
    input.style.borderColor = 'var(--red)';
    setTimeout(() => input.style.borderColor = '', 1200);
    return;
  }
  const today = getTodayStr();
  const u = allUsers[currentUser];
  let valToStore = val;
  if (u && u.units === 'metric') valToStore = kgToLbs(val);
  _doLogWeight(valToStore, today, '');
  if (u) u.weight = valToStore;

  // Save pending progress photo alongside the weight entry
  if (_dwPendingB64) {
    if (!u.progressPhotos) u.progressPhotos = [];
    u.progressPhotos.unshift({
      id: 'photo_' + Date.now(),
      date: today,
      shot: _dwShot,
      b64: _dwPendingB64,
      weight: val
    });
    // Show thumbnail in card
    const thumb = document.getElementById('d-weigh-photo-thumb');
    const preview = document.getElementById('d-weigh-photo-preview');
    if (thumb)   thumb.src = 'data:image/jpeg;base64,' + _dwPendingB64;
    if (preview) preview.style.display = 'block';
    _dwPendingB64 = null;
    // Hide photo status
    const statusEl = document.getElementById('d-weigh-photo-status');
    if (statusEl) statusEl.style.display = 'none';
  }

  saveStorage();

  const displayEl = document.getElementById('d-weight-display');
  if (displayEl) displayEl.textContent = val;
  const subtitleEl = document.getElementById('d-weight-subtitle');
  if (subtitleEl) subtitleEl.textContent = 'Logged today ¬∑ ' + new Date().toLocaleDateString('en-US', { weekday:'long', month:'short', day:'numeric' });

  const msg = document.getElementById('d-weigh-msg');
  if (msg) { msg.style.display = 'block'; setTimeout(() => msg.style.display = 'none', 2500); }

  renderDashboard();
}

// ‚îÄ‚îÄ Camera controls ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function dashOpenCamera() {
  const panel       = document.getElementById('d-weigh-camera-panel');
  const placeholder = document.getElementById('d-weigh-cam-placeholder');
  const snapBtn     = document.getElementById('d-weigh-snap-btn');
  const video       = document.getElementById('d-weigh-video');
  if (panel) panel.style.display = 'block';
  panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'user' }, width: { ideal: 1280 } }
    });
    _dwStream = stream;
    if (video) { video.srcObject = stream; video.style.display = 'block'; }
    if (placeholder) placeholder.style.display = 'none';
    if (snapBtn) snapBtn.style.display = 'block';
  } catch(e) {
    if (placeholder) placeholder.innerHTML = '<div style="font-size:22px;">üö´</div><div style="font-size:11px;color:var(--red);margin-top:4px;">Camera denied ‚Äî use Upload instead</div>';
  }
}

function dashCloseCamera() {
  const panel = document.getElementById('d-weigh-camera-panel');
  if (panel) panel.style.display = 'none';
  if (_dwStream) { _dwStream.getTracks().forEach(t => t.stop()); _dwStream = null; }
  const video = document.getElementById('d-weigh-video');
  if (video) video.srcObject = null;
  const snapBtn = document.getElementById('d-weigh-snap-btn');
  if (snapBtn) snapBtn.style.display = 'none';
}

function setDwShot(type) {
  _dwShot = type;
  ['Front','Side','Back'].forEach(s => {
    const btn = document.getElementById('dw-shot-' + s);
    if (btn) btn.classList.toggle('src-active', s === type);
  });
}

function dashSnapPhoto() {
  const video  = document.getElementById('d-weigh-video');
  const canvas = document.getElementById('d-weigh-canvas');
  if (!video || !video.videoWidth) return;
  canvas.width  = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  // Resize to max 640px
  const maxW = 640;
  const scale = Math.min(1, maxW / canvas.width);
  const rc = document.createElement('canvas');
  rc.width  = Math.round(canvas.width  * scale);
  rc.height = Math.round(canvas.height * scale);
  rc.getContext('2d').drawImage(canvas, 0, 0, rc.width, rc.height);
  _dwPendingB64 = rc.toDataURL('image/jpeg', 0.82).split(',')[1];
  dashCloseCamera();
  _showDwPhotoReady();
}

function dashHandlePhotoUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const img = new Image();
    img.onload = () => {
      const maxW = 640;
      const scale = Math.min(1, maxW / img.width);
      const rc = document.createElement('canvas');
      rc.width  = Math.round(img.width  * scale);
      rc.height = Math.round(img.height * scale);
      rc.getContext('2d').drawImage(img, 0, 0, rc.width, rc.height);
      _dwPendingB64 = rc.toDataURL('image/jpeg', 0.82).split(',')[1];
      _showDwPhotoReady();
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
  e.target.value = '';
}

function _showDwPhotoReady() {
  const statusEl = document.getElementById('d-weigh-photo-status');
  if (statusEl) { statusEl.style.display = 'inline'; statusEl.textContent = '‚úì Photo ready ‚Äî tap Save to attach'; }
  // Show a tiny inline preview of the pending photo
  const preview = document.getElementById('d-weigh-photo-preview');
  const thumb   = document.getElementById('d-weigh-photo-thumb');
  if (thumb && preview) {
    thumb.src = 'data:image/jpeg;base64,' + _dwPendingB64;
    preview.style.display = 'block';
  }
}

function dashDeletePhoto() {
  _dwPendingB64 = null;
  const preview  = document.getElementById('d-weigh-photo-preview');
  const statusEl = document.getElementById('d-weigh-photo-status');
  // Check if there's a saved photo for today in progress photos and remove it
  const u = allUsers[currentUser];
  const today = getTodayStr();
  if (u && u.progressPhotos) {
    // Remove only the most recent photo from today
    const idx = u.progressPhotos.findIndex(p => p.date === today);
    if (idx >= 0) { u.progressPhotos.splice(idx, 1); saveStorage(); }
  }
  if (preview) preview.style.display = 'none';
  if (statusEl) statusEl.style.display = 'none';
}

// ‚îÄ‚îÄ Weight Logging ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function logWeight() {
  // Called from profile page quick-log widget
  const input = document.getElementById('quick-weight-input');
  let val = parseFloat(input ? input.value : 0);
  if (!val || val < 10) { alert('Please enter a valid weight.'); return; }
  const u = allUsers[currentUser];
  if (u && u.units === 'metric') val = kgToLbs(val); // convert to lbs for storage
  if (val < 50 || val > 800) { alert('Please enter a valid weight.'); return; }
  _doLogWeight(val, new Date().toISOString().slice(0,10), '');
  if (input) input.value = '';
  // Also update profile weight field
  const pw = document.getElementById('profile-weight');
  if (pw) pw.value = val;
  // Update u.weight too
  const uRef = allUsers[currentUser];
  if (uRef) uRef.weight = val;
  saveStorage();
  renderWeightMiniChart();
  const msg = document.getElementById('weight-log-msg');
  if (msg) { msg.style.display = 'block'; setTimeout(() => msg.style.display = 'none', 2000); }
}

function logWeightFull() {
  // Called from Progress page
  const val  = parseFloat(document.getElementById('pg-weight-input').value);
  const date = document.getElementById('pg-weight-date').value;
  const note = (document.getElementById('pg-weight-note').value || '').trim();
  if (!val || val < 10) { alert('Please enter a valid weight.'); return; }
  if (!date) { alert('Please select a date.'); return; }
  const uUnit = allUsers[currentUser];
  if (uUnit && uUnit.units === 'metric') val = kgToLbs(val);
  if (val < 50 || val > 800) { alert('Please enter a valid weight.'); return; }
  _doLogWeight(val, date, note);
  document.getElementById('pg-weight-input').value = '';
  document.getElementById('pg-weight-note').value  = '';
  // Update u.weight if today
  const u = allUsers[currentUser];
  if (u && date === new Date().toISOString().slice(0,10)) { u.weight = val; }
  saveStorage();
  renderWeightChart();
  renderWeightHistory();
  renderWeightStats();
  renderGoalProgress();
  renderWeightMiniChart();
  const msg = document.getElementById('pg-weight-saved');
  if (msg) { msg.style.display = 'block'; setTimeout(() => msg.style.display = 'none', 2000); }
}

function _doLogWeight(val, date, note) {
  const log = getWeightLog();
  // Replace entry for same date if exists
  const existing = log.findIndex(e => e.date === date);
  const entry = { date, weight: val, note };
  if (existing >= 0) log[existing] = entry;
  else { log.push(entry); log.sort((a,b) => a.date.localeCompare(b.date)); }
  const u = allUsers[currentUser];
  if (u) u.weightLog = log;
}

function deleteWeightEntry(date) {
  const u = allUsers[currentUser];
  if (!u || !u.weightLog) return;
  u.weightLog = u.weightLog.filter(e => e.date !== date);
  saveStorage();
  renderWeightChart();
  renderWeightHistory();
  renderWeightStats();
  renderGoalProgress();
}

function updateWeightPreview(val) {
  // Keep both weight inputs in sync
  const qi = document.getElementById('quick-weight-input');
  const pi = document.getElementById('profile-weight');
  if (qi && document.activeElement !== qi) qi.value = val;
  if (pi && document.activeElement !== pi) pi.value = val;
}

// ‚îÄ‚îÄ Goal Weight ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveGoalWeight() {
  const val = parseFloat(document.getElementById('pg-goal-weight').value);
  if (!val || val < 50) { alert('Enter a valid goal weight.'); return; }
  const u = allUsers[currentUser];
  if (u) u.goalWeight = val;
  saveStorage();
  renderGoalProgress();
  const info = document.getElementById('pg-goal-weight-info');
  if (info) { info.textContent = '‚úì Saved!'; info.style.color = 'var(--green)'; setTimeout(() => info.textContent = '', 1500); }
}

function renderGoalProgress() {
  const u = allUsers[currentUser];
  const log = getWeightLog();
  const wrap = document.getElementById('pg-goal-progress-bar-wrap');
  if (!wrap || !u) return;
  if (!u.goalWeight || !log.length) { wrap.style.display = 'none'; return; }
  wrap.style.display = 'block';
  const start = log[0].weight;
  const curr  = log[log.length - 1].weight;
  const goal  = u.goalWeight;
  const total = Math.abs(start - goal);
  const done  = Math.abs(start - curr);
  const pct   = total > 0 ? Math.min(100, Math.round((done / total) * 100)) : 0;
  const startLbl = document.getElementById('pg-goal-bar-start-lbl');
  const endLbl   = document.getElementById('pg-goal-bar-end-lbl');
  const pctLbl   = document.getElementById('pg-goal-bar-pct-lbl');
  const fill     = document.getElementById('pg-goal-bar-fill');
  if (startLbl) startLbl.textContent = start + ' lbs';
  if (endLbl)   endLbl.textContent   = goal + ' lbs goal';
  if (pctLbl)   pctLbl.textContent   = pct + '% there!';
  if (fill)     fill.style.width     = pct + '%';
  const statEl = document.getElementById('pg-stat-target');
  if (statEl)   statEl.textContent = goal + ' lbs';
}

// ‚îÄ‚îÄ Weight Chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderWeightChart() {
  const container = document.getElementById('pg-weight-chart');
  if (!container) return;
  const log = getWeightLog();
  if (log.length < 2) { container.innerHTML = ''; return; }

  // Show last 30 entries max
  const entries = log.slice(-30);
  const weights = entries.map(e => e.weight);
  const minW = Math.floor(Math.min(...weights) - 2);
  const maxW = Math.ceil(Math.max(...weights) + 2);
  const range = maxW - minW || 1;

  const W = 600, H = 160, padL = 40, padR = 16, padT = 12, padB = 28;
  const chartW = W - padL - padR;
  const chartH = H - padT - padB;

  // Build SVG path
  const pts = entries.map((e, i) => {
    const x = padL + (i / (entries.length - 1)) * chartW;
    const y = padT + (1 - (e.weight - minW) / range) * chartH;
    return [x, y];
  });

  // Smooth bezier
  let path = 'M' + pts[0][0] + ',' + pts[0][1];
  for (let i = 1; i < pts.length; i++) {
    const prev = pts[i-1], curr = pts[i];
    const cpx = (prev[0] + curr[0]) / 2;
    path += ' C' + cpx + ',' + prev[1] + ' ' + cpx + ',' + curr[1] + ' ' + curr[0] + ',' + curr[1];
  }

  // Area fill path
  const lastPt = pts[pts.length-1];
  const firstPt = pts[0];
  const area = path + ' L' + lastPt[0] + ',' + (padT + chartH) + ' L' + firstPt[0] + ',' + (padT + chartH) + ' Z';

  // Y-axis labels
  const yLabels = [minW, Math.round((minW + maxW) / 2), maxW].map(w => {
    const y = padT + (1 - (w - minW) / range) * chartH;
    return '<text x="' + (padL - 6) + '" y="' + (y + 4) + '" font-size="9" fill="#6b7280" text-anchor="end">' + w + '</text>';
  }).join('');

  // X-axis labels (first, middle, last)
  const xIdxs = [0, Math.floor(entries.length/2), entries.length-1];
  const xLabels = xIdxs.map(i => {
    const d = new Date(entries[i].date + 'T12:00:00');
    const lbl = d.toLocaleDateString('en-US', { month:'short', day:'numeric' });
    return '<text x="' + pts[i][0] + '" y="' + (H - 6) + '" font-size="9" fill="#6b7280" text-anchor="middle">' + lbl + '</text>';
  }).join('');

  // Dots + tooltips
  const dots = pts.map((p, i) => {
    const e = entries[i];
    return '<circle cx="' + p[0] + '" cy="' + p[1] + '" r="3" fill="var(--green)" stroke="var(--surface)" stroke-width="1.5">'
      + '<title>' + e.date + ': ' + e.weight + ' lbs' + (e.note ? ' (' + e.note + ')' : '') + '</title>'
      + '</circle>';
  }).join('');

  container.innerHTML = '<svg viewBox="0 0 ' + W + ' ' + H + '" style="width:100%;height:auto;display:block;" xmlns="http://www.w3.org/2000/svg">'
    + '<defs><linearGradient id="wGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#4ade80" stop-opacity="0.3"/><stop offset="100%" stop-color="#4ade80" stop-opacity="0.02"/></linearGradient></defs>'
    + '<path d="' + area + '" fill="url(#wGrad)"/>'
    + '<path d="' + path + '" fill="none" stroke="var(--green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>'
    + yLabels + xLabels + dots
    + '</svg>';
}

function renderWeightStats() {
  const log = getWeightLog();
  const statsRow = document.getElementById('pg-weight-stats');
  if (!statsRow) return;
  if (!log.length) { statsRow.style.display = 'none'; return; }
  statsRow.style.display = 'block';
  const curr   = log[log.length - 1].weight;
  const start  = log[0].weight;
  const change = Math.round((curr - start) * 10) / 10;
  const currEl   = document.getElementById('pg-stat-current');
  const startEl  = document.getElementById('pg-stat-start');
  const changeEl = document.getElementById('pg-stat-change');
  const wu = weightUnit();
  const dispCurr  = fmtWeightNum(curr);
  const dispStart = fmtWeightNum(start);
  const dispChg   = Math.round((fmtWeightNum(curr) - fmtWeightNum(start)) * 10) / 10;
  if (currEl)   currEl.textContent = dispCurr + ' ' + wu;
  if (startEl)  startEl.textContent = dispStart + ' ' + wu;
  if (changeEl) {
    changeEl.textContent = (dispChg > 0 ? '+' : '') + dispChg + ' ' + wu;
    changeEl.style.color = change < 0 ? 'var(--green)' : change > 0 ? 'var(--red)' : 'var(--text-muted)';
  }
}

function renderWeightHistory() {
  const container = document.getElementById('pg-weight-history');
  if (!container) return;
  const log = getWeightLog();
  if (!log.length) { container.innerHTML = '<div style="color:var(--text-muted);font-size:13px;padding:8px 0;">No weight entries yet. Log your first weigh-in above!</div>'; return; }
  const entries = [...log].reverse().slice(0, 20);
  container.innerHTML = '<div style="max-height:260px;overflow-y:auto;">'
    + entries.map((e, i) => {
        const prev = log[log.length - 1 - i - 1]; // previous chronological
        const delta = prev ? Math.round((e.weight - prev.weight) * 10) / 10 : null;
        const d = new Date(e.date + 'T12:00:00');
        const dateStr = d.toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric', year:'numeric' });
        const dispW = fmtWeightNum(e.weight);
        const dispUnit = weightUnit();
        const dispDelta = delta !== null ? (allUsers[currentUser] && allUsers[currentUser].units === 'metric' ? Math.round(lbsToKg(e.weight) - (prev ? lbsToKg(prev.weight) : 0) * 10) / 10 : delta) : null;
        return '<div class="weight-entry-row">'
          + '<div><div style="font-size:14px;font-weight:600;">' + dispW + ' ' + dispUnit + '</div>'
          + '<div style="font-size:11px;color:var(--text-muted);">' + dateStr + (e.note ? ' ¬∑ ' + e.note : '') + '</div></div>'
          + '<div style="display:flex;align-items:center;gap:12px;">'
          + (delta !== null ? '<span style="font-size:12px;font-weight:600;color:' + (delta<0?'var(--green)':delta>0?'var(--red)':'var(--text-muted)') + ';">' + (delta>0?'+':'') + Math.round((allUsers[currentUser]&&allUsers[currentUser].units==='metric'?lbsToKg(Math.abs(e.weight-(prev?prev.weight:e.weight))):Math.abs(delta))*10)/10 * (delta<0?-1:delta>0?1:0) + '</span>' : '')
          + '<button onclick="deleteWeightEntry(\'' + e.date + '\')" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px;padding:4px;transition:color 0.15s;" onmouseover="this.style.color=\'var(--red)\'" onmouseout="this.style.color=\'var(--text-muted)\'">‚úï</button>'
          + '</div></div>';
      }).join('')
    + '</div>';
}

function renderWeightMiniChart() {
  const container = document.getElementById('weight-mini-chart');
  if (!container) return;
  const log = getWeightLog();
  if (log.length < 2) { container.innerHTML = ''; return; }
  const entries = log.slice(-14);
  const weights = entries.map(e => e.weight);
  const minW = Math.min(...weights) - 1;
  const maxW = Math.max(...weights) + 1;
  const range = maxW - minW || 1;
  const W = 300, H = 48, padL = 4, padR = 4, padT = 4, padB = 4;
  const pts = entries.map((e, i) => [padL + (i / (entries.length-1)) * (W-padL-padR), padT + (1-(e.weight-minW)/range)*(H-padT-padB)]);
  let path = 'M' + pts[0];
  for (let i = 1; i < pts.length; i++) {
    const cpx = (pts[i-1][0] + pts[i][0]) / 2;
    path += ' C' + cpx + ',' + pts[i-1][1] + ' ' + cpx + ',' + pts[i][1] + ' ' + pts[i];
  }
  const area = path + ' L' + pts[pts.length-1][0] + ',' + H + ' L' + padL + ',' + H + ' Z';
  container.innerHTML = '<svg viewBox="0 0 ' + W + ' ' + H + '" style="width:100%;height:40px;display:block;" xmlns="http://www.w3.org/2000/svg">'
    + '<defs><linearGradient id="wmg" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#4ade80" stop-opacity="0.4"/><stop offset="100%" stop-color="#4ade80" stop-opacity="0.02"/></linearGradient></defs>'
    + '<path d="' + area + '" fill="url(#wmg)"/>'
    + '<path d="' + path + '" fill="none" stroke="#4ade80" stroke-width="1.5" stroke-linecap="round"/>'
    + '</svg>';
}

function exportWeightCSV() {
  const log = getWeightLog();
  if (!log.length) { alert('No weight data to export.'); return; }
  const csv = 'Date,Weight (lbs),Note\n' + log.map(e => e.date + ',' + e.weight + ',"' + (e.note||'') + '"').join('\n');
  const blob = new Blob([csv], { type:'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'chingone-weight-log.csv';
  a.click();
}

// ‚îÄ‚îÄ Progress Camera ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openProgressCamera() {
  const panel = document.getElementById('pg-camera-panel');
  if (panel) panel.style.display = 'block';
  const placeholder = document.getElementById('pg-cam-placeholder');
  const snapBtn     = document.getElementById('pg-snap-btn');
  const video       = document.getElementById('pg-video');
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'user' }, width:{ ideal:1280 } } });
    _pgStream = stream;
    if (video) { video.srcObject = stream; video.style.display = 'block'; }
    if (placeholder) placeholder.style.display = 'none';
    if (snapBtn) snapBtn.style.display = 'block';
  } catch(e) {
    if (placeholder) placeholder.innerHTML = '<div style="font-size:22px;">üö´</div><div style="font-size:11px;color:var(--red);margin-top:4px;">Camera denied ‚Äî use Upload instead</div>';
  }
}

function closeProgressCamera() {
  const panel = document.getElementById('pg-camera-panel');
  if (panel) panel.style.display = 'none';
  if (_pgStream) { _pgStream.getTracks().forEach(t => t.stop()); _pgStream = null; }
  const video = document.getElementById('pg-video');
  if (video) video.srcObject = null;
}

function setPgShot(type) {
  _pgShot = type;
  ['Front','Side','Back'].forEach(s => {
    const btn = document.getElementById('pg-shot-' + s.toLowerCase());
    if (btn) btn.classList.toggle('src-active', s === type);
  });
}

function snapProgressPhoto() {
  const video  = document.getElementById('pg-video');
  const canvas = document.getElementById('pg-canvas');
  if (!video || !video.videoWidth) return;
  canvas.width  = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  // Resize to reasonable storage size: max 640px wide
  const maxW = 640;
  const scale = Math.min(1, maxW / canvas.width);
  const rc = document.createElement('canvas');
  rc.width  = Math.round(canvas.width  * scale);
  rc.height = Math.round(canvas.height * scale);
  rc.getContext('2d').drawImage(canvas, 0, 0, rc.width, rc.height);
  const b64 = rc.toDataURL('image/jpeg', 0.82).split(',')[1];
  saveProgressPhoto(b64);
  closeProgressCamera();
}

function handleProgressUpload(e) {
  const files = Array.from(e.target.files);
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = ev => {
      const img = new Image();
      img.onload = () => {
        const maxW = 640;
        const scale = Math.min(1, maxW / img.width);
        const rc = document.createElement('canvas');
        rc.width  = Math.round(img.width  * scale);
        rc.height = Math.round(img.height * scale);
        rc.getContext('2d').drawImage(img, 0, 0, rc.width, rc.height);
        const b64 = rc.toDataURL('image/jpeg', 0.82).split(',')[1];
        saveProgressPhoto(b64);
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  });
  e.target.value = '';
}

function saveProgressPhoto(b64) {
  const u = allUsers[currentUser];
  if (!u) return;
  if (!u.progressPhotos) u.progressPhotos = [];
  const today = new Date().toISOString().slice(0,10);
  const currWeight = getWeightLog().slice(-1)[0]?.weight || u.weight || null;
  const id = 'photo_' + Date.now();
  u.progressPhotos.push({ id, date: today, shot: _pgShot, b64, weight: currWeight });
  // Keep newest first for display
  u.progressPhotos.sort((a,b) => b.date.localeCompare(a.date));
  try { saveStorage(); } catch(e) {
    // If storage is full, alert user
    alert('Storage is getting full. Consider deleting older photos or exporting them first.\n\nLast photo was not saved.');
    u.progressPhotos.shift();
    return;
  }
  renderPhotoGrid();
}

function deleteProgressPhoto(id) {
  if (!confirm('Delete this progress photo?')) return;
  const u = allUsers[currentUser];
  if (!u || !u.progressPhotos) return;
  u.progressPhotos = u.progressPhotos.filter(p => p.id !== id);
  saveStorage();
  renderPhotoGrid();
  closeLightbox();
}

// ‚îÄ‚îÄ Photo Gallery ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setPgFilter(filter) {
  _pgFilter = filter;
  document.querySelectorAll('#pg-filter-row .src-btn').forEach(btn => btn.classList.remove('src-active'));
  const activeId = 'pg-filter-' + (filter === 'all' ? 'all' : filter.toLowerCase());
  const activeBtn = document.getElementById(activeId);
  if (activeBtn) activeBtn.classList.add('src-active');
  renderPhotoGrid();
}

function renderPhotoGrid() {
  const container = document.getElementById('pg-photo-grid');
  const noEl      = document.getElementById('pg-no-photos');
  if (!container) return;
  const photos = getProgressPhotos();
  const filtered = _pgFilter === 'all' ? photos : photos.filter(p => p.shot === _pgFilter);

  if (!filtered.length) {
    container.innerHTML = '';
    if (noEl) noEl.style.display = 'block';
    return;
  }
  if (noEl) noEl.style.display = 'none';

  container.innerHTML = filtered.map((p, i) => {
    const d = new Date(p.date + 'T12:00:00');
    const dateStr = d.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'2-digit' });
    const weightStr = p.weight ? p.weight + ' lbs' : '';
    return '<div class="photo-thumb" onclick="openLightbox(' + i + ')">'
      + '<img src="data:image/jpeg;base64,' + p.b64 + '" alt="' + p.shot + ' ' + p.date + '" loading="lazy">'
      + '<div class="photo-thumb-label">' + (p.shot || '') + '  ' + dateStr + (weightStr ? '<br>' + weightStr : '') + '</div>'
      + '<button class="photo-thumb-del" onclick="event.stopPropagation();deleteProgressPhoto(\'' + p.id + '\')" title="Delete">‚úï</button>'
      + '</div>';
  }).join('');
}

// ‚îÄ‚îÄ Lightbox ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openLightbox(idx) {
  const photos  = getProgressPhotos();
  const filtered = _pgFilter === 'all' ? photos : photos.filter(p => p.shot === _pgFilter);
  if (!filtered.length) return;
  _pgLightboxIdx = idx;

  // Remove existing lightbox
  const existing = document.getElementById('pg-lightbox');
  if (existing) existing.remove();

  const p = filtered[idx];
  const d = new Date(p.date + 'T12:00:00');
  const dateStr = d.toLocaleDateString('en-US', { weekday:'long', month:'long', day:'numeric', year:'numeric' });

  const lb = document.createElement('div');
  lb.className = 'photo-lightbox';
  lb.id = 'pg-lightbox';
  lb.innerHTML = '<div style="position:absolute;top:16px;right:16px;display:flex;gap:8px;">'
    + '<button onclick="deleteProgressPhoto(\'' + p.id + '\')" style="background:rgba(248,113,113,0.9);border:none;color:#fff;border-radius:8px;padding:8px 14px;cursor:pointer;font-size:13px;font-weight:600;">üóë Delete</button>'
    + '<button onclick="closeLightbox()" style="background:rgba(255,255,255,0.15);border:none;color:#fff;border-radius:8px;padding:8px 14px;cursor:pointer;font-size:13px;font-weight:600;">‚úï Close</button>'
    + '</div>'
    + '<img src="data:image/jpeg;base64,' + p.b64 + '" alt="Progress photo">'
    + '<div style="color:#fff;text-align:center;margin-top:12px;">'
    + '<div style="font-size:15px;font-weight:700;">' + (p.shot || 'Photo') + ' ¬∑ ' + dateStr + '</div>'
    + (p.weight ? '<div style="font-size:13px;color:#aaa;margin-top:4px;">Weight: ' + p.weight + ' lbs</div>' : '')
    + '</div>'
    + '<div class="photo-lightbox-nav">'
    + (idx > 0 ? '<button onclick="openLightbox(' + (idx-1) + ')" style="background:rgba(255,255,255,0.15);border:none;color:#fff;border-radius:8px;padding:10px 18px;cursor:pointer;font-size:16px;">‚Äπ Prev</button>' : '<div style="width:80px;"></div>')
    + '<div style="color:#aaa;font-size:12px;">' + (idx+1) + ' / ' + filtered.length + '</div>'
    + (idx < filtered.length-1 ? '<button onclick="openLightbox(' + (idx+1) + ')" style="background:rgba(255,255,255,0.15);border:none;color:#fff;border-radius:8px;padding:10px 18px;cursor:pointer;font-size:16px;">Next ‚Ä∫</button>' : '<div style="width:80px;"></div>')
    + '</div>';

  document.body.appendChild(lb);
  // Swipe support
  let touchStartX = 0;
  lb.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; }, { passive:true });
  lb.addEventListener('touchend', e => {
    const dx = e.changedTouches[0].clientX - touchStartX;
    if (Math.abs(dx) > 50) { if (dx < 0 && idx < filtered.length-1) openLightbox(idx+1); else if (dx > 0 && idx > 0) openLightbox(idx-1); }
  });
}

function closeLightbox() {
  const lb = document.getElementById('pg-lightbox');
  if (lb) lb.remove();
}

// Close lightbox on Escape
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeLightbox(); });

// ‚îÄ‚îÄ Time-lapse Video ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function generateTimelapse() {
  const photos = getProgressPhotos();
  const shotFilter = document.getElementById('tl-shot-type').value;
  const frameDur   = parseFloat(document.getElementById('tl-speed').value) * 1000;

  const frames = shotFilter === 'all' ? [...photos] : photos.filter(p => p.shot === shotFilter);
  // Sort oldest first
  frames.sort((a,b) => a.date.localeCompare(b.date));

  if (frames.length < 3) {
    alert('You need at least 3 ' + (shotFilter !== 'all' ? shotFilter + ' ' : '') + 'photos to generate a time-lapse.\n\nCurrently: ' + frames.length + ' photo' + (frames.length !== 1 ? 's' : '') + '.');
    return;
  }

  const statusEl   = document.getElementById('tl-status');
  const progWrap   = document.getElementById('tl-progress-wrap');
  const progFill   = document.getElementById('tl-progress-fill');
  const outputEl   = document.getElementById('tl-output');
  const btn        = document.getElementById('tl-gen-btn');
  const videoEl    = document.getElementById('tl-video');
  const dlBtn      = document.getElementById('tl-download-btn');

  btn.disabled = true;
  btn.innerHTML = '<div class="spinner" style="width:16px;height:16px;border-width:2px;display:inline-block;vertical-align:middle;margin-right:8px;"></div> Building time-lapse...';
  if (statusEl)   { statusEl.style.display = 'block'; statusEl.textContent = 'Loading photos...'; }
  if (progWrap)   progWrap.style.display = 'block';
  if (progFill)   progFill.style.width = '0%';
  if (outputEl)   outputEl.style.display = 'none';

  try {
    // Check MediaRecorder + WebM support
    if (!window.MediaRecorder) throw new Error('Your browser does not support video recording. Please use Chrome or Edge.');

    const mimeType = ['video/webm;codecs=vp9','video/webm;codecs=vp8','video/webm'].find(m => MediaRecorder.isTypeSupported(m)) || '';
    if (!mimeType) throw new Error('WebM video format not supported. Please use Chrome or Edge.');

    // Step 1: Load all images into Image objects
    const imgObjects = await Promise.all(frames.map((f, i) => new Promise((res, rej) => {
      const img = new Image();
      img.onload = () => res(img);
      img.onerror = () => rej(new Error('Failed to load photo ' + (i+1)));
      img.src = 'data:image/jpeg;base64,' + f.b64;
    })));

    if (progFill) progFill.style.width = '20%';
    if (statusEl) statusEl.textContent = 'Setting up canvas...';

    // Step 2: Find common dimensions (use first image as reference, letterbox others)
    const W = 640;
    const H = Math.round((imgObjects[0].naturalHeight / imgObjects[0].naturalWidth) * W) || 800;

    const canvas  = document.createElement('canvas');
    canvas.width  = W;
    canvas.height = H;
    const ctx     = canvas.getContext('2d');

    // Step 3: Set up MediaRecorder
    const stream   = canvas.captureStream(30);
    const recorder = new MediaRecorder(stream, { mimeType, videoBitsPerSecond: 2500000 });
    const chunks   = [];
    recorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };

    // Step 4: Record each frame
    const recordingDone = new Promise(resolve => recorder.onstop = resolve);
    recorder.start();

    for (let i = 0; i < imgObjects.length; i++) {
      if (statusEl) statusEl.textContent = 'Rendering frame ' + (i+1) + ' of ' + imgObjects.length + '...';
      if (progFill) progFill.style.width = (20 + Math.round((i / imgObjects.length) * 70)) + '%';

      const img = imgObjects[i];
      const f   = frames[i];

      // Draw background
      ctx.fillStyle = '#0d0f0e';
      ctx.fillRect(0, 0, W, H);

      // Draw image centered/letterboxed
      const scale = Math.min(W / img.naturalWidth, H / img.naturalHeight);
      const iw = img.naturalWidth * scale, ih = img.naturalHeight * scale;
      const ix = (W - iw) / 2, iy = (H - ih) / 2;
      ctx.drawImage(img, ix, iy, iw, ih);

      // Overlay: date + weight + shot
      const d = new Date(f.date + 'T12:00:00');
      const dateStr = d.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
      ctx.fillStyle = 'rgba(0,0,0,0.55)';
      ctx.fillRect(0, H - 54, W, 54);
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 16px Arial';
      ctx.fillText(dateStr + (f.shot ? '  ¬∑  ' + f.shot : ''), 14, H - 30);
      if (f.weight) {
        ctx.font = '13px Arial';
        ctx.fillStyle = '#4ade80';
        ctx.fillText(f.weight + ' lbs', 14, H - 12);
      }

      // Hold frame for frameDur milliseconds
      const frameStart = performance.now();
      while (performance.now() - frameStart < frameDur) {
        await new Promise(r => requestAnimationFrame(r));
      }
    }

    // Hold last frame a little longer
    await new Promise(r => setTimeout(r, 800));
    recorder.stop();
    await recordingDone;

    if (progFill) progFill.style.width = '100%';
    if (statusEl) statusEl.textContent = 'Finalising video...';

    // Step 5: Create blob and show
    const blob    = new Blob(chunks, { type: mimeType });
    const url     = URL.createObjectURL(blob);
    if (videoEl)  { videoEl.src = url; videoEl.load(); }
    if (dlBtn)    { dlBtn.href = url; }
    if (outputEl) outputEl.style.display = 'block';
    if (statusEl) statusEl.textContent = '‚úÖ Done! ' + frames.length + ' frames ¬∑ ' + (frames.length * frameDur / 1000).toFixed(1) + 's total';

  } catch(err) {
    if (statusEl) {
      statusEl.style.color = 'var(--red)';
      statusEl.textContent = '‚ùå ' + err.message;
    }
  }

  btn.disabled = false;
  btn.innerHTML = 'üé¨ Generate Time-lapse Video';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UNIT SYSTEM (Imperial / Metric)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Conversion helpers ‚Äî app stores values internally as imperial (lbs, inches)
function lbsToKg(lbs)    { return Math.round(lbs   * 0.453592 * 10) / 10; }
function kgToLbs(kg)     { return Math.round(kg    / 0.453592 * 10) / 10; }
function inToCm(inches)  { return Math.round(inches * 2.54    * 10) / 10; }
function cmToIn(cm)      { return Math.round(cm     / 2.54    * 10) / 10; }

// Format a stored-imperial weight for display in current unit
function fmtWeight(lbs) {
  const u = allUsers[currentUser];
  const isMetric = u && u.units === 'metric';
  return isMetric ? lbsToKg(lbs) + ' kg' : lbs + ' lbs';
}
function fmtWeightNum(lbs) {
  const u = allUsers[currentUser];
  return (u && u.units === 'metric') ? lbsToKg(lbs) : lbs;
}
function weightUnit() {
  const u = allUsers[currentUser];
  return (u && u.units === 'metric') ? 'kg' : 'lbs';
}
function heightUnit() {
  const u = allUsers[currentUser];
  return (u && u.units === 'metric') ? 'cm' : 'in';
}

function setUnitSystem(system) {
  const u = allUsers[currentUser];
  if (!u) return;
  u.units = system;
  saveStorage();
  updateUnitButtons();
  refreshUnitLabels();
  // Re-populate profile fields with converted values
  loadProfileFormUnits();
}

function updateUnitButtons() {
  const u = allUsers[currentUser];
  const isMetric = u && u.units === 'metric';
  const impBtn = document.getElementById('unit-btn-imperial');
  const metBtn = document.getElementById('unit-btn-metric');
  if (impBtn) {
    impBtn.style.background = isMetric ? 'transparent' : 'var(--green)';
    impBtn.style.color      = isMetric ? 'var(--text-dim)' : '#0d0f0e';
  }
  if (metBtn) {
    metBtn.style.background = isMetric ? 'var(--green)' : 'transparent';
    metBtn.style.color      = isMetric ? '#0d0f0e' : 'var(--text-dim)';
  }
}

function refreshUnitLabels() {
  const isMetric = (allUsers[currentUser] || {}).units === 'metric';
  const wUnit = isMetric ? 'kg'     : 'lbs';
  const hUnit = isMetric ? 'cm'     : 'inches';
  const wPh   = isMetric ? 'e.g. 82.5' : 'e.g. 182.5';

  // Profile page labels
  const hlbl = document.getElementById('profile-height-label');
  const wlbl = document.getElementById('profile-weight-label');
  const qwlbl = document.getElementById('quick-weight-unit-lbl');
  if (hlbl)  hlbl.textContent  = 'Height (' + hUnit + ')';
  if (wlbl)  wlbl.textContent  = 'Current Weight (' + wUnit + ')';
  if (qwlbl) qwlbl.textContent = wUnit;

  // Progress page labels
  const pgWinput = document.getElementById('pg-weight-input');
  if (pgWinput) pgWinput.placeholder = wPh;
  const pgWlbl = document.querySelector('label[for="pg-weight-input"], #pg-weight-form-label');
  if (pgWlbl) pgWlbl.textContent = 'Weight (' + wUnit + ')';

  // Dashboard weigh-in unit
  const dwUnit = document.querySelector('#d-weight-display + div');
  if (dwUnit) dwUnit.textContent = wUnit + ' today';
  const dwInputLbl = document.querySelector('#d-weigh-input + span');
  if (dwInputLbl) dwInputLbl.textContent = wUnit;

  // AI plan form
  const aiWLbl = document.getElementById('ai-weight-label');
  if (aiWLbl) aiWLbl.textContent = 'Weight (' + wUnit + ')';
  const aiHLbl = document.getElementById('ai-height-label');
  if (aiHLbl) aiHLbl.textContent = 'Height (' + hUnit + ')';
  const aiTLbl = document.getElementById('ai-target-label');
  if (aiTLbl) aiTLbl.textContent = 'Target Weight (' + wUnit + ', optional)';
}

function loadProfileFormUnits() {
  const u = allUsers[currentUser];
  if (!u) return;
  const isMetric = u.units === 'metric';
  // Show converted values in the fields
  const hEl = document.getElementById('profile-height');
  const wEl = document.getElementById('profile-weight');
  if (hEl && u.height) hEl.value = isMetric ? inToCm(u.height)  : u.height;
  if (wEl && u.weight) wEl.value = isMetric ? lbsToKg(u.weight) : u.weight;
  // Quick log placeholder
  const qwEl = document.getElementById('quick-weight-input');
  if (qwEl) qwEl.placeholder = isMetric ? 'e.g. 82.5' : 'e.g. 182.5';
}

function loadProfileForm() {
  const u = allUsers[currentUser];
  if (!u) return;
  document.getElementById('profile-avatar').textContent = u.name.charAt(0).toUpperCase();
  document.getElementById('profile-name').value = u.name || '';
  document.getElementById('profile-email').value = u.email || '';
  document.getElementById('profile-age').value = u.age || '';
  document.getElementById('profile-gender').value = u.gender || 'male';
  document.getElementById('profile-height').value = u.height || '';
  document.getElementById('profile-weight').value = u.weight || '';
  document.getElementById('profile-cal-goal').value = u.cals_goal || 1800;
  document.getElementById('profile-protein-goal').value = u.protein_goal || 120;
  document.getElementById('profile-fat-goal').value = u.fat_goal || 60;
  document.getElementById('profile-carbs-goal').value = u.carbs_goal || 200;
  document.getElementById('profile-goal').value = u.goal || 'lose_weight';
  // WhatsApp
  const waInput = document.getElementById('profile-whatsapp');
  const waTest  = document.getElementById('wa-test-btn');
  const waClear = document.getElementById('wa-clear-btn');
  const waErr   = document.getElementById('wa-error');
  if (waInput) waInput.value = u.whatsapp || '';
  if (waErr) waErr.style.display = 'none';
  if (waTest)  waTest.style.display  = u.whatsapp ? 'inline-flex' : 'none';
  if (waClear) waClear.style.display = u.whatsapp ? 'inline-flex' : 'none';
  // Populate weight from latest log entry
  const wLog = (u.weightLog || []);
  if (wLog.length) {
    const latest = wLog[wLog.length-1];
    const pwEl = document.getElementById('profile-weight');
    if (pwEl && !pwEl.value) pwEl.value = latest.weight;
  }
  renderWeightMiniChart();
  // Unit system
  updateUnitButtons();
  refreshUnitLabels();
  loadProfileFormUnits();
}

function saveProfile() {
  const u = allUsers[currentUser];
  u.name = document.getElementById('profile-name').value;
  u.email = document.getElementById('profile-email').value;
  u.age = parseInt(document.getElementById('profile-age').value) || u.age;
  u.gender = document.getElementById('profile-gender').value;
  const isMetric = u.units === 'metric';
  const rawH = parseFloat(document.getElementById('profile-height').value) || 0;
  const rawW = parseFloat(document.getElementById('profile-weight').value) || 0;
  if (rawH) u.height = isMetric ? cmToIn(rawH) : rawH;
  if (rawW) u.weight = isMetric ? kgToLbs(rawW) : rawW;
  u.cals_goal = parseInt(document.getElementById('profile-cal-goal').value) || 1800;
  u.protein_goal = parseInt(document.getElementById('profile-protein-goal').value) || 120;
  u.fat_goal = parseInt(document.getElementById('profile-fat-goal').value) || 60;
  u.carbs_goal = parseInt(document.getElementById('profile-carbs-goal').value) || 200;
  u.goal = document.getElementById('profile-goal').value;
  saveStorage();
  refreshSidebarUser();
  refreshSidebarWhatsApp();
  document.getElementById('profile-saved').style.display = 'block';
  setTimeout(() => document.getElementById('profile-saved').style.display = 'none', 2000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PWA ‚Äî INSTALL & SERVICE WORKER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let deferredInstallPrompt = null;

// Catch the beforeinstallprompt event (Android Chrome)
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredInstallPrompt = e;
  // Show the install card on the Install page if it's open
  const card = document.getElementById('install-prompt-card');
  if (card) card.style.display = 'block';
});

// After install
window.addEventListener('appinstalled', () => {
  deferredInstallPrompt = null;
  const card = document.getElementById('install-prompt-card');
  if (card) {
    card.innerHTML = '<div class="card" style="border-color:rgba(74,222,128,0.4);background:var(--green-glow);padding:20px;text-align:center;"><div style="font-size:40px;">üéâ</div><div style="font-weight:700;font-size:16px;margin-top:10px;">Successfully Installed!</div><div style="font-size:13px;color:var(--text-dim);margin-top:6px;">Chingone is now on your home screen.</div></div>';
  }
});



function triggerPWAInstall() {
  if (deferredInstallPrompt) {
    deferredInstallPrompt.prompt();
    deferredInstallPrompt.userChoice.then((choice) => {
      deferredInstallPrompt = null;
    });
  } else {
    // iOS or already installed ‚Äî show instructions
    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    if (isIOS) {
      alert('On iPhone:\n\n1. Tap the Share button (‚¨Ü) at the bottom of Safari\n2. Scroll down and tap "Add to Home Screen"\n3. Tap "Add" in the top right\n\nMake sure you\'re using Safari, not Chrome.');
    } else {
      alert('To install:\n\nTap the ‚ãÆ menu in Chrome ‚Üí "Add to Home screen" or "Install app"');
    }
  }
}

function updateShareMessage() {
  const url = document.getElementById('app-url-input').value.trim();
  if (url) localStorage.setItem('vt_app_url', url);
  const box  = document.getElementById('share-message-box');
  const text = document.getElementById('share-message-text');
  if (!url) { box.style.display = 'none'; return; }
  box.style.display = 'block';
  text.textContent =
    'üëã Hey everyone!\n\n' +
    'I set up our group health tracker app ‚Äî Chingone Life Tracker üí™\n\n' +
    'üì≤ Open this link on your phone:\n' + url + '\n\n' +
    'Then:\n' +
    '‚Ä¢ iPhone: Tap Share ‚¨Ü ‚Üí "Add to Home Screen"\n' +
    '‚Ä¢ Android: Tap ‚ãÆ menu ‚Üí "Add to Home screen"\n\n' +
    'It installs like a real app! Create your account once you\'re in. üèãÔ∏èü•ó';
}

function copyShareMessage() {
  const text = document.getElementById('share-message-text').textContent;
  navigator.clipboard.writeText(text).then(() => {
    const el = document.getElementById('share-copied');
    el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 2500);
  }).catch(() => {
    // Fallback for older browsers
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    const el = document.getElementById('share-copied');
    el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 2500);
  });
}

// Register inline Service Worker for offline support
function registerServiceWorker() {
  if (!('serviceWorker' in navigator)) return;

  // Build SW code as a base64 data URI ‚Äî works without HTTPS hosting restriction on blob URLs
  const swCode = [
    "const CACHE='chingone-v2';",
    "self.addEventListener('install',e=>{",
    "  e.waitUntil(caches.open(CACHE).then(c=>c.add(self.location.href)));",
    "  self.skipWaiting();",
    "});",
    "self.addEventListener('activate',e=>{",
    "  e.waitUntil(caches.keys().then(ks=>Promise.all(ks.filter(k=>k!==CACHE).map(k=>caches.delete(k)))));",
    "  self.clients.claim();",
    "});",
    "self.addEventListener('fetch',e=>{",
    "  if(e.request.mode==='navigate'){",
    "    e.respondWith(fetch(e.request).catch(()=>caches.match(e.request).then(r=>r||caches.open(CACHE).then(c=>c.match(self.location.href)))));",
    "  } else {",
    "    e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));",
    "  }",
    "});"
  ].join('\n');

  // Encode as base64 data URI ‚Äî supported in all browsers, no blob URL needed
  const b64 = btoa(unescape(encodeURIComponent(swCode)));
  const swUrl = 'data:application/javascript;base64,' + b64;

  navigator.serviceWorker.register(swUrl, { scope: './' })
    .then(() => console.log('‚úÖ Service Worker registered ‚Äî app works offline!'))
    .catch(err => {
      // Will fail on local file:// ‚Äî works fine once hosted on HTTPS
      if (!err.message.includes('protocol')) {
        console.log('SW registration note:', err.message);
      }
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMPORT DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let importLogs = [];

function renderImportPage() {
  // Just make sure the first tab is active on load
  const panels = document.querySelectorAll('.platform-panel');
  panels.forEach(p => p.classList.remove('active'));
  const first = document.getElementById('import-panel-fitbit');
  if (first) first.classList.add('active');
}

function switchImportTab(platform, btn) {
  document.querySelectorAll('.import-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.platform-panel').forEach(p => p.classList.remove('active'));
  const panel = document.getElementById('import-panel-' + platform);
  if (panel) panel.classList.add('active');
}

function handleDragOver(e, id) {
  e.preventDefault();
  document.getElementById('dz-' + id).classList.add('drag-over');
}
function handleDragLeave(id) {
  document.getElementById('dz-' + id).classList.remove('drag-over');
}
function handleDrop(e, dzId, platform) {
  e.preventDefault();
  document.getElementById('dz-' + dzId).classList.remove('drag-over');
  processFiles(Array.from(e.dataTransfer.files), platform);
}
function handleFileSelect(e, platform) {
  processFiles(Array.from(e.target.files), platform);
  e.target.value = '';
}

function processFiles(files, platform) {
  importLogs = [];
  let processed = 0;
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const text = e.target.result;
      try {
        if (platform === 'fitbit')  parseFitbit(text, file.name);
        else if (platform === 'mfp') parseMFP(text, file.name);
        else if (platform === 'apple') parseAppleHealth(text, file.name);
        else if (platform === 'csv')   parseGenericCSV(text, file.name);
      } catch(err) {
        importLogs.push('‚ùå Error parsing ' + file.name + ': ' + err.message);
      }
      processed++;
      if (processed === files.length) {
        showImportLog();
        showImportPreview(platform);
      }
    };
    if (file.name.endsWith('.xml')) reader.readAsText(file);
    else reader.readAsText(file);
  });
}

// ‚îÄ‚îÄ PARSE CSV helper ‚îÄ‚îÄ
function parseCSVText(text) {
  const lines = text.trim().split('\n');
  if (lines.length < 2) return [];
  const headers = lines[0].split(',').map(h => h.replace(/"/g,'').trim().toLowerCase());
  return lines.slice(1).filter(l => l.trim()).map(line => {
    const vals = splitCSVLine(line);
    const row = {};
    headers.forEach((h,i) => row[h] = (vals[i] || '').replace(/"/g,'').trim());
    return row;
  });
}

function splitCSVLine(line) {
  const result = [];
  let cur = '', inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    if (line[i] === '"') { inQuotes = !inQuotes; }
    else if (line[i] === ',' && !inQuotes) { result.push(cur); cur = ''; }
    else { cur += line[i]; }
  }
  result.push(cur);
  return result;
}

function normalizeDate(str) {
  if (!str) return null;
  // Try YYYY-MM-DD
  if (/^\d{4}-\d{2}-\d{2}/.test(str)) return str.slice(0,10);
  // Try MM/DD/YYYY
  const mdy = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
  if (mdy) return mdy[3] + '-' + mdy[1].padStart(2,'0') + '-' + mdy[2].padStart(2,'0');
  // Try DD/MM/YYYY
  const dmy = str.match(/^(\d{1,2})-(\d{1,2})-(\d{4})/);
  if (dmy) return dmy[3] + '-' + dmy[2].padStart(2,'0') + '-' + dmy[1].padStart(2,'0');
  return str.slice(0,10);
}

function safeParse(v) { return parseFloat(String(v).replace(/,/g,'')) || 0; }

// ‚îÄ‚îÄ FITBIT PARSER ‚îÄ‚îÄ
function parseFitbit(text, filename) {
  const rows = parseCSVText(text);
  if (!rows.length) { importLogs.push('‚ö†Ô∏è ' + filename + ': no data found'); return; }
  const u = allUsers[currentUser];
  if (!u.foodLog) u.foodLog = {};

  let foodCount = 0, workoutCount = 0;
  const fn = filename.toLowerCase();

  // Detect file type by headers
  const headers = Object.keys(rows[0]);
  const isFood     = headers.some(h => h.includes('calori') || h.includes('food') || h.includes('meal'));
  const isActivity = headers.some(h => h.includes('activit') || h.includes('duration') || h.includes('steps'));

  rows.forEach(row => {
    const dateRaw = row['date'] || row['log date'] || row['start time'] || '';
    const date = normalizeDate(dateRaw);
    if (!date) return;

    if (isFood) {
      const kcal    = safeParse(row['calories'] || row['energy (kcal)'] || row['cal'] || 0);
      const protein = safeParse(row['protein (g)'] || row['protein'] || 0);
      const carbs   = safeParse(row['carbohydrates (g)'] || row['carbs'] || row['carbohydrates'] || 0);
      const fat     = safeParse(row['fat (g)'] || row['fat'] || row['total fat'] || 0);
      const name    = row['food name'] || row['name'] || row['description'] || 'Fitbit Import';
      const meal    = normalizeMeal(row['meal'] || row['meal name'] || row['type'] || 'snack');

      if (!u.foodLog[date]) u.foodLog[date] = {};
      if (!u.foodLog[date][meal]) u.foodLog[date][meal] = [];
      u.foodLog[date][meal].push({ name, brand: 'Fitbit Import', kcal, protein, carbs, fat, fiber:0, sugar:0, sodium:0, qty:100, _imported: true });
      foodCount++;
    }

    if (isActivity) {
      const activity  = row['activity name'] || row['activity type'] || row['activity'] || 'Fitbit Activity';
      const duration  = safeParse(row['duration'] || row['duration (min)'] || row['minutes'] || 0);
      const calories  = safeParse(row['calories burned'] || row['calories'] || 0);
      const steps     = safeParse(row['steps'] || 0);
      if (!u.workoutLog) u.workoutLog = {};
      if (!u.workoutLog[date]) u.workoutLog[date] = [];
      u.workoutLog[date].push({
        activity: activity, name: steps ? steps + ' steps' : '',
        duration: Math.round(duration), calories: Math.round(calories),
        intensity: 'Moderate', exercises: [], notes: 'Imported from Fitbit', timestamp: Date.now(), _imported: true
      });
      workoutCount++;
    }
  });

  saveStorage();
  if (foodCount)    importLogs.push('‚úÖ ' + filename + ': imported ' + foodCount + ' food entries');
  if (workoutCount) importLogs.push('‚úÖ ' + filename + ': imported ' + workoutCount + ' workout sessions');
  if (!foodCount && !workoutCount) importLogs.push('‚ö†Ô∏è ' + filename + ': no recognizable data found');
}

// ‚îÄ‚îÄ MYFITNESSPAL PARSER ‚îÄ‚îÄ
function parseMFP(text, filename) {
  const rows = parseCSVText(text);
  if (!rows.length) { importLogs.push('‚ö†Ô∏è ' + filename + ': no data found'); return; }
  const u = allUsers[currentUser];
  if (!u.foodLog) u.foodLog = {};
  let count = 0;

  rows.forEach(row => {
    const dateRaw = row['date'] || row['day'] || '';
    const date = normalizeDate(dateRaw);
    if (!date) return;

    const kcal    = safeParse(row['calories'] || row['energy (kcal)'] || row['cal'] || 0);
    const protein = safeParse(row['protein (g)'] || row['protein'] || 0);
    const carbs   = safeParse(row['carbohydrates (g)'] || row['carbohydrates'] || row['carbs'] || 0);
    const fat     = safeParse(row['fat (g)'] || row['fat'] || 0);
    const fiber   = safeParse(row['fiber (g)'] || row['fiber'] || 0);
    const sugar   = safeParse(row['sugar (g)'] || row['sugar'] || 0);
    const sodium  = safeParse(row['sodium (mg)'] || row['sodium'] || 0);
    const name    = row['name'] || row['food name'] || row['description'] || 'MFP Import';
    const meal    = normalizeMeal(row['meal'] || row['meal name'] || 'snack');

    if (kcal === 0 && protein === 0 && carbs === 0) return; // skip empty rows

    if (!u.foodLog[date]) u.foodLog[date] = {};
    if (!u.foodLog[date][meal]) u.foodLog[date][meal] = [];
    u.foodLog[date][meal].push({ name, brand: 'MyFitnessPal Import', kcal, protein, carbs, fat, fiber, sugar, sodium, qty:100, _imported: true });
    count++;
  });

  saveStorage();
  importLogs.push(count > 0
    ? '‚úÖ ' + filename + ': imported ' + count + ' food entries from MyFitnessPal'
    : '‚ö†Ô∏è ' + filename + ': no recognizable MFP data found');
}

// ‚îÄ‚îÄ APPLE HEALTH XML PARSER ‚îÄ‚îÄ
function parseAppleHealth(text, filename) {
  const u = allUsers[currentUser];
  if (!u.workoutLog) u.workoutLog = {};
  if (!u.foodLog)    u.foodLog = {};

  let workoutCount = 0, nutritionCount = 0;

  try {
    const parser = new DOMParser();
    const xml    = parser.parseFromString(text, 'text/xml');

    // Workouts
    const workouts = xml.querySelectorAll('Workout');
    workouts.forEach(w => {
      const type     = (w.getAttribute('workoutActivityType') || '').replace('HKWorkoutActivityType','');
      const start    = w.getAttribute('startDate') || '';
      const date     = normalizeDate(start);
      if (!date) return;
      const duration = parseFloat(w.getAttribute('duration') || 0);
      const kcal     = parseFloat(w.getAttribute('totalEnergyBurned') || 0);
      if (!u.workoutLog[date]) u.workoutLog[date] = [];
      u.workoutLog[date].push({
        activity: type || 'Apple Health Workout', name: '',
        duration: Math.round(duration), calories: Math.round(kcal),
        intensity: 'Moderate', exercises: [], notes: 'Imported from Apple Health', timestamp: Date.now(), _imported: true
      });
      workoutCount++;
    });

    // Nutrition records
    const nutritionTypes = {
      'HKQuantityTypeIdentifierDietaryEnergyConsumed': 'kcal',
      'HKQuantityTypeIdentifierDietaryProtein':        'protein',
      'HKQuantityTypeIdentifierDietaryCarbohydrates':  'carbs',
      'HKQuantityTypeIdentifierDietaryFatTotal':       'fat',
      'HKQuantityTypeIdentifierDietaryFiber':          'fiber',
      'HKQuantityTypeIdentifierDietarySodium':         'sodium',
      'HKQuantityTypeIdentifierDietarySugar':          'sugar'
    };
    const byDate = {};
    const records = xml.querySelectorAll('Record');
    records.forEach(r => {
      const type  = r.getAttribute('type') || '';
      const key   = nutritionTypes[type];
      if (!key) return;
      const start = r.getAttribute('startDate') || '';
      const date  = normalizeDate(start);
      if (!date) return;
      const val   = parseFloat(r.getAttribute('value') || 0);
      if (!byDate[date]) byDate[date] = { kcal:0, protein:0, carbs:0, fat:0, fiber:0, sodium:0, sugar:0 };
      if (key === 'kcal') byDate[date].kcal += val;
      else byDate[date][key] += val;
    });

    Object.entries(byDate).forEach(([date, n]) => {
      if (!n.kcal && !n.protein && !n.carbs && !n.fat) return;
      if (!u.foodLog[date]) u.foodLog[date] = {};
      if (!u.foodLog[date]['snack']) u.foodLog[date]['snack'] = [];
      u.foodLog[date]['snack'].push({
        name: 'Apple Health Daily Nutrition', brand: 'Apple Health',
        kcal: Math.round(n.kcal), protein: Math.round(n.protein*10)/10,
        carbs: Math.round(n.carbs*10)/10, fat: Math.round(n.fat*10)/10,
        fiber: Math.round(n.fiber*10)/10, sugar: Math.round(n.sugar*10)/10, sodium: Math.round(n.sodium),
        qty: 100, _imported: true
      });
      nutritionCount++;
    });

    saveStorage();
    if (workoutCount)   importLogs.push('‚úÖ ' + filename + ': imported ' + workoutCount + ' Apple Health workouts');
    if (nutritionCount) importLogs.push('‚úÖ ' + filename + ': imported nutrition data for ' + nutritionCount + ' days');
    if (!workoutCount && !nutritionCount) importLogs.push('‚ö†Ô∏è ' + filename + ': no Workout or Nutrition records found in XML');

  } catch(err) {
    importLogs.push('‚ùå ' + filename + ': XML parse error ‚Äî ' + err.message);
  }
}

// ‚îÄ‚îÄ GENERIC CSV PARSER ‚îÄ‚îÄ
function parseGenericCSV(text, filename) {
  const rows = parseCSVText(text);
  if (!rows.length) { importLogs.push('‚ö†Ô∏è ' + filename + ': empty or unreadable file'); return; }
  const u = allUsers[currentUser];
  if (!u.foodLog) u.foodLog = {};
  let count = 0;

  // Try to find date and nutrition columns by fuzzy matching
  const colMap = (row) => {
    const k = Object.keys(row);
    const find = (...terms) => k.find(h => terms.some(t => h.includes(t))) || '';
    return {
      date:    find('date','day','time'),
      kcal:    find('calori','kcal','energy','cal'),
      protein: find('protein'),
      carbs:   find('carb','carbohy'),
      fat:     find('fat','lipid'),
      fiber:   find('fiber','fibre'),
      sugar:   find('sugar'),
      sodium:  find('sodium','salt'),
      name:    find('food','name','desc','item','meal name'),
      meal:    find('meal','type','category'),
    };
  };
  const cols = colMap(rows[0]);

  rows.forEach(row => {
    const dateRaw = row[cols.date] || '';
    const date = normalizeDate(dateRaw);
    if (!date) return;
    const kcal    = safeParse(row[cols.kcal] || 0);
    const protein = safeParse(row[cols.protein] || 0);
    const carbs   = safeParse(row[cols.carbs] || 0);
    const fat     = safeParse(row[cols.fat] || 0);
    if (!kcal && !protein && !carbs) return;
    const name = row[cols.name] || 'CSV Import';
    const meal = normalizeMeal(row[cols.meal] || 'snack');
    if (!u.foodLog[date]) u.foodLog[date] = {};
    if (!u.foodLog[date][meal]) u.foodLog[date][meal] = [];
    u.foodLog[date][meal].push({
      name, brand: 'CSV Import', kcal, protein, carbs, fat,
      fiber: safeParse(row[cols.fiber]||0), sugar: safeParse(row[cols.sugar]||0),
      sodium: safeParse(row[cols.sodium]||0), qty: 100, _imported: true
    });
    count++;
  });

  saveStorage();
  importLogs.push(count > 0
    ? '‚úÖ ' + filename + ': imported ' + count + ' entries'
    : '‚ö†Ô∏è ' + filename + ': could not find recognizable columns. Expected: date, calories, protein, carbs, fat');
}

function normalizeMeal(val) {
  const v = String(val).toLowerCase();
  if (v.includes('break') || v.includes('morning')) return 'breakfast';
  if (v.includes('lunch') || v.includes('midday') || v.includes('noon')) return 'lunch';
  if (v.includes('dinner') || v.includes('supper') || v.includes('evening')) return 'dinner';
  return 'snack';
}

function showImportLog() {
  const log = document.getElementById('import-log');
  const content = document.getElementById('import-log-content');
  if (!log || !content) return;
  log.style.display = 'block';
  content.innerHTML = importLogs.map(l => {
    const color = l.startsWith('‚úÖ') ? 'var(--green)' : l.startsWith('‚ùå') ? 'var(--red)' : 'var(--accent)';
    return `<div style="color:${color}">${escHtml(l)}</div>`;
  }).join('');
  log.scrollIntoView({ behavior:'smooth', block:'nearest' });
}

function showImportPreview(platform) {
  const u = allUsers[currentUser];
  const container = document.getElementById('import-preview-' + platform);
  if (!container) return;

  // Count totals
  const foodLog = u.foodLog || {};
  const workLog = u.workoutLog || {};
  const importedFoodDates = Object.keys(foodLog).filter(d =>
    Object.values(foodLog[d]).some(m => m.some(i => i._imported))
  ).length;
  const importedWorkDates = Object.keys(workLog).filter(d =>
    workLog[d].some(w => w._imported)
  ).length;

  if (!importedFoodDates && !importedWorkDates) return;

  container.innerHTML = `
    <div class="import-preview" style="margin-top:16px;">
      <div class="import-preview-title">‚úÖ Import Summary</div>
      ${importedFoodDates ? `
      <div class="import-stat">
        <span>Days with food data</span>
        <span class="import-stat-val" style="color:var(--green);">${importedFoodDates}</span>
      </div>` : ''}
      ${importedWorkDates ? `
      <div class="import-stat">
        <span>Days with workout data</span>
        <span class="import-stat-val" style="color:var(--blue);">${importedWorkDates}</span>
      </div>` : ''}
      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn btn-primary btn-sm" onclick="navigate('history')">üìÖ View in History</button>
        <button class="btn btn-outline btn-sm" onclick="navigate('dashboard')">üìä Back to Dashboard</button>
        <button class="btn btn-danger btn-sm" onclick="clearImportedData('${platform}')">üóë Clear Imported Data</button>
      </div>
    </div>`;
}

function clearImportedData(platform) {
  if (!confirm('Remove all imported data? Your manually logged entries will not be affected.')) return;
  const u = allUsers[currentUser];
  // Remove imported food entries
  Object.keys(u.foodLog || {}).forEach(date => {
    Object.keys(u.foodLog[date]).forEach(meal => {
      u.foodLog[date][meal] = (u.foodLog[date][meal] || []).filter(i => !i._imported);
    });
  });
  // Remove imported workouts
  Object.keys(u.workoutLog || {}).forEach(date => {
    u.workoutLog[date] = (u.workoutLog[date] || []).filter(w => !w._imported);
  });
  saveStorage();
  importLogs.push('üóë All imported data cleared.');
  showImportLog();
  const container = document.getElementById('import-preview-' + platform);
  if (container) container.innerHTML = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WHATSAPP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveWhatsApp() {
  const input  = document.getElementById('profile-whatsapp');
  const errEl  = document.getElementById('wa-error');
  const savedEl = document.getElementById('wa-saved');
  const waTest  = document.getElementById('wa-test-btn');
  const waClear = document.getElementById('wa-clear-btn');
  const val = input.value.trim();

  errEl.style.display = 'none';

  if (!val) {
    // Treat empty as a clear
    clearWhatsApp();
    return;
  }

  // Validate ‚Äî accept any URL that could be a WhatsApp link
  const isWaLink = val.includes('chat.whatsapp.com') || val.includes('whatsapp.com') || val.startsWith('https://wa.me/');
  if (!isWaLink) {
    errEl.style.display = 'block';
    return;
  }

  allUsers[currentUser].whatsapp = val;
  saveStorage();
  refreshSidebarWhatsApp();
  if (waTest)  waTest.style.display  = 'inline-flex';
  if (waClear) waClear.style.display = 'inline-flex';
  savedEl.style.display = 'block';
  setTimeout(() => savedEl.style.display = 'none', 2500);
}

function clearWhatsApp() {
  allUsers[currentUser].whatsapp = '';
  saveStorage();
  refreshSidebarWhatsApp();
  document.getElementById('profile-whatsapp').value = '';
  document.getElementById('wa-test-btn').style.display  = 'none';
  document.getElementById('wa-clear-btn').style.display = 'none';
  document.getElementById('wa-error').style.display = 'none';
}

function openWhatsApp() {
  const u = allUsers[currentUser];
  const link = u && u.whatsapp;
  if (!link) {
    alert('No WhatsApp group linked yet. Go to My Profile to add your group link.');
    navigate('profile');
    return;
  }
  window.open(link, '_blank');
}

function refreshSidebarWhatsApp() {
  const u   = allUsers[currentUser];
  const btn = document.getElementById('sidebar-whatsapp');
  if (btn) btn.style.display = (u && u.whatsapp) ? 'block' : 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// USERS GRID
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderUsersGrid() {
  const grid = document.getElementById('users-grid');
  const goalLabels = { lose_weight:'Lose Weight', build_muscle:'Build Muscle', maintain:'Maintain', improve_fitness:'Get Fit' };
  grid.innerHTML = Object.values(allUsers).map(u => `
    <div class="user-card ${u.username === currentUser ? 'active-user' : ''}" onclick="switchToUser('${u.username}')">
      <div class="uc-avatar">${u.name.charAt(0).toUpperCase()}</div>
      <div class="uc-name">${u.name}</div>
      <div class="uc-goal">${goalLabels[u.goal] || 'General Fitness'}</div>
      ${u.username === currentUser ? '<div style="margin-top:8px"><span class="badge badge-green">Active</span></div>' : ''}
    </div>
  `).join('');
}

function switchToUser(uname) {
  currentUser = uname;
  localStorage.setItem('vt_current', uname);
  refreshSidebarUser();
  refreshSidebarWhatsApp();
  navigate('dashboard');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOOGLE SHEETS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadSheetsPage() {
  if (gSheetsConfig && gSheetsConfig.connected) {
    document.getElementById('sheets-connected-banner').style.display = 'flex';
    document.getElementById('goog-client-id').value = gSheetsConfig.clientId || '';
    document.getElementById('goog-sheet-id').value = gSheetsConfig.sheetId || '';
  }
}

function connectGoogleSheets() {
  const clientId = document.getElementById('goog-client-id').value.trim();
  const sheetId = document.getElementById('goog-sheet-id').value.trim();
  const errEl = document.getElementById('sheets-err');
  const msgEl = document.getElementById('sheets-msg');
  
  if (!clientId || !sheetId) { errEl.style.display = 'block'; return; }
  errEl.style.display = 'none';
  
  // Initialize Google Identity Services
  const script = document.createElement('script');
  script.src = 'https://accounts.google.com/gsi/client';
  script.onload = () => {
    try {
      window.tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: clientId,
        scope: 'https://www.googleapis.com/auth/spreadsheets',
        callback: (tokenResponse) => {
          if (tokenResponse.access_token) {
            gSheetsConfig = { clientId, sheetId, connected: true, token: tokenResponse.access_token };
            localStorage.setItem('vt_sheets', JSON.stringify(gSheetsConfig));
            msgEl.style.display = 'block';
            document.getElementById('sheets-connected-banner').style.display = 'flex';
          }
        }
      });
      window.tokenClient.requestAccessToken();
    } catch(e) {
      errEl.textContent = 'Google OAuth failed: ' + e.message;
      errEl.style.display = 'block';
    }
  };
  document.head.appendChild(script);
}

async function syncEntryToSheets(food, meal, qty) {
  if (!gSheetsConfig || !gSheetsConfig.token) return;
  const f = qty / 100;
  const row = [currentLogDate, allUsers[currentUser].name, meal, food.name, qty,
    Math.round((food.kcal||0)*f), Math.round((food.protein||0)*f*10)/10,
    Math.round((food.carbs||0)*f*10)/10, Math.round((food.fat||0)*f*10)/10];
  
  try {
    await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${gSheetsConfig.sheetId}/values/A1:I1:append?valueInputOption=USER_ENTERED`, {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + gSheetsConfig.token, 'Content-Type': 'application/json' },
      body: JSON.stringify({ values: [row] })
    });
  } catch(e) { console.log('Sheets sync failed:', e); }
}

async function manualSyncSheets() {
  if (!gSheetsConfig || !gSheetsConfig.token) {
    alert('Please connect to Google Sheets first.'); return;
  }
  const u = allUsers[currentUser];
  const log = u.foodLog || {};
  const rows = [['Date','User','Meal','Food Name','Quantity (g)','Calories','Protein (g)','Carbs (g)','Fat (g)']];
  
  Object.keys(log).sort().forEach(date => {
    ['breakfast','lunch','dinner','snack'].forEach(meal => {
      (log[date][meal] || []).forEach(item => {
        const f = (item.qty||100)/100;
        rows.push([date, u.name, meal, item.name, item.qty||100,
          Math.round((item.kcal||0)*f), Math.round((item.protein||0)*f*10)/10,
          Math.round((item.carbs||0)*f*10)/10, Math.round((item.fat||0)*f*10)/10]);
      });
    });
  });
  
  try {
    await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${gSheetsConfig.sheetId}/values/A1:I${rows.length}?valueInputOption=USER_ENTERED`, {
      method: 'PUT',
      headers: { 'Authorization': 'Bearer ' + gSheetsConfig.token, 'Content-Type': 'application/json' },
      body: JSON.stringify({ values: rows })
    });
    document.getElementById('sync-msg').style.display = 'block';
    setTimeout(() => document.getElementById('sync-msg').style.display = 'none', 3000);
  } catch(e) { alert('Sync failed: ' + e.message); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CSV EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportCSV() {
  const u = allUsers[currentUser];
  const log = u.foodLog || {};
  const rows = [['Date','User','Meal','Food Name','Quantity (g)','Calories (kcal)','Protein (g)','Carbs (g)','Fat (g)','Fiber (g)','Sugar (g)','Sodium (mg)']];
  
  Object.keys(log).sort().forEach(date => {
    ['breakfast','lunch','dinner','snack'].forEach(meal => {
      (log[date][meal] || []).forEach(item => {
        const f = (item.qty||100)/100;
        rows.push([date, u.name, meal, '"'+item.name+'"', item.qty||100,
          Math.round((item.kcal||0)*f),
          Math.round((item.protein||0)*f*10)/10,
          Math.round((item.carbs||0)*f*10)/10,
          Math.round((item.fat||0)*f*10)/10,
          Math.round((item.fiber||0)*f*10)/10,
          Math.round((item.sugar||0)*f*10)/10,
          Math.round((item.sodium||0)*f*10)/10
        ]);
      });
    });
  });
  
  const csv = rows.map(r => r.join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `vitaltrack_${currentUser}_${getTodayStr()}.csv`;
  a.click();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLOSE DROPDOWN ON CLICK OUTSIDE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('click', (e) => {
  if (!e.target.closest('#food-search-input') && !e.target.closest('#search-dropdown')) {
    document.getElementById('search-dropdown').style.display = 'none';
  }
});


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORKOUT LOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentWorkoutDate = getTodayStr();
let selectedActivity = 'Weightlifting';
let exerciseRowCount = 0;

function changeWorkoutDate(delta) {
  const d = new Date(currentWorkoutDate + 'T12:00:00');
  d.setDate(d.getDate() + delta);
  if (d > new Date()) return;
  currentWorkoutDate = d.toISOString().split('T')[0];
  renderWorkoutLog();
}

function renderWorkoutLog() {
  const u = allUsers[currentUser];
  const workouts = ((u.workoutLog || {})[currentWorkoutDate]) || [];
  const isToday = currentWorkoutDate === getTodayStr();

  document.getElementById('workout-date-label').textContent = isToday
    ? 'Today ‚Äî ' + new Date().toLocaleDateString('en-US', {month:'short', day:'numeric'})
    : new Date(currentWorkoutDate + 'T12:00:00').toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric', year:'numeric'});

  // Streak
  const streak = calcWorkoutStreak();
  document.getElementById('workout-streak').textContent = streak > 1 ? 'üî• ' + streak + '-day streak!' : '';

  const container = document.getElementById('workout-sessions-container');
  const emptyState = document.getElementById('workout-empty-state');

  if (!workouts.length) {
    emptyState.style.display = 'block';
    container.innerHTML = '';
    container.appendChild(emptyState);
  } else {
    emptyState.style.display = 'none';
    container.innerHTML = workouts.map((w, wi) => buildSessionCard(w, wi, currentWorkoutDate)).join('');
  }

  // Recent workouts
  renderRecentWorkouts();
}

function buildSessionCard(w, wi, date) {
  const totalSets = (w.exercises || []).reduce((s, e) => s + (e.sets || []).length, 0);
  const totalVol = (w.exercises || []).reduce((v, e) =>
    v + (e.sets || []).reduce((sv, s) => sv + ((parseFloat(s.weight) || 0) * (parseInt(s.reps) || 0)), 0), 0);

  const exercisesHTML = (w.exercises || []).map(ex => {
    const setsRows = (ex.sets || []).map((s, si) => {
      const prCheck = checkPR(ex.name, s.weight, s.reps, date);
      return `<tr>
        <td>Set ${si + 1}</td>
        <td>${s.weight ? s.weight + ' lbs' : '‚Äî'}</td>
        <td>${s.reps || '‚Äî'}</td>
        <td>${s.weight && s.reps ? Math.round(s.weight * s.reps) : '‚Äî'}</td>
        <td>${prCheck ? '<span class="pr-badge">üèÜ PR</span>' : ''}</td>
      </tr>`;
    }).join('');
    return `<div class="exercise-block">
      <div class="exercise-block-name">üí™ ${ex.name}</div>
      <table class="sets-table">
        <thead><tr><th>Set</th><th>Weight</th><th>Reps</th><th>Volume</th><th></th></tr></thead>
        <tbody>${setsRows}</tbody>
      </table>
    </div>`;
  }).join('');

  return `<div class="workout-session-card">
    <div class="wsc-header" onclick="toggleSession(this)">
      <div>
        <div class="wsc-activity">${w.activity}${w.name ? ' ‚Äî ' + w.name : ''}</div>
        <div class="wsc-meta">
          ${w.duration ? '<span>‚è± ' + w.duration + ' min</span>' : ''}
          ${w.calories ? '<span>üî• ' + w.calories + ' kcal burned</span>' : ''}
          <span>üìã ${(w.exercises || []).length} exercise${(w.exercises||[]).length !== 1 ? 's' : ''}</span>
          <span>üî¢ ${totalSets} sets</span>
          ${totalVol > 0 ? '<span>‚öñÔ∏è ' + Math.round(totalVol).toLocaleString() + ' lbs total volume</span>' : ''}
          <span class="intensity-badge intensity-${w.intensity || 'Moderate'}">${w.intensity || 'Moderate'}</span>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation();deleteWorkout('${date}',${wi})">‚úï</button>
        <span style="color:var(--text-muted);font-size:18px;">‚ñæ</span>
      </div>
    </div>
    <div class="wsc-body">
      ${exercisesHTML || '<div style="color:var(--text-muted);font-size:13px;">No exercises recorded</div>'}
      ${w.notes ? '<div class="wsc-notes">üìù ' + w.notes + '</div>' : ''}
    </div>
  </div>`;
}

function toggleSession(header) {
  const body = header.nextElementSibling;
  body.style.display = body.style.display === 'none' ? 'block' : 'none';
}

function deleteWorkout(date, idx) {
  if (!confirm('Delete this workout?')) return;
  const u = allUsers[currentUser];
  u.workoutLog[date].splice(idx, 1);
  saveStorage();
  renderWorkoutLog();
}

function calcWorkoutStreak() {
  const u = allUsers[currentUser];
  const log = u.workoutLog || {};
  let streak = 0;
  const d = new Date();
  while (true) {
    const key = d.toISOString().split('T')[0];
    if (log[key] && log[key].length > 0) { streak++; }
    else if (streak > 0) break;
    d.setDate(d.getDate() - 1);
    if (streak === 0 && key < getTodayStr()) break;
    if (d < new Date('2020-01-01')) break;
  }
  return streak;
}

function checkPR(exerciseName, weight, reps, currentDate) {
  if (!weight || !reps) return false;
  const u = allUsers[currentUser];
  const log = u.workoutLog || {};
  const vol = parseFloat(weight) * parseInt(reps);
  for (const [date, sessions] of Object.entries(log)) {
    if (date >= currentDate) continue;
    for (const session of sessions) {
      for (const ex of (session.exercises || [])) {
        if (ex.name.toLowerCase() === exerciseName.toLowerCase()) {
          for (const s of (ex.sets || [])) {
            if (s.weight && s.reps && parseFloat(s.weight) * parseInt(s.reps) >= vol) return false;
          }
        }
      }
    }
  }
  return true;
}

function renderRecentWorkouts() {
  const u = allUsers[currentUser];
  const log = u.workoutLog || {};
  const allDates = Object.keys(log).filter(d => log[d].length > 0).sort().reverse().slice(0, 5);
  const card = document.getElementById('workout-history-card');
  const list = document.getElementById('workout-recent-list');
  if (!allDates.length) { card.style.display = 'none'; return; }
  card.style.display = 'block';
  list.innerHTML = allDates.map(date => {
    const sessions = log[date];
    const label = date === getTodayStr() ? 'Today' : new Date(date + 'T12:00:00').toLocaleDateString('en-US', {month:'short', day:'numeric'});
    return `<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);">
      <div>
        <div style="font-size:13px;font-weight:600;">${label}</div>
        <div style="font-size:12px;color:var(--text-dim);margin-top:2px;">${sessions.map(s => s.activity + (s.name ? ' ‚Äì ' + s.name : '')).join(', ')}</div>
      </div>
      <div style="font-size:12px;color:var(--text-muted);">${sessions.reduce((t,s) => t + (s.exercises||[]).length, 0)} exercises</div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ WORKOUT MODAL ‚îÄ‚îÄ
function openAddWorkout() {
  // Reset form
  selectedActivity = 'Weightlifting';
  document.querySelectorAll('.activity-chip').forEach(c => c.classList.toggle('active', c.textContent.includes('Weightlifting')));
  document.getElementById('wm-activity-custom').style.display = 'none';
  document.getElementById('wm-name').value = '';
  document.getElementById('wm-duration').value = '';
  document.getElementById('wm-intensity').value = 'Moderate';
  document.getElementById('wm-calories').value = '';
  document.getElementById('wm-notes').value = '';
  document.getElementById('wm-error').style.display = 'none';
  document.getElementById('exercise-rows-container').innerHTML = '';
  exerciseRowCount = 0;
  document.getElementById('no-exercises-msg').style.display = 'block';
  // Add first exercise row by default
  addExerciseRow();
  document.getElementById('add-workout-modal').classList.add('open');
}

function closeWorkoutModal() {
  document.getElementById('add-workout-modal').classList.remove('open');
}

function selectActivity(btn, name) {
  document.querySelectorAll('.activity-chip').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  selectedActivity = name;
  const customInput = document.getElementById('wm-activity-custom');
  customInput.style.display = name === 'Other' ? 'block' : 'none';
  if (name === 'Other') { customInput.focus(); return; }
  // Auto-fill workout name with the activity type if name field is empty or was auto-filled
  const nameInput = document.getElementById('wm-name');
  const activityNames = ['Weightlifting','Cardio','HIIT','Yoga','Swimming','Cycling','Running','Sports','Other'];
  const currentVal = (nameInput.value || '').trim();
  // Only auto-fill if empty or was previously auto-filled with an activity name
  if (!currentVal || activityNames.some(a => currentVal === a)) {
    nameInput.value = name;
  }
}

function addExerciseRow() {
  document.getElementById('no-exercises-msg').style.display = 'none';
  const id = exerciseRowCount++;
  const row = document.createElement('div');
  row.className = 'exercise-row';
  row.id = 'ex-row-' + id;
  row.innerHTML = `
    <div class="exercise-row-header">
      <input class="exercise-name-input" id="ex-name-${id}" placeholder="Exercise name (e.g. Bench Press, Squat, Deadlift...)" autocomplete="off">
      <button type="button" class="del-exercise-btn" onclick="deleteExerciseRow(${id})" title="Remove exercise">‚úï</button>
    </div>
    <div class="sets-grid" style="margin-bottom:4px;">
      <div class="sets-header">#</div>
      <div class="sets-header">Weight (lbs)</div>
      <div class="sets-header">Reps</div>
      <div class="sets-header">Notes</div>
      <div></div>
    </div>
    <div id="ex-sets-${id}"></div>
    <button type="button" class="add-set-btn" onclick="addSetRow(${id})">Ôºã Add Set</button>
  `;
  document.getElementById('exercise-rows-container').appendChild(row);
  addSetRow(id); // start with one set
}

function addSetRow(exId) {
  const container = document.getElementById('ex-sets-' + exId);
  const setNum = container.children.length + 1;
  const setDiv = document.createElement('div');
  setDiv.className = 'sets-grid';
  setDiv.innerHTML = `
    <div class="set-num">${setNum}</div>
    <input class="set-input" type="number" placeholder="0" min="0" step="2.5">
    <input class="set-input" type="number" placeholder="0" min="0">
    <input class="set-input" type="text" placeholder="notes" style="font-family:'DM Sans',sans-serif;text-align:left;padding-left:8px;">
    <button type="button" class="del-set-btn" onclick="this.parentElement.remove();renumberSets(${exId})">‚úï</button>
  `;
  container.appendChild(setDiv);
}

function renumberSets(exId) {
  const container = document.getElementById('ex-sets-' + exId);
  Array.from(container.children).forEach((row, i) => {
    const numEl = row.querySelector('.set-num');
    if (numEl) numEl.textContent = i + 1;
  });
}

function deleteExerciseRow(id) {
  const row = document.getElementById('ex-row-' + id);
  if (row) row.remove();
  if (!document.getElementById('exercise-rows-container').children.length) {
    document.getElementById('no-exercises-msg').style.display = 'block';
  }
}

function confirmAddWorkout() {
  const activity = selectedActivity === 'Other'
    ? (document.getElementById('wm-activity-custom').value.trim() || 'Other')
    : selectedActivity;

  const exercises = [];
  document.querySelectorAll('.exercise-row').forEach(row => {
    const exId = row.id.replace('ex-row-', '');
    const nameEl = document.getElementById('ex-name-' + exId);
    const name = nameEl ? nameEl.value.trim() : '';
    if (!name) return;
    const sets = [];
    const setsContainer = document.getElementById('ex-sets-' + exId);
    if (setsContainer) {
      Array.from(setsContainer.children).forEach(setRow => {
        const inputs = setRow.querySelectorAll('input');
        if (inputs.length >= 2) {
          sets.push({
            weight: inputs[0].value || '',
            reps:   inputs[1].value || '',
            notes:  inputs[2] ? inputs[2].value : ''
          });
        }
      });
    }
    exercises.push({ name, sets });
  });

  const workout = {
    activity,
    name:      document.getElementById('wm-name').value.trim(),
    duration:  document.getElementById('wm-duration').value,
    intensity: document.getElementById('wm-intensity').value,
    calories:  document.getElementById('wm-calories').value,
    notes:     document.getElementById('wm-notes').value.trim(),
    exercises,
    timestamp: Date.now()
  };

  const u = allUsers[currentUser];
  if (!u.workoutLog) u.workoutLog = {};
  if (!u.workoutLog[currentWorkoutDate]) u.workoutLog[currentWorkoutDate] = [];
  u.workoutLog[currentWorkoutDate].push(workout);
  saveStorage();
  closeWorkoutModal();
  renderWorkoutLog();
}

// ‚îÄ‚îÄ WORKOUT HISTORY PAGE ‚îÄ‚îÄ
function renderWorkoutHistory() {
  const u = allUsers[currentUser];
  const log = u.workoutLog || {};
  const allDates = Object.keys(log).filter(d => log[d].length > 0).sort().reverse();
  const container = document.getElementById('workout-history-full');
  if (!allDates.length) {
    container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:48px;font-size:14px;">No workouts logged yet.</div>';
    return;
  }
  container.innerHTML = allDates.map(date => {
    const label = new Date(date + 'T12:00:00').toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric', year:'numeric'});
    return `<div style="margin-bottom:28px;">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:1px;color:var(--text-dim);margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border);">${label}</div>
      ${log[date].map((w, wi) => buildSessionCard(w, wi, date)).join('')}
    </div>`;
  }).join('');
}

function exportWorkoutCSV() {
  const u = allUsers[currentUser];
  const log = u.workoutLog || {};
  const rows = [['Date','User','Activity','Workout Name','Duration (min)','Intensity','Calories Burned','Exercise','Set','Weight (lbs)','Reps','Volume (lbs)','Set Notes','Workout Notes']];
  Object.keys(log).sort().forEach(date => {
    (log[date] || []).forEach(w => {
      if (!(w.exercises || []).length) {
        rows.push([date, u.name, w.activity, w.name||'', w.duration||'', w.intensity||'', w.calories||'', '', '', '', '', '', '', w.notes||'']);
      } else {
        w.exercises.forEach(ex => {
          (ex.sets || []).forEach((s, si) => {
            const vol = (parseFloat(s.weight)||0) * (parseInt(s.reps)||0);
            rows.push([date, u.name, w.activity, w.name||'', w.duration||'', w.intensity||'', w.calories||'',
              ex.name, si+1, s.weight||'', s.reps||'', vol||'', s.notes||'', w.notes||'']);
          });
        });
      }
    });
  });
  const csv = rows.map(r => r.map(v => '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'workout_log_' + currentUser + '_' + getTodayStr() + '.csv';
  a.click();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RECIPES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentRecipeFilter = 'all';
let currentRecipeId = null;
let recipeEmoji = 'ü•ó';
let ingredientCount = 0;
let stepCount = 0;

// Seed some demo recipes on first load
function seedDemoRecipes() {
  const existing = getSharedRecipes();
  if (existing.length > 0) return;
  const demos = [
    {
      id: 'demo1', emoji: 'ü•ó', name: 'High-Protein Chicken & Quinoa Bowl',
      desc: 'A filling, macro-balanced lunch bowl that preps in 20 minutes.',
      category: 'lunch', servings: 2, prep: '10 mins', cook: '20 mins',
      kcal: 480, protein: 42, carbs: 38, fat: 14,
      ingredients: [
        {amount:'200', unit:'g', name:'Chicken breast, grilled & sliced'},
        {amount:'1', unit:'cup', name:'Quinoa, cooked'},
        {amount:'1', unit:'cup', name:'Spinach'},
        {amount:'¬Ω', unit:'cup', name:'Cherry tomatoes, halved'},
        {amount:'¬º', unit:'cup', name:'Cucumber, diced'},
        {amount:'2', unit:'tbsp', name:'Lemon tahini dressing'},
      ],
      steps: [
        'Cook quinoa per package directions and let cool slightly.',
        'Season and grill chicken breast until cooked through (165¬∞F). Slice thin.',
        'Arrange quinoa as the base in two bowls.',
        'Top with spinach, cherry tomatoes, and cucumber.',
        'Layer sliced chicken on top and drizzle with tahini dressing.',
        'Season with salt, pepper, and a squeeze of fresh lemon. Serve immediately.'
      ],
      tags: ['high-protein','meal-prep','gluten-free'],
      author: 'Sarah Johnson', date: '2026-02-10'
    },
    {
      id: 'demo2', emoji: 'ü•£', name: 'Overnight Oats with Berries',
      desc: 'Zero cook time ‚Äî just mix the night before for a perfect high-fiber breakfast.',
      category: 'breakfast', servings: 1, prep: '5 mins', cook: 'None',
      kcal: 340, protein: 18, carbs: 52, fat: 7,
      ingredients: [
        {amount:'¬Ω', unit:'cup', name:'Rolled oats'},
        {amount:'¬æ', unit:'cup', name:'Unsweetened almond milk'},
        {amount:'¬Ω', unit:'cup', name:'Greek yogurt (nonfat)'},
        {amount:'1', unit:'tbsp', name:'Chia seeds'},
        {amount:'1', unit:'tsp', name:'Honey'},
        {amount:'¬Ω', unit:'cup', name:'Mixed berries (fresh or frozen)'},
      ],
      steps: [
        'Combine oats, almond milk, Greek yogurt, and chia seeds in a jar or container.',
        'Stir in honey and mix well.',
        'Seal and refrigerate overnight (at least 6 hours).',
        'In the morning, top with fresh or thawed berries.',
        'Add a dash of cinnamon or vanilla extract if desired.'
      ],
      tags: ['high-fiber','no-cook','meal-prep'],
      author: 'Mike Chen', date: '2026-02-12'
    },
    {
      id: 'demo3', emoji: 'ü•§', name: 'Post-Workout Green Protein Smoothie',
      desc: 'Packed with protein and greens ‚Äî perfect within 30 minutes of your workout.',
      category: 'smoothie', servings: 1, prep: '5 mins', cook: 'None',
      kcal: 290, protein: 30, carbs: 28, fat: 5,
      ingredients: [
        {amount:'1', unit:'scoop', name:'Vanilla whey protein powder'},
        {amount:'1', unit:'cup', name:'Unsweetened almond milk'},
        {amount:'1', unit:'cup', name:'Spinach or kale'},
        {amount:'¬Ω', unit:'', name:'Banana (frozen)'},
        {amount:'¬Ω', unit:'cup', name:'Frozen mango chunks'},
        {amount:'1', unit:'tsp', name:'Chia seeds'},
      ],
      steps: [
        'Add almond milk to blender first (helps blending).',
        'Add spinach/kale and blend until smooth.',
        'Add banana, mango, protein powder, and chia seeds.',
        'Blend on high for 45‚Äì60 seconds until completely smooth.',
        'Pour into a glass and drink immediately for best nutrition.'
      ],
      tags: ['post-workout','high-protein','vegan-option'],
      author: 'Sarah Johnson', date: '2026-02-14'
    }
  ];
  saveSharedRecipes(demos);
}

function getSharedRecipes() {
  try { return JSON.parse(localStorage.getItem('vt_recipes') || '[]'); } catch(e) { return []; }
}

function saveSharedRecipes(recipes) {
  localStorage.setItem('vt_recipes', JSON.stringify(recipes));
}

function renderRecipes() {
  const q = (document.getElementById('recipe-search')?.value || '').toLowerCase();
  let recipes = getSharedRecipes();

  if (currentRecipeFilter !== 'all') {
    recipes = recipes.filter(r => r.category === currentRecipeFilter);
  }
  if (q) {
    recipes = recipes.filter(r =>
      r.name.toLowerCase().includes(q) ||
      (r.desc || '').toLowerCase().includes(q) ||
      (r.tags || []).some(t => t.toLowerCase().includes(q)) ||
      (r.author || '').toLowerCase().includes(q)
    );
  }

  const grid = document.getElementById('recipe-grid');
  const empty = document.getElementById('recipe-empty');

  if (!recipes.length) {
    grid.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  grid.innerHTML = recipes.map(r => {
    const hasMacros = r.kcal || r.protein || r.carbs || r.fat;
    const catClass = 'cat-' + (r.category || 'lunch');
    const tags = (r.tags || []).slice(0, 3).map(t => `<span class="recipe-tag">#${t}</span>`).join('');
    const macrosHTML = hasMacros ? `
      <div class="recipe-macros-row">
        ${r.kcal ? `<div class="recipe-macro"><div class="recipe-macro-val" style="color:var(--accent)">${r.kcal}</div><div class="recipe-macro-lbl">kcal</div></div>` : ''}
        ${r.protein ? `<div class="recipe-macro"><div class="recipe-macro-val" style="color:var(--green)">${r.protein}g</div><div class="recipe-macro-lbl">protein</div></div>` : ''}
        ${r.carbs ? `<div class="recipe-macro"><div class="recipe-macro-val" style="color:var(--blue)">${r.carbs}g</div><div class="recipe-macro-lbl">carbs</div></div>` : ''}
        ${r.fat ? `<div class="recipe-macro"><div class="recipe-macro-val" style="color:var(--accent2)">${r.fat}g</div><div class="recipe-macro-lbl">fat</div></div>` : ''}
      </div>` : '';
    return `<div class="recipe-card" onclick="openRecipeDetail('${r.id}')">
      <div class="recipe-card-img">${r.emoji || 'ü•ó'}</div>
      <div class="recipe-card-body">
        <div class="recipe-card-title">${escHtml(r.name)}</div>
        <div class="recipe-card-author">by ${escHtml(r.author || 'Unknown')} ¬∑ ${r.servings || 1} serving${r.servings != 1 ? 's' : ''}</div>
        <div class="recipe-card-desc">${escHtml(r.desc || '')}</div>
        ${macrosHTML}
        <div class="recipe-card-footer">
          <span class="recipe-tag ${catClass}">${categoryLabel(r.category)}</span>
          ${r.prep ? `<span class="recipe-tag">‚è± ${r.prep}</span>` : ''}
          ${tags}
        </div>
      </div>
    </div>`;
  }).join('');
}

function categoryLabel(cat) {
  const m = {breakfast:'üåÖ Breakfast', lunch:'‚òÄÔ∏è Lunch', dinner:'üåô Dinner', snack:'üçé Snack', smoothie:'ü•§ Smoothie', dessert:'üçì Dessert'};
  return m[cat] || cat;
}

function setRecipeFilter(btn, cat) {
  document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  currentRecipeFilter = cat;
  renderRecipes();
}

// ‚îÄ‚îÄ RECIPE DETAIL ‚îÄ‚îÄ
function openRecipeDetail(id) {
  const recipes = getSharedRecipes();
  const r = recipes.find(rx => rx.id === id);
  if (!r) return;
  currentRecipeId = id;

  const u = allUsers[currentUser];
  const isOwner = r.author === (u ? u.name : '') || r.authorId === currentUser || isAdmin();
  document.getElementById('recipe-delete-btn').style.display = isOwner ? 'inline-flex' : 'none';

  const hasMacros = r.kcal || r.protein || r.carbs || r.fat;
  const ingredientsHTML = (r.ingredients || []).map(ing =>
    `<li><span style="font-weight:600;min-width:100px;display:inline-block;">${escHtml(ing.amount)} ${escHtml(ing.unit)}</span> ${escHtml(ing.name)}</li>`
  ).join('');
  const stepsHTML = (r.steps || []).map(s => `<li>${escHtml(s)}</li>`).join('');
  const tagsHTML = (r.tags || []).map(t => `<span class="recipe-tag">#${escHtml(t)}</span>`).join(' ');

  document.getElementById('recipe-detail-content').innerHTML = `
    <div class="recipe-detail-hero">${r.emoji || 'ü•ó'}</div>
    <div class="recipe-detail-title">${escHtml(r.name)}</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px;">
      <span class="recipe-tag cat-${r.category}">${categoryLabel(r.category)}</span>
      ${r.prep ? `<span class="recipe-tag">‚è± Prep: ${escHtml(r.prep)}</span>` : ''}
      ${r.cook && r.cook !== 'None' ? `<span class="recipe-tag">üî• Cook: ${escHtml(r.cook)}</span>` : ''}
      <span class="recipe-tag">üçΩÔ∏è ${r.servings || 1} serving${r.servings != 1 ? 's' : ''}</span>
    </div>
    ${r.desc ? `<p style="font-size:14px;color:var(--text-dim);margin-bottom:16px;line-height:1.7;">${escHtml(r.desc)}</p>` : ''}
    ${hasMacros ? `
    <div style="display:flex;gap:14px;flex-wrap:wrap;padding:14px;background:var(--surface2);border-radius:var(--radius);margin-bottom:20px;">
      ${r.kcal ? `<div class="recipe-macro"><div class="recipe-macro-val" style="color:var(--accent)">${r.kcal}</div><div class="recipe-macro-lbl">calories</div></div>` : ''}
      ${r.protein ? `<div class="recipe-macro"><div class="recipe-macro-val" style="color:var(--green)">${r.protein}g</div><div class="recipe-macro-lbl">protein</div></div>` : ''}
      ${r.carbs ? `<div class="recipe-macro"><div class="recipe-macro-val" style="color:var(--blue)">${r.carbs}g</div><div class="recipe-macro-lbl">carbs</div></div>` : ''}
      ${r.fat ? `<div class="recipe-macro"><div class="recipe-macro-val" style="color:var(--accent2)">${r.fat}g</div><div class="recipe-macro-lbl">fat</div></div>` : ''}
      <div style="font-size:11px;color:var(--text-muted);align-self:flex-end;margin-left:auto;">per serving</div>
    </div>` : ''}
    <div style="font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);margin-bottom:10px;">Ingredients</div>
    <ul class="ingredient-list">${ingredientsHTML || '<li style="color:var(--text-muted)">No ingredients listed</li>'}</ul>
    ${stepsHTML ? `
    <div style="font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);margin:18px 0 10px;">Instructions</div>
    <ol class="step-list">${stepsHTML}</ol>` : ''}
    ${tagsHTML ? `<div style="margin-top:16px;display:flex;gap:6px;flex-wrap:wrap;">${tagsHTML}</div>` : ''}
    <div style="margin-top:16px;font-size:12px;color:var(--text-muted);">Shared by <strong style="color:var(--text-dim)">${escHtml(r.author || 'Unknown')}</strong> ¬∑ ${r.date || ''}</div>
  `;
  document.getElementById('recipe-detail-modal').classList.add('open');
}

function deleteCurrentRecipe() {
  if (!currentRecipeId) return;
  const recipes = getSharedRecipes();
  const r = recipes.find(rx => rx.id === currentRecipeId);
  if (!r) return;
  const u = allUsers[currentUser];
  const isOwner = r.authorId === currentUser || r.author === (u ? u.name : '');
  if (!isOwner && !isAdmin()) { showContactAdmin('delete other users\' recipes'); return; }
  if (!confirm('Delete this recipe? It will be removed for all users.')) return;
  saveSharedRecipes(recipes.filter(rx => rx.id !== currentRecipeId));
  document.getElementById('recipe-detail-modal').classList.remove('open');
  renderRecipes();
}

// ‚îÄ‚îÄ ADD RECIPE FORM ‚îÄ‚îÄ
function openAddRecipe() {
  recipeEmoji = 'ü•ó';
  ingredientCount = 0;
  stepCount = 0;
  document.getElementById('r-name').value = '';
  document.getElementById('r-desc').value = '';
  document.getElementById('r-category').value = 'lunch';
  document.getElementById('r-servings').value = '2';
  document.getElementById('r-prep').value = '';
  document.getElementById('r-cook').value = '';
  document.getElementById('r-kcal').value = '';
  document.getElementById('r-protein').value = '';
  document.getElementById('r-carbs').value = '';
  document.getElementById('r-fat').value = '';
  document.getElementById('r-tags').value = '';
  document.getElementById('r-error').style.display = 'none';
  document.getElementById('ingredients-container').innerHTML = '';
  document.getElementById('steps-container').innerHTML = '';
  document.getElementById('no-ingredients-msg').style.display = 'block';
  document.getElementById('no-steps-msg').style.display = 'block';
  document.querySelectorAll('.emoji-opt').forEach(e => e.classList.toggle('selected', e.dataset.emoji === 'ü•ó'));
  // Add first ingredient + step
  addIngredientRow();
  addStepRow();
  document.getElementById('add-recipe-modal').classList.add('open');
  setTimeout(() => document.getElementById('r-name').focus(), 100);
}

function closeRecipeModal() {
  document.getElementById('add-recipe-modal').classList.remove('open');
}

function selectRecipeEmoji(el) {
  document.querySelectorAll('.emoji-opt').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
  recipeEmoji = el.dataset.emoji;
}

function addIngredientRow() {
  document.getElementById('no-ingredients-msg').style.display = 'none';
  const id = ingredientCount++;
  const row = document.createElement('div');
  row.style.cssText = 'display:grid;grid-template-columns:80px 65px 1fr 24px;gap:6px;margin-bottom:6px;';
  row.id = 'ing-row-' + id;
  row.innerHTML = `
    <input class="set-input" type="text" id="ing-amt-${id}" placeholder="1" style="text-align:left;padding:8px 10px;">
    <input class="set-input" type="text" id="ing-unit-${id}" placeholder="cup" style="text-align:left;padding:8px 10px;">
    <input class="set-input" type="text" id="ing-name-${id}" placeholder="Ingredient name" style="text-align:left;padding:8px 10px;">
    <button type="button" class="del-set-btn" onclick="document.getElementById('ing-row-${id}').remove(); checkIngredientEmpty()">‚úï</button>
  `;
  document.getElementById('ingredients-container').appendChild(row);
}

function checkIngredientEmpty() {
  const isEmpty = !document.getElementById('ingredients-container').children.length;
  document.getElementById('no-ingredients-msg').style.display = isEmpty ? 'block' : 'none';
}

function addStepRow() {
  document.getElementById('no-steps-msg').style.display = 'none';
  const id = stepCount++;
  const num = document.getElementById('steps-container').children.length + 1;
  const row = document.createElement('div');
  row.className = 'step-entry';
  row.id = 'step-row-' + id;
  row.innerHTML = `
    <div class="step-num-badge">${num}</div>
    <textarea id="step-text-${id}" rows="2" placeholder="Describe this step..." style="flex:1;resize:vertical;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;outline:none;line-height:1.6;"></textarea>
    <button type="button" class="del-set-btn" style="margin-top:10px;" onclick="document.getElementById('step-row-${id}').remove(); renumberSteps()">‚úï</button>
  `;
  document.getElementById('steps-container').appendChild(row);
}

function renumberSteps() {
  const isEmpty = !document.getElementById('steps-container').children.length;
  document.getElementById('no-steps-msg').style.display = isEmpty ? 'block' : 'none';
  document.querySelectorAll('#steps-container .step-num-badge').forEach((el, i) => el.textContent = i + 1);
}

function confirmAddRecipe() {
  const name = document.getElementById('r-name').value.trim();
  const errEl = document.getElementById('r-error');
  if (!name) { errEl.textContent = 'Please enter a recipe name.'; errEl.style.display = 'block'; return; }

  // Collect ingredients
  const ingredients = [];
  document.querySelectorAll('#ingredients-container > div').forEach(row => {
    const id = row.id.replace('ing-row-', '');
    const nameVal = document.getElementById('ing-name-' + id)?.value.trim();
    if (nameVal) {
      ingredients.push({
        amount: document.getElementById('ing-amt-' + id)?.value.trim() || '',
        unit:   document.getElementById('ing-unit-' + id)?.value.trim() || '',
        name:   nameVal
      });
    }
  });
  if (!ingredients.length) { errEl.textContent = 'Please add at least one ingredient.'; errEl.style.display = 'block'; return; }

  // Collect steps
  const steps = [];
  document.querySelectorAll('#steps-container .step-entry').forEach(row => {
    const id = row.id.replace('step-row-', '');
    const t = document.getElementById('step-text-' + id)?.value.trim();
    if (t) steps.push(t);
  });

  const u = allUsers[currentUser];
  const recipe = {
    id: 'r_' + Date.now() + '_' + Math.random().toString(36).slice(2,7),
    emoji:       recipeEmoji,
    name,
    desc:        document.getElementById('r-desc').value.trim(),
    category:    document.getElementById('r-category').value,
    servings:    parseInt(document.getElementById('r-servings').value) || 1,
    prep:        document.getElementById('r-prep').value.trim(),
    cook:        document.getElementById('r-cook').value.trim(),
    kcal:        parseFloat(document.getElementById('r-kcal').value) || 0,
    protein:     parseFloat(document.getElementById('r-protein').value) || 0,
    carbs:       parseFloat(document.getElementById('r-carbs').value) || 0,
    fat:         parseFloat(document.getElementById('r-fat').value) || 0,
    ingredients,
    steps,
    tags:        document.getElementById('r-tags').value.split(',').map(t => t.trim()).filter(Boolean),
    author:      u ? u.name : currentUser,
    authorId:    currentUser,
    date:        getTodayStr()
  };

  errEl.style.display = 'none';
  const recipes = getSharedRecipes();
  recipes.unshift(recipe); // newest first
  saveSharedRecipes(recipes);
  closeRecipeModal();
  renderRecipes();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PDF / SHARE DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function shareDashboardPDF() {
  const html = buildDashboardPDFHTML();
  document.getElementById('pdf-preview-container').innerHTML = html;
  document.getElementById('pdf-modal').classList.add('open');
}

function printDashboardPDF() {
  const html = buildDashboardPDFHTML();
  // Put content in the print frame and trigger print
  const frame = document.getElementById('pdf-print-frame');
  frame.innerHTML = html;
  window.print();
  // Clean up after print dialog closes
  setTimeout(() => { frame.innerHTML = ''; }, 2000);
}

function buildDashboardPDFHTML() {
  const u        = allUsers[currentUser];
  if (!u) return '<p>No user data.</p>';

  const dateStr  = dashViewDate;
  const viewDate = new Date(dateStr + 'T12:00:00');
  const dateLabel = viewDate.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
  const generatedAt = new Date().toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit' });

  const totals   = getDayTotals(dateStr);
  const log      = (u.foodLog || {})[dateStr] || {};
  const workouts = ((u.workoutLog || {})[dateStr]) || [];

  const goalLabels = { lose_weight:'Lose Weight üî•', build_muscle:'Build Muscle üí™', maintain:'Maintain Weight ‚öñÔ∏è', improve_fitness:'Improve Fitness üèÉ' };
  const goalLabel  = goalLabels[u.goal] || 'General Fitness';

  // ‚îÄ‚îÄ Dual-unit body stats ‚îÄ‚îÄ
  // Always stored internally as imperial (lbs / inches)
  const wLbs  = parseFloat((u.weightLog && u.weightLog.length ? u.weightLog[u.weightLog.length-1].weight : u.weight) || 0);
  const hIn   = parseFloat(u.height || 0);
  const gwLbs = parseFloat(u.goalWeight || 0);

  // Today's weigh-in (if logged)
  const todayWeighIn = (u.weightLog || []).find(e => e.date === dateStr);

  // Imperial display
  const wLbsDisplay  = wLbs  ? wLbs + ' lbs'  : '‚Äî';
  const hInDisplay   = hIn   ? (Math.floor(hIn/12) + 'ft ' + Math.round(hIn%12) + 'in') : '‚Äî';
  const gwLbsDisplay = gwLbs ? gwLbs + ' lbs'  : '‚Äî';
  const todayLbsDisplay = todayWeighIn ? todayWeighIn.weight + ' lbs' : null;

  // Metric display
  const wKgDisplay   = wLbs  ? (Math.round(wLbs  * 0.453592 * 10) / 10) + ' kg' : '‚Äî';
  const hCmDisplay   = hIn   ? (Math.round(hIn   * 2.54     * 10) / 10) + ' cm' : '‚Äî';
  const gwKgDisplay  = gwLbs ? (Math.round(gwLbs * 0.453592 * 10) / 10) + ' kg' : '‚Äî';
  const todayKgDisplay = todayWeighIn ? (Math.round(todayWeighIn.weight * 0.453592 * 10) / 10) + ' kg' : null;

  // BMI (uses metric internally)
  let bmiStr = '';
  if (wLbs && hIn) {
    const bmi = Math.round((wLbs * 703 / (hIn * hIn)) * 10) / 10;
    const cat  = bmi < 18.5 ? 'Underweight' : bmi < 25 ? 'Normal' : bmi < 30 ? 'Overweight' : 'Obese';
    bmiStr = bmi + ' (' + cat + ')';
  }

  // ‚îÄ‚îÄ Macro progress bars ‚îÄ‚îÄ
  const calPct     = Math.min(100, Math.round((totals.cals    / (u.cals_goal    || 1800)) * 100));
  const proteinPct = Math.min(100, Math.round((totals.protein / (u.protein_goal || 120))  * 100));
  const carbsPct   = Math.min(100, Math.round((totals.carbs   / (u.carbs_goal   || 200))  * 100));
  const fatPct     = Math.min(100, Math.round((totals.fat     / (u.fat_goal     || 60))   * 100));

  const remaining  = Math.max(0, (u.cals_goal || 1800) - totals.cals);
  const overBy     = Math.max(0, totals.cals - (u.cals_goal || 1800));

  // ‚îÄ‚îÄ Meal rows ‚îÄ‚îÄ
  const mealEmojis = { breakfast:'üåÖ', lunch:'‚òÄÔ∏è', dinner:'üåô', snack:'üçé' };
  const mealLabels = { breakfast:'Breakfast', lunch:'Lunch', dinner:'Dinner', snack:'Snacks & Other' };

  let mealRows = '';
  let totalMealCals = 0;
  ['breakfast','lunch','dinner','snack'].forEach(meal => {
    const items = log[meal] || [];
    if (!items.length) return;
    const mealCals = items.reduce((s, i) => s + ((i.kcal||0) * ((i.qty||100)/100)), 0);
    totalMealCals += mealCals;
    const itemNames = items.slice(0,3).map(i => i.name).join(', ') + (items.length > 3 ? ` +${items.length-3} more` : '');
    mealRows += `
      <div class="pdf-meal-row">
        <div>
          <div style="display:flex;align-items:center;gap:6px;">
            <span class="pdf-meal-icon">${mealEmojis[meal]}</span>
            <span class="pdf-meal-name">${mealLabels[meal]}</span>
            <span style="font-size:11px;color:#999;">(${items.length} item${items.length!==1?'s':''})</span>
          </div>
          <div class="pdf-meal-items">${escHtml(itemNames)}</div>
        </div>
        <span class="pdf-meal-cals">${Math.round(mealCals)} kcal</span>
      </div>`;
  });

  if (!mealRows) {
    mealRows = '<div class="pdf-no-data">No food logged for this day.</div>';
  } else {
    const calStatus = overBy > 0
      ? `<span style="color:#dc2626;">+${Math.round(overBy)} kcal over goal</span>`
      : `<span style="color:#16a34a;">${Math.round(remaining)} kcal remaining</span>`;
    mealRows += `<div class="pdf-totals-row"><span>Total</span><span>${Math.round(totalMealCals)} kcal &nbsp;¬∑&nbsp; ${calStatus}</span></div>`;
  }

  // ‚îÄ‚îÄ Workout blocks ‚îÄ‚îÄ
  let workoutBlocks = '';
  if (workouts.length) {
    const totalDuration = workouts.reduce((s, w) => s + (w.duration||0), 0);
    const totalCalsBurned = workouts.reduce((s, w) => s + (w.calories||0), 0);
    workouts.forEach(w => {
      let exerciseRows = '';
      (w.exercises || []).forEach(ex => {
        const setsSummary = (ex.sets||[]).map(s => {
          const wVal = parseFloat(s.weight);
          const wStr = wVal ? s.weight + ' lbs (' + (Math.round(wVal * 0.453592 * 10)/10) + ' kg)' : '‚Äî';
          return wStr + ' √ó ' + (s.reps||'‚Äî');
        }).join('  ¬∑  ');
        exerciseRows += `<div class="pdf-exercise-row"><span class="pdf-exercise-name">${escHtml(ex.name||'Exercise')}</span><span class="pdf-exercise-sets">${setsSummary}</span></div>`;
      });
      workoutBlocks += `
        <div class="pdf-workout-block">
          <div class="pdf-workout-name">${escHtml(w.activity||'Workout')}${w.name ? ' ‚Äî ' + escHtml(w.name) : ''}</div>
          <div class="pdf-workout-meta">
            ${w.duration ? `<span>‚è± ${w.duration} min</span>` : ''}
            ${w.calories ? `<span>üî• ${w.calories} kcal burned</span>` : ''}
            ${w.intensity ? `<span>‚ö° ${w.intensity}</span>` : ''}
            ${w.exercises?.length ? `<span>üèãÔ∏è ${w.exercises.length} exercise${w.exercises.length!==1?'s':''}</span>` : ''}
          </div>
          ${exerciseRows ? `<div style="margin-top:8px;border-top:1px solid #e5e7eb;padding-top:8px;">${exerciseRows}</div>` : ''}
        </div>`;
    });
    workoutBlocks += `<div style="font-size:12px;color:#666;margin-top:6px;">Total: ${totalDuration} min active ¬∑ ${totalCalsBurned} kcal burned across ${workouts.length} session${workouts.length!==1?'s':''}</div>`;
  } else {
    workoutBlocks = '<div class="pdf-no-data">No workouts logged for this day.</div>';
  }

  // ‚îÄ‚îÄ Net calories ‚îÄ‚îÄ
  const netCals = Math.round(totals.cals - workouts.reduce((s, w) => s + (w.calories||0), 0));

  return `
  <div class="pdf-preview">

    <!-- Header -->
    <div class="pdf-header">
      <div>
        <div class="pdf-logo">CHINGONE <span>LIFE TRACKER</span></div>
        <div style="margin-top:6px;"><span class="pdf-goal-badge">${goalLabel}</span></div>
      </div>
      <div class="pdf-date-block">
        <div class="pdf-date">${dateLabel}</div>
        <div class="pdf-user">${escHtml(u.name)} ¬∑ Generated ${generatedAt}</div>
      </div>
    </div>

    <!-- Body Stats ‚Äî Dual Units -->
    ${(wLbs || hIn) ? `
    <div style="margin-bottom:14px;padding:12px 16px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;">
      <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:#64748b;margin-bottom:10px;">üìè Body Stats</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;">

        ${wLbs ? `<div style="background:white;border:1px solid #e2e8f0;border-radius:8px;padding:10px 12px;">
          <div style="font-size:10px;color:#94a3b8;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">Weight</div>
          <div style="font-size:16px;font-weight:700;color:#1e293b;">${wLbsDisplay}</div>
          <div style="font-size:12px;color:#64748b;margin-top:2px;">${wKgDisplay}</div>
        </div>` : ''}

        ${hIn ? `<div style="background:white;border:1px solid #e2e8f0;border-radius:8px;padding:10px 12px;">
          <div style="font-size:10px;color:#94a3b8;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">Height</div>
          <div style="font-size:16px;font-weight:700;color:#1e293b;">${hInDisplay}</div>
          <div style="font-size:12px;color:#64748b;margin-top:2px;">${hCmDisplay}</div>
        </div>` : ''}

        ${bmiStr ? `<div style="background:white;border:1px solid #e2e8f0;border-radius:8px;padding:10px 12px;">
          <div style="font-size:10px;color:#94a3b8;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">BMI</div>
          <div style="font-size:14px;font-weight:700;color:#1e293b;">${bmiStr}</div>
          <div style="font-size:11px;color:#94a3b8;margin-top:2px;">kg/m¬≤</div>
        </div>` : ''}

        ${gwLbs ? `<div style="background:white;border:1px solid #e2e8f0;border-radius:8px;padding:10px 12px;">
          <div style="font-size:10px;color:#94a3b8;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">Goal Weight</div>
          <div style="font-size:16px;font-weight:700;color:#16a34a;">${gwLbsDisplay}</div>
          <div style="font-size:12px;color:#64748b;margin-top:2px;">${gwKgDisplay}</div>
        </div>` : ''}

        ${todayLbsDisplay ? `<div style="background:white;border:2px solid #a78bfa;border-radius:8px;padding:10px 12px;">
          <div style="font-size:10px;color:#94a3b8;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">‚öñÔ∏è Today's Weigh-In</div>
          <div style="font-size:16px;font-weight:700;color:#7c3aed;">${todayLbsDisplay}</div>
          <div style="font-size:12px;color:#64748b;margin-top:2px;">${todayKgDisplay}</div>
        </div>` : ''}

      </div>
    </div>` : ''}

    <!-- Nutrition Stats -->
    <div class="pdf-section-title">üìä Nutrition Summary</div>
    <div class="pdf-stats-row">
      <div class="pdf-stat-box cals">
        <div><span class="pdf-stat-val" style="color:#d97706;">${Math.round(totals.cals)}</span><span class="pdf-stat-unit" style="color:#d97706;">kcal</span></div>
        <div class="pdf-stat-label">Calories</div>
        <div class="pdf-stat-goal">Goal: ${u.cals_goal||1800}</div>
        <div class="pdf-bar-wrap"><div class="pdf-bar-fill" style="width:${calPct}%;background:#f59e0b;"></div></div>
      </div>
      <div class="pdf-stat-box protein">
        <div><span class="pdf-stat-val" style="color:#16a34a;">${Math.round(totals.protein)}</span><span class="pdf-stat-unit" style="color:#16a34a;">g</span></div>
        <div class="pdf-stat-label">Protein</div>
        <div class="pdf-stat-goal">Goal: ${u.protein_goal||120}g</div>
        <div class="pdf-bar-wrap"><div class="pdf-bar-fill" style="width:${proteinPct}%;background:#22c55e;"></div></div>
      </div>
      <div class="pdf-stat-box carbs">
        <div><span class="pdf-stat-val" style="color:#2563eb;">${Math.round(totals.carbs)}</span><span class="pdf-stat-unit" style="color:#2563eb;">g</span></div>
        <div class="pdf-stat-label">Carbs</div>
        <div class="pdf-stat-goal">Goal: ${u.carbs_goal||200}g</div>
        <div class="pdf-bar-wrap"><div class="pdf-bar-fill" style="width:${carbsPct}%;background:#3b82f6;"></div></div>
      </div>
      <div class="pdf-stat-box fat">
        <div><span class="pdf-stat-val" style="color:#ea580c;">${Math.round(totals.fat)}</span><span class="pdf-stat-unit" style="color:#ea580c;">g</span></div>
        <div class="pdf-stat-label">Fat</div>
        <div class="pdf-stat-goal">Goal: ${u.fat_goal||60}g</div>
        <div class="pdf-bar-wrap"><div class="pdf-bar-fill" style="width:${fatPct}%;background:#f97316;"></div></div>
      </div>
    </div>

    ${workouts.length ? `
    <div style="margin-top:12px;padding:10px 14px;background:#f0fdf4;border:1px solid #86efac;border-radius:8px;font-size:13px;color:#166534;display:flex;justify-content:space-between;flex-wrap:wrap;gap:6px;">
      <span>üî• Net calories (after exercise): <strong>${netCals} kcal</strong></span>
      <span>${calPct}% of daily goal consumed</span>
    </div>` : `
    <div style="margin-top:12px;padding:10px 14px;background:#fffbeb;border:1px solid #fde68a;border-radius:8px;font-size:13px;color:#92400e;display:flex;justify-content:space-between;flex-wrap:wrap;gap:6px;">
      <span>${calPct >= 100 ? '‚ö†Ô∏è Over calorie goal by ' + Math.round(overBy) + ' kcal' : '‚úÖ ' + Math.round(remaining) + ' kcal remaining today'}</span>
      <span>${calPct}% of daily goal</span>
    </div>`}

    <!-- Food Log -->
    <div class="pdf-section-title">üçΩÔ∏è Food Log</div>
    <div>${mealRows}</div>

    ${totals.fiber || totals.sodium ? `
    <div style="display:flex;gap:20px;margin-top:10px;font-size:12px;color:#666;">
      ${totals.fiber  ? `<span>Fiber: <strong>${Math.round(totals.fiber)}g</strong></span>` : ''}
      ${totals.sodium ? `<span>Sodium: <strong>${Math.round(totals.sodium)}mg</strong></span>` : ''}
      ${totals.sugar  ? `<span>Sugar: <strong>${Math.round(totals.sugar)}g</strong></span>` : ''}
    </div>` : ''}

    <!-- Workouts -->
    <div class="pdf-section-title">üèãÔ∏è Workout Log</div>
    <div>${workoutBlocks}</div>

    <!-- Footer -->
    <div class="pdf-footer">
      <div class="pdf-footer-app">Chingone Life Tracker ¬∑ chingone.app</div>
      <div class="pdf-footer-date">Printed ${new Date().toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}</div>
    </div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MEAL IDEAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let fridgeItems    = [];
let cupboardItems  = [];
let lastMealIdeas  = [];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INGREDIENT SCANNER (Meal Ideas)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const _ingStreams = {};   // { fridge: MediaStream, cupboard: MediaStream }
const _ingModes  = {};   // { fridge: 'live'|'upload', cupboard: 'live'|'upload' }

function openIngredientScanner(type) {
  const key = _OPENAI_KEY;
  if (!key) {

  }
  const panel = document.getElementById(type + '-scanner-panel');
  if (panel) panel.style.display = 'block';
  setIngredientScanMode(type, 'live');
}

function closeIngredientScanner(type) {
  const panel = document.getElementById(type + '-scanner-panel');
  if (panel) panel.style.display = 'none';
  stopIngredientStream(type);
  // reset status
  const status = document.getElementById(type + '-scan-status');
  if (status) status.style.display = 'none';
}

function setIngredientScanMode(type, mode) {
  // On mobile, Camera button opens native camera directly
  if (mode === 'live' && /iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
    let camInput = document.getElementById('_ing_cam_' + type);
    if (!camInput) {
      camInput = document.createElement('input');
      camInput.type = 'file';
      camInput.id = '_ing_cam_' + type;
      camInput.accept = 'image/*';
      camInput.setAttribute('capture', 'environment');
      camInput.style.display = 'none';
      camInput.addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) handleIngredientUpload(e, type);
      });
      document.body.appendChild(camInput);
    }
    camInput.click();
    return;
  }
  _ingModes[type] = mode;
  const liveBtn   = document.getElementById(type + '-scan-mode-live');
  const uploadBtn = document.getElementById(type + '-scan-mode-upload');
  const liveDiv   = document.getElementById(type + '-scan-live');
  const uploadDiv = document.getElementById(type + '-scan-upload');
  if (liveBtn)   liveBtn.classList.toggle('src-active', mode === 'live');
  if (uploadBtn) uploadBtn.classList.toggle('src-active', mode === 'upload');
  if (liveDiv)   liveDiv.style.display   = mode === 'live'   ? 'block' : 'none';
  if (uploadDiv) uploadDiv.style.display = mode === 'upload' ? 'block' : 'none';
  if (mode === 'live') startIngredientCam(type);
  else stopIngredientStream(type);
}

async function startIngredientCam(type) {
  const video       = document.getElementById(type + '-scan-video');
  const placeholder = document.getElementById(type + '-scan-placeholder');
  const snapBtn     = document.getElementById(type + '-snap-btn');
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 } }
    });
    _ingStreams[type] = stream;
    if (video) { video.srcObject = stream; video.style.display = 'block'; }
    if (placeholder) placeholder.style.display = 'none';
    if (snapBtn) snapBtn.style.display = 'block';
  } catch(e) {
    if (placeholder) placeholder.innerHTML = '<div style="font-size:22px;">üö´</div><div style="font-size:11px;color:var(--red);margin-top:4px;">Camera denied ‚Äî use Upload</div>';
    setIngredientScanMode(type, 'upload');
  }
}

function stopIngredientStream(type) {
  if (_ingStreams[type]) {
    _ingStreams[type].getTracks().forEach(t => t.stop());
    delete _ingStreams[type];
  }
  const video = document.getElementById(type + '-scan-video');
  if (video) video.srcObject = null;
  const snapBtn = document.getElementById(type + '-snap-btn');
  if (snapBtn) snapBtn.style.display = 'none';
}

function snapIngredientPhoto(type) {
  const video  = document.getElementById(type + '-scan-video');
  const canvas = document.getElementById(type + '-scan-canvas');
  if (!video || !video.videoWidth) return;
  canvas.width  = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  const b64 = canvas.toDataURL('image/jpeg', 0.85).split(',')[1];
  stopIngredientStream(type);
  analyseIngredientPhoto(type, b64);
}

function handleIngredientUpload(e, type) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const b64 = ev.target.result.split(',')[1];
    analyseIngredientPhoto(type, b64);
  };
  reader.readAsDataURL(file);
}

function handleIngredientDrop(e, type) {
  e.preventDefault();
  const file = e.dataTransfer.files[0];
  if (!file || !file.type.startsWith('image/')) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const b64 = ev.target.result.split(',')[1];
    analyseIngredientPhoto(type, b64);
  };
  reader.readAsDataURL(file);
}

async function analyseIngredientPhoto(type, b64) {
  const status = document.getElementById(type + '-scan-status');
  if (status) status.style.display = 'block';

  // Use Claude or ChatGPT key
  const claudeKey = '';
  const gptKey    = _OPENAI_KEY;
  const useGPT    = !claudeKey && gptKey;

  const location = type === 'fridge' ? 'fridge or freezer' : 'cupboard or pantry';
  const prompt = `Look carefully at this photo of a ${location}. List every food ingredient, item, or product you can see that could be used for cooking.

Return ONLY a JSON array of ingredient names as plain strings ‚Äî no descriptions, no quantities, no markdown, just the names. Example:
["chicken breast", "eggs", "cheddar cheese", "broccoli", "milk"]

Be thorough ‚Äî include everything edible visible. Use simple common names (e.g. "chicken breast" not "poultry protein").`;

  try {
    let ingredients = [];

    if (!useGPT) {
      // Claude vision
      const res = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': claudeKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-opus-4-6',
          max_tokens: 400,
          messages: [{ role: 'user', content: [
            { type: 'image', source: { type: 'base64', media_type: 'image/jpeg', data: b64 } },
            { type: 'text',  text: prompt }
          ]}]
        })
      });
      if (!res.ok) throw new Error('API error ' + res.status);
      const data = await res.json();
      const text = (data.content || []).map(c => c.text || '').join('').trim();
      const match = text.match(/\[[\s\S]*\]/);
      if (match) ingredients = JSON.parse(match[0]);

    } else {
      // ChatGPT vision (GPT-4o)
      const res = await openAIFetch('/v1/chat/completions', {
        body: JSON.stringify({
          model: 'gpt-4o',
          max_tokens: 400,
          messages: [{ role: 'user', content: [
            { type: 'image_url', image_url: { url: 'data:image/jpeg;base64,' + b64 } },
            { type: 'text', text: prompt }
          ]}]
        })
      });
      if (!res.ok) throw new Error('GPT API error ' + res.status);
      const data = await res.json();
      const text = (data.choices?.[0]?.message?.content || '').trim();
      const match = text.match(/\[[\s\S]*\]/);
      if (match) ingredients = JSON.parse(match[0]);
    }

    // Add found ingredients to the list (avoid duplicates)
    const list = type === 'fridge' ? fridgeItems : cupboardItems;
    let added = 0;
    ingredients.forEach(ing => {
      const clean = String(ing).trim();
      if (clean && !list.find(i => i.toLowerCase() === clean.toLowerCase())) {
        list.push(clean);
        added++;
      }
    });

    saveIngredients();
    renderChips(type);
    closeIngredientScanner(type);

    // Show toast
    showIngredientToast(type, added, ingredients.length);

  } catch(e) {
    if (status) {
      status.innerHTML = '<span style="color:var(--red);font-size:12px;">‚ùå ' + escHtml(e.message) + '</span>';
    }
  }
}

function showIngredientToast(type, added, total) {
  const panel = document.getElementById(type + '-scanner-panel');
  if (!panel) return;
  // Small success note above the chips
  const chipRow = document.getElementById(type + '-chips');
  if (!chipRow) return;
  const toast = document.createElement('div');
  toast.style.cssText = 'padding:6px 10px;background:rgba(74,222,128,0.12);border:1px solid rgba(74,222,128,0.3);border-radius:8px;font-size:12px;color:var(--green);margin-bottom:8px;';
  toast.textContent = added > 0
    ? '‚úÖ Found ' + total + ' ingredients ‚Äî ' + added + ' added!'
    : '‚úÖ Scan complete ‚Äî all ingredients already in your list!';
  chipRow.parentNode.insertBefore(toast, chipRow);
  setTimeout(() => toast.remove(), 4000);
}

function loadMealIdeasPage() {

  // Restore saved ingredients from user profile
  const u = allUsers[currentUser];
  if (u && u.fridgeItems)    fridgeItems    = [...(u.fridgeItems || [])];
  if (u && u.cupboardItems)  cupboardItems  = [...(u.cupboardItems || [])];
  renderChips('fridge');
  renderChips('cupboard');

  // Hide results initially only if no results yet
  const results = document.getElementById('mi-results');
  const empty   = document.getElementById('mi-empty-state');
  if (!lastMealIdeas.length) {
    if (results) results.style.display = 'none';
    if (empty) empty.style.display = 'block';
  }
}

function addIngredient(type) {
  const input = document.getElementById(type + '-input');
  const val   = input.value.trim();
  if (!val) return;
  const list  = type === 'fridge' ? fridgeItems : cupboardItems;
  const clean = val.replace(/^[^\w\s]+\s*/, '').trim(); // strip leading emoji
  if (!list.find(i => i.toLowerCase() === clean.toLowerCase())) {
    list.push(clean);
    saveIngredients();
    renderChips(type);
  }
  input.value = '';
  input.focus();
}

function quickAdd(type, label) {
  const clean = label.replace(/^[^\w\s]+\s*/, '').trim();
  const list  = type === 'fridge' ? fridgeItems : cupboardItems;
  if (!list.find(i => i.toLowerCase() === clean.toLowerCase())) {
    list.push(clean);
    saveIngredients();
    renderChips(type);
  }
}

function removeIngredient(type, idx) {
  if (type === 'fridge') fridgeItems.splice(idx, 1);
  else cupboardItems.splice(idx, 1);
  saveIngredients();
  renderChips(type);
}

function renderChips(type) {
  const container = document.getElementById(type + '-chips');
  if (!container) return;
  const list = type === 'fridge' ? fridgeItems : cupboardItems;
  if (!list.length) { container.innerHTML = ''; return; }
  container.innerHTML = list.map((item, i) =>
    `<span class="ingredient-chip ${type}">
      ${escHtml(item)}
      <button class="chip-del" onclick="removeIngredient('${type}',${i})" title="Remove">‚úï</button>
    </span>`
  ).join('');
}

function saveIngredients() {
  const u = allUsers[currentUser];
  if (!u) return;
  u.fridgeItems   = [...fridgeItems];
  u.cupboardItems = [...cupboardItems];
  saveStorage();
}

async function generateMealIdeas() {
  const apiAuth = getUserApiKey();

  const u          = allUsers[currentUser];
  const mealType   = document.getElementById('mi-meal-type').value;
  const count      = parseInt(document.getElementById('mi-count').value) || 3;
  const restrict   = (document.getElementById('mi-restrictions').value || '').trim();
  const maxTime    = document.getElementById('mi-time').value;
  const notes      = (document.getElementById('mi-notes').value || '').trim();
  const savedPlan  = (u && u.aiPlan) ? u.aiPlan.slice(0, 1200) : '';

  const goalMap = {
    lose_weight:     'lose weight (lower calorie, high protein, filling)',
    build_muscle:    'build muscle (high protein, calorie surplus)',
    maintain:        'maintain weight (balanced macros)',
    improve_fitness: 'improve overall fitness (clean, balanced nutrition)'
  };
  const userGoal  = u ? (goalMap[u.goal] || 'general healthy eating') : 'general healthy eating';
  const userStats = u
    ? ['Age: ' + (u.age||'unknown'),
       'Weight: ' + (u.weight||'unknown') + ' lbs',
       'Calorie goal: ' + (u.cals_goal||'unknown') + ' kcal',
       'Protein goal: ' + (u.protein_goal||'unknown') + 'g',
       'Goal: ' + userGoal].join(', ')
    : 'No profile set';

  const fridgeList   = fridgeItems.length   ? fridgeItems.join(', ')   : null;
  const cupboardList = cupboardItems.length ? cupboardItems.join(', ') : null;
  const hasIngredients = fridgeList || cupboardList;

  // Build prompt as array then join ‚Äî avoids all quoting issues
  const lines = [
    'You are a creative nutritionist chef. Suggest ' + count + (mealType !== 'any' ? ' ' + mealType : '') + ' meal ideas perfectly suited to this person and their fitness goals.',
    '',
    'USER PROFILE: ' + userStats,
    hasIngredients ? 'FRIDGE/FREEZER: ' + (fridgeList || 'not specified') : 'No specific ingredients listed ‚Äî suggest practical meals using common everyday ingredients.',
    hasIngredients ? 'CUPBOARD/PANTRY: ' + (cupboardList || 'not specified') : ''
  ].filter(function(l) { return l !== undefined; });
  if (restrict)            lines.push('DIETARY RESTRICTIONS: ' + restrict);
  if (maxTime !== 'any')   lines.push('MAX PREP + COOK TIME: ' + maxTime + ' minutes');
  if (notes)               lines.push('ADDITIONAL NOTES: ' + notes);
  if (savedPlan)           lines.push('', 'FITNESS PLAN CONTEXT:', savedPlan);

  lines.push(
    '',
    'For EACH meal use exactly this format:',
    '',
    '## [Meal Name]',
    '**Category:** [Breakfast/Lunch/Dinner/Snack]',
    '**Prep time:** [X mins] | **Cook time:** [X mins]',
    '**Servings:** [X]',
    '',
    '**Why it fits your plan:** [1-2 sentences connecting this meal to their goals]',
    '',
    hasIngredients ? '**Ingredients you have:** [from their list]' : '**Key ingredients:** [main ingredients needed]',
    hasIngredients ? '**You will also need:** [extras, or "Nothing - you have everything!"]' : '**Shopping list:** [any items to pick up]',
    '',
    '**Estimated nutrition per serving:**',
    '- Calories: ~[X] kcal | Protein: ~[X]g | Carbs: ~[X]g | Fat: ~[X]g',
    '',
    '**Instructions:**',
    '1. [step]',
    '2. [step]',
    '3. [step]',
    '',
    '**Pro tip:** [one practical tip]',
    '',
    '---',
    '',
    'Be practical. Prioritise meals using mostly ingredients they already own. Order from quickest to most involved.'
  );

  const prompt = lines.join('\n');

  // ‚îÄ‚îÄ UI elements ‚îÄ‚îÄ
  const btn       = document.getElementById('mi-gen-btn');
  const resultsEl = document.getElementById('mi-results');
  const emptyEl   = document.getElementById('mi-empty-state');
  const contentEl = document.getElementById('mi-results-content');

  // apiAuth always has a value (default ChatGPT key is embedded)

  // ‚îÄ‚îÄ Loading state ‚îÄ‚îÄ
  const aiLabel = 'ChatGPT';
  if (btn) {
    btn.disabled  = true;
    btn.innerHTML = '<div class="spinner" style="width:18px;height:18px;border-width:2px;display:inline-block;vertical-align:middle;margin-right:8px;"></div> ' + aiLabel + ' is crafting your meal plan...';
  }
  if (emptyEl)   emptyEl.style.display   = 'none';
  if (resultsEl) resultsEl.style.display = 'block';
  if (contentEl) contentEl.innerHTML     = '<div class="mi-streaming" id="mi-stream-text" style="padding:16px;color:var(--text-dim);">Generating your personalised meal ideas...<span class="mi-cursor"></span></div>';

  try {
    let fullText = '';

    if (apiAuth.provider === 'chatgpt' || true) {
      // ChatGPT ‚Äî non-streaming (works on all browsers including iOS Safari)
      const res = await openAIFetch('/v1/chat/completions', {
        body: JSON.stringify({ model: 'gpt-4o', max_tokens: 4096, stream: false, messages: [{ role: 'user', content: prompt }] })
      });
      if (!res.ok) {
        const e = await res.json().catch(() => ({}));
        throw new Error((e.error && e.error.message) || 'OpenAI error ' + res.status);
      }
      const data = await res.json();
      fullText = (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) || '';
      if (!fullText) throw new Error('Empty response from OpenAI.');

    } else {
      // fallback (should not reach here since provider is always chatgpt)
      throw new Error('Unknown provider');
    }

    if (!fullText.trim()) throw new Error('No meal ideas were returned. Please try again.');

    // Render as formatted cards
    renderMealIdeaCards(fullText);
    if (u) { u.lastMealIdeas = fullText; saveStorage(); }

  } catch (err) {
    if (contentEl) {
      const isAuth  = err.message.includes('401') || err.message.includes('Unauthorized') || err.message.includes('invalid_api_key');
      const isQuota = err.message.includes('429') || err.message.includes('quota') || err.message.includes('billing');
      const isNet   = err.message === 'Failed to fetch' || err.message.includes('NetworkError');
      let tip = isAuth  ? 'Your API key was rejected ‚Äî try creating a new one at platform.openai.com/api-keys'
              : isQuota ? 'No credits ‚Äî add funds at platform.openai.com/billing'
              : isNet   ? 'Network blocked ‚Äî make sure you are on your live https:// URL, not a local file'
              : 'Check your internet connection and try again';
      contentEl.innerHTML = '<div style="background:rgba(248,113,113,0.08);border:1px solid rgba(248,113,113,0.3);border-radius:12px;padding:16px 18px;">'
        + '<div style="font-size:14px;font-weight:700;color:var(--red);margin-bottom:6px;">Could not generate meal ideas</div>'
        + '<div style="font-size:12px;font-family:monospace;background:var(--surface2);padding:6px 10px;border-radius:5px;margin-bottom:8px;">' + escHtml(err.message) + '</div>'
        + '<div style="font-size:12px;color:var(--accent);">&#x1F4A1; ' + tip + '</div>'
        + '</div>';
    }
  }

  if (btn) {
    btn.disabled  = false;
    btn.innerHTML = '‚ú® Generate Meal Ideas (Aligned to My Fitness Plan)';
  }
}


function renderMealIdeaCards(rawText) {
  const content = document.getElementById('mi-results-content');
  if (!content) return;

  // Split into individual meal blocks by ## heading
  const meals = rawText.split(/\n(?=##\s)/).filter(b => b.trim().startsWith('##'));

  if (!meals.length) {
    // Fallback: just show streamed text nicely
    content.innerHTML = `<div class="meal-idea-card"><div class="mi-streaming">${escHtml(rawText).replace(/\n/g,'<br>')}</div></div>`;
    return;
  }

  const allOwned = [...fridgeItems, ...cupboardItems].map(i => i.toLowerCase());

  content.innerHTML = meals.map((block, idx) => {
    const lines = block.trim().split('\n');
    const title = (lines[0] || '').replace(/^##\s*/, '').trim();

    const get = (label) => {
      const re = new RegExp(label + '[:\\s]+(.+)', 'i');
      for (const l of lines) { const m = l.match(re); if (m) return m[1].trim().replace(/\*\*/g,''); }
      return '';
    };

    const category   = get('Category');
    const prepTime   = get('Prep time');
    const cookTime   = get('Cook time');
    const servings   = get('Servings');
    const whyFits    = get('Why it fits your goal');
    const haveRaw    = get("Ingredients you have");
    const needRaw    = get("You'll also need|You'll need");
    const cals       = get('Calories');
    const protein    = get('Protein');
    const carbs      = get('Carbs');
    const fat        = get('Fat');
    const proTip     = get('Pro tip');

    // Instructions block
    const instrStart = lines.findIndex(l => /Instructions/i.test(l));
    const tipIdx     = lines.findIndex(l => /Pro tip/i.test(l));
    const instrLines = instrStart > -1
      ? lines.slice(instrStart + 1, tipIdx > instrStart ? tipIdx : undefined)
          .filter(l => /^\d+\./.test(l.trim()))
          .map(l => `<li>${escHtml(l.replace(/^\d+\.\s*/,''))}</li>`)
          .join('')
      : '';

    const haveChips = haveRaw.split(',').filter(Boolean).map(i => {
      const clean = i.trim().replace(/\*\*/g,'');
      const owned = allOwned.some(o => clean.toLowerCase().includes(o) || o.includes(clean.toLowerCase()));
      return `<span class="meal-idea-ingredient ${owned ? 'have' : 'have'}">‚úì ${escHtml(clean)}</span>`;
    }).join('');

    const needChips = (needRaw && !needRaw.toLowerCase().includes('nothing') && !needRaw.toLowerCase().includes('you have everything'))
      ? needRaw.split(',').filter(Boolean).map(i =>
          `<span class="meal-idea-ingredient need">+ ${escHtml(i.trim().replace(/\*\*/g,''))}</span>`
        ).join('')
      : '<span style="font-size:13px;color:var(--green);">‚úÖ You have everything!</span>';

    const catEmoji = { breakfast:'üåÖ', lunch:'‚òÄÔ∏è', dinner:'üåô', snack:'üçé' };
    const emoji    = catEmoji[(category||'').toLowerCase()] || 'üçΩÔ∏è';

    return `<div class="meal-idea-card">
      <div class="meal-idea-title">${escHtml(title)}</div>
      <div class="meal-idea-meta">
        ${category ? `<span class="recipe-tag cat-${(category||'').toLowerCase()}">${emoji} ${escHtml(category)}</span>` : ''}
        ${prepTime ? `<span class="recipe-tag">‚è± Prep: ${escHtml(prepTime.split('|')[0].trim())}</span>` : ''}
        ${cookTime ? `<span class="recipe-tag">üî• Cook: ${escHtml(cookTime)}</span>` : ''}
        ${servings ? `<span class="recipe-tag">üçΩÔ∏è ${escHtml(servings)} serving${servings!=='1'?'s':''}</span>` : ''}
      </div>
      ${whyFits ? `<div style="font-size:13px;color:var(--green);background:var(--green-glow);border-radius:var(--radius);padding:10px 14px;margin-bottom:12px;border:1px solid rgba(74,222,128,0.2);">üí™ ${escHtml(whyFits)}</div>` : ''}
      ${haveRaw ? `<div class="meal-idea-section">Ingredients You Have</div><div>${haveChips}</div>` : ''}
      ${needRaw ? `<div class="meal-idea-section">You'll Also Need</div><div>${needChips}</div>` : ''}
      ${(cals||protein||carbs||fat) ? `
      <div class="meal-macros-row">
        ${cals    ? `<div class="recipe-macro"><div class="recipe-macro-val" style="color:var(--accent)">${escHtml(cals.split(' ')[0].replace('~',''))}</div><div class="recipe-macro-lbl">calories</div></div>` : ''}
        ${protein ? `<div class="recipe-macro"><div class="recipe-macro-val" style="color:var(--green)">${escHtml(protein.split(' ')[0].replace('~',''))}</div><div class="recipe-macro-lbl">protein</div></div>` : ''}
        ${carbs   ? `<div class="recipe-macro"><div class="recipe-macro-val" style="color:var(--blue)">${escHtml(carbs.split(' ')[0].replace('~',''))}</div><div class="recipe-macro-lbl">carbs</div></div>` : ''}
        ${fat     ? `<div class="recipe-macro"><div class="recipe-macro-val" style="color:var(--accent2)">${escHtml(fat.split(' ')[0].replace('~',''))}</div><div class="recipe-macro-lbl">fat</div></div>` : ''}
      </div>` : ''}
      ${instrLines ? `<div class="meal-idea-section">Instructions</div><ol style="padding-left:20px;margin:0;">${instrLines}</ol>` : ''}
      ${proTip ? `<div style="margin-top:14px;padding:10px 14px;background:rgba(250,204,21,0.08);border:1px solid rgba(250,204,21,0.2);border-radius:var(--radius);font-size:13px;color:var(--accent);">üí° <strong>Tip:</strong> ${escHtml(proTip)}</div>` : ''}
      <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn btn-outline btn-sm" onclick="saveSingleMealToRecipes(${idx})">üìñ Save to Recipes</button>
        <button class="btn btn-outline btn-sm" onclick="logMealToFoodLog('${escHtml(title).replace(/'/g,"\\'")}', ${cals?cals.split(' ')[0].replace('~',''):0}, ${protein?protein.split(' ')[0].replace('~',''):0}, ${carbs?carbs.split(' ')[0].replace('~',''):0}, ${fat?fat.split(' ')[0].replace('~',''):0})">ü•ó Log to Food Log</button>
      </div>
    </div>`;
  }).join('');
}

function saveSingleMealToRecipes(idx) {
  // Re-parse the meal at index idx from lastMealIdeas
  const meals = String(lastMealIdeas).split(/\n(?=##\s)/).filter(b => b.trim().startsWith('##'));
  const block = meals[idx];
  if (!block) return;
  const title = (block.split('\n')[0] || '').replace(/^##\s*/,'').trim();
  const u = allUsers[currentUser];
  const recipe = {
    id: 'r_' + Date.now() + '_' + Math.random().toString(36).slice(2,5),
    emoji: 'üßë‚Äçüç≥', name: title, desc: 'Generated from your pantry ingredients by Claude AI',
    category: 'lunch', servings: 1, prep: '', cook: '', kcal: 0, protein: 0, carbs: 0, fat: 0,
    ingredients: [], steps: [block],
    tags: ['ai-generated','pantry-meal'],
    author: u ? u.name : currentUser, authorId: currentUser, date: getTodayStr()
  };
  const recipes = getSharedRecipes();
  recipes.unshift(recipe);
  saveSharedRecipes(recipes);
  alert('‚úÖ "' + title + '" saved to Recipes!');
}

function saveMealIdeasToRecipes() {
  const meals = String(lastMealIdeas).split(/\n(?=##\s)/).filter(b => b.trim().startsWith('##'));
  if (!meals.length) return;
  meals.forEach((_, i) => saveSingleMealToRecipes(i));
  alert('‚úÖ All ' + meals.length + ' meal ideas saved to your Recipes tab!');
}

function logMealToFoodLog(name, kcal, protein, carbs, fat) {
  const u = allUsers[currentUser];
  if (!u) return;
  if (!u.foodLog) u.foodLog = {};
  const today = getTodayStr();
  if (!u.foodLog[today]) u.foodLog[today] = {};
  if (!u.foodLog[today]['lunch']) u.foodLog[today]['lunch'] = [];
  u.foodLog[today]['lunch'].push({
    name: name, brand: 'AI Meal Idea', kcal: parseFloat(kcal)||0,
    protein: parseFloat(protein)||0, carbs: parseFloat(carbs)||0, fat: parseFloat(fat)||0,
    fiber:0, sugar:0, sodium:0, qty:100
  });
  saveStorage();
  alert('‚úÖ "' + name + '" logged to today\'s Food Log under Lunch!');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPER_ADMIN = 'bribush44';
const ADMIN_CONTACT = 'bribush44@gmail.com';

function isAdmin() {
  const u = allUsers[currentUser];
  return u && (u.isSuperAdmin || u.isAdmin);
}

function isSuperAdmin() {
  return currentUser === SUPER_ADMIN;
}

function showContactAdmin(action) {
  const modal = document.getElementById('contact-admin-modal');
  const msg   = document.getElementById('contact-admin-msg');
  if (msg) msg.textContent = action || 'perform this action';
  if (modal) modal.classList.add('open');
}

function renderAdminPanel() {
  renderAdminUsers();
  renderAdminRecipes();
}

function renderAdminUsers() {
  const container = document.getElementById('admin-user-list');
  const goalLabels = { lose_weight:'Lose Weight', build_muscle:'Build Muscle', maintain:'Maintain', improve_fitness:'Get Fit' };
  const users = Object.values(allUsers);

  container.innerHTML = users.map(u => {
    const isSelf   = u.username === currentUser;
    const isSA     = u.username === SUPER_ADMIN;
    const adminTag = u.isSuperAdmin
      ? '<span class="admin-badge">üõ°Ô∏è Super Admin</span>'
      : u.isAdmin ? '<span class="admin-badge">üõ°Ô∏è Admin</span>' : '';

    const promoteBtn = !u.isAdmin && !isSA
      ? `<button class="btn btn-warning btn-sm" onclick="adminToggleAdmin('${u.username}', true)">‚¨Ü Make Admin</button>` : '';
    const demoteBtn  = u.isAdmin && !u.isSuperAdmin && !isSA
      ? `<button class="btn btn-outline btn-sm" onclick="adminToggleAdmin('${u.username}', false)">‚¨á Remove Admin</button>` : '';
    const deleteBtn  = !isSA && !isSelf
      ? `<button class="btn btn-danger btn-sm" onclick="adminDeleteUser('${u.username}')">üóë Delete</button>` : '';

    return `<div class="admin-user-row">
      <div class="admin-user-info">
        <div class="uc-avatar" style="width:38px;height:38px;font-size:16px;border-radius:50%;background:var(--surface3);display:flex;align-items:center;justify-content:center;font-weight:700;">${u.name.charAt(0).toUpperCase()}</div>
        <div>
          <div style="font-weight:600;font-size:14px;display:flex;align-items:center;gap:8px;">${escHtml(u.name)} ${adminTag} ${isSelf ? '<span style="font-size:11px;color:var(--green);">(you)</span>' : ''}</div>
          <div style="font-size:12px;color:var(--text-muted);">@${u.username} ¬∑ ${goalLabels[u.goal] || 'General Fitness'}</div>
        </div>
      </div>
      <div class="admin-actions">
        ${promoteBtn}${demoteBtn}${deleteBtn}
      </div>
    </div>`;
  }).join('');
}

function renderAdminRecipes() {
  const container = document.getElementById('admin-recipe-list');
  const recipes   = getSharedRecipes();
  if (!recipes.length) {
    container.innerHTML = '<div style="color:var(--text-muted);font-size:14px;">No recipes shared yet.</div>';
    return;
  }
  container.innerHTML = recipes.map(r => `
    <div class="admin-user-row">
      <div style="display:flex;align-items:center;gap:10px;flex:1;min-width:0;">
        <span style="font-size:24px;">${r.emoji || 'ü•ó'}</span>
        <div style="min-width:0;">
          <div style="font-weight:600;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escHtml(r.name)}</div>
          <div style="font-size:12px;color:var(--text-muted);">by ${escHtml(r.author || 'Unknown')} ¬∑ ${r.date || ''}</div>
        </div>
      </div>
      <button class="btn btn-danger btn-sm" onclick="adminDeleteRecipe('${r.id}')">üóë Delete</button>
    </div>
  `).join('');
}

function adminToggleAdmin(username, makeAdmin) {
  if (!isSuperAdmin()) { showContactAdmin('manage admin roles'); return; }
  if (username === SUPER_ADMIN) return;
  const action = makeAdmin ? 'grant admin rights to' : 'remove admin rights from';
  if (!confirm(`Are you sure you want to ${action} @${username}?`)) return;
  allUsers[username].isAdmin = makeAdmin;
  saveStorage();
  renderAdminUsers();
  // If demoting and that user is currently logged in, refresh nav
  if (username === currentUser) refreshSidebarUser();
}

function adminDeleteUser(username) {
  if (!isSuperAdmin()) { showContactAdmin('delete users'); return; }
  if (username === SUPER_ADMIN) return;
  if (!confirm(`Permanently delete @${username} and ALL their data? This cannot be undone.`)) return;
  delete allUsers[username];
  saveStorage();
  renderAdminUsers();
}

function adminDeleteRecipe(id) {
  if (!confirm('Delete this recipe for all users?')) return;
  saveSharedRecipes(getSharedRecipes().filter(r => r.id !== id));
  renderAdminRecipes();
  renderRecipes();
}

function adminDeleteDemoUsers() {
  if (!isSuperAdmin()) { showContactAdmin('remove demo users'); return; }
  if (!confirm('Delete demo accounts sarah and mike? This will permanently remove all their data.')) return;
  delete allUsers['sarah'];
  delete allUsers['mike'];
  saveStorage();
  renderAdminUsers();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
loadStorage();
registerServiceWorker();
</script>
</body>
</html